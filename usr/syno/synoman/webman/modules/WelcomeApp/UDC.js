/* Copyright (c) 2020 Synology Inc. All rights reserved. */

Ext.define("SYNO.SDS.UDC.Utils",{singleton:true,sendWebAPIPrmoise:function(a){return new Promise(function(c,b){var d=this.findAppWindow();a.callback=function(e,h,g,f){if(e&&!h||h.has_fail===false){c({succ:e,data:h,request:g,opts:f})}else{b({succ:e,data:h,request:g,opts:f})}};d.sendWebAPI(a)}.bind(this))},setUDCState:function(a){return this.sendWebAPIPrmoise({api:"SYNO.Core.QuickStart.Info",version:1,method:"set_udc",params:{udc_value:a}})}});Ext.define("SYNO.SDS.UDC.WelcomePanel",{extend:"Ext.Container",constructor:function(a){var b={cls:"udc-welcome-panel inner-panel",items:[{xtype:"box",cls:"content title",html:_T("welcome","udc_welcome_title")},{xtype:"box",cls:"content desc",html:_T("welcome","udc_welcome_desc")},{xtype:"container",cls:"bbar",items:[{xtype:"syno_button",btnStyle:"blue",width:"100%",text:_T("welcome","udc_sure"),handler:this.onSureBtnClick.bind(this)},{xtype:"syno_button",text:_T("welcome","udc_later"),handler:this.onRemindBtnClick.bind(this)},{xtype:"box",cls:"skip-btn",html:_T("common","no_thanks"),listeners:{afterrender:this.onSkipBtnRender.bind(this)}}]}]};this.callParent([Ext.apply(b,a)])},onSkipBtnRender:function(a){a.el.on("click",this.onDisagree.bind(this))},sendWebAPIPrmoise:SYNO.SDS.UDC.Utils.sendWebAPIPrmoise,setUDCState:SYNO.SDS.UDC.Utils.setUDCState,onSureBtnClick:function(){this.hide()},onRemindBtnClick:function(){this.setUDCState("later").then(function(){this.findAppWindow().close()}.bind(this))["catch"](function(){this.findAppWindow().close()}.bind(this))},onDisagree:function(){this.sendWebAPIPrmoise({api:"SYNO.Core.DataCollect",version:1,method:"set",params:{enable:false}}).then(this.setUDCState.bind(this,_S("productversion"))).then(function(){this.findAppWindow().close()}.bind(this))["catch"](function(){this.findAppWindow().close()}.bind(this))}});Ext.define("SYNO.SDS.UDC.StatementPanel",{extend:"Ext.Container",constructor:function(a){var b={cls:"udc-statement-panel inner-panel",items:[{xtype:"container",cls:"statement-title-wrap",items:[{xtype:"box",cls:"statement-title",html:_T("welcome","udc_statement_title")}]},{xtype:"container",cls:"statement-content-wrap",items:{ref:"../statementBox",xtype:"box",cls:"statement-content",autoFlexcroll:true,updateScrollBarEventNames:["afterrender"],html:_T("welcome","udc_statement_content")}},{xtype:"container",cls:"statement-checkbox-wrap",items:[{xtype:"syno_checkbox",htmlEncode:false,checked:false,boxLabel:_T("welcome","udc_statement_checkbox"),listeners:{check:this.onUDCStatementCheck.bind(this)}}]},{xtype:"container",cls:"bbar",items:[{xtype:"syno_button",btnStyle:"blue",ref:"../confirmBtn",disabled:true,text:_T("common","ok"),handler:this.onAgree.bind(this)}]},{xtype:"box",cls:"close-btn",listeners:{afterrender:this.onCloseBtnRender.bind(this)}}]};this.callParent([Ext.apply(b,a)]);this.mon(this,"show",this.onAfterShow,this)},onUDCStatementCheck:function(b,a){this.confirmBtn.setDisabled(!a)},onAfterShow:function(){this.statementBox.updateFleXcroll();this.addClass.defer(10,this,["activate"])},onCloseBtnRender:function(a){a.el.on("click",function(){this.removeClass("activate");this.hide.defer(250,this)},this)},sendWebAPIPrmoise:SYNO.SDS.UDC.Utils.sendWebAPIPrmoise,setUDCState:SYNO.SDS.UDC.Utils.setUDCState,onAgree:function(){this.sendWebAPIPrmoise({api:"SYNO.Core.DataCollect",version:1,method:"set",params:{enable:true}}).then(this.setUDCState.bind(this,_S("productversion"))).then(function(){this.findAppWindow().close()}.bind(this))["catch"](function(){this.findAppWindow().close()}.bind(this))}});Ext.define("SYNO.SDS.UDC.SmartUpdatePanel",{extend:"Ext.Container",constructor:function(a){var b={cls:"smartupdate-panel inner-panel",items:[{xtype:"box",cls:"content title",html:_T("welcome","smartupdate_title")},{xtype:"box",cls:"content desc",html:_T("welcome","smartupdate_description")},{xtype:"container",cls:"bbar",items:[{xtype:"syno_button",btnStyle:"blue",text:_T("welcome","smartupdate_update_button"),handler:this.onBtnClick.bind(this)}]}]};this.callParent([Ext.apply(b,a)]);this.mon(this,"hide",this.onPageHide,this)},onPageHide:function(){this.owner.removeClass("smartupdate-activated")},onBtnClick:function(){SYNO.SDS.UserSettings.setProperty("SYNO.SDS.UDC.Instance","smartupdate_notified",true);this.fireEvent("finished")}});Ext.define("SYNO.SDS.UDC.MainPanel",{extend:"Ext.Container",constructor:function(b){var g=SYNO.SDS.UDC.Constraint,f=g.isUDCVisible(),e=g.isSmartUpdateVisible(),h="welcome",a="udc-main-panel",c=[];if(e){c.push(new SYNO.SDS.UDC.SmartUpdatePanel({owner:this,itemId:"smartupdate"}));a+=" smartupdate-activated";h="smartupdate"}if(f){c=c.concat([new SYNO.SDS.UDC.WelcomePanel({owner:this,itemId:"welcome",hidden:e}),new SYNO.SDS.UDC.StatementPanel({owner:this,itemId:"statement",hidden:true})])}var d={cls:a,activeItem:h,width:602,height:494,hideMode:"offsets",items:c};this.callParent([Ext.apply(d,b)]);this.bindEvents()},bindEvents:function(){var b=this.getComponent("welcome"),a=this.getComponent("statement"),c=this.getComponent("smartupdate");if(b){b.mon(a,"hide",function(){b.show()})}if(a){a.mon(b,"hide",function(){a.show()})}if(c){this.mon(c,"finished",function(){if(b){c.hide();b.show()}else{this.findAppWindow().close()}},this)}},sendWebAPIPrmoise:SYNO.SDS.UDC.Utils.sendWebAPIPrmoise,setUDCState:SYNO.SDS.UDC.Utils.setUDCState});Ext.define("SYNO.SDS.UDC.Constraint",{singleton:true,isUDCVisible:function(){var b=_S("udc_enabled"),a=_S("udc_check_state");if(b==="yes"){return false}return Ext.isEmpty(a)||a==="later"||a!==_S("productversion")},isSmartUpdateVisible:function(){var a=SYNO.SDS.UserSettings.getProperty("SYNO.SDS.UDC.Instance","smartupdate_notified")||false;return !a}});Ext.define("SYNO.SDS.UDC.Instance",{extend:"SYNO.SDS.AppInstance",appWindowName:"SYNO.SDS.UDC.AppWindow",fullsize:true,shouldLaunch:function(){var c=SYNO.SDS.UDC.Constraint,b=c.isUDCVisible(),a=c.isSmartUpdateVisible();return a||b}});Ext.define("SYNO.SDS.UDC.AppWindow",{extend:"SYNO.SDS.AppWindow",constructor:function(a){var b={border:false,toggleMinimizable:false,maximized:true,resizable:false,header:false,showHelp:false,cls:"syno-udc-win",renderTo:document.body,items:new SYNO.SDS.UDC.MainPanel()};this.callParent([Ext.apply(b,a)])},onOpen:function(){SYNO.SDS.ShowDesktop();this.callParent(arguments)}});