/* Copyright (c) 2020 Synology Inc. All rights reserved. */

Ext.define("SYNO.SDS.App.WelcomeApp.Package.Utils",{singleton:true,saveUsersettings:function(){this.getWin().sendWebAPI({api:"SYNO.Core.Package.Term",version:1,method:"get_version",callback:function(b,a){if(!b||!a){return}SYNO.SDS.UserSettings.setProperty("SYNO.SDS.PkgManApp.Instance","agreed_term_version",a.curr_term_version)}})},getWin:function(){return SYNO.SDS.WindowMgr.front},sendRequest:function(){var a=SYNO.SDS.App.WelcomeApp.Utils.isDVA();this.saveUsersettings();if(!a){this.enableUserHome()}this.installApp(a?"install_dva":"install_pkgs")},enableUserHome:function(){this.getWin().sendWebAPI({api:"SYNO.Core.User.Home",version:1,method:"set",params:{location:this.getWin().curVol.path,enable:true}})},installApp:function(a){this.getWin().sendWebAPI({api:"SYNO.Core.QuickStart.Install",version:1,timeout:24*60*60*1000,method:a||"install_pkgs",params:{path:this.getWin().curVol.path}})}});Ext.define("SYNO.SDS.App.WelcomeApp.SynoAccount.Utils",{singleton:true,setAPIParams:function(a){this.webapiParam=a},getWin:function(){return SYNO.SDS.WindowMgr.front},getQuickConnectPage:function(){return this.getWin().getComponent("register-quickconnect")},sendRequest:function(){if(!this.webapiParam){throw"no webapi to send"}return new Promise(function(b,a){var c=this.getWin();this.webapiParam.callback=function(d,g,f,e){if(d&&g.has_fail===false){b({succ:d,data:g,request:f,opts:e})}else{a({succ:d,data:g,request:f,opts:e})}};c.setStatusBusy();c.sendWebAPI(this.webapiParam)}.bind(this)).then(this.onSucc.bind(this))["catch"](this.onFail.bind(this))},onSucc:function(e){var g=this.getWin(),f=SYNO.API.Util.GetReqByAPI(e.opts,"SYNO.Core.QuickConnect","set_server_alias","server_alias"),d=SYNO.API.Util.GetValByAPI(e.data,"SYNO.Core.QuickConnect","get","domain"),a=g.getComponent("agreement_synoaccount");g.clearStatusBusy();var i=new SYNO.SDS.QuickConnect.Main(),b=i.aliasToPortalUrl(f,d),h=new SYNO.SDS.App.WelcomeApp.QuickConnectLinkStep({itemId:"quickconnect_link",quickconnect_url:b,appWin:g}),c=g.getCurrentStepIdx();g.insertSingleStep(c+1,h);g.setActiveItem("quickconnect_link");if(a){g.removeSteps(a)}return true},onCommonFail:function(e,b,h){var g=this.getWin(),c=[2902,2904,3004,3005,3006,3012],d=new SYNO.SDS.MessageBoxV5({owner:g,renderTo:Ext.getBody()}),a=g.getComponent("agreement_synoaccount"),i=e===3012?_T("welcome","error_exist_myds_account"):SYNO.API.getErrorString(e)||_T("common","commfail"),f=c.indexOf(e)>=0;h=h||false;switch(e){case 2904:i=String.format(i,SYNO.API.Util.GetReqByAPI(b,"SYNO.Core.QuickConnect","set_server_alias","server_alias"));break;case 3005:i=String.format(i,SYNO.API.Util.GetReqByAPI(b,"SYNO.Core.MyDSCenter","register","account"));break}if(f){this.goBackToQuickConnectPage(h)}d.getWrapper().alert(_T("error","error_error"),i,f?null:function(){g.gotoNextStep();if(a){g.removeSteps(a)}},this);return true},goBackToQuickConnectPage:function(a){var c=this.getWin(),b=this.getQuickConnectPage();c.setActiveItem("register-quickconnect");if(a&&b.registerForm.type!=="is_login_ok"){b.registerForm.adjustForLoginAccount()}b.nextBtn.enable()},confirmRetry:function(){var a,b=this.getQuickConnectPage();a=new SYNO.SDS.MessageBoxV5({owner:this.getWin(),renderTo:Ext.getBody()});a.getWrapper().confirm(_T("error","error_error"),_T("relayservice","alias_change_machine_message"),function(c){if(c==="yes"){b.registerForm.setAliasAgain=true;b.onGotoNextPage()}return})},onFail:function(f){var e=this.getWin(),d=f.data,a=false,b=d.result[0],c;e.clearStatusBusy();if(!f.succ){return this.onCommonFail()}c=SYNO.API.Util.GetFirstError(d).code;a=b&&b.success&&b.api==="SYNO.Core.MyDSCenter"&&(b.method==="register"||b.method==="login");if(c===3010){this.webapiParam.compound.params.splice(0,2);this.sendRequest();return true}if(c===2906){this.goBackToQuickConnectPage(a);this.confirmRetry();return true}this.onCommonFail(c,f.opts,a)}});Ext.define("SYNO.SDS.App.WelcomeApp.Agreement.BasePanel",{extend:"SYNO.ux.Panel",EXPAND_CLS:"expanded",COLLAPSE_CLS:"collapsed",subTitleHeight:84,constructor:function(a){Ext.apply(this,a);var b={items:this.configPanelItems(),cls:String.format("welcome-agree-panel {0}",this.innerCollapsed?this.COLLAPSE_CLS:this.EXPAND_CLS)};this.callParent([Ext.apply(b,a)]);this.relayEvents(this.getInnerCt().getComponent("agreement-checkbox"),["check"])},configPanelItems:function(){var b=430-20-44-8,a=b-this.subTitleHeight-16-20-30;return[{xtype:"box",cls:"agreement-title",itemId:"agreement-title",html:this.title,listeners:{afterrender:this.onTitleAfterRender.bind(this)}},{xtype:"container",cls:"welcome-inner-ct",itemId:"inner-ct",height:b,items:[{xtype:"box",cls:"agreement-subtitle",itemId:"agreement-subtitle",html:this.subTitle,height:this.subTitleHeight},{xtype:"container",cls:"agreement-content-wrap",items:[{xtype:"box",cls:"agreement-content",html:this.agreementStr,autoFlexcroll:true,height:a-28,updateScrollBarEventNames:["afterrender"]}],height:a},{xtype:"syno_checkbox",cls:"agreement-checkbox",itemId:"agreement-checkbox",boxLabel:this.agreementCheckboxStr||""}]}]},isExpanded:function(){return this.el.hasClass(this.EXPAND_CLS)},onTitleAfterRender:function(a){a.el.on("click",function(){var b=this.isExpanded();this.fireEvent("titleclicked",this,!b);this[b?"collapseInnerCt":"expandInnerCt"]()},this)},getInnerCt:function(){return this.getComponent("inner-ct")},isAgreed:function(){return this.getInnerCt().getComponent("agreement-checkbox").getValue()},expandInnerCt:function(){this.el.replaceClass(this.COLLAPSE_CLS,this.EXPAND_CLS)},collapseInnerCt:function(){this.el.replaceClass(this.EXPAND_CLS,this.COLLAPSE_CLS)}});Ext.define("SYNO.SDS.App.WelcomeApp.SynoAccount.TOS",{extend:"SYNO.SDS.App.WelcomeApp.Agreement.BasePanel",constructor:function(a){var b={title:_T("welcome","synoaccount_tos_title"),subTitle:_T("welcome","synoaccount_tos_subtitle"),agreementStr:_T("welcome","synoaccount_tos_content"),agreementCheckboxStr:_T("welcome","synoaccount_tos_checkbox")};this.callParent([Ext.apply(b,a)])}});Ext.define("SYNO.SDS.App.WelcomeApp.SynoAccount.Privacy",{extend:"SYNO.SDS.App.WelcomeApp.Agreement.BasePanel",constructor:function(a){var b={title:_T("welcome","synoaccount_privacy_title"),subTitle:_T("welcome","synoaccount_privacy_subtitle"),agreementStr:_T("welcome","synoaccount_privacy_content"),agreementCheckboxStr:_T("welcome","synoaccount_privacy_checkbox")};this.callParent([Ext.apply(b,a)])}});Ext.define("SYNO.SDS.App.WelcomeApp.Base.AgreementStep",{extend:"Ext.Container",constructor:function(a){var b={header:false,border:false,cls:"welcome-step-ct",height:800,items:this.createItems(a)};this.callParent([Ext.apply(b,a)]);this.bindEvents()},createItems:function(a){var e=Ext.getClassByName(a.tosCls),c=Ext.getClassByName(a.privacyCls),g=!!a.canSkip,d=a.nextText||_T("common","next"),f=a.nextHandler,b;b=[new e({itemId:"tos",innerCollapsed:false}),{xtype:"box",cls:"divider"},new c({itemId:"privacy",innerCollapsed:true}),{xtype:"container",cls:"welcome-paging",itemId:"footer",items:g?[{xtype:"syno_button",btnStyle:"blue",text:_T("common","back"),itemId:"back",cls:"welcome-back-btn",scope:this,handler:function(){this.appWin.gotoPreviousStep()}},{xtype:"syno_button",btnStyle:"blue",text:d,itemId:"next",cls:"welcome-next-btn",disabled:true,tooltip:_T("welcome","please_acknowledge_agreement"),scope:this,handler:f}]:{xtype:"syno_button",btnStyle:"blue",text:d,itemId:"next",cls:"welcome-next-btn",disabled:true,tooltip:_T("welcome","please_acknowledge_agreement"),scope:this,handler:f}}];return b},bindEvents:function(){var b=this.getComponent("tos"),a=this.getComponent("privacy"),c=function(){var d=this.getComponent("footer").getComponent("next"),e=this.isAgreed();d.setDisabled(!e);d.btnEl.dom.qtip=e?"":_T("welcome","please_acknowledge_agreement")}.bind(this);this.mon(b,"check",function(d){if(d&&!a.isAgreed()){b.collapseInnerCt();a.expandInnerCt()}c()},this,{delay:10});this.mon(a,"check",c,this,{delay:10});this.mon(b,"titleclicked",function(d,e){a[e?"collapseInnerCt":"expandInnerCt"]()});this.mon(a,"titleclicked",function(d,e){b[e?"collapseInnerCt":"expandInnerCt"]()})},isAgreed:function(){var b=this.getComponent("tos"),a=this.getComponent("privacy");return b.isAgreed()&&a.isAgreed()}});Ext.define("SYNO.SDS.App.WelcomeApp.SynoAccount.AgreementStep",{extend:"SYNO.SDS.App.WelcomeApp.Base.AgreementStep",constructor:function(a){var b={tosCls:"SYNO.SDS.App.WelcomeApp.SynoAccount.TOS",privacyCls:"SYNO.SDS.App.WelcomeApp.SynoAccount.Privacy",nextHandler:function(){SYNO.SDS.App.WelcomeApp.SynoAccount.Utils.sendRequest()}};this.callParent([Ext.apply(b,a)])}});Ext.define("SYNO.SDS.App.WelcomeApp.Package.TOS",{extend:"SYNO.SDS.App.WelcomeApp.Agreement.BasePanel",constructor:function(a){var b={title:_T("welcome","package_tos_title"),subTitle:_T("welcome","package_tos_subtitle"),agreementStr:_T("welcome","package_tos_content"),agreementCheckboxStr:_T("welcome","package_tos_checkbox")};this.callParent([Ext.apply(b,a)])}});Ext.define("SYNO.SDS.App.WelcomeApp.Package.Privacy",{extend:"SYNO.SDS.App.WelcomeApp.Agreement.BasePanel",constructor:function(a){var b={title:_T("welcome","package_privacy_title"),subTitle:_T("welcome","package_privacy_subtitle"),agreementStr:_T("welcome","package_privacy_content"),agreementCheckboxStr:_T("welcome","package_privacy_checkbox")};this.callParent([Ext.apply(b,a)])}});Ext.define("SYNO.SDS.App.WelcomeApp.Package.AgreementStep",{extend:"SYNO.SDS.App.WelcomeApp.Base.AgreementStep",constructor:function(a){var b={tosCls:"SYNO.SDS.App.WelcomeApp.Package.TOS",privacyCls:"SYNO.SDS.App.WelcomeApp.Package.Privacy",nextText:_T("welcome","welcome_pkg_install"),nextHandler:function(){SYNO.SDS.App.WelcomeApp.Package.Utils.sendRequest();this.appWin.gotoNextStep()}};this.callParent([Ext.apply(b,a)])}});Ext.define("SYNO.SDS.App.WelcomeApp.DataCollectFormPanel",{termsInfoUrl:"http://www.synology.com/company/privacy"});Ext.define("SYNO.SDS.App.WelcomeApp.EndPanel",{extend:"Ext.Container",constructor:function(a){var b={cls:"welcome-welcome-ct welcome-end-panel",items:[{xtype:"box",cls:"welcome-title",html:_T("welcome","welcome_end_title")},{xtype:"box",cls:"welcome-welcome-desc",html:_T("welcome","welcome_end_desc")},{xtype:"container",cls:"end-content-ct",items:[{ref:"../privacyCheckbox",xtype:"syno_checkbox",htmlEncode:false,boxLabel:_T("welcome","find_privacy_checkbox")||"?????????????????????????????????"}]},{xtype:"container",cls:"welcome-paging",items:[{xtype:"syno_button",btnStyle:"blue",cls:"welcome-next-btn",text:_T("welcome","welcome_go"),handler:this.endWelcome,scope:this}]}]};this.callParent([Ext.apply(b,a)])},setOtherDefaultSetting:function(){return this.requestPromise({compound:{params:this.getWebAPIs(),stopwhenerror:false}}).then(function(c){var a=_S("theme_cls")==="business",b=SYNO.SDS.isBusinessModel;if(b!==a){this.need_redirect=true;return}if(c&&c.result){Ext.each(c.result,function(e,d){if(e.api==="SYNO.Core.Region.NTP.DateTimeFormat"&&e.success){SYNO.SDS.Session.date_format=SYNO.SDS.DateTimeUtils.GetDateFormatByLang(_S("lang"));SYNO.SDS.Session.time_format=SYNO.SDS.DateTimeUtils.GetTimeFormatByLang(_S("lang"))}})}}.bind(this))["catch"](function(a){SYNO.Debug(a)})},endWelcome:function(){var b=this;var a=b.findAppWindow();a.setStatusBusy({text:_T("welcome","end_apply_msg")||"Apply Settings"});this.listTimeZone().then(this.setNTPTimeZone.bind(this)).then(this.setOtherDefaultSetting.bind(this)).then(this.setNetworkSetting.bind(this)).then(function(c){if(this.waiting_for_reload){return}if(this.need_redirect){window.location.reload(true);return}if(c!==false){a.clearStatusBusy();a.close()}}.bind(this))},getWebAPIs:function(){var c=new Date();var a=this.defaultLanguageSettingRequest();var b=[{api:"SYNO.Core.Service",version:1,method:"control",params:{service:[{action:this.privacyCheckbox.getValue()?"start":"stop",service_id:"synoagentregisterd"}]}},{api:"SYNO.Core.Security.AutoBlock",version:1,method:"set",params:{enable:true,attempts:10,within_mins:5,enable_expire:false},callback:Ext.emptyFn,scope:this},{api:"SYNO.Core.Theme.Desktop",version:1,method:"set",params:{theme:SYNO.SDS.isBusinessModel?"business":"default"},callback:Ext.emptyFn,scope:this},{api:"SYNO.Core.QuickStart.Info",method:"check_permission",version:1,callback:Ext.emptyFn},{api:"SYNO.Core.QuickStart.Info",method:"hide_welcome",version:1,callback:Ext.emptyFn},{api:"SYNO.Storage.CGI.Smart.Scheduler",method:"set",version:1,params:{app:{task_name:"Auto S.M.A.R.T. Test",id:"-1",enabled:"true",test_style:"quick",test_range:"all",selected_disks:"",test_type:"smart"},basic:{task_name:"Auto S.M.A.R.T. Test",id:"-1",enabled:"true",test_style:"quick",test_range:"all",selected_disks:"",test_type:"smart"},schedule:{date:String.format("{0}/{1}/{2}",c.getFullYear(),c.getMonth()+1,c.getDate()),repeat:1,date_type:1,hour:0,min:0,repeat_hour:0,repeat_min:0,last_work_hour:0,repeat_min_store_config:[],repeat_hour_store_config:[1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23]}},callback:Ext.emptyFn},{api:"SYNO.Core.Region.NTP.DateTimeFormat",version:1,method:"set",params:{date_format:SYNO.SDS.DateTimeUtils.GetDateFormatByLang(_S("lang")),time_format:SYNO.SDS.DateTimeUtils.GetTimeFormatByLang(_S("lang"))}}];if(null!==a){b.push(a)}return b},redirect:function(c){if(!c){throw"no need to redirect"}var g=c.redirect,a=c.secure,f=c.ip_list,b=c.port,h=c.auth_key,j=15000,d=0;if(!Ext.isBoolean(a)||!Ext.isArray(f)||!Ext.isString(b)||!Ext.isString(h)){throw"bad parameters"}if(!g){a=("https:"===location.protocol);f=[location.hostname];b=location.port;throw"no need to redirect"}SYNO.SDS.StatusNotifier.fireEvent("redirect");window.onbeforeunload=null;var e=function(k){var l="http"+((true===a)?"s":"");var m=String.format("{0}://{1}:{2}/index.cgi?auth_key={3}",l,f[k%f.length],b,h);window.location=m};e.defer(j,this,[0]);for(d=0;d<3;d++){j+=10000;e.defer(j,this,[0])}for(d=1;d<=f.length;d++){j+=10000;e.defer(j,this,[d])}this.waiting_for_reload=true},onSetNetworkFailed:function(c){if(c==="no need to redirect"){return true}var b=this.findAppWindow();b.clearStatusBusy();var a=new SYNO.SDS.MessageBoxV5({owner:b,renderTo:Ext.getBody()});a.getWrapper().alert("error",_T("welcome","apply_network_failed"),function(d){b.close()},this);return false},setNetworkSetting:function(){var a=this.findAppWindow();a.clearStatusBusy();var b=a.networkPanel?a.networkPanel.createSetAPI():null;if(!b){return true}a.setStatusBusy({text:_T("welcome","end_apply_network_msg")||"Apply Network Settings"},0.4,0);return this.requestPromise(b).then(this.redirect.bind(this))["catch"](this.onSetNetworkFailed.bind(this))},getBrowserTimeZone:function(b){var c,a,f,d,e="Dublin";c=(new Date()).getFullYear();if(Ext.isNumber(c)){a=new Date(c,0,1).getTimezoneOffset();f=new Date(c,6,1).getTimezoneOffset()}if(Ext.isNumber(a)&&Ext.isNumber(f)){d=(-1)*Math.max(a,f)*60}if(28800===d&&"chs"===_S("lang")){return"Beijing"}Ext.each(b,function(h,g,i){if(h.offset===d){e=h.value;return false}},this);return e},requestPromise:function(a){return new Promise(function(c,b){SYNO.API.Request(Ext.apply(a,{callback:function(e,d){if(e){c(d)}else{b(d)}},scope:this}))})},listTimeZone:function(){return this.requestPromise({api:"SYNO.Core.Region.NTP",version:1,method:"listzone"}).then(function(b){var a=b.zonedata;return this.getBrowserTimeZone(a)}.bind(this))["catch"](function(){var a="Dublin";return a}.bind(this))},setNTPTimeZone:function(a){var c;var b;if("Beijing"===a){c="set";b={timezone:a,enable_ntp:"ntp",server:"pool.ntp.org"}}else{c="setzone";b={timezone:a}}return this.requestPromise({api:"SYNO.Core.Region.NTP",version:1,method:c,params:b})["catch"](function(d){SYNO.Debug("Unable to set NTP time zone to: "+a);SYNO.Debug(d)})},defaultLanguageSettingRequest:function(){if(SYNO.SDS.UserSettings.getProperty("SYNO.SDS.App.WelcomeApp.Instance","welcome_dsm50_hide")){return null}var d=_S("lang"),b="enu",e="enu",a=SYNO.SDS.Utils.getSupportedLanguage(0),c=SYNO.SDS.Utils.getSupportedLanguageCodepage(0);Ext.each(a,function(f){if(f[0]===d){b=f[0];return false}},this);Ext.each(c,function(f){if(f[0]===d){e=f[0];return false}},this);return{api:"SYNO.Core.Region.Language",version:1,method:"set",params:{language:"def",maillang:b,codepage:e}}}});Ext.define("SYNO.SDS.App.WelcomeApp.RegiterAccountPanel",{extend:"Ext.Container",constructor:function(a){var b=this.fillConfig(a);this.callParent([b])},fillConfig:function(a){this.initRegisteryForm(a);this.nextBtn=new SYNO.ux.Button({xtype:"syno_button",btnStyle:"blue",text:_T("common","next"),itemId:"next",cls:"welcome-next-btn",disabled:false,scope:this,handler:function(d,c){var f=function(g){if(g.appWin.haveToCheckShr()){g.maskRegistryPage(true);g.waitForShrCreation()}else{g.onGotoNextPage()}};var e=this.registerForm.accountField;if(this.registerForm.fieldsValid()===false){return}d.disable();if(e.getValue()==="admin"){f(this);return}this.sendWebAPI({api:"SYNO.Core.User",method:"get",version:1,params:{name:e.getValue()},scope:this,callback:function(i,h,g){if(i){d.enable();e.markInvalid(_T("user","error_nameused"))}else{f(this)}}})}});var b={header:false,border:false,cls:"welcome-step-ct",items:[{xtype:"box",cls:"welcome-step-title",html:String.format(_T("welcome","welcome_admin_account_title"),_D("product"))},{xtype:"box",cls:"welcome-step-desc",html:String.format(_T("welcome","welcome_admin_account_desc"),"Synology "+_D("upnpmodelname"))},this.registerForm,{xtype:"container",cls:"welcome-paging",items:this.nextBtn}],listeners:{beforeshow:{fn:this.loadPasswordRules,scope:this}}};Ext.apply(b,a);return b},initRegisteryForm:function(a){this.registerFormID=Ext.id();this.registerForm=new SYNO.SDS.App.WelcomeApp.RegisterFormPanel({id:this.registerFormID,appWin:a.appWin})},getProgressBox:function(){if(!this.progressBox||this.progressBox.isDestroyed){this.progressBox=new SYNO.SDS.MessageBoxV5({modal:true,draggable:false,cls:"welcome-progress-box progress",renderTo:document.body});this.mon(this.progressBox,"beforeshow",function(){this.progressBox.maskEl.addClass("welcome-progress-mask")},this)}return this.progressBox.getWrapper()},maskRegistryPage:function(a){if(a){this.getProgressBox().progress();this.getProgressBox().updateProgress(0,"0%",_T("welcome","welcome_creating_shr"))}else{this.getProgressBox().hide()}},loadPasswordRules:function(){this.rules={exclude_username:true,min_length:6,min_length_enable:true};this.appWin.setStatusBusy();this.appWin.sendWebAPI({api:"SYNO.Core.User.PasswordPolicy",version:1,method:"get",callback:function(d,c,b,a){this.appWin.clearStatusBusy();if(d&&c&&c.strong_password){if(c.strong_password){Ext.applyIf(this.rules,c.strong_password);if(c.strong_password.min_length_enable&&c.strong_password.min_length>this.rules.min_length){this.rules.min_length=c.strong_password.min_length}}}},scope:this})},onGotoNextPage:function(){var b=this.registerForm.getForm().getValues();var a=[{api:"SYNO.Core.Security.AutoBlock",version:1,method:"set",params:{enable:true,attempts:10,within_mins:5,enable_expire:false},callback:Ext.emptyFn,scope:this},{api:"SYNO.Core.Theme.Desktop",version:1,method:"set",params:{theme:SYNO.SDS.isBusinessModel?"business":"default"},callback:Ext.emptyFn,scope:this},{api:"SYNO.Core.Network",version:1,method:"set",params:{server_name:b.myds_server_name}},{api:"SYNO.Core.Service",version:1,method:"control",params:{service:[{service_id:"synoagentregisterd",action:(b.registBox?"start":"stop")}]}}];if("yes"!=_D("dockerdsm")){a.push({api:"SYNO.Core.Network",version:1,method:"set",params:{server_name:b.myds_server_name}})}if(b.myds_account.toLowerCase()==="admin"){a.push({api:"SYNO.Core.User",version:1,method:"set",params:{name:"admin",password:b.myds_password}})}else{a=a.concat([{api:"SYNO.Core.User",version:1,method:"set",params:{name:"admin",password:(function(){var l=function(i){return Math.floor(Math.random()*i)};var k="1234567890";var h="abcdefghijklmnopqrstuvwxyz";var m="ABCDEFGHIJKLMNOPQRSTUVWXYZ";var d="~`!@#$%^&*()-_+={[}]|\\:;\"'<,>.?/";var n=k+h+m+d;var c=16+l(32);var o=[];var g=0;Ext.each([k,h,m,d],function(i){o[g++]=i[l(i.length)]});while(g<c){o[g++]=n[l(n.length)]}while(g!==0){var e=l(g--);var f=o[g];o[g]=o[e];o[e]=f}return o.join("")})()}},{api:"SYNO.Core.User",version:1,method:"create",params:{name:b.myds_account,password:b.myds_password}},{api:"SYNO.Core.Group.Member",version:1,method:"add",params:{group:"administrators",name:[b.myds_account]}},{api:"SYNO.Core.User",version:1,method:"set",params:{name:"admin",expired:"now"}}])}this.getNewAdminInfo=function(){return{username:b.myds_account,password:b.myds_password}};SYNO.SDS.StatusNotifier.fireEvent("halt");this.sendWebAPI({compound:{stopwhenerror:false,params:a},encryption:["password"],scope:this,callback:function(h,c,g,d){if("yes"!=_D("dockerdsm")){SYNO.SDS.Session.hostname=SYNO.API.Util.GetReqByAPI(d,"SYNO.Core.Network","set","server_name")}var f=_S("custom_login_title")||(_D("manager")+" - "+_S("hostname"));document.title=Ext.util.Format.htmlEncode(f);if(h&&!c.has_fail){this.doAuth();return}var e=new SYNO.SDS.MessageBoxV5({owner:this.appWin,renderTo:Ext.getBody()});e.getWrapper().alert(_T("error","error_error"),_T("welcome","create_admin_fail"),function(){this.appWin.close()},this)}})},doAuth:function(){this.appWin.isDoingAuth=true;if(!window.location.origin){window.location.origin=window.location.protocol+"//"+window.location.hostname+(window.location.port?":"+window.location.port:"")}var b=this.getNewAdminInfo();var a=new Date().getTime();var c=Ext.apply(document.createElement("iframe"),{className:"x-hidden",src:window.location.origin+"/webapi/auth.cgi?"+Ext.urlEncode({api:"SYNO.API.Auth",method:"login",account:b.username,passwd:b.password,session:"id",version:2,format:"sid"})});if(Ext.isIE6||Ext.isIE7||Ext.isIE8){c.onreadystatechange=function(){if(this.readyState!=="complete"&&this.readyState!=="loaded"){return}window.location.href="/?dc="+a}}else{c.onload=function(){window.location.href="/?dc="+a}}document.body.appendChild(c)},waitForShrCreation:function(){this.shrTask=this.addWebAPITask({webapi:{api:"SYNO.Storage.CGI.Storage",method:"load_info",version:1},immediate:true,interval:3000,scope:this,callback:function(g,f,e,b){if(!g||!Ext.isArray(f.volumes)||f.volumes.length===0){this.shrTask.stop();this.onGotoNextPage();return}var d=["crashed","deleting"];var a=f.volumes[0];if(a.status==="creating"){var c=String.format("{0}%",(a.progress.percent<0)?0:Math.round(a.progress.percent));this.getProgressBox().updateProgress(a.progress.percent/100,c,_T("welcome","welcome_creating_shr"));return}if(d.indexOf(a.status)===-1){this.appWin.curVol={path:a.vol_path}}this.shrTask.stop();this.onGotoNextPage()}});this.shrTask.start()},getNewAdminInfo:Ext.emptyFn});Ext.define("SYNO.SDS.App.WelcomeApp.RegisterFormPanel",{extend:"SYNO.SDS.Utils.FormPanel",constructor:function(a){var b=Ext.apply({cls:"welcome-form welcome-register-form",border:false,autoFlexcroll:false,labelWidth:300,height:250,useGradient:false,items:this.initLayout(),encryption:["password","myds_password"],listeners:{afterlayout:{fn:function(){if("yes"!=_D("dockerdsm")){this.addTip(this.servNameField.getEl(),String.format(_T("welcome","welcome_server_name_tip"),_D("upnpmodelname")))}this.addTip(this.accountField.getEl(),String.format(_T("welcome","welcome_account_info_tip"),_D("upnpmodelname")))},single:true,scope:this}}},a);this.setAliasAgain=false;this.callParent([b])},initLayout:function(){this.pswID=Ext.id();this.cfmPswID=Ext.id();this.servNameField=new SYNO.ux.TextField({name:"myds_server_name",fieldLabel:_T("welcome","welcome_admin_server_name"),labelSeparator:"",maxLength:15,allowBlank:false,width:300,vtype:"netbiosName",hidden:("yes"===_D("dockerdsm")),disabled:("yes"===_D("dockerdsm")),scope:this});this.accountField=new SYNO.ux.TextField({name:"myds_account",fieldLabel:_T("welcome","welcome_admin_account_id"),labelSeparator:"",maxLength:64,allowBlank:false,blankText:_T("user","error_noname"),vtype:"username",width:300,scope:this});this.passStrField=new SYNO.ux.DisplayField({fieldLabel:_T("welcome","passwd_strength"),labelSeparator:"",htmlEncode:false,value:'<div class="strength-block password-strength-weak"></div><div class="strength-block"></div><div class="strength-block"></div><div class="strength-text password-strength-weak">'+_T("welcome","passwd_weak")+"</div>"});this.passField=new SYNO.SDS.App.WelcomeApp.RegisterFormPanel.PasswordField({id:this.pswID,fieldLabel:_T("user","user_passwd"),labelSeparator:"",name:"myds_password",inputType:"password",maxLength:127,allowBlank:true,width:300,accountField:this.accountField,validationEvent:"keyup",strengthField:this.passStrField,owner:this,scope:this});this.confirmPassField=new SYNO.ux.TextField({id:this.cfmPswID,fieldLabel:_T("user","user_repswd"),labelSeparator:"",textType:"password",maxLength:127,allowBlank:true,width:300,initialPin:this.pswID,invalidText:_T("error","error_repswd"),validator:function(c){if(this.initialPin){var b=Ext.getCmp(this.initialPin).getValue();return(c==b)}return true},scope:this});var a=[this.servNameField,this.accountField,this.passField,this.confirmPassField,this.passStrField];return a},fieldsValid:function(){var b=this.servNameField.isValid();var a=this.accountField.isValid();var d=this.passField.isValid();var c=this.confirmPassField.isValid();return(b&&a&&d&&c)},addTip:function(d,a){var c=document.createElement("div");c.className="information-tip-icon";c.setAttribute("ext:qtip",a);var b=Ext.getCmp(d.id);Ext.getDom(b.label).appendChild(c)}});Ext.define("SYNO.SDS.App.WelcomeApp.RegisterFormPanel.PasswordField",{extend:"SYNO.ux.TextField",exPwdStrength:0,pwdStrengthText:[_T("welcome","passwd_weak"),_T("welcome","passwd_medium"),_T("welcome","passwd_strong")],pwdStrengthCls:["password-strength-weak","password-strength-medium","password-strength-strong"],hinStr:_T("welcome","passwd_hint_rule")+" ",constructor:function(a){this.callParent([this.fillConfig(a)])},fillConfig:function(a){var b={validator:this.onCheckValidate};Ext.apply(b,a);return b},onCheckValidate:function(b){var a=this.getPasswordRuleError(b);this.sendCheckStrengthAPI(b);return(a.length===0)?true:a.join(", ")},getPasswordRuleError:function(h){var c,d=/[a-z]/,j=/[A-Z]/,g=/[0-9]/,b=/[~`!@#$%^&*()\-_+={[}]|\\:;"'<,>\.\? ]/,f,a=[],k=this.ownerCt.ownerCt.rules,e=this.accountField.getValue().toLowerCase();for(c in k){if(k[c]===true){f=false;switch(c){case"exclude_username":f=(e.length===0||h.toLowerCase().indexOf(e)<0);break;case"included_numeric_char":f=g.test(h);break;case"included_special_char":f=b.test(h);break;case"min_length_enable":f=(h.length>=k.min_length);break;case"mixed_case":f=(d.test(h)&&j.test(h));break;default:break}if(!f){a.push((c==="min_length_enable")?_T("passwd",c)+" "+k.min_length:_T("passwd",c))}}}return a},normalizeStregth:function(a){return Math.floor(a/2)+1},onPasswordStregthGet:function(g,e,d){if(g){var f=this.normalizeStregth(e.score),b=this.strengthField.el.query(".strength-block"),c=this.strengthField.el.child(".strength-text");if(this.exPwdStrength!==f){for(var a=0;a<3;a++){b[a].removeClassName(this.pwdStrengthCls[this.exPwdStrength-1]);if(a<=(f-1)){b[a].addClassName(this.pwdStrengthCls[f-1])}}c.removeClass(this.pwdStrengthCls[this.exPwdStrength-1]);c.addClass(this.pwdStrengthCls[f-1]);c.update(this.pwdStrengthText[f-1]);this.exPwdStrength=f}}},sendCheckStrengthAPI:function(a){this.sendWebAPI({api:"SYNO.Core.User.PasswordMeter",method:"evaluate",version:1,encryption:["password","required_rules"],params:{password:a,required_rules:this.ownerCt.ownerCt.rules},callback:this.onPasswordStregthGet.bind(this)})}});Ext.define("SYNO.SDS.App.WelcomeApp.InstallPanel",{extend:"Ext.Container",installAppsTitle:[_T("welcome","welcome_package_moments"),_T("backup","app_name"),_T("welcome","welcome_package_video"),_T("welcome","welcome_package_drive"),_T("welcome","welcome_package_mediaserver"),_T("welcome","welcome_package_download"),_T("welcome","welcome_package_audio")],installAppsName:["SynologyMoments","HyperBackup","VideoStation","SynologyDrive","MediaServer","DownloadStation","AudioStation"],cols:2,title:_T("welcome","welcome_install_title"),desc:_T("welcome","welcome_install_desc"),canSkip:true,boxWrapCls:"",fixHeight:true,constructor:function(a){var b,c;this.idPrefix="welcome-install-";this.appIds=[];for(c=0;c<this.installAppsName.length;c++){this.appIds.push(this.idPrefix+this.installAppsName[c].replace(/\s/,""))}b=this.initLayout(a);this.callParent([b])},createAppBoxes:function(){var d=[],c,b;var e=this.cols,k=(this.installAppsTitle.length)/e;for(c=0;c<k;c++){var a=[],f=c+1;var h={xtype:"container",layout:"hbox",cls:"welcome-install-apps-hbox"+f+" "+this.boxWrapCls,bottom:68,items:[]};for(b=0;b<e;b++){var g=e*c+b;if(g>=this.installAppsTitle.length){break}a.push({xtype:"box",html:String.format('<div id="{0}" class="{1}"><div class="welcome-install-app-icon"></div><p class="welcome-install-apps-title">{2}</p><p id="{3}" class="welcome-install-apps-subtitle"></p></div>',this.appIds[g],String.format("{0}",this.appIds[g]).toLowerCase(),this.installAppsTitle[g],String.format("{0}-subtitle",this.appIds[g].toLowerCase()))})}h.items=a;d.push(h)}return d},initLayout:function(a){var b={header:false,border:false,cls:"welcome-step-ct",items:[{xtype:"box",cls:"welcome-step-title",html:this.title},{xtype:"box",cls:this.fixHeight?"welcome-step-desc fixed-install-height-desc":"welcome-step-desc",html:this.desc}]};b.items=b.items.concat(this.createAppBoxes());b.items=b.items.concat([{xtype:"container",cls:"welcome-paging",items:new SYNO.ux.Button({xtype:"syno_button",btnStyle:"blue",text:_T("common","next"),itemId:"install",cls:"welcome-next-btn",disabled:false,handler:this.onNextBtnClick,scope:this})}]);if(this.canSkip){b.items.push({xtype:"syno_button",cls:"welcome-skip-step-btn",text:_T("welcome","welcome_skip_alias"),handler:this.onSkipClick,scope:this})}Ext.apply(b,a);return b},onNextBtnClick:function(){var b=this.appWin,a=b.getComponent("agreement_package");if(!a){b.insertStepAfter(new SYNO.SDS.App.WelcomeApp.Package.AgreementStep({appWin:b,canSkip:this.canSkip,itemId:"agreement_package"}),this.itemId)}b.gotoNextStep()},onSkipClick:function(){var b=this.appWin,a=b.getComponent("agreement_package");if(a){b.removeSteps(a)}b.gotoNextStep()}});Ext.define("SYNO.SDS.App.WelcomeApp.InstallDvaPkgPanel",{extend:"SYNO.SDS.App.WelcomeApp.InstallPanel",installAppsTitle:[_T("welcome","welcome_package_surveillance")||"Surveillance Station",_T("welcome","welcome_package_nvidia_lib")||"NVIDIA Runtime Library"],installAppsName:["SurveillanceStation","GpuDriverPack"],cols:1,title:_T("welcome","install_dva_title")||"Install Essential Packages",desc:_T("welcome","install_dva_desc")||"Fulfill the complete Deep Video Analytics functionality",canSkip:false,fixHeight:false,boxWrapCls:"dva-wrap",onNextBtnClick:function(){var b=this.appWin,a=b.getComponent("agreement_package");if(!a){b.insertStepAfter(new SYNO.SDS.App.WelcomeApp.Package.AgreementStep({appWin:b,itemId:"agreement_package"}),this.itemId)}b.gotoNextStep()}});Ext.define("SYNO.SDS.App.WelcomeApp.QuickConnectDescPanel",{extend:"Ext.Container",constructor:function(a){var b=this.fillConfig(a);this.callParent([b])},fillConfig:function(a){var b={cls:"welcome-quickconnect-desc-panel",items:[{xtype:"box",cls:"welcome-quickconnect-desc-bg"},{xtype:"box",cls:"welcome-quickconnect-desc-panel-title",html:a.title||""},{xtype:"box",cls:"welcome-quickconnect-desc-panel-desc",html:a.desc||""},{xtype:"box",cls:"welcome-quickconnect-desc-panel-img "+(a.imgCls||"")},{xtype:"box",itemId:"tool-wrap",cls:"welcome-quickconnect-desc-panel-tool",html:'<div class="close-tool"></div>',listeners:{afterrender:{fn:this.onToolRender,scope:this}}}],listeners:{afterrender:{fn:function(){Ext.getBody().on("keydown",this.onKeyDown,this);this.mon(this.appWin.el,"click",this.onAppWinClick,this)},scope:this,buffer:100},beforedestroy:{fn:function(){Ext.getBody().un("keydown",this.onKeyDown,this)},scope:this}}};Ext.apply(b,a);return b},onKeyDown:function(a,b){if(a.keyCode===27){this.destroy()}},onAppWinClick:function(a){if(a.within(this.el)){return}this.destroy()},onToolRender:function(){var b=this.getComponent("tool-wrap"),a=b.el.child(".close-tool");a.on("click",this.destroy,this)}});Ext.define("SYNO.SDS.App.WelcomeApp.QuickConnectLinkStep",{extend:"Ext.Container",constructor:function(a){var b=this.fillConfig(a);this.callParent([b])},fillConfig:function(a){this.nextBtn=new SYNO.ux.Button({xtype:"syno_button",btnStyle:"blue",text:_T("common","next"),itemId:"next",cls:"welcome-next-btn",disabled:false,scope:this,handler:function(){this.appWin.gotoNextStep()}});this.bookmarkWrapID=Ext.id();var b={cls:"welcome-step-ct",items:[{xtype:"box",cls:"welcome-step-title",html:_T("welcome","welcome_quickcnt_service_title")},{xtype:"box",cls:"welcome-step-desc",html:String.format(_T("welcome","welcome_quickcnt_service_desc"),"Synology "+_D("upnpmodelname"))},{xtype:"container",cls:"welcome-quickconnect-link-container",tpl:['<div class="welcome-service-step-img-left">','<div class="welcome-service-step-img-top-tag">','<div class="welcome-service-step-img-top-tab-icon"></div>','<p class="welcome-service-step-img-top-text">{addr_desc}</p>',"</div>",'<div class="welcome-service-step-textbox">','<p class="welcome-service-step-textbox-text allowDefCtxMenu selectabletext">{url_text}</p>',"</div>","</div>",'<div class="welcome-service-step-img-right"></div>','<div class="welcome-dragurl-container">','<a href="{url_text}" class="welcomedragable-url" target="_blank">','<p style="visibility: hidden; position: absolute;"> {hostname} </p>','<div class="welcome-drag-bookmark-foreground"> </div>',"</a>","</div>",'<div class="welcome-service-drag-btn-wrap">','<div class="welcome-service-drag-btn"> {drag_text}</div>','<div class="welcome-service-drag-btn-left-arrow">','<div class="welcome-service-drag-btn-arrow-transform"></div>',"</div>","<div>"],data:{addr_desc:_T("welcome","welcome_nas_address"),drag_text:_T("welcome","welcome_drag_to_desktop"),url_text:a.quickconnect_url,hostname:Ext.isEmpty(_S("hostname"),true)?"Synology DiskStation":_S("hostname")},listeners:{afterlayout:function(){var f=this.el,d=f.child(".welcome-service-step-img-right"),h=f.child(".welcome-service-step-img-left"),e=f.child(".welcomedragable-url"),c=f.child(".welcome-service-drag-btn-left-arrow"),g=f.child(".welcome-service-drag-btn");d.anchorTo(h,"l-r");c.anchorTo(e,"l-r",[8,0]);g.anchorTo(c,"l-r")}}},{xtype:"container",cls:"welcome-paging",items:this.nextBtn}]};return Ext.apply(b,a)}});Ext.define("SYNO.SDS.App.WelcomeApp.RegisterQuickConnectStep",{extend:"Ext.Container",myDSInfoUrl:"https://myds.synology.com/",infoLoaded:false,regionListSucc:false,constructor:function(a){var b=this.fillConfig(a);this.callParent([b])},fillConfig:function(a){var c=this;c.registerForm=new SYNO.SDS.App.WelcomeApp.RegisteQuickConnectForm({owner:this,type:(a&&a.type)?a.type:null});c.skipBox=new SYNO.ux.Button({cls:"welcome-skip-step-btn",text:_T("welcome","welcome_skip_alias"),handler:function(){var d=new SYNO.SDS.MessageBoxV5({owner:c.appWin,renderTo:Ext.getBody()});d.getWrapper().confirm(_T("error","error_error"),_T("welcome","skip_warning"),function(e){if(e==="yes"){var f=this.appWin.getComponent("agreement_synoaccount");if(f){this.appWin.removeSteps(f)}this.appWin.gotoNextStep()}},c)}});this.nextBtn=new SYNO.ux.Button({xtype:"syno_button",btnStyle:"blue",text:_T("common","next"),itemId:"next",cls:"welcome-next-btn",disabled:false,scope:this,handler:function(){if(this.registerForm.fieldsValid()===false){return}this.onGotoNextPage()}});var b={header:false,border:false,cls:"welcome-step-ct",height:800,items:[{xtype:"box",cls:"welcome-step-title",html:_T("welcome","welcome_setup_quickcnt_title")},{xtype:"box",cls:"welcome-step-desc",html:String.format(_T("welcome","welcome_setup_quickcnt_desc"),"Synology "+_D("upnpmodelname"))+String.format('<span class="information-tip-icon" ext:qtip="{0}"></span>',_T("welcome","know_more")),listeners:{afterrender:function(d){this.mon(d.el.child("span"),"click",function(){this.hideItems();var e=new SYNO.SDS.App.WelcomeApp.QuickConnectDescPanel({title:_T("welcome","welcome_quickcnt"),desc:_T("welcome","welcome_quickcnt_desc"),imgCls:"quick-connect",renderTo:this.el.id,appWin:this.appWin});e.show();this.mon(e,"destroy",this.showItems,this)}.bind(this))}.bind(this)}},this.registerForm,{xtype:"container",cls:"welcome-paging",items:this.nextBtn},this.skipBox],listeners:{beforeshow:this.loadMyDSInfo,scope:this}};Ext.apply(b,a);return b},hideItems:function(){this.items.each(function(a){a.hide()})},showItems:function(){this.items.each(function(a){a.show()})},loadMyDSInfo:function(){var a=this.appWin;if(this.infoLoaded===true){a.clearStatusBusy();return true}a.setStatusBusy.defer(10,a);Promise.all([this.loadQuickConnectInfo(),this.loadRegionList()]).then(function(){this.infoLoaded=true;this.show()}.bind(this))["catch"](function(){a.clearStatusBusy();a.gotoNextStep()});return false},alertLoadRegionListFailed:function(b){var a=new SYNO.SDS.MessageBoxV5({owner:this.orgWindow,renderTo:Ext.getBody()});a.getWrapper().alert(_T("error","error_error"),_T("welcome","load_region_list_failed"),function(c){b()},this)},loadRegionList:function(){return new Promise(function(b,a){var d=Ext.Ajax.request({method:"GET",url:_S("myds_region_api_base_url")+"config.json?keys[]=countries",success:this.onLoadRegionListSucc.bind(this,b),failure:function(){clearTimeout(c);this.alertLoadRegionListFailed(a)}.bind(this)}),c=setTimeout(function(){if(!this.regionListSucc){Ext.Ajax.abort(d);this.alertLoadRegionListFailed(a)}}.bind(this),30*1000)}.bind(this))},onLoadRegionListSucc:function(b,c,a){this.regionListSucc=true;this.registerForm.loadRegionInfo(Ext.decode(c.responseText));b()},loadQuickConnectInfo:function(){return new Promise(function(b,a){this.sendWebAPI({compound:{stopwhenerror:true,params:[{api:"SYNO.Core.QuickConnect",method:"get",version:2},{api:"SYNO.Core.MyDSCenter",method:"query",version:2}]},callback:this.onLoadMyDSInfo.bind(this,b,a),scope:this})}.bind(this))},onLoadMyDSInfo:function(l,n,k,f,e,b){var d=this.registerForm;if(k&&f.has_fail!==true){var m=f.result[0].data,c=f.result[1].data,i=m.enabled,h=c.is_logged_in,a=(h===true)?c.account:"",j=(i===true)?m.server_alias:"";d.updateFormValue({myds_account:a,server_alias:j});if(h&&i){n();return}if(h){d.adjustForLoginAccount()}else{for(var g in _S("found_myds_account")){if(_S("found_myds_account").hasOwnProperty(g)){d.updateFormValue({myds_account:g});d.showUseExistMyDSFields();break}}}d.getForm().clearInvalid()}l()},onGotoNextPage:function(){var d=this,g=d.appWin,f=d.registerForm,c=f.getForm().getValues().register==="register",e=f.getWebAPIParams(),b=SYNO.SDS.App.WelcomeApp.SynoAccount.Utils,a=g.getComponent("agreement_synoaccount");b.setAPIParams(e);if(c){if(!a){g.insertStepAfter(a=new SYNO.SDS.App.WelcomeApp.SynoAccount.AgreementStep({appWin:g,itemId:"agreement_synoaccount",sendRegisterRequest:function(){g.setStatusBusy();d.sendWebAPI(e)}}),d.itemId)}if(!a.isAgreed()){g.gotoNextStep();return}}if(a){g.removeSteps(a)}d.nextBtn.disable();b.sendRequest()}});Ext.define("SYNO.SDS.App.WelcomeApp.RegisteQuickConnectForm",{extend:"SYNO.ux.FormPanel",constructor:function(a){var b=Ext.apply({cls:"welcome-form quickconnect-form",border:false,autoFlexcroll:false,labelWidth:300,height:280,useGradient:false,labelSeparator:"",hasExistAlias:false,items:this.initLayout(a)},a);this.setAliasAgain=false;this.callParent([b])},showCreateMyDSFields:function(){this.hideFields();Ext.defer(function(){this.forgetPW_field.hide();this.use_exist_radio.hide();this.showRegisterFields();this.fake_exist_radio.show()},300,this)},showUseExistMyDSFields:function(){this.hideFields();Ext.defer(function(){this.fake_exist_radio.hide();this.use_exist_radio.show();this.forgetPW_field.show();this.use_exist_radio.setValue(true);this.showUseExistAccFields()},300,this)},adjustForLoginAccount:function(){this.type="is_login_ok";this.hideFields(true);this.register_radio.hide();this.use_exist_radio.hide();this.forgetPW_field.hide();this.fake_exist_radio.hide();this.loginAccount_field.setValue(this.email_field.getValue());this.loginAccount_field.show();this.quickCon_field.show()},loadRegionInfo:function(d){var a=d.countries.map(function(e){return[e,e]}),b=d["default"].country,c=this.region_field;c.store.loadData(a);c.setValue(b)},initLayout:function(a){var c=a&&a.type==="is_login_ok";this.pswID=Ext.id();this.cfmPswID=Ext.id();this.register_radio=new SYNO.ux.Radio({cls:"welcome-register-radio",name:"register",htmlEncode:false,boxLabel:_T("welcome","welcome_register_account"),inputValue:"register",checked:true,hidden:c,handler:function(){if(this.register_radio.checked===true){this.showCreateMyDSFields()}},listeners:{afterrender:function(d){this.mon(d.boxlabelEl.child("span"),"click",function(f,h,g){this.owner.hideItems();var e=new SYNO.SDS.App.WelcomeApp.QuickConnectDescPanel({title:_T("welcome","welcome_myds"),desc:_T("welcome","welcome_myds_desc"),imgCls:"myds-center",renderTo:this.container.id,appWin:this.owner.appWin});e.show();this.owner.mon(e,"destroy",this.owner.showItems,this.owner)},this)}.bind(this)},scope:this});this.use_exist_radio=new SYNO.ux.Radio({cls:"welcome-register-radio",name:"register",boxLabel:_T("welcome","welcome_use_exist_account"),inputValue:"exist",hidden:true,scope:this});this.fake_exist_radio=new SYNO.ux.Radio({cls:"welcome-register-radio",name:"register",boxLabel:_T("welcome","welcome_use_exist_account"),inputValue:"exist",hidden:c,ctCls:"welcome-top-padding-field",handler:function(){if(this.fake_exist_radio.checked===true){this.showUseExistMyDSFields()}},scope:this});this.email_field=new SYNO.ux.TextField({name:"myds_account",cls:"welcome-register-textfield",fieldLabel:_T("welcome","welcome_email_addr"),minLength:3,maxLength:256,vtype:"email",allowBlank:false,itemCls:"x-form-item item-with-larger-indent",hidden:c,vtypeText:_JSLIBSTR("vtype","bad_email"),width:300,indent:2,scope:this});this.loginAccount_field=new SYNO.ux.DisplayField({fieldLabel:_T("welcome","welcome_email_addr"),value:"",indent:2,hidden:!c,itemCls:"x-form-item item-with-larger-indent",name:"login_account"});this.psw_field=new SYNO.ux.TextField({id:this.pswID,cls:"welcome-register-textfield",fieldLabel:_T("common","password"),name:"myds_password",textType:"password",vtype:"confirmPassword",itemCls:"x-form-item item-with-larger-indent",hidden:c,minLength:8,maxLength:128,allowBlank:false,width:300,indent:2,scope:this});this.cfmPsw_field=new SYNO.ux.TextField({id:this.cfmPswID,cls:"welcome-register-textfield",fieldLabel:_T("user","user_repswd"),textType:"password",hidden:c,confirmFor:"password",allowBlank:false,itemCls:"x-form-item item-with-larger-indent",vtype:"confirmPassword",initialPin:this.pswID,width:300,indent:2,scope:this});this.forgetPW_field=new SYNO.ux.DisplayField({fieldLabel:" ",hidden:true,htmlEncode:false,value:_T("welcome","forget_myds_passwd"),itemCls:"x-form-item item-with-larger-indent"});this.region_field=new SYNO.ux.ComboBox({fieldLabel:_T("welcome","region"),width:300,allowBlank:false,displayField:"display",valueField:"value",indent:2,itemCls:"x-form-item item-with-larger-indent",store:new Ext.data.ArrayStore({autoDestroy:true,idIndex:0,fields:["display","value"]})});this.enews_field=new SYNO.ux.Checkbox({boxLabel:_T("welcome","subscribe_enews"),checked:true,indent:2});this.quickCon_field=new SYNO.ux.TextField({cls:"welcome-register-textfield",name:"server_alias",fieldLabel:_T("welcome","welcome_quickcnt_id"),width:300,indent:2,itemCls:"x-form-item item-with-larger-indent",allowBlank:false,maxLength:63,regex:/^[a-zA-Z][a-zA-Z\-0-9]*$/,regexText:_JSLIBSTR("vtype","bad_relay_alias_name"),scope:this});Ext.apply(Ext.form.VTypes,{confirmPassword:function(f,e){if(e.initialPin){var d=Ext.getCmp(e.initialPin).getValue();return(f==d)}return true},confirmPasswordText:_T("error","error_repswd")});var b=[this.register_radio,this.use_exist_radio,this.email_field,this.loginAccount_field,this.psw_field,this.cfmPsw_field,this.forgetPW_field,this.region_field,this.enews_field,this.quickCon_field,this.fake_exist_radio];return b},getWebAPIParams:function(d){var a={encryption:["password","myds_password"],compound:{stopwhenerror:true}},b=[],c=this.getForm().getValues().register;if(this.type==="is_login_ok"){}else{if(c=="register"){b.push(this.createRegisterApi());b.push(this.createLoginApi())}else{if(c=="exist"){b.push(this.createLoginApi())}}}b.push(this.createSetServerAliasApi());b.push(this.createEnableQuickConnectApi());b.push(this.createGetQuickConnectApi());Ext.apply(a.compound,{params:b});return a},fieldsValid:function(){var c=this.email_field.isValid();var b=this.psw_field.isValid();var a=this.quickCon_field.isValid();var e=this.getForm().getValues().register;if(this.type==="is_login_ok"){return a}else{if(e=="register"){var d=this.cfmPsw_field.isValid();return(c&&b&&a&&d)}else{if(e=="exist"){return(c&&a)}else{return true}}}},createLoginApi:function(){var b={account:this.email_field.getValue(),password:this.psw_field.getValue()},a=this.createApi("SYNO.Core.MyDSCenter","login",2,b);return a},createRegisterApi:function(){var b=_S("hostname");if(!b){b="Synology User"}var a=this.enews_field.getValue(),d={account:this.email_field.getValue(),password:this.psw_field.getValue(),fullname:b,country:this.region_field.getValue(),enews:a,critical_release:a,enews_local_promotion:a};var c=this.createApi("SYNO.Core.MyDSCenter","register",2,d);return c},createSetServerAliasApi:function(a){var c={myds_account:this.email_field.getValue(),server_alias:this.quickCon_field.getValue(),enabled:true,force:this.setAliasAgain};var b=this.createApi("SYNO.Core.QuickConnect","set_server_alias",2,c);return b},createEnableQuickConnectApi:function(){var b={enabled:true};var a=this.createApi("SYNO.Core.QuickConnect","set",2,b);return a},createGetQuickConnectApi:function(){return this.createApi("SYNO.Core.QuickConnect","get",2,{})},createApi:function(d,e,a,c){var b={};b.api=d;b.method=e;b.version=a;b.params={};Ext.apply(b.params,c);return b},slideOutCmp:function(a){a.itemCt.slideOut("t",{easing:"easeOut",duration:0.3,useDisplay:true})},slideInCmp:function(a){a.itemCt.slideIn("t",{easing:"easeOut",duration:0.3,useDisplay:true})},showRegisterFields:function(){this.slideInCmp(this.email_field);this.slideInCmp(this.psw_field);this.slideInCmp(this.cfmPsw_field);this.slideInCmp(this.enews_field);this.slideInCmp(this.region_field);this.slideInCmp(this.quickCon_field);this.psw_field.minLength=8;this.psw_field.validate()},showUseExistAccFields:function(){this.slideInCmp(this.email_field);this.slideInCmp(this.psw_field);this.slideInCmp(this.quickCon_field);this.slideInCmp(this.forgetPW_field);this.psw_field.minLength=6;this.psw_field.validate()},hideFields:function(a){if(a){this.email_field.hide();this.psw_field.hide();this.cfmPsw_field.hide();this.quickCon_field.hide();this.enews_field.hide();this.region_field.hide();return}this.slideOutCmp(this.email_field);this.slideOutCmp(this.psw_field);this.slideOutCmp(this.cfmPsw_field);this.slideOutCmp(this.quickCon_field);this.slideOutCmp(this.region_field);this.slideOutCmp(this.enews_field);this.slideOutCmp(this.forgetPW_field)},updateFormValue:function(a){if(!Ext.isEmpty(a)){this.getForm().setValues(a)}}});Ext.define("SYNO.SDS.App.WelcomeApp.XA.NetworkStep",{extend:"Ext.Container",constructor:function(a){var b={header:false,border:false,height:800,cls:"welcome-step-ct",items:[{xtype:"box",cls:"welcome-step-title",html:_T("welcome","network_setup_title")},{xtype:"box",cls:"welcome-step-desc",html:_T("welcome","network_setup_desc")+String.format('<span class="information-tip-icon" style="cursor: default;" ext:qtip="{0}"></span>',_T("welcome","network_setup_desc_tip"))},this.createFormPanel(),{xtype:"container",cls:"welcome-paging",itemId:"footer",items:{xtype:"syno_button",btnStyle:"blue",text:_T("common","next"),itemId:"next",cls:"welcome-next-btn",scope:this,handler:this.checkGoNext}},{xtype:"syno_button",cls:"welcome-skip-step-btn",text:_T("welcome","welcome_skip_alias"),handler:function(){var c=new SYNO.SDS.MessageBoxV5({owner:this.findAppWindow(),renderTo:Ext.getBody()});c.getWrapper().confirm(_T("error","error_error"),_T("welcome","network_setup_skip_msg"),function(d){if(d==="yes"){this.skip=true;this.appWin.gotoNextStep()}},this)}.bind(this)}]};this.getEthernetList();this.callParent([Ext.apply(b,a)]);this.mon(this,"activate",this.onStepActivate.bind(this))},createFormPanel:function(){return{xtype:"syno_formpanel",itemId:"network-form",cls:"welcome-form welcome-register-form",border:false,autoFlexcroll:false,labelWidth:300,height:250,useGradient:false,items:[{xtype:"syno_textfield",fieldLabel:_T("tcpip","tcpip_ipaddr"),name:"ip",allowBlank:false,maxlength:15,vtype:"v4ip",width:300,validator:function(e){var c=e.split(".");var b=this.ownerCt.getForm().findField("mask");var f=b.getValue().split(".");if(c.length!==4||f.length!==4||0!==b.getActiveError().length){return true}var g=parseInt(c[0],10)<<24|parseInt(c[1],10)<<16|parseInt(c[2],10)<<8|parseInt(c[3],10);var a=parseInt(f[0],10)<<24|parseInt(f[1],10)<<16|parseInt(f[2],10)<<8|parseInt(f[3],10);var d=g|~a;if(g==d){return _T("network","error_bad_broadcast_ip")}return true}},{xtype:"syno_textfield",fieldLabel:_T("tcpip","tcpip_mask"),name:"mask",allowBlank:false,maxlength:15,vtype:"netmask",width:300,listeners:{valid:function(a){this.getComponent("network-form").getForm().findField("ip").validate()},scope:this}},{xtype:"syno_textfield",fieldLabel:_T("network","route_gateway"),name:"gateway",allowBlank:true,vtype:"v4ip",width:300,maxlength:15,validator:function(b){var c=this.getComponent("network-form").getForm();var d=c.findField("ip").getValue();var a=c.findField("mask").getValue();if(""!==b&&""!==d&&""!==a&&!SYNO.SDS.Utils.Network.GatewayMatchIP(b,d,a)){return _T("common","error_notmatch")}return true}.bind(this)},{xtype:"syno_textfield",fieldLabel:_T("network","route_dns"),name:"dns",allowBlank:true,maxlength:15,vtype:"v4ip",width:300}]}},setLoading:function(b){var a=this.findAppWindow();this.loading=b;if(a&&a.layout.activeItem===this){a[b?"setStatusBusy":"clearStatusBusy"]()}},onStepActivate:function(){var a=this.findAppWindow();if(this.skip===true){a.gotoNextStep();return}if(this.loading){this.findAppWindow().setStatusBusy()}},createSetAPI:function(){if(this.skip){return null}var a=Ext.copyTo({},this.currentInterface,["ifname","enable_ha_ip","is_default_gateway","mtu","enable_vlan"]);a=Ext.apply(a,this.getComponent("network-form").getForm().getValues());a.use_dhcp=false;return{api:"SYNO.Core.Network.Ethernet",method:"set",version:1,params:{configs:[a]}}},getEthernetList:function(){this.setLoading(true);SYNO.API.Request({api:"SYNO.Core.Network.Ethernet",method:"list",version:2,callback:this.onEthernetListGet.bind(this)})},setStepSkipped:function(){var a=this.findAppWindow();this.skip=true;if(a.layout.activeItem===this){a.gotoNextStep();return}},onEthernetListGet:function(a,c){this.setLoading(false);if(!a){this.setStepSkipped();return}var b;Ext.each(c,function(d){if(d.status==="connected"&&d.ip===window.location.hostname){b=d.ifname;return false}});if(!b){this.setStepSkipped();return}this.getEthernet(b)},getEthernet:function(a){this.setLoading(true);SYNO.API.Request({api:"SYNO.Core.Network.Ethernet",version:1,method:"get",params:{ifname:a},callback:this.onEthernetGet.bind(this)})},onEthernetGet:function(a,c){this.setLoading(false);if(!a){this.setStepSkipped();return}var b=this.getComponent("network-form").getForm();delete c.ip;b.setValues(c);b.findField("ip").clearInvalid();this.currentInterface=c},onCheckIP:function(a,d){this.findAppWindow().clearStatusBusy();if(a){this.findAppWindow().gotoNextStep();return}var b=new SYNO.SDS.MessageBoxV5({owner:this.findAppWindow(),renderTo:Ext.getBody()}),c;if(d&&d.code){c=SYNO.API.getErrorString(d)}c=c||_T("common","error_system");b.getWrapper().alert(_T("error","error_error"),c)},checkGoNext:function(){var a=this.getComponent("network-form").getForm();if(!a.isValid()){return}this.findAppWindow().setStatusBusy();SYNO.API.Request({api:"SYNO.Core.Network.Ethernet",method:"DAD",version:1,params:{ifname:this.currentInterface.ifname,ip:a.getValues().ip},callback:this.onCheckIP.bind(this)})}});Ext.namespace("SYNO.SDS.App.WelcomeApp");Ext.define("SYNO.SDS.App.WelcomeApp.Utils",{singleton:true,isDVA:function(){return _D("unique")==="synology_denverton_dva3219"}});Ext.define("SYNO.SDS.App.WelcomeApp.Instance",{extend:"SYNO.SDS.AppInstance",appWindowName:"SYNO.SDS.App.WelcomeApp.Main",fullsize:true,isAccountShow:function(){return SYNO.SDS.Session.admin_configured===false},isWelcomeHidden:function(){if(this.welcome_hide===undefined){this.welcome_hide=_S("welcome_hide")||(_S("demo_mode")===true)}return this.welcome_hide},isInstallPageNeeded:function(){if(this.install_page_needed===undefined){this.install_page_needed=!this.isWelcomeHidden()&&_S("is_admin")&&(SYNO.SDS.Session.vol_path&&((_D("support_tutorial")==="yes"&&!SYNO.SDS.isNVR)||SYNO.SDS.App.WelcomeApp.Utils.isDVA()))}return this.install_page_needed},shouldLaunch:function(){var b=this.isAccountShow();var a=this.isWelcomeHidden();var c=this.isInstallPageNeeded();return b||!a||c},onDestroy:function(){SYNO.SDS.App.WelcomeApp.Instance.superclass.onDestroy.apply(this,arguments)}});Ext.define("SYNO.SDS.App.WelcomeApp.Main",{extend:"SYNO.SDS.AppWindow",dsmStyle:"v5",adminConfigured:true,curVol:null,onEsc:Ext.emptyFn,constructor:function(a){this.stepIdArr=[];this.steps=[];var b=this.fillConfig(a);SYNO.SDS.App.WelcomeApp.Main.superclass.constructor.call(this,b);this.center()},getStepIdx:function(a){return this.stepIdArr.indexOf(a)},getStep:function(a){return this.getComponent(a)},insertSingleStep:function(a,b){var c=b.getItemId()||b.getId();this.stepIdArr.splice(a,0,c);this.steps.splice(a,0,b);this.insert(a,b)},addSteps:function(c){var a=(this.getStepIdx("end")!==-1),b=(a)?this.stepIdArr.length-1:this.stepIdArr.length;if(Ext.isArray(c)){c.each(function(d){this.insertSingleStep(b,d);b++},this)}else{if(Ext.isObject(c)){this.insertSingleStep(b,c)}}},insertStepAfter:function(b,c){var d=this.stepIdArr.indexOf(c),a;if(d===-1){return}a=Math.min(d+1,this.stepIdArr.length);this.insertSteps(a,b)},insertStepBefore:function(b,c){var d=this.stepIdArr.indexOf(c),a;if(d===-1){return}a=Math.max(0,d-1);this.insertSteps(a,b)},insertSteps:function(a,b){if(Ext.isArray(b)){b.each(function(c){this.insertSingleStep(a,c);a++},this)}else{if(Ext.isObject(b)){this.insertSingleStep(a,b)}}},removeSteps:function(b){var a=this,c=function(e){var g=e.getItemId()||e.getId(),d=a.stepIdArr.indexOf(g),f=a.getComponent(g);if(d!==-1){a.stepIdArr.splice(d,1);a.steps.splice(d,1)}if(f){a.remove(f,true)}};if(Ext.isArray(b)){b.each(function(d){c(d)})}else{if(Ext.isObject(b)){c(b)}}},canReload:function(){return this.isDoingAuth||_S("admin_configured")},addStepsBeforeRender:function(a){if(Ext.isObject(a)){var b=a.getItemId()||a.getId();this.stepIdArr.push(b);this.steps.push(a)}else{if(Ext.isArray(a)){a.each(function(c){this.addStepsBeforeRender(c)},this)}}},configureSteps:function(a){var b=[],d=a.appInstance.isAccountShow(),c=a.appInstance.isInstallPageNeeded();if(d){this.adminConfigured=_S("admin_configured");this.registerPanel=new SYNO.SDS.App.WelcomeApp.RegiterAccountPanel({owner:this,appWin:this,itemId:"register"});b.push(this.registerPanel)}else{if(this.haveToRegisterQuickConnect()){this.registerQCTPanel=new SYNO.SDS.App.WelcomeApp.RegisterQuickConnectStep({appWin:this,owner:this,itemId:"register-quickconnect"});b.push(this.registerQCTPanel)}if(c&&Ext.isDefined(_S("vol_path"))){this.curVol={path:_S("vol_path")};if(this.haveToInstallPkg()){this.installPanel=new SYNO.SDS.App.WelcomeApp.InstallPanel({owner:this,appWin:this,itemId:"install"})}else{if(this.haveToInstallDvaPkg()){this.installPanel=new SYNO.SDS.App.WelcomeApp.InstallDvaPkgPanel({owner:this,appWin:this,itemId:"install"})}}b.push(this.installPanel)}if(_D("support_xa","no")==="yes"){this.networkPanel=new SYNO.SDS.App.WelcomeApp.XA.NetworkStep({appWin:this,owner:this,itemId:"xa-network"});b.push(this.networkPanel)}this.endPanel=new SYNO.SDS.App.WelcomeApp.EndPanel({owner:this,appWin:this,itemId:"end"});b.push(this.endPanel)}this.addStepsBeforeRender(b)},fillConfig:function(a){this.configureSteps(a);var b={title:_T("welcome","welcome_app_title"),cls:"syno-sds-welcome welcome-default-bg",border:false,toggleMinimizable:false,maximized:true,resizable:false,header:false,showHelp:false,layout:"card",activeItem:this.stepIdArr[0],renderTo:document.body,items:this.steps};Ext.apply(b,a);return b},haveToCheckShr:function(){return(!Ext.isObject(this.curVol)&&_D("support_autocreate_shr")==="yes")},haveToInstallPkg:function(){return(Ext.isObject(this.curVol)&&_D("support_tutorial")==="yes"&&!SYNO.SDS.isNVR&&!SYNO.SDS.App.WelcomeApp.Utils.isDVA())},haveToInstallDvaPkg:function(){return Ext.isObject(this.curVol)&&SYNO.SDS.App.WelcomeApp.Utils.isDVA()},haveToInstallSur:function(){return false},haveToRegisterQuickConnect:function(){var c=SYNO.SDS.isNVR,b=(Ext.isFunction(SYNO.SDS.Utils.isInVirtualDSM))?SYNO.SDS.Utils.isInVirtualDSM():false,a=_D("dockerdsm")==="yes";return !c&&!b&&!a},showHtml:function(a){this.htmlPanel.loadHelp(a)},getCurrentStepIdx:function(){var c=this.getLayout().activeItem,a=c.getItemId()||c.getId(),b=this.getStepIdx(a);return b},getNextStep:function(){if(this.getCurrentStepIdx()<this.stepIdArr.length-1){var a=this.stepIdArr[this.getCurrentStepIdx()+1];return this.getComponent(a)}return null},gotoPreviousStep:function(){var a=this.getCurrentStepIdx();if(0<this.getCurrentStepIdx()){this.setActiveItem(this.stepIdArr[a-1])}},gotoNextStep:function(){var a=this.getCurrentStepIdx();if(a<this.stepIdArr.length-1){this.setActiveItem(this.stepIdArr[a+1])}else{this.close()}},addSurveillacneIcon:function(){var a=SYNO.SDS.Desktop.iconItems,c="SYNO.SDS.SurveillanceStation",b,d=false;if(a){for(b=0;b<a.length&&d!==true;b++){if(a[b].className===c){d=true}}}if(!d){if(SYNO.SDS.AppUtil.isApp(c)&&SYNO.SDS.StatusNotifier.isAppEnabled(c)){SYNO.SDS.Desktop.addLaunchItem({className:c},-1);this.canClose=true;if(this.needClose===true){this.close()}return}this.mon(SYNO.SDS.StatusNotifier,"jsconfigLoaded",this.addSurveillacneIcon,this);this.canClose=false}},setActiveItem:function(a){this.getLayout().setActiveItem(a)},onOpen:function(){SYNO.SDS.App.WelcomeApp.Main.superclass.onOpen.apply(this,arguments)},checkClosable:function(){if(this.canClose===false){this.needClose=true;return false}return true},onClose:function(){this.sendNotify();this.callParent(arguments)},sendNotify:function(){if(this.installSurFailed===true){SYNO.API.Request({api:"SYNO.Core.QuickStart.Install",method:"notify_sur_failed",version:1,callback:Ext.emptyFn})}}});