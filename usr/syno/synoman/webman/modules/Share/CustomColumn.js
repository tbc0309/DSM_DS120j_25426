/* Copyright (c) 2020 Synology Inc. All rights reserved. */

Ext.define("SYNO.SDS.Share.CustomColumn",{extend:"SYNO.ux.EnableColumn",constructor:function(b){var a=Ext.apply({header:_T("share","share_permission_acl"),shareRecord:undefined,ownerGrid:undefined,userId:undefined,applyCallback:undefined,applyTarget:this,width:120,align:"center",disableSelectAll:true,renderer:function(g,d,c){var f=(this.shareRecord)?this.shareRecord.data:c.data;var e=false;if(Ext.isFunction(this.ownerGrid.isAdminGroupMember)){e=this.ownerGrid.isAdminGroupMember()}else{if(Ext.isDefined(this.ownerGrid.owner.isAdminGroup)){e=this.ownerGrid.owner.isAdminGroup}else{e=c.get("is_admin")}}if(!SYNO.SDS.ControlPanel.Share.isCustomizable(f)||e){g="disabled"}return SYNO.SDS.Share.renderCheckBox.call(this,g,d,c)}},b);this.callParent([a])},onCellClick:function(c,d,a){if(this.isLockCustomSetting){this.ownerGrid.owner.getMsgBox().alert(this.title,_T("user","lock_setting"));return}var b=false;if(Ext.isFunction(c.isAdminGroupMember)){b=c.isAdminGroupMember()}else{if(Ext.isDefined(c.owner.isAdminGroup)){b=c.owner.isAdminGroup}else{b=c.getSelectionModel().getSelected().get("is_admin")}}if(b){return}if(!Ext.isFunction(this.ownerGrid.isChanged)||!Ext.isFunction(this.ownerGrid.getWebAPI)||!Ext.isFunction(this.ownerGrid.getShareInfoForS2S)){console.log('One of "isChanged" and "getWebAPI" and "getShareInfoForS2S" is missing!')}if(!Ext.isFunction(this.ownerGrid.isChanged)||!Ext.isFunction(this.ownerGrid.getWebAPI)||!this.ownerGrid.isChanged()){this.initEditorDialog(c,d);return}this.ownerGrid.owner.getMsgBox().confirm(this.ownerGrid.title,_T("share","share_save_chg_before_reload"),function(e){if(e!=="yes"){return}var f=this.ownerGrid.getWebAPI();if(f.length===0){console.log("Permission is changed but getWebAPI returns nothing!");this.initEditorDialog(c,d);return}var g=Ext.apply(f[0],{scope:this,callback:function(k,j,i,h){this.owner.clearStatusBusy();if(k){this.ownerGrid.getStore().commitChanges();this.initEditorDialog(c,d)}else{this.owner.getMsgBox().alert(this.ownerGrid.title,SYNO.API.Erros.core[j.code]||_T("common","commfail"))}}});SYNO.SDS.Utils.S2S.confirmIfSyncShareAffected(false,this.ownerGrid.getShareInfoForS2S(),{dialogTitle:this.ownerGrid.title,dialogMsg:_T("s2s","s2s_warn_share_change_priv"),dialogOwner:this.owner,continueHandler:function(){this.owner.setStatusBusy({text:_T("common","saving")});this.owner.sendWebAPI(g)},abortHandler:Ext.EmptyFn,scope:this})},this)},initEditorDialog:function(a,c){var b=(this.shareRecord)?this.shareRecord:a.getSelectionModel().getSelected();if(!Ext.isObject(b)||!b.data||!SYNO.SDS.ControlPanel.Share.isCustomizable(b.data)){return}b=b.data;if(this.userId){this.launchEditorDialog(b);return}this.owner.sendWebAPI({api:"SYNO.Core.User",version:1,method:"get",params:{name:this.owner._S("user")},scope:this,callback:function(g,f,e,d){if(g){this.userId=f.users[0].uid;this.launchEditorDialog(b)}else{this.owner.getMsgBox().alert(_T("tree","leaf_user"),_T("user","failed_load_user"))}}})},launchEditorDialog:function(c){var b=c.vol_path||c.share_path.replace("/"+c.name,"");var a=new SYNO.FileStation.PropertyDialog({title:String.format(_T("share","share_edit_title"),c.name),module:this.module,owner:this.owner,hideAdvPermPanel:true,hideInfoPanel:true,privilegeType:"aclPrivilege",userId:this.userId,openConfig:this.ownerGrid.getOpenConfig(),source:"remote",rec:[new Ext.data.Record({name:c.name,is_aclmode:c.is_aclmode,isshare:true,is_sync_share:c.is_sync_share,isdir:true,vol_path:b,real_path:c.share_path,filename:c.name,file_id:"/"+c.name})]});a.mon(a,"callback",this.onSaveProperty,this,{single:true});a.load()},onSaveProperty:function(d,e,b){function c(h,f){var g=_T("property","error_save_property");if(!h){if(Ext.isDefined(f.code)){g=SYNO.API.getErrorString(f.code)}this.owner.getMsgBox().alert(_T("filetable","filetable_properties"),g);return true}return false}if(c.call(this,e,b)){return}if(Ext.isDefined(b.task_id)){this.owner.setStatusBusy({text:_T("common","saving")});var a=this.owner.pollReg({webapi:{api:"SYNO.Core.ACL",method:"status",version:1,params:{task_id:b.task_id}},interval:3,immediate:true,status_callback:function(h,f,g){if(!h||(h&&f.finished===true)){this.owner.pollUnreg(a);this.owner.clearStatusBusy();if(Ext.isFunction(this.applyCallback)&&Ext.isObject(this.applyTarget)){this.applyCallback.call(this.applyTarget)}c.call(this,h,f)}},scope:this})}}});