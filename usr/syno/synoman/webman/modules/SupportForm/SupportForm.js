/* Copyright (c) 2020 Synology Inc. All rights reserved. */

Ext.ns("SYNO.SDS.SupportForm");SYNO.SDS.SupportForm.Module=Ext.extend(Object,{constructor:function(){},activate:function(){},deactivate:function(){return true},getPanel:function(){return null},getAbsoluteURL:function(a){return String.format("{0}/{1}",this.jsConfig.jsBaseURL,a)},getHelpParam:Ext.emptyFn});Ext.ns("SYNO.SDS.SupportForm");SYNO.SDS.SupportForm.FormModule=Ext.extend(SYNO.SDS.SupportForm.Module,{constructor:function(a){SYNO.SDS.SupportForm.FormModule.superclass.constructor.call(this);this.createPanel(a)},getPanel:function(){return this.panel},createPanel:function(a){var b={cp:a.cp,module:this,border:false,frame:false,autoScroll:false,autoFlexcroll:false,header:false,useDefaultBtn:false,layout:"fit",items:[{xtype:"syno_panel",region:"center",itemId:"form_iframe",padding:"0 0 0 0",id:"form_iframe",name:"form_iframe",hidden:true,autoFlexcroll:false,html:String.format('<iframe id="iframe_form" src="about:blank" frameborder="0" marginheight="0" marginwidth="0" width="100%" height="100%"></iframe>')}]};this.panel=new SYNO.SDS.SupportForm.FormPanel(b)},stopPolling:function(){if(Ext.isDefined(this.pollingId)){this.cp.pollUnreg(this.pollingId);delete this.pollingId}},onPollingDone:function(c,b,a){if(!c){this.stopPolling();return}if(!b.finished){return}this.stopPolling()},startPolling:function(){this.pollingId=this.cp.pollReg({webapi:{api:"SYNO.Core.SupportForm.Log",method:"polling",version:1},interval:20,scope:this,status_callback:this.onPollingDone})},activate:function(){this.panel.init();this.startPolling()},deactivate:function(){this.panel.el.unmask();Ext.getDom("iframe_form").src="about:blank";this.stopPolling()}});SYNO.SDS.SupportForm.FormPanel=Ext.extend(SYNO.SDS.Utils.FormPanel,{constructor:function(a){SYNO.SDS.SupportForm.FormPanel.superclass.constructor.call(this,a)},init:function(){this.cp.setStatusBusy();this.sendWebAPI({api:"SYNO.Core.MyDSCenter",method:"query",version:2,scope:this,callback:function(a,b){this.cp.clearStatusBusy();if(!a){this.cp.getMsgBox().alert(_T("support_center","title"),_T("support_center","error_connect"))}else{if(false===b.is_logged_in){this.showNotLoggedInMask()}else{if(true===b.is_logged_in&&Ext.isDefined(b.account)&&Ext.isDefined(b.account)){this.loadSupportForm(b.account,b.auth_key)}else{this.cp.getMsgBox().alert(_T("support_center","title"),_T("support_center","error_connect"))}}}}})},loadSupportForm:function(b,a){this.cp.setStatusBusy();this.sendWebAPI({api:"SYNO.Core.SupportForm.Form",method:"get",version:1,scope:this,callback:function(c,d){this.cp.clearStatusBusy();if(!c){this.cp.getMsgBox().alert(_T("support_center","title"),_T("support_center","error_connect"))}else{d.user_id=b;d.auth_key=a;this.generateIframe(d)}}})},generateIframe:function(e){this.cp.setStatusBusy();var f=String.format("{0}//{1}/webapi/entry.cgi?api=SYNO.Core.SupportForm.Form&method=upload&version=1",window.location.protocol,window.location.host);var d="";var c="";var a=this.cp.getOpenConfig("extra");if(a){d=a.pkg_id;c=a.pkg_version}if(Ext.getDom("iframe_form").src==="about:blank"){var g=setTimeout((function(){this.el.mask(_T("support_center","error_connect"),"syno-ux-mask-info");this.cp.clearStatusBusy();Ext.getCmp("form_iframe").setVisible(false);Ext.getDom("iframe_form").src="about:blank"}).createDelegate(this),60000);Ext.EventManager.on(Ext.getDom("iframe_form"),"load",function(){if(g){clearTimeout(g);g=null;Ext.getCmp("form_iframe").setVisible(true);this.cp.clearStatusBusy()}else{if(Ext.getDom("iframe_form").src==="about:blank"){Ext.EventManager.removeAll(Ext.getDom("iframe_form"))}else{var h;Ext.EventManager.removeAll(Ext.getDom("iframe_form"));h=this.getFrameResponse();Ext.getCmp("form_iframe").setVisible(false);Ext.getDom("iframe_form").src="about:blank";if(h.success){if(h.data.msg!==""){this.cp.getMsgBox().alert(_T("support_center","title"),h.data.msg)}else{if(h.data.attach){this.cp.getMsgBox().alert(_T("support_center","title"),_T("support_center","send_attach"))}else{this.cp.getMsgBox().alert(_T("support_center","title"),_T("support_center","success_send_form"))}}}else{if(h.error.code==4703){this.cp.getMsgBox().alert(_T("support_center","title"),h.error.errors.result.msg)}else{if(h.error.code==4701){this.cp.getMsgBox().alert(_T("support_center","title"),_T("support_center","error_connect"))}else{this.cp.getMsgBox().alert(_T("support_center","title"),_T("support_center","error_system"))}}}this.init()}}},this);var b={user_id:e.user_id,auth_key:e.auth_key,dsm_user:this._S("user"),sn:e.sn,model:e.model,dsm_version:e.version,pseudo_sn:e.pseudo_sn,pseudo_model:e.pseudo_model,pseudo_dsm_version:e.pseudo_dsm_version,timestamp:e.timestamp,theme:_S("theme_cls"),lang:_S("lang"),supportform_version:2,buildphase:e.buildphase,isdemo:this._S("demo_mode")?true:false,pkg_id:d,pkg_version:c,user_agnet:navigator.userAgent,url:Ext.urlAppend(f)};Ext.getDom("iframe_form").setAttribute("src",String.format(e.server_baseurl+"/iframe/support?{0}{1}",Ext.urlEncode(b),this.getCustomParam(e.custom)))}},getCustomParam:function(b){var a="";Ext.iterate(b,function(c,d){a+="&custom["+c+"]="+d},this);return a},getFrameResponse:function(){var g={};try{var f=Ext.getDom("iframe_form");var c=f.contentWindow.document||f.contentDocument||window.frames.iframe_form.document;var a,d;if(!c||!c.body){throw {message:"Failed to get iframe body"}}if((a=c.body.firstChild)&&/pre/i.test(a.tagName)){d=a.textContent}else{if((a=c.getElementsByTagName("textarea")[0])){d=a.value}else{d=c.body.textContent||c.body.innerText}}g=Ext.decode(d)}catch(b){g={success:false,error:(b.message||b.description).trim()}}return g},showNotLoggedInMask:function(){var a,c,b;a=String.format('<a href="" class="link-font" id="login_btn">{0}</a>',_T("myds","myds_account"));c=String.format(_T("support_center","support_login_first"),a);this.el.mask(c,"syno-ux-mask-info");b=Ext.get("login_btn");if(Ext.isObject(b)){b.on("click",this.onClickLoginBtn,this)}},onLoggedIn:function(b,a){this.loadSupportForm(b,a);this.el.unmask()},onClickLoginBtn:function(a){a.preventDefault();var b=new SYNO.SDS.MyDSCenter.LoginDialog({owner:this.findWindow(),listeners:{scope:this,login_success:this.onLoggedIn}});b.show()}});Ext.ns("SYNO.SDS.SupportForm");SYNO.SDS.SupportForm.RemoteModule=Ext.extend(SYNO.SDS.SupportForm.Module,{constructor:function(a){SYNO.SDS.SupportForm.RemoteModule.superclass.constructor.call(this);this.createPanel(a);this.panel.mon(this.panel,"afterlayout",this.switchLayout,this);this.panel.mon(Ext.getCmp(this.hibernation_debug_id),"check",this.switchLayout,this)},getPanel:function(){return this.panel},onCommit:function(){if(!this.panel.isFormDirty()&&!this.panel.isDebugItemDirty()){this.panel.setStatusError({text:_T("error","nochange_subject"),clear:true});return}this.cp.getEl().mask(_T("common","loading"));var a={enable_support_channel:Ext.getCmp(this.enable_support_channel_id).getValue(),hibernation_debug_en:Ext.getCmp(this.hibernation_debug_id).getValue(),hibernation_debug_level:Ext.getCmp(this.hibernation_debug_level).getValue(),log_level_up:Ext.getCmp(this.log_level_up).getValue(),fan_debug_en:Ext.getCmp(this.fan_debug_id).getValue(),sysstat_dump_en:Ext.getCmp(this.sysstat_dump_id).getValue()};Ext.apply(a,this.panel.getDebugItemParam());this.cp.sendWebAPI({api:"SYNO.Core.SupportForm.Service",method:"set",version:1,params:a,scope:this,callback:function(d,c,b){this.cp.getEl().unmask();if(!d){this.cp.getMsgBox().alert("",_T("error","error_error_system"))}this.panel.loadForm()}})},onReset:function(){this.panel.loadForm()},createPanel:function(a){var b={cp:a.cp,module:this,border:false,frame:false,autoScroll:true,header:false,useDefaultBtn:false,webapi:{api:"SYNO.Core.SupportForm.Service",methods:{get:"get"},version:1},buttons:[{btnStyle:"blue",text:_T("common","commit"),xtype:"syno_button",scope:this,handler:this.onCommit},{btnStyle:"gray",text:_T("common","reset"),xtype:"syno_button",scope:this,handler:this.onReset}],items:[{xtype:"syno_fieldset",title:_T("support_center","fieldset_remote"),itemId:"remote_fieldset",name:"remote_fieldset",id:"remote_fieldset",items:[{xtype:"syno_displayfield",hideLabel:true,value:_T("support_center","remote_desc")},{xtype:"syno_checkbox",boxLabel:_T("support_center","support_channel_chkbox"),itemId:"enable_support_channel",id:this.enable_support_channel_id=Ext.id(),name:"enable_support_channel"},{xtype:"syno_displayfield",fieldLabel:_T("support_center","expired_date"),htmlEncode:false,name:"expiredate",labelWidth:280,indent:1,value:"--"},{xtype:"syno_displayfield",fieldLabel:_T("support_center","sns_identifier_key"),name:"sns_identifier_key",labelWidth:280,selectable:true,indent:1,value:"--"}]},{xtype:"syno_fieldset",title:_T("support_center","support_log_tool_title"),itemId:"log_tools",name:"log_tools",id:"log_tools",items:this.getLogToolSetting()},{xtype:"syno_fieldset",title:_T("support_center","fieldset_log"),itemId:"log_fieldset",name:"log_fieldset",id:"log_fieldset",items:[{xtype:"syno_displayfield",hideLabel:true,value:_T("support_center","log_desc")},{xtype:"syno_button",btnStyle:"default",id:"log_btn",text:_T("support_center","log_generate_btn"),autoWidth:true,scope:this,tooltip:a.cp._S("demo_mode")?_JSLIBSTR("uicommon","error_demo"):"",handler:this.doDownload}]}]};this.panel=new SYNO.SDS.SupportForm.ServicePanel(b)},getLogToolSetting:function(){var a=new Ext.data.SimpleStore({fields:["display","value"],data:[[_T("support_center","support_hibernation_cannot_sleep"),1],[_T("support_center","support_hibernation_awake_frequently"),2]]});return[{xtype:"syno_checkbox",boxLabel:_T("support_center","support_hibernation_debug_mode"),itemId:"hibernation_debug_en",name:"hibernation_debug_en",id:this.hibernation_debug_id=Ext.id(),listeners:{scope:this,check:function(c,b){var d=Ext.getCmp(this.hibernation_debug_level);if(b){d.enable();d.setValue(1)}else{d.disable();d.clearValue()}}}},{xtype:"syno_displayfield",indent:1,value:_T("common","note")+": "+_T("support_center","support_hibernation_note")},{xtype:"syno_combobox",store:a,name:"hibernation_debug_level",fieldLabel:_T("support_center","support_hibernation_problem"),indent:1,displayField:"display",valueField:"value",editable:false,id:this.hibernation_debug_level=Ext.id()},{xtype:"syno_checkbox",boxLabel:_T("support_center","support_log_level_up"),itemId:"log_level_up",name:"log_level_up",id:this.log_level_up=Ext.id()},{xtype:"syno_checkbox",boxLabel:_T("support_center","support_fan_debug_mode"),itemId:"fan_debug_en",name:"fan_debug_en",id:this.fan_debug_id=Ext.id()},{xtype:"syno_checkbox",boxLabel:_T("support_center","support_system_stat_dump"),itemId:"sysstat_dump_en",name:"sysstat_dump_en",id:this.sysstat_dump_id=Ext.id()}]},switchLayout:function(){var a=Ext.getCmp(this.hibernation_debug_id).getValue();this.setCompEnable([Ext.getCmp(this.log_level_up),Ext.getCmp(this.fan_debug_id),Ext.getCmp(this.sysstat_dump_id)],!a);if(a){Ext.getCmp(this.hibernation_debug_level).enable()}else{Ext.getCmp(this.hibernation_debug_level).disable();Ext.getCmp(this.hibernation_debug_level).clearValue()}},setCompEnable:function(a,b){for(var c=0;c<a.length;c++){if(b){a[c].enable()}else{a[c].disable();a[c].setValue(false)}}},activate:function(){this.panel.loadForm()},deactivate:function(){if(this.panel.isFormDirty()||this.panel.isDebugItemDirty()){return false}return true},onDownloadFail:function(){this.wait.hide();this.cp.getMsgBox().alert(_T("download","download_failed"),_T("download","download_msg_action_failed"))},doDownload:function(e,b,c,a){var d=[];d=this.panel.getFilterComponent();if(0===d.size()){this.cp.getMsgBox().alert("",_T("filetable","filetable_select_one"));return}this.wait=this.cp.getMsgBox().wait(_T("relayservice","file_downloading"));this.cp.sendWebAPI({scope:this,webapi:{api:"SYNO.Core.SupportForm.Log",version:1,method:"collect",params:{app_list:d}},callback:function(g,f){if(!g){this.onDownloadFail();return}this.taskId=f.task_id;this.startPolling()}})},startPolling:function(){this.pollingId=this.cp.pollReg({webapi:{api:"SYNO.Core.SupportForm.Log",method:"status",version:1,params:{task_id:this.taskId}},interval:5,status_callback:this.onPollingDone,scope:this})},stopPolling:function(){if(Ext.isDefined(this.pollingId)){this.cp.pollUnreg(this.pollingId);delete this.pollingId}},onPollingDone:function(c,b,a){if(!c){this.stopPolling();this.onDownloadFail();return}if(!b.finished){return}this.stopPolling();this.wait.hide();this.onCollectDone(b.path)},onCollectDone:function(a){this.cp.downloadWebAPI({scope:this,webapi:{api:"SYNO.Core.SupportForm.Log",version:1,method:"download",params:{path:a}},callback:function(c,b){if(!c){this.onDownloadFail()}}})}});SYNO.SDS.SupportForm.ServicePanel=Ext.extend(SYNO.SDS.Utils.FormPanel,{constructor:function(a){this.filter_prefix="filter_";SYNO.SDS.SupportForm.ServicePanel.superclass.constructor.call(this,a)},processReturnData:function(f,d,c){for(var b=0;b<d.result.length;b++){if(d.result[b].api=="SYNO.Core.SupportForm.Service"&&d.result[b].method=="get"){if(d.result[b].data.expiredate!=="--"){var a=Date.parseDate(d.result[b].data.expiredate,"Y/n/j");var e=SYNO.SDS.DateTimeFormatter(a,{type:"date"});d.result[b].data.expiredate='<font class="syno-supportform-expire">'+e+"</font>"}this.updateFilterComponent(d.result[b].data.app_list);if(0>=d.result[b].data.fan_num){this.hideFanDebug()}}}SYNO.SDS.SupportForm.ServicePanel.superclass.processReturnData.call(this,f,d,c);this.doLayout()},processParams:function(b,a){if("set"!==b){return SYNO.SDS.SupportForm.ServicePanel.superclass.processParams.call(this,b,a)}if(!Ext.isArray(a)||!Ext.isObject(a[0])||"set"!==a[0].method||Ext.isEmpty(a[0].params)){return a}return a},updateFilterComponent:function(e){var b=this.cp.getOpenConfig("extra");var c=Ext.isObject(b)?b.pkg_id:"";var a=this.getComponent("log_fieldset"),d=[];if(Ext.isEmpty(a)||Ext.isEmpty(e)){return}if(!Ext.isEmpty(this.filterComponent)){a.remove(this.filterComponent);delete this.filterComponent}e.each(function(f){d.push({enable:f.enable||(f.id===c),id:f.id,name:f.name})},this);this.enableColumn=new SYNO.ux.EnableColumn({header:_T("common","enabled"),dataIndex:"enable",menuDisabled:true,sortable:true,width:0.2,align:"center"});this.filterStore=new Ext.data.JsonStore({fields:["enable","id","name"],autoLoad:false});this.filterComponent=new SYNO.ux.GridPanel({enableHdMenu:false,plugins:[this.enableColumn],store:this.filterStore,columns:[this.enableColumn,{header:_T("status","header_item"),dataIndex:"name",width:0.8}]});this.filterComponent.setHeight(49+28*d.size());this.filterStore.loadData(d);a.insert(1,this.filterComponent);a.doLayout()},isDebugItemDirty:function(){return this.filterComponent.getStore().getModifiedRecords().size()!==0},getFilterComponent:function(){var a=[];this.filterComponent.getStore().each(function(b){if(b.data.enable){a.push(b.data.id)}},this);return a},getDebugItemParam:function(){var a={};this.filterComponent.getStore().each(function(b){a[this.filter_prefix+b.data.id]=b.data.enable},this);return a},hideFanDebug:function(){var b=this.getComponent("log_tools");if(!b){return}var a=b.getComponent("fan_debug_en");if(!a){return}a.hide()}});Ext.ns("SYNO.SDS.SupportForm");SYNO.SDS.SupportForm.Application=Ext.extend(SYNO.SDS.AppInstance,{appWindowName:"SYNO.SDS.SupportForm.MainWindow"});SYNO.SDS.SupportForm.MainWindow=Ext.extend(SYNO.SDS.AppWindow,{constructor:function(a){this.appInstance=a.appInstance;var b=this.fillConfig(a);SYNO.SDS.SupportForm.MainWindow.superclass.constructor.call(this,b)},fillConfig:function(a){var b={layout:"border",cls:"syno-app-support-form",dsmStyle:"v5",minWidth:1000,minHeight:570,width:1000,height:570,border:false,plain:true,items:[this.moduleList=new SYNO.SDS.SupportForm.ModuleList({region:"west",width:250,appWin:this}),this.moduleCt=new SYNO.ux.Panel({layout:"card",padding:"0 0 0 16px",border:false,frame:false,hideMode:"offsets",cls:"syno-app-support-form-module-ct",region:"center",appWin:this})]};Ext.apply(b,a);return b},getModule:function(d){var c=this.moduleCt;var a=c.getComponent(d);var b;if(a){b=a.module}else{var e;e=Ext.getClassByName(d);e.prototype.jsConfig=this.jsConfig;b=new e({cp:this});b.cp=this;a=b.getPanel();a.module=b;a.itemId=d;c.add(a);b.title=a.title;b.height=a.height}return b},activateModule:function(b,c){if(b&&b.activate){var a=b.getPanel();if(a instanceof Ext.TabPanel&&Ext.isFunction(a.setActiveTab)){a.setActiveTab(0)}b.activate(c)}},startModule:function(b,c){var a;a=this.getModule(b);if(!a){return false}this.moduleCt.layout.setActiveItem(b);this.activateModule(a,c)},deactivateModule:function(b,c){var a=this.getModule(b);if(a&&a.deactivate){return a.deactivate(c)}},onActivate:function(){var b=Ext.getDom("iframe_form");if(b){var a=Ext.get(b.parentNode).query(".sds-shim-for-iframe");Ext.each(a,function(c){Ext.removeNode(c)})}SYNO.SDS.SupportForm.MainWindow.superclass.onActivate.apply(this,arguments)},onDeactivate:function(){var a=Ext.getDom("iframe_form");if(a){var b=document.createElement("div");b.addClassName("sds-shim-for-iframe");Ext.get(Ext.getDom("iframe_form").parentNode).appendChild(b)}SYNO.SDS.SupportForm.MainWindow.superclass.onDeactivate.apply(this,arguments)},onClose:function(){if(this.isSkipDeactivateCheck()){this.clearSkipDeactivateCheck();return true}var b,a=true;b=this.moduleList.getSelectionModel().getSelectedNode().attributes.fn;if(b){a=this.deactivateModule(b);if(false===a){this.getMsgBox().confirm(this.title,_T("common","confirm_lostchange"),function(c){if("yes"===c){this.setSkipDeactivateCheck();this.close()}},this)}}return a},isSkipDeactivateCheck:function(){return !!this.skipDeactivateCheckFlag},setSkipDeactivateCheck:function(){this.skipDeactivateCheckFlag=true},clearSkipDeactivateCheck:function(){this.skipDeactivateCheckFlag=false}});SYNO.SDS.SupportForm.ModuleList=Ext.extend(SYNO.ux.ModuleList,{constructor:function(a){var b=this.fillConfig(a);SYNO.SDS.SupportForm.ModuleList.superclass.constructor.call(this,b);this.getSelectionModel().on("selectionchange",this.onModuleListSelect,this);this.getSelectionModel().on("beforeselect",this.onBeforeSelect,this)},fillConfig:function(a){var b={itemId:"module_list",padding:"4px 16px 0 12px",listItems:[{text:"support_center:support_form",iconCls:"icon-contact",fn:"SYNO.SDS.SupportForm.FormModule"},{text:"support_center:support_services",iconCls:"icon-utilities",fn:"SYNO.SDS.SupportForm.RemoteModule"}],listeners:{scope:this,single:true,load:function(){(function(){this.selectModule("SYNO.SDS.SupportForm.FormModule")}).defer(200,this)}}};Ext.apply(b,a);return b},onBeforeSelect:function(a,b,e){if(!e){return true}if(this.appWin.isSkipDeactivateCheck()){this.appWin.clearSkipDeactivateCheck();return true}var d,c=true;d=e.attributes.fn;if(d){c=this.appWin.deactivateModule(d);if(false===c){this.appWin.getMsgBox().confirm(this.title,_T("common","confirm_lostchange"),function(f){if("yes"===f){this.appWin.setSkipDeactivateCheck();this.appWin.moduleList.selectModule(b.attributes.fn)}},this)}}return c},onModuleListSelect:function(a,c){var b;if(!c.leaf){return}b=c.attributes.fn;if(b){this.appWin.startModule(b)}else{this.appWin.getMsgBox().alert(this.appWin.title,"not implemented yet")}}});