/* Copyright (c) 2020 Synology Inc. All rights reserved. */

Ext.ns("SYNO.SDS.PkgManApp.Utils");SYNO.SDS.PkgManApp.Utils.Helper={T:function(b,a){if(a){return _T(b,a)}else{return _T("pkgmgr",b)}},getAbsoluteURL:function(a,b){var c=SYNO.SDS.PkgManApp.Window.jsConfig.jsBaseURL;if(!a){return c}else{if(b){return[c,b,a].join("/")}else{return[c,a].join("/")}}},getIconFromServer:function(c,a,b){a=a||72;if(SYNO.SDS.UIFeatures.test("isRetina")&&!Ext.isEmpty(c.thumbnail_retina)&&c.thumbnail_retina[0]){return 72===a?c.thumbnail_retina[0]:(c.thumbnail_retina[1]||c.thumbnail_retina[0])}else{return 72===a?c.thumbnail[0]:(c.thumbnail[1]||c.thumbnail[0])}},getTransparentDataURI:function(){return"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVQYV2NgYAAAAAMAAWgmWQ0AAAAASUVORK5CYII="},getIconFromDS:function(c,a){a=a||72;var d=SYNO.SDS.UIFeatures.test("isRetina");if(d){a=(72===a)?144:256}var b=Ext.urlAppend(SYNO.API.currentManager.getBaseURL("SYNO.Core.Package.Thumb","get",1),Ext.urlEncode(SYNO.API.EncodeParams({name:c.id,ver:c.version,size:a})));return b},hashCode:function(a){var d=0;if(a.length===0){return d}for(var b=0;b<a.length;b++){var e=a.charCodeAt(b);d=((d<<5)-d)+e;d=d&d}return d},versionCompare:function(e,c,j){var b=c.split("-");var k=j.split("-");var h=b[0].split(".");var g=k[0].split(".");var l=0;var a=function(n,i){var m=Math.max(n.length,i.length);n.push.apply(n,new Array(m-n.length).map(Number.prototype.valueOf,0));i.push.apply(i,new Array(m-i.length).map(Number.prototype.valueOf,0))};a(h,g);if(1<b.length){h.push(b[1])}if(1<k.length){g.push(k[1])}a(h,g);for(var d=0,f=h.length;d<f;d++){if(Number(h[d])>Number(g[d])){l=1;break}if(Number(h[d])<Number(g[d])){l=-1;break}}switch(e){case"=":return l===0;case">=":return l>=0;case">":return l>0;case"<=":return l<=0;case"<":return l<0;default:return false}},getCardWidth:function(a){var b=2;while(a>250*b+(b+1)){b+=1}b-=1;return(a-(b+1))/b},renderURL:function(a,b){return String.format('<a target="_blank" href="{0}">{1}</a>',a,b||Ext.util.Format.htmlEncode(a))},getInstallationText:function(e,d,c,a,b){if(e){return this.T("status_installed")}else{if(d){return this.T("pkgmgr_pkg_upgrade")}else{if(c){return this.T("myds_pay_trail")}else{if(a){return this.T("myds_pay_buy")}else{if(b){return this.T("join_beta")}else{return this.T("pkgmgr_pkg_install")}}}}}},encodeMsg:function(b,a){var c=b;if(!Ext.isDefined(b)){c=""}else{if(a){c=Ext.util.Format.stripTags(c)}}return Ext.util.Format.htmlEncode(c)},getAdminPortUrl:function(c){if(!c){return""}var a="";for(var b=0;b<c.length;b++){a+=String.format("<a href='{0}' target='_blank'>{0}</a>",c[0]);if(b>0){a+=";"}}return a},getPriceFormatString:function(b,a){var c="";var d;if(Ext.isEmpty(b)||(typeof b!=="object")){return c}d=(a in b)?a:SYNO.SDS.PkgManApp.Config.DEFAULT_CURRENCY;c=String.format("{0} {1}",b[d],d);return c}};Ext.define("SYNO.SDS.PkgManApp.All.Banner",{extend:"Ext.DataView",helper:SYNO.SDS.PkgManApp.Utils.Helper,constructor:function(a){SYNO.SDS.PkgManApp.Utils.Utils._initWinWrappers.call(this,a);this.callParent([this.fillConfig(a)]);this.mon(this.store,"load",this.onStoreLoad,this);this.mon(this._getSynoServerObj().store,"load",this.refresh,this);this.mon(this._getBetaServerObj().store,"load",this.refresh,this)},fillConfig:function(a){this.tpl=this.createTpl();var b={tpl:this.tpl,trackOver:true,listeners:{click:this._onClick,mouseenter:this._onMouseEnter,afterrender:this.onAfterRender}};Ext.apply(b,a);return b},collectData:function(a,c){var b=[];Ext.each(a,function(d){if(!SYNO.SDS.PkgManApp.Config.blBetaChannel&&d.get("type")==="package"&&d.get("beta")){return}if(d.get("type")==="package"&&!d.get("beta")&&Ext.isEmpty(this._getSynoServerObj().store.getById(d.get("keyword")))){return}if(d.get("type")==="package"&&d.get("beta")&&Ext.isEmpty(this._getBetaServerObj().store.getById(d.get("keyword")))){return}b.push(d.data)},this);this.determineVisibility(b);return b},determineVisibility:function(a){if(0<a.length){this.show()}else{this.hide()}},createTpl:function(){return new Ext.XTemplate("<div class=syno-pkg-banner-pager>",'<tpl for=".">','<div class="button" data-target-id="{[xindex - 1]}">',"</div>","</tpl>","</div>",'<tpl for=".">','<div class="syno-pkg-banner-item" data-keyword="{keyword}" data-type="{type}" data-link="{link}" data-beta="{beta}" style="background:url({[this.getBanner(values, xindex)]}) no-repeat;">','<div style="{css_string}">',"<article>",'<div><img style="{css_icon}" src="{[this.getIcon(values, xindex)]}"/></div>','<div style="{css_title}">{title}</div>','<div style="{css_desc}">{descr}</div>',"</article>",'<div style="{css_triangle}"></div>',"</div>","</div>","</tpl>",{compiled:true,disableFormats:true,getIcon:this.getIcon.createDelegate(this),getBanner:this.getBanner.createDelegate(this)})},getBanner:function(a,b){if(Ext.isEmpty(a.background)){return""}var d=SYNO.API.currentManager.getBaseURL("SYNO.Core.Package.Screenshot.Server","get",1);var c=Ext.urlAppend(d,Ext.urlEncode(SYNO.API.EncodeParams({name:"ReservedForBanner"+b,ver:this.helper.hashCode(a.background).toString(),link:a.background,index:b})));return c},getIcon:function(a,b){if(Ext.isEmpty(a.icon)){return""}var d=SYNO.API.currentManager.getBaseURL("SYNO.Core.Package.Screenshot.Server","get",1);var c=Ext.urlAppend(d,Ext.urlEncode(SYNO.API.EncodeParams({name:"ReservedForBannerIcon"+b,ver:this.helper.hashCode(a.icon).toString(),link:a.icon,index:b})));return c},selectBanner:function(a){this.getEl().select(".syno-pkg-banner-pager .button").each(function(b,e,d){b.removeClass("selected");if(d===a){b.addClass("selected")}},this);this.getEl().select(".syno-pkg-banner-item").each(function(b,e,d){b.dom.style.display="none";if(d===a){b.dom.style.display="block"}},this)},onStoreLoad:function(){this.selectBanner(0)},onAfterRender:function(){this.selectBanner(0)},_onClick:function(g,c,a){var i=Ext.fly(a).findParent(".syno-pkg-banner-item");if(Ext.isEmpty(i)){return}var e=i.getAttribute("data-type");var d=i.getAttribute("data-keyword");var f=i.getAttribute("data-link");var h=i.getAttribute("data-beta");var b;if(e==="url"&&f){window.open(f,"_blank","")}else{if(e==="package"&&d){b=h=="true"?"SYNO.SDS.PkgManApp.Beta.Panel":"SYNO.SDS.PkgManApp.All.Panel";SYNO.SDS.PkgManApp.Window.jumpTo(b,1,d)}else{if(e==="compilation"&&d){b="SYNO.SDS.PkgManApp.SearchResult.Panel";SYNO.SDS.PkgManApp.Window.jumpTo(b,0,null,d)}}}},_onMouseEnter:function(b,d,e){var a=Ext.fly(e).findParent(".button");if(Ext.isEmpty(a)){return}var c=Number(a.getAttribute("data-target-id"));this.selectBanner(c)},refresh:function(){this.callParent(arguments);this.onAfterRender()}});Ext.define("SYNO.SDS.PkgManApp.Detail.Status",{extend:"Ext.Container",helper:SYNO.SDS.PkgManApp.Utils.Helper,constructor:function(a){SYNO.SDS.PkgManApp.Utils.Utils._initWinWrappers.call(this,a);this.callParent([this.fillConfig(a)])},fillConfig:function(a){this.iconStore=this.createIconStore();this.icon=this.createIcon();this.statusArea=this.createStatusArea();this.addTplRenderer();var b={cls:"syno-pkg-detail-status",items:[this.icon,this.statusArea]};Ext.apply(b,a);return b},createIconStore:function(){return new Ext.data.JsonStore({autoDestroy:true,fields:["icon"]})},createIcon:function(){return new Ext.DataView({cls:"syno-pkg-detail-iconarea",tpl:new Ext.XTemplate('<tpl for=".">','<img class="syno-pkg-icon-img" src="{[this.getTransparentDataURI()]}" style="background:url(\'{icon}\'); background-size:128px;">',"</tpl>",{compiled:true,disableFormats:true,getTransparentDataURI:SYNO.SDS.PkgManApp.Utils.Helper.getTransparentDataURI.createDelegate(this)}),store:this.iconStore})},createStatusArea:function(){this.btnMenu=new SYNO.ux.Menu({cls:"syno-ux-searchfield-menu",items:[{text:this.helper.T("repair"),itemId:"repair",handler:this.onAction,scope:this},{text:this.helper.T("pkgmgr_pkg_upgrade"),itemId:"upgrade",handler:this.onAction,scope:this},{text:this.helper.T("common","cancel"),itemId:"cancel",handler:this.onAction,scope:this},{text:this.helper.T("pkgmgr_pkg_install"),itemId:"install",handler:this.onAction,scope:this},{text:this.helper.T("open"),itemId:"open",handler:this.openPkg,scope:this},{text:this.helper.T("pkgmgr_pkg_start"),itemId:"start",handler:this.startPkg,scope:this},{text:this.helper.T("pkgmgr_pkg_stop"),itemId:"stop",handler:this.stopPkg,scope:this},{text:this.helper.T("pkgmgr_pkg_uninstall"),itemId:"uninstall",handler:this.uninstallPkg,scope:this},"-",{text:this.helper.T("auto_update_one"),itemId:"autoupdate",handler:this.toggleAutoUpdate,checked:true,scope:this}]});this.actionBtn=new SYNO.ux.SplitButton({text:this.helper.T("pkgmgr_pkg_install"),minWidth:124,handler:this.onAction,menu:this.btnMenu,scope:this});this._isClickOnArrow=this.actionBtn.isClickOnArrow;var a=this;return new Ext.form.FormPanel({cls:"syno-pkg-detail-statusarea",hideLabels:true,border:false,clearCls:"",defaults:{xtype:"syno_displayfield"},items:[{cls:"syno-pkg-detail-status-developer",name:"maintainer",value:"Synology"},{itemCls:"syno-pkg-detail-status-title-form-item",cls:"syno-pkg-detail-status-title",name:"dname",setRawValue:function(c){var b=Ext.util.Format.htmlEncode(c);if(a.data.beta){b+='<div class="syno-pkg-detail-status-beta syno-pkglist-beta2"></div>'}return this.rendered?(this.el.dom.innerHTML=(Ext.isEmpty(b)?"":b)):(this.value=b)}},{itemCls:"syno-pkg-detail-status-status-form-tiem",cls:"syno-pkg-detail-status-status",name:"status",setRawValue:function(b){var c=a.renderStatusOrCategories(b,a.data);return this.rendered?(this.el.dom.innerHTML=(Ext.isEmpty(c)?"":c)):(this.value=c)}},this.actionBtn,{itemCls:"syno-pkg-detail-status-price-form-item",cls:"syno-pkg-detail-status-price",name:"price",setValue:function(b){this.setRawValue(SYNO.SDS.PkgManApp.Utils.Helper.getPriceFormatString(b,SYNO.SDS.PkgManApp.Window.synoAccountInfo.currency));return this}},{itemCls:"syno-pkg-detail-status-download-count-form-item",cls:"syno-pkg-detail-status-download-count",name:"download_count",setValue:function(b){var c=a.data.price;var d=(Ext.isEmpty(c)||(typeof c!=="object"))?"":" / ";var e="";if(!Ext.isEmpty(b)){e=d+a.helper.T("download_count")+" : "+b}return this.rendered?(this.el.dom.innerHTML=(Ext.isEmpty(e)?"":e)):(this.value=e)}}]})},addTplRenderer:function(){this.icon.tpl.getIcon=this.getIcon},setStatusValue:function(b){var a=this.statusArea.getForm();a.setValues(b);this.setActionBtn()},_setHandler:function(c,d,b){var a=b||null;c.setText(d);c.setHandler(a,this)},setActionBtn:function(){var c=this.actionBtn;var a=this.btnMenu.items;var h=this.getActionStatus(this.data);var e=this.data;var k=[];var b=SYNO.SDS.PkgManApp.Utils.Utils.IsPkgOpenable(e);c.enable();this._setBtnAppearance(c,true);c.menu=this.btnMenu;switch(h.actionstatus){case"installed":case"upgraded":if(e.status==="running"&&b){k.push("open")}break;case"upgrading":case"starting":case"stopping":case"installing":case"waiting":case"loading":this._setHandler(c,this.helper.T(h.actionstatus));c.disable();return;case"upgradedcancel":case"installedcancel":k.push("cancel");break;case"broken":if(this._isRepairable(e)){k.push("repair")}break;case"upgrade":k.push("upgrade");break;case"install":k.push("install");break;default:break}for(var f=0,j=a.getCount();f<j;f++){a.get(f).hide()}if(false===e.pkgstartable){if("stop"===e.status||"stopped_by_dep_limit"===e.status){k.push("start")}}else{if("running"===e.status){k.push("stop")}else{if("stop"===e.status||"stopped_by_dep_limit"===e.status){k.push("start")}else{}}}if(e.status==="running"&&b){k.push("open")}if(e.ctl_uninstall){k.push("uninstall")}if(this.data.silent_upgrade){k.push("autoupdate");k.push(a.getCount()-2);a.get("autoupdate").setChecked(e.autoupdate)}k=k.filter(function(i,l){return k.indexOf(i)===l});if(0===k.length){this._setHandler(c,this.helper.T("common","action"));c.disable()}else{if(1===k.length){var d=a.get(k[0]).text;if("install"===k[0]){d=this.helper.getInstallationText(false,false,!this.isCommunity()&&e&&0!==e.type&&(Ext.isEmpty(e.status)&&!e.price),SYNO.SDS.PkgManApp.Utils.Utils.isBuyable(e)&&!this.isCommunity(),this.data.beta)}this._setBtnAppearance(c,false);this._setHandler(c,d,a.get(k[0]).handler)}else{if(2===k.length&&this.data.silent_upgrade){this._setHandler(c,this.helper.T("common","action"));k.each(function(i){a.get(i).show()},this)}else{var g=true;k.each(function(i){if(g){this._setHandler(c,a.get(i).text,a.get(i).handler);g=false}else{a.get(i).show()}},this)}}}},_setBtnAppearance:function(b,a){var c=b.getEl();if(a){c.select(".x-btn-split").first().setStyle("background-size",null);c.select(".x-btn-split").first().setStyle("padding-left",null);c.select(".arrow").first().setStyle("display",null);b.isClickOnArrow=this._isClickOnArrow}else{c.select(".x-btn-split").first().setStyle("background-size",0);c.select(".x-btn-split").first().setStyle("padding-left","18px");c.select(".arrow").first().setStyle("display","none");b.isClickOnArrow=function(){return false}}},getIcon:function(b,a){var c=this._getInstalledStore().getById(b.id);if(c&&c.data.version===b.version){return this.helper.getIconFromDS(b,a)}return this.getIconFromServerOrDSM(b,a)},onLoadData:function(a){this.data=a;this.pkgname=a.id;this.iconStore.loadData([{icon:this.getIcon(a,128)}]);this.setStatusValue(a)},openPkg:function(){var a=this.data;if(a.dsm_apps){var b=a.dsm_apps;if(!Ext.isArray(a.dsm_apps)){b=a.dsm_apps.split(" ")}if(b&&b[0]){SYNO.SDS.PkgManApp.Utils.Utils.AppLaunch(b[0])}}else{if(a.url&&a.url[0]){window.open(a.url[0],"_blank","")}}},startPkg:function(){var a=this._getInstalledStore().getById(this.pkgname);if(a){this._onStartPkg(a)}},stopPkg:function(){var a=this._getInstalledStore().getById(this.pkgname);if(a){this._onStopPkg(a)}},onAction:function(){var b=this.pkgname;var a;var c;var d=this._getReplacerRecByReplaceeId(b);if(d){c=d}else{if(this.owner.isInstalledPage()&&(this._isUpgradableFromBetaToStable(b)||this._isRepairableFromBetaToStable(b))){a="stable"}else{if(this.owner.isInstalledPage()){a=this._getInstalledStore().getById(b).get("beta")?"beta":"stable"}else{a=this.owner.targetStore}}c=SYNO.SDS.PkgManApp.Window.getStore(a).getById(b)||this._getOtherServerObj().store.getById(b)}this._onClickSynoPkgActionBtn(c)},uninstallPkg:function(){this._applyFeasibilityCheck({type:"uninstall_check",packages:[this.pkgname]},(function(){var a=(function(d){this._onUninstallPkg(d,(function(){if(SYNO.SDS.PkgManApp.Window.pageList.getNodeById("SYNO.SDS.PkgManApp.Installed.Panel").isSelected()){SYNO.SDS.PkgManApp.Window.setCurrentPage("SYNO.SDS.PkgManApp.Installed.Panel",0);SYNO.SDS.PkgManApp.Window.pageCt.ownerCt.pageCt.getComponent("SYNO.SDS.PkgManApp.Installed.Panel").layout.setActiveItem(0)}SYNO.SDS.PkgManApp.Action.clearProgress(d.get("id"))}).createDelegate(this))}).createDelegate(this);var c=this._getInstalledStore().getById(this.pkgname);if(c){a(c)}else{var b=SYNO.SDS.PkgManApp.Window;b.mon(b.instListPolling,"callback",function(){var d=this._getInstalledStore().getById(this.pkgname);if(d){a(d)}},this,{single:true});b.fireEvent("pollinginstpage")}}).createDelegate(this))},toggleAutoUpdate:function(b){var a=!b.checked;this.sendWebAPI({single:true,api:"SYNO.Core.Package.Setting.Update",method:a?"add":"delete",version:1,params:{id:this.pkgname},scope:this});var c=this._getInstalledStore().getById(this.pkgname);c.data.autoupdate=a},renderStatusOrCategories:function(b,e){var a=this.getStatusStyle(b,e);if(!Ext.isEmpty(a.text)){return String.format('<font style="color:{0};">{1}</font>',a.color,a.text)}if(Ext.isArray(e.category)){var c=[];var d=SYNO.SDS.PkgManApp.Window.getStore("category");Ext.each(e.category,function(f){if(d.getById(f)){c.push(d.getById(f).get("dname"))}else{c.push(f)}});a.color="rgba(80,90,100,0.65)";a.text=c.join(", ");return String.format('<font style="color:{0};" ext:qtip="{1}">{1}</font>',a.color,a.text)}return""},isCommunity:function(){return this.owner.targetStore==="community"},getActionStatus:function(h){var j=this._isQuickInstll(h);var e=this._getInstalledStore().getById(h.id);var c=((this.owner.targetStore==="beta")===(e&&true===e.get("beta")));var b=this._isUpgradable(h.id)&&(c||this.isCommunity()||this.owner.isInstalledPage());b|=this._isUpgradableFromBetaToStable(h.id)&&(this.owner.isInstalledPage()||(this.owner.panel==="all"&&e&&e.get("beta")));var m=false;var f=(b&&h.status!=="loading")?"upgrade":"install";if(j&&-1!==this._getInstallAll_Background().indexOf(h.id)){f="waiting"}if(SYNO.SDS.PkgManApp.Utils.Utils.isBrokenStatus(h)){f="broken"}else{if(!Ext.isEmpty(h.status)&&!b){f="installed"}}var k=this._GetProcessStatus(h.status);if(k.blProcessing){f=h.status}else{if(this._IsInstalling(h)){f=b?"upgrading":"installing"}}var g="";if(Ext.isDefined(h.progress)&&h.progress){if(h.progress==1){}else{if(h.progress>0){if(!(this._IsInstalling(h))){f=b?"upgradedcancel":"installedcancel"}if(0.00001>=h.progress){g=_T("vpnc","waiting")}else{g=Math.floor(h.progress*100)+"%&nbsp;";if(this._IsInstalling(h)){if(k.blProcessing){g+=k.msg}else{g+=b?_T("pkgmgr","upgrading"):_T("pkgmgr","installing")}}else{g+=_T("download","download_task_downloading")}}}else{if(h.progress<0){m=true;f=b?"upgrade":"install";g=b?_T("pkgmgr","upgrade_pkg_fail"):_T("pkgmgr","install_pkg_fail");g=String.format(g,h.dname,"")}}}}var a,d,i;if(h.info&&h.progress<0){d=h.info;m=true;g=this._IsInstalling(h)?_T("pkgmgr","install_pkg_fail"):_T("pkgmgr","download_pkg_fail");g=String.format(g,h.dname,"");i=h.dname+":&nbsp;";if(d.sec&&d.key){g=i+_T(d.sec,d.key)+"&nbsp;"}else{if(d.errmsg){a=this._onCheckPKGFailMsg(h.dname,d);g+=a.msg}}if(d.message&&""!==d.message){g+=SYNO.SDS.PkgManApp.Utils.Utils.localizeMsg(d.message,d.message)}}var l=g;if(!m&&!Ext.isEmpty(g)){l="<div><font style='color:#0086E6;' ext:qtip='"+g+"'>";l+="&nbsp;";l+=g;l+="</font></div>"}return{actionstatus:f,statustext:l,callback:a?a.callback:undefined}}});Ext.define("SYNO.SDS.PkgManApp.Detail.Screenshot",{extend:"Ext.DataView",helper:SYNO.SDS.PkgManApp.Utils.Helper,constructor:function(a){this.callParent([this.fillConfig(a)]);this.mon(this.store,"load",this.onStoreLoad,this)},fillConfig:function(a){this.store=this.createStore();this.tpl=this.createTpl();this.addTplRenderer();var b={cls:"syno-pkg-detail-screenshot",tpl:this.tpl,trackOver:true,listeners:{mouseenter:this._onMouseEnter,afterrender:this.onAfterRender}};Ext.apply(b,a);return b},addTplRenderer:function(){},createStore:function(){return new Ext.data.JsonStore({autoDestroy:true,fields:["screenshot"]})},createTpl:function(){return new Ext.XTemplate("<div class=syno-pkg-detail-screenshot-pager>",'<tpl for=".">','<div class="button" data-target-id="{[xindex - 1]}">',"</div>","</tpl>","</div>",'<tpl for=".">','<img class="syno-pkg-detail-screenshot-item" src="{screenshot}"/>',"</tpl>")},selectScreenshot:function(a){this.getEl().select(".syno-pkg-detail-screenshot-pager .button").each(function(b,e,d){b.removeClass("selected");if(d===a){b.addClass("selected")}},this);this.getEl().select(".syno-pkg-detail-screenshot-item").each(function(b,e,d){b.dom.style.display="none";if(d===a){b.dom.style.display="block"}},this)},onStoreLoad:function(b,a){if(b.getCount()<1){this.hide()}else{this.show();this.selectScreenshot(0)}},onAfterRender:function(){this.selectScreenshot(0)},getScreenshot:function(c,d,b,a){var f=SYNO.API.currentManager.getBaseURL(a?"SYNO.Core.Package.Screenshot":"SYNO.Core.Package.Screenshot.Server","get",1);var e=Ext.urlAppend(f,Ext.urlEncode(SYNO.API.EncodeParams({name:d.id,ver:d.version,link:b,index:c})));if(a){e=Ext.urlAppend(e,Ext.urlEncode(SYNO.API.EncodeParams({newlink:a})))}return e},_onMouseEnter:function(b,d,e){var a=Ext.fly(e).findParent(".button");if(Ext.isEmpty(a)){return}var c=Number(a.getAttribute("data-target-id"));this.selectScreenshot(c)},onLoadData:function(b){var a=[];if(b&&b.snapshot){b.snapshot.each(function(e,d){var c=this.getScreenshot(d,b,e);a.push({screenshot:c})},this)}this.store.loadData(a)}});Ext.define("SYNO.SDS.PkgManApp.Detail.Container",{extend:"Ext.Container",helper:SYNO.SDS.PkgManApp.Utils.Helper,constructor:function(a){SYNO.SDS.PkgManApp.Utils.Utils._initWinWrappers.call(this,a);this.callParent([this.fillConfig(a)])},fillConfig:function(a){this.statusArea=this.createStatus();this.descAndChangelog=this.createDescAndChangelog();this.relatedPkgs=this.createRelatedPkgs();this.screenshot=this.createScreenshot();this.info=this.createInfo();this.feedbackBtn=this.createFeedbackBtn();var b=[this.statusArea,this.screenshot,this.descAndChangelog,this.relatedPkgs,this.info,this.feedbackBtn];var c={autoFlexcroll:true,cls:"syno-pkg-view syno-pkg-detail-container",style:{paddingBottom:"20px",paddingRight:"20px"},items:b,listeners:{resize:this._onResize,deactivate:this.onDeactivate,activate:this.onActivate}};Ext.apply(c,a);return c},clearStatusScreenshotClass:function(){this.statusArea.removeClass("syno-pkg-detail-status");this.screenshot.removeClass("syno-pkg-detail-screenshot");this.statusArea.removeClass("syno-pkg-detail-status-wide");this.screenshot.removeClass("syno-pkg-detail-screenshot-wide")},createRelatedPkgs:function(){return new SYNO.SDS.PkgManApp.Detail.RelatedPkgList({owner:this,style:{marginTop:"32px"},showTBar:true,store:SYNO.SDS.PkgManApp.Window.getStore("stable"),viewType:"card",panelName:"SYNO.SDS.PkgManApp.All.Panel",headerText:this.helper.T("related_packages")})},_onResize:function(){var a=this.getWidth(true);if(a>980&&this.screenshot.getStore().getCount()>0){this.clearStatusScreenshotClass();this.statusArea.addClass("syno-pkg-detail-status-wide");this.screenshot.addClass("syno-pkg-detail-screenshot-wide")}else{this.clearStatusScreenshotClass();this.statusArea.addClass("syno-pkg-detail-status");this.screenshot.addClass("syno-pkg-detail-screenshot")}},createScreenshot:function(){return new SYNO.SDS.PkgManApp.Detail.Screenshot({})},createInfo:function(){var a=this;return new Ext.form.FormPanel({title:this.helper.T("other_information"),cls:"syno-pkg-detail-other",border:false,clearCls:"",labelSeparator:"",labelAlign:"top",defaults:{xtype:"displayfield"},items:[{name:"maintainer",fieldLabel:this.helper.T("pkgmgr_pkg_maintainer"),setRawValue:function(b){var c=a.getPkgData();if(b&&c&&!Ext.isEmpty(c.maintainer_url)){b=a.helper.renderURL(c.maintainer_url,b)}else{b=Ext.util.Format.htmlEncode(b)}return this.rendered?(this.el.dom.innerHTML=(Ext.isEmpty(b)?"":b)):(this.value=b)}},{name:"distributor",fieldLabel:this.helper.T("pkgmgr_pkg_distributor"),setRawValue:function(b){var c=a.getPkgData();if(b&&c&&!Ext.isEmpty(c.distributor_url)){b=a.helper.renderURL(c.distributor_url,b)}else{b=Ext.util.Format.htmlEncode(b)}return this.rendered?(this.el.dom.innerHTML=(Ext.isEmpty(b)?"":b)):(this.value=b)}},{name:"installed_version",fieldLabel:this.helper.T("pkgmgr_installed_pkg_version")},{name:"pkgtarget",fieldLabel:this.helper.T("pkgmgr_pkg_install_volume"),setValue:function(b){var c=(Ext.isEmpty(b.path)?"":b.path);if(b.is_brick){c=_T("pkgmgr","brick")}else{if(c){if(c.substr(0,20)==="/usr/local/packages/"){c=_T("pkgmgr","system_volume")}else{c=_T("volume","volume")+" "+c.match(/^\/volume(\d*)\//)[1]}}}return this.rendered?(this.el.dom.innerHTML=(Ext.isEmpty(c)?"":c)):(this.value=c)}},{name:"download_count",fieldLabel:this.helper.T("download_count")},{name:"newest_online_version",fieldLabel:this.helper.T("pkgmgr_pkg_version")},{name:"category",fieldLabel:this.helper.T("category"),itemId:"category",setRawValue:function(b){var d="";if(b&&Ext.isArray(b)){var c=SYNO.SDS.PkgManApp.Window.getStore("category");Ext.each(b,function(f){var e;if(c.getById(f)){e=c.getById(f).get("dname")}else{e=f}d+=String.format('<span data-id="{0}" class="syno-pkg-detail-category">{1}</span>',f,e)})}return this.rendered?(this.el.dom.innerHTML=(Ext.isEmpty(d)?"":d)):(this.value=d)}},{name:"url",fieldLabel:this.helper.T("pkgmgr_pkg_adminurl"),setRawValue:function(b){var c=SYNO.SDS.PkgManApp.Utils.Helper.getAdminPortUrl(b);return this.rendered?(this.el.dom.innerHTML=(Ext.isEmpty(c)?"":c)):(this.value=c)}}]})},createFeedbackBtn:function(){return new SYNO.ux.Button({style:{marginTop:"16px"},text:this.helper.T("report"),handler:this.sendFeedback,scope:this})},sendFeedback:function(){var a=this.getPkgData();if(a.support_center){SYNO.SDS.AppLaunch("SYNO.SDS.SupportForm.Application",{extra:{pkg_id:a.id,pkg_version:a.version}})}else{if(a.pkgreporturl){window.open(a.pkgreporturl,"_blank","")}}},createDescAndChangelog:function(){return new Ext.form.FormPanel({cls:"syno-pkg-detail-desc-changelog",border:false,labelSeparator:"",labelAlign:"top",defaults:{xtype:"displayfield"},items:[{name:"desc",fieldLabel:this.helper.T("pkgmgr_pkg_description")},{name:"changelog",itemId:"changelog",fieldLabel:this.helper.T("pkgmgr_pkg_changelog")},{name:"replace_message",itemId:"replace_message",fieldLabel:_T("widget","attention_status")}]})},setPkgId:function(a){this.pkgId=a},setServerStore:function(a){this.serverStore=a},onLoadData:function(){this.relatedPkgs.hide();this.relatedPkgs._view.refresh();var a=this.getPkgData();this.screenshot.onLoadData(a);this.onUpdateStatusCallBack()},createStatus:function(){return new SYNO.SDS.PkgManApp.Detail.Status({owner:this})},setFieldValues:function(b,a){b=b.getForm();b.reset();b.setValues(a);b.items.each(function(d){var c=d.getValue();if(Ext.isEmpty(c)||(Ext.isNumber(c)&&c===0)){d.hide()}else{d.show()}})},getPkgData:function(){var k=false;var d=SYNO.SDS.PkgManApp.Window.getStore("installed").getById(this.targetPkg);var j;var g=this.targetStore;var f={status:null,download_count:null,price:null};if(!d){k=true}else{var i=this._isUpgradableFromBetaToStable(this.targetPkg);var e=this._isRepairableFromBetaToStable(this.targetPkg);switch(this.panel){case"all":if(!d.get("beta")||i){k=true}break;case"beta":if(d.get("beta")){k=true}break;case"installed":if(i||e){g="stable"}else{if(d.get("beta")&&this._hasNewVersion(this.targetPkg,true)){g="beta"}else{if(!d.get("beta")&&this._hasNewVersion(this.targetPkg,false)){g="stable"}}}k=true;break;case"community":k=true;break}if(k){Ext.apply(f,d.data);f.installed_version=d.get("version");f.id=d.get("id")}}j=SYNO.SDS.PkgManApp.Window.getStore(g).getById(this.targetPkg)||this._getOtherServerObj().store.getById(this.targetPkg);if(j){Ext.apply(f,j.data)}if(g==="installed"){var c=SYNO.SDS.PkgManApp.Window.getStore("community").getById(this.targetPkg);if(c){f.newest_online_version=c.get("version")}var b=SYNO.SDS.PkgManApp.Window.getStore("stable").getById(this.targetPkg);var a=SYNO.SDS.PkgManApp.Window.getStore("beta").getById(this.targetPkg);if(b){f.newest_online_version=b.get("version")}else{if(a){f.newest_online_version=a.get("version")+" (beta)"}}}else{f.newest_online_version=f.version}var h=this._getReplacerRecByReplaceeId(this.targetPkg);if(this.panel=="installed"&&h&&h.data.replace_message){f.changelog=null;f.replace_message=h.data.replace_message}else{f.replace_message=null}if(k){SYNO.SDS.PkgManApp.Action.applyStatusData(f,null,true)}return f},onUpdateStatus:function(){if(!this.pollingStatus||this.pollingStatus.removed){this.pollingStatus=this.addTask({interval:500,run:function(){this.onUpdateStatusCallBack()},scope:this})}this.pollingStatus.restart(true)},onUpdateStatusCallBack:function(){var a=this.getPkgData();this.setFieldValues(this.info,a);this.bindCategoryClick();this.setFieldValues(this.descAndChangelog,a);this.descAndChangelog.getComponent("changelog").label.dom.innerHTML=String.format(this.helper.T("pkgmgr_pkg_changelog"),a.version);this.statusArea.onLoadData(a);this.setFeedbackBtn(a)},onActivate:function(){this.onLoadData();this.onUpdateStatus();this.scrollToTop();this._onResize()},scrollToTop:function(){if(this.el.dom.fleXcroll){this.el.dom.fleXcroll.setScrollPos(false,0);this.updateFleXcroll()}},onDeactivate:function(){if(this.pollingStatus){this.pollingStatus.remove()}},setFeedbackBtn:function(a){if(a.pkgreporturl||a.support_center){this.feedbackBtn.show()}else{this.feedbackBtn.hide()}},setPkg:function(a){this.targetPkg=a},isInstalledPage:function(){return this.panel==="installed"},bindCategoryClick:function(){var a=this.info.getComponent("category").getEl();if(a){a.select(".syno-pkg-detail-category").each(function(b,f,d){var e=b.getAttribute("data-id");this.mun(b,"click");this.mon(b,"click",function(h,g){var c="SYNO.SDS.PkgManApp.All.Panel";SYNO.SDS.PkgManApp.Window.jumpTo(c,0,null,e)},this)},this)}return}});Ext.define("SYNO.SDS.PkgManApp.Utils.PkgListCardView",{extend:"Ext.DataView",helper:SYNO.SDS.PkgManApp.Utils.Helper,constructor:function(a){SYNO.SDS.PkgManApp.Utils.Utils._initWinWrappers.call(this,a);this.callParent([this.fillConfig(a)]);this.mon(this.store,"load",this._onStoreLoad,this);this.addEvents("widthset")},fillConfig:function(a){this.tpl=this.createTpl();this.addTplRenderer();var b={listeners:{click:this._onClick,resize:this.onResize,activate:this.onActivate},tpl:this.tpl};Ext.apply(b,a);return b},createTpl:function(){return new Ext.XTemplate('<tpl for=".">','<div data-id="{id}" class="syno-pkglist-card">','<div class="syno-pkglist-badge {[this.getBetaClass(values)]}"></div>','<div class="syno-pkglist-iconarea">','<div class="syno-pkglist-icon">','<img class="syno-pkg-icon-img" src="{[this.getTransparentDataURI()]}"  style="background:url(\'{[this.getIcon(values, undefined)]}\');background-size:64px;">',"</div>",'<div class="syno-pkglist-price">',"<span>","{[this.getPrice(values)]}","</span>","</div>","</div>",'<div class="syno-pkglist-infoarea">','<div class="syno-pkglist-info">','<span class="syno-pkglist-title" ext:qtip="{[this.getTitle(values)]}">',"{[this.getTitle(values)]}","</span>",'<span class="syno-pkglist-subtitle">',"{[this.getSubTitle(values)]}","</span>","</div>",'<div class="syno-pkglist-btn">',"{[this.getActionBtn(values)]}","</div>","</div>","</div>","</tpl>",{compiled:true,disableFormats:true,getActionBtn:this.getActionBtn.createDelegate(this),getSubTitle:this.getSubTitle.createDelegate(this),getTransparentDataURI:SYNO.SDS.PkgManApp.Utils.Helper.getTransparentDataURI.createDelegate(this)})},getBtnTemplate:function(f,b,e,d){var a=String.format("aria-label='{0} {1}'",f,d?d:"");var c='<span cellspacing="0" class="x-btn syno-ux-button '+(b||"syno-ux-button-grey")+(e?" x-item-disabled":"")+' x-btn-noicon" style="width: auto; margin-left: 0px;"><em class=" x-unselectable" unselectable="on"><button ext:qtip="'+f+'" type="button" class=" x-btn-text" '+a+">"+f+"</button></em></span>";return c},addTplRenderer:function(){this.tpl.getBetaClass=this.getBetaClass;this.tpl.getPrice=this.getPrice;this.tpl.getIcon=this.getIcon;this.tpl.getTitle=this.getTitle},collectData:Ext.emptyFn,sortFunction:function(a,d){var c=a.dname||a.id;var b=d.dname||d.id;return c.localeCompare(b)},filterCollectData:function(a,b){var d=Ext.getCmp("SYNO.SDS.PkgManApp.SearchResult.Panel").searchtext;var c=[];Ext.each(a,function(g){if(Ext.isEmpty(d)){c.push(g.data)}else{var f=d.split(/\s+/);for(var h=0,e=f.length;h<e;h++){if(Ext.isEmpty(f[h])){break}if(this.checkTextMatch(g.data.dname,f[h])||this.checkTextMatch(g.data.id,f[h])||this.checkTextMatch(g.data.maintainer,f[h])||this.checkTextMatch(g.data.desc,f[h])||this.checkTextMatch(g.data.desc_enu,f[h])||this.checkTextMatch(g.data.category,f[h])){c.push(g.data);break}}}},this);c.sort(function(g,f){var e=this.getWeight(g,d);var j=this.getWeight(f,d);var i=g.dname||g.id;var h=f.dname||f.id;if(j>e){return 1}else{if(e>j){return -1}else{if(i<h){return -1}else{if(i>h){return 1}}return 0}}}.createDelegate(this));this.determineVisibility(c);return c},getWeight:function(f,g){var e=0;var d=0;if(f.distributor=="Synology Inc."){d=1}if(!Ext.isEmpty(g)){if(this.checkTextMatch(f.id,this.getWordFullMatch(g))||this.checkTextMatch(f.dname,this.getWordFullMatch(g))){e=Math.pow(10,8)*2}else{if(this.checkTextMatch(f.dname,g)){e=Math.pow(10,8)}else{if(this.checkTextMatch(f.id,g)){e=Math.pow(10,7)}else{var b=g.split(/\s+/);for(var c=0,a=b.length;c<a&&c<20;c++){if(Ext.isEmpty(b[c])){break}if(this.checkTextMatch(f.id,this.getWordFullMatch(b[c]))||this.checkTextMatch(f.dname,this.getWordFullMatch(b[c]))){e=e+Math.pow(10,6)*2}else{if(this.checkTextMatch(f.dname,b[c])){e=e+Math.pow(10,6)}else{if(this.checkTextMatch(f.id,b[c])){e=e+Math.pow(10,5)}else{if(this.checkTextMatch(f.category,this.getWordFullMatch(b[c]))){e=e+Math.pow(10,4)*2}else{if(this.checkTextMatch(f.category,b[c])){e=e+Math.pow(10,4)}else{if(this.checkTextMatch(f.maintainer,this.getWordFullMatch(b[c]))){e=e+Math.pow(10,2)*2}else{if(this.checkTextMatch(f.maintainer,b[c])){e=e+Math.pow(10,2)}else{if(this.checkTextMatch(f.desc,this.getWordFullMatch(b[c]))||this.checkTextMatch(f.desc_enu,this.getWordFullMatch(b[c]))){e=e+Math.pow(10,0)*2}else{if(this.checkTextMatch(f.desc,b[c])||this.checkTextMatch(f.desc_enu,b[c])){e=e+Math.pow(10,0)}}}}}}}}}}}}}}return e*2+d},getWordFullMatch:function(a){return"(^| )"+a+"($| )"},checkTextMatch:function(d,f){var b=["-","[","]","/","{","}","(",")","*","+","?",".","\\","^","$","|"];var e=new RegExp("["+b.join("\\")+"]","g");var a=function(g){return g.replace(e,"\\$&")};f=a(f);if(d){if(Ext.isArray(d)){for(var c=0;c<d.length;c++){if(d[c].toLowerCase().search(f)!=-1){return true}}}else{if(Ext.isString(d)&&d.toLowerCase().search(f)!=-1){return true}}}return false},onResize:function(){if(!this.rendered){return}if(this.previousContainerWidth!==this.containerWidth){this.previousContainerWidth=this.containerWidth;this.setCardWidth()}},onActivate:function(){this.refresh();this.setCardWidth()},_onStoreLoad:function(){this.setCardWidth()},setCardWidth:function(){if(!this.rendered){return}var f=this.getCardWidth();var c=this.getCardButtonMaxWidth();var e=this.getEl().select(".syno-pkglist-card").elements;for(var b=0;b<e.length;b++){var a=Ext.fly(e[b]);a.setStyle("width",f+"px");var d=a.select(".x-btn-text").first();d.setStyle("max-width",c+"px")}this.fireEvent("widthset")},getCardWidth:function(){return this.helper.getCardWidth(this.containerWidth)},getCardButtonMaxWidth:function(){return this.getCardWidth()-96-1-8},getCardClass:function(){return".syno-pkglist-card"},_onClick:function(g,f,a){var b=Ext.fly(a).findParent(this.getCardClass());if(Ext.isEmpty(b)){return}var i=b.getAttribute("data-id");var d;if((d=Ext.fly(a).findParent(".syno-ux-button",3))){if(!Ext.fly(d).hasClass("x-item-disabled")){var c=this.store.getById(i);var e=c.data;this.applyStatusData(e,this.panelName==="SYNO.SDS.PkgManApp.Beta.Panel");if(Ext.fly(d).hasClass("syno-pkg-button-run")){this._onStartPkg(c);return}if(Ext.fly(d).hasClass("syno-pkg-button-open")){if(e.dsm_apps){var h=e.dsm_apps;if(!Ext.isArray(e.dsm_apps)){h=e.dsm_apps.split(" ")}if(h&&h[0]){SYNO.SDS.PkgManApp.Utils.Utils.AppLaunch(h[0])}}else{if(e.url&&e.url[0]){window.open(e.url[0],"_blank","")}}return}if(this.panelName==="SYNO.SDS.PkgManApp.Installed.Panel"){if(this._isUpgradableFromBetaToStable(i)||this._isRepairableFromBetaToStable(i)){c=this._getSynoServerObj().store.getById(i)}else{c=this.getRecFromSameChannel(i)}}this._onClickSynoPkgActionBtn(c)}}else{SYNO.SDS.PkgManApp.Window.jumpTo(this.panelName,1,i)}},determineVisibility:function(b){var a=true;if(0<b.length){a=true}else{a=false}if(this.owner&&this.owner.panelName==="SYNO.SDS.PkgManApp.Beta.Panel"&&!SYNO.SDS.PkgManApp.Config.blBetaChannel){a=false}if(a){this.owner.show()}else{this.owner.hide()}},getBetaClass:Ext.emptyFn,getSubTitle:function(b){var d=this.getActionStatus(b);if(d){return d}var a=[];var c=SYNO.SDS.PkgManApp.Window.getStore("category");Ext.each(b.category,function(e){if(c.getById(e)){a.push(c.getById(e).get("dname"))}else{a.push(e)}});return String.format('<span ext:qtip="{0}">{0}</span>',a.join(", "))},getPrice:Ext.emptyFn,getIcon:Ext.emptyFn,onUpdate:function(b,a,f){if(Ext.data.Record.COMMIT!==f){return}var d=SYNO.SDS.PkgManApp.Window.getActivePage().panelName;if(this.panelName!==d&&"SYNO.SDS.PkgManApp.SearchResult.Panel"!==d){return}var e=Ext.query(".syno-pkglist-card[data-id="+a.id+"]",this.getTemplateTarget().dom)[0];if(undefined===e){return}var g=document.createElement("div");this.tpl.overwrite(g,[a.data]);var c=Ext.query(".syno-pkglist-card",g)[0];Ext.fly(c).setStyle("width",this.getCardWidth()+"px");Ext.fly(c).select(".x-btn-text").first().setStyle("max-width",this.getCardButtonMaxWidth()+"px");this.getTemplateTarget().dom.replaceChild(c,e)},getActionBtn:function(b){var a=this.getActionTemplate(b);return a.actiontext},getActionTemplate:function(q,v,b){var x=Ext.copyTo({},q,Object.keys(q));SYNO.SDS.PkgManApp.Window.applyStatusData(x,this.panelName==="SYNO.SDS.PkgManApp.Beta.Panel");var r=this._isQuickInstll(x);var c=false;var g=x.status==="loading";var f=SYNO.SDS.PkgManApp.Utils.Utils.isBuyable(x)&&!this.isCommunityPage();var o;var m="";var k=false;var w=false;var i=false;var y;var h='<div class="syno-pkg-button-container" ';var u=x.status;var a=SYNO.SDS.PkgManApp.Window.getStore("installed").getById(x.id);if(a&&(!a.get("beta")&&this.panelName==="SYNO.SDS.PkgManApp.Beta.Panel")){u=null}else{if(a&&(a.get("beta")&&this.panelName==="SYNO.SDS.PkgManApp.All.Panel")){u=null;c=this._isUpgradableFromBetaToStable(x.id)}else{if(a&&(a.get("beta")&&this.panelName==="SYNO.SDS.PkgManApp.Installed.Panel")){c=this._isUpgradableFromBetaToStable(x.id)||this._isUpgradable(x.id);w=(SYNO.SDS.PkgManApp.Utils.Utils.isBrokenStatus(x))}else{w=(SYNO.SDS.PkgManApp.Utils.Utils.isBrokenStatus(x));c=this._isUpgradable(x.id)}}}y=((c&&!g)?"syno-ux-button-green":"");o=this.helper.getInstallationText(g,c,!this.isCommunityPage()&&x&&0!==x.type&&(Ext.isEmpty(x.status)&&!x.price),f,this.isBeta());x.open=0;if(w){y="syno-ux-button-orange";o=SYNO.SDS.PkgManApp.Utils.Utils.getBrokenStr(x)}if(r&&-1!==this._getInstallAll_Background().indexOf(x.id)){i=true;o=_T("vpnc","waiting")}if(w){}else{if(!Ext.isEmpty(u)&&!c){if(SYNO.SDS.PkgManApp.Utils.Utils.IsPkgOpenable(x)){x.open=SYNO.SDS.PkgManApp.Utils.Utils.mode.open}if(SYNO.SDS.PkgManApp.Utils.Utils.mode.open===x.open){o=_T("pkgmgr","open");y="syno-pkg-button-open syno-ux-button-grey"}else{if(b){o=_T("pkgmgr","more_info");x.open=SYNO.SDS.PkgManApp.Utils.Utils.mode.more}else{if("stop"===x.status||"stopped_by_dep_limit"===x.status){o=_T("pkgmgr","pkgmgr_pkg_start");y="syno-pkg-button-run syno-ux-button-grey"}else{if(!this._IsInstalling(x)){o=_T("pkgmgr","status_installed");i=true}}}}}}var d=this._GetProcessStatus(u);if(d.blProcessing){m=d.msg;i=true}else{if(this._IsInstalling(x)){m=c?_T("pkgmgr","upgrading"):_T("pkgmgr","installing");i=true}}if(Ext.isDefined(x.progress)&&x.progress){if(0<x.progress){if(b){o=_T("pkgmgr","more_info");x.open=SYNO.SDS.PkgManApp.Utils.Utils.mode.more}else{if(1===x.progress){}else{o=_T("common","cancel")}}}if(x.progress==1){}else{if(x.progress>0){y="syno-ux-button-grey";if(0.00001>=x.progress){m=_T("vpnc","waiting")}else{m=Math.floor(x.progress*100)+"%&nbsp;";if(this._IsInstalling(x)){if(d.blProcessing){m+=d.msg}else{m+=c?_T("pkgmgr","upgrading"):_T("pkgmgr","installing")}}else{m+=_T("download","download_task_downloading")}}}else{if(x.progress<0){k=true;m=c?_T("pkgmgr","upgrade_pkg_fail"):_T("pkgmgr","install_pkg_fail");m=String.format(m,x.dname,"");o=this.helper.getInstallationText(false,c,false,false,this.isBeta())}}}}var l,t,p;if(v&&x.info&&x.progress<0){t=x.info;k=true;m=this._IsInstalling(x)?_T("pkgmgr","install_pkg_fail"):_T("pkgmgr","download_pkg_fail");m=String.format(m,x.dname,"");p=x.dname+":<br>";if(t.error){var n;try{n=Ext.decode(t.error)}catch(s){}m=p+SYNO.SDS.PkgManApp.Utils.Utils.localizeArrMsg(n)}else{if(t.sec&&t.key){m=p+_T(t.sec,t.key)+"&nbsp;"}}if(t.message&&""!==t.message){m+=SYNO.SDS.PkgManApp.Utils.Utils.localizeMsg(t.message,t.message)}delete x.info}if(_S("demo_mode")){i=true;h+=(' ext:qtip="'+_JSLIBSTR("uicommon","error_demo")+'"')}if(g){i=true;m=_T("pkgmgr","loading")}h+=">"+this.getBtnTemplate(o,y,i,x.dname)+"</div>";var j=m;if(!k&&m){j="<span class='syno-pkg-status'>";j+="<font style='color:#0086E6;' ext:qtip='"+m+"'>";j+="&nbsp;";j+=m;j+="</font></span>"}return{actiontext:h,statustext:j,callback:l?l.callback:undefined}},getActionStatus:function(c){var b=this.getActionTemplate(c,true);var a=b.statustext;if(c.progress<0){if(!this.modalWin||this.modalWin.length===0){a="";this._getOwner().getMsgBox().alert(_T("tree","leaf_packagemanage"),b.statustext,function(){if(b.callback){b.callback()}this._getOwner().fireEvent("pollinginstpage");this.getStore().onLoadPkgStore(false)},this)}else{if(c.qinst){SYNO.SDS.SystemTray.notifyMsg("SYNO.SDS.PkgManApp.Instance",_T("tree","leaf_packagemanage"),b.statustext)}}}return a},isCommunityPage:function(){return false},isBeta:function(){return false},getTitle:function(a){return SYNO.SDS.PkgManApp.Utils.Helper.encodeMsg(a.dname||a.id)}});Ext.define("SYNO.SDS.PkgManApp.Utils.PkgListListView",{extend:"Ext.DataView",helper:SYNO.SDS.PkgManApp.Utils.Helper,constructor:function(a){SYNO.SDS.PkgManApp.Utils.Utils._initWinWrappers.call(this,a);this.callParent([this.fillConfig(a)]);this.addEvents("widthset")},fillConfig:function(a){this.tpl=this.createTpl();var b={listeners:{click:this._onClick},tpl:this.tpl};Ext.apply(b,a);return b},createTpl:function(){return new Ext.XTemplate('<tpl for=".">','<div data-id="{id}"  class="syno-pkglist-list">','<div class="syno-pkglist-badge {[this.getBetaClass(values)]}"></div>','<div class="syno-pkglist-iconarea">','<div class="syno-pkglist-icon">','<img class="syno-pkg-icon-img" src="{[this.getTransparentDataURI()]}"  style="background:url(\'{[this.getIcon(values, undefined)]}\');background-size:64px;">',"</div>",'<div class="syno-pkglist-info">','<span ext:qtip="{[this.getTitle(values)]}" class="syno-pkglist-title">',"{[this.getTitle(values)]}","</span>",'<span class="syno-pkglist-subtitle">',"{[this.getStatus(values)]}","</span>","</div>","</div>",'<div class="syno-pkglist-descarea">',"<span>","{[this.getDesc(values)]}","</span>","</div>",'<div class="syno-pkglist-btnarea">','<div class="syno-pkglist-btn">',"{[this.getActionBtn(values)]}","</div>","</div>","</div>","</tpl>",{compiled:true,disableFormats:true,getDesc:this.getDesc.createDelegate(this),getIcon:this.getIcon.createDelegate(this),getTitle:this.getTitle.createDelegate(this),getActionBtn:this.getActionBtn.createDelegate(this),getBetaClass:this.getBetaClass.createDelegate(this),getStatus:this.getStatus.createDelegate(this),getTransparentDataURI:SYNO.SDS.PkgManApp.Utils.Helper.getTransparentDataURI.createDelegate(this)})},collectData:Ext.emptyFn,_onStoreLoad:Ext.emptyFn,getListClass:function(){return".syno-pkglist-list"},_onClick:function(a,b,c){var e=Ext.fly(c).findParent(this.getListClass());if(Ext.isEmpty(e)){return}var d=e.getAttribute("data-id");var g;if((g=Ext.fly(c).hasClass("syno-ux-button"))||(g=Ext.fly(c).findParent(".syno-ux-button",3))){if(!Ext.fly(g).hasClass("x-item-disabled")){var f;var h=this._getReplacerRecByReplaceeId(d);if(h){f=h}else{if(this._isUpgradableFromBetaToStable(d)||this._isRepairableFromBetaToStable(d)){f=this._getSynoServerObj().store.getById(d)}else{f=this.getRecFromSameChannel(d)}}if(f){this.applyStatusData(f.data,this.panelName==="SYNO.SDS.PkgManApp.Beta.Panel")}this._onClickSynoPkgActionBtn(f)}}else{SYNO.SDS.PkgManApp.Window.jumpTo(this.panelName,1,d)}},refresh:function(){this.callParent(arguments);this.fireEvent("widthset")},determineVisibility:function(a){if(0<a.length){this.owner.show()}else{this.owner.hide()}},getDesc:Ext.emptyFn,getStatus:function(c){var b=Ext.copyTo({},c,Object.keys(c));this.applyStatusData(b,this.panelName==="SYNO.SDS.PkgManApp.Beta.Panel");var a=this.getStatusStyle(b.status,b);return String.format('<font ext:qtip="{1}" class="syno-pkg-status" style="color:{0};">{1}</font>',a.color,a.text)},getIcon:Ext.emptyFn,onUpdate:Ext.emptyFn,getTitle:function(a){var c;var b=this.getRecFromSameChannel(a.id);if(this._isUpgradableFromBetaToStable(a.id)){b=SYNO.SDS.PkgManApp.Window.getStore("stable").getById(a.id)}if(b){c=SYNO.SDS.PkgManApp.Utils.Helper.encodeMsg(b.get("dname"))||SYNO.SDS.PkgManApp.Utils.Helper.encodeMsg(b.get("id"))}return c||SYNO.SDS.PkgManApp.Utils.Helper.encodeMsg(a.dname)||SYNO.SDS.PkgManApp.Utils.Helper.encodeMsg(a.id)},getBetaClass:Ext.emptyFn});Ext.define("SYNO.SDS.PkgManApp.Utils.PkgList",{extend:"Ext.Container",helper:SYNO.SDS.PkgManApp.Utils.Helper,constructor:function(a){SYNO.SDS.PkgManApp.Utils.Utils._initWinWrappers.call(this,a);this.callParent([this.fillConfig(a)]);this.mon(this.store,"load",this.setGroupBtn,this)},fillConfig:function(a){this.store=a.store;this.owner=a.owner;this.showTBarBtns=a.showTBarBtns;this.panelName=a.panelName;this.goSearch=a.goSearch;var b=[];if(a.showTBar){b.push(this.createTBar(a.headerText,a.showTBarBtns))}if(a.viewType==="card"){this._view=this.createCardView()}else{this._view=this.createListView()}b.push(this._view);b.push({xtype:"box",cls:"x-clear"});var c={items:b,cls:"syno-pkglist-container",listeners:{afterlayout:this._afterlayout,buffer:1}};Ext.apply(c,a);return c},_activate:function(){if(this.viewType==="card"){this._view.fireEvent("activate")}},_afterlayout:function(a,b){if(this.viewType==="card"){this._view.fireEvent("resize")}},setGroupBtn:function(){if(!this.showTBarBtns){return}this.repairBtn.hide();this.upgradeBtn.hide();var a=false,b=false;this.store.each(function(c){var d=c.data;if(d.status==="loading"){return}if(this._isRepairable(d)){a=true}else{if(this._isUpgradable(d.id)||this._isUpgradableFromBetaToStable(d.id)){b=true}}},this);if(a){this.repairBtn.show()}if(b){this.upgradeBtn.show()}},createTBar:function(c,b){var a=[{xtype:"displayfield",cls:"syno-pkglist-header",style:{fontSize:"15px"},value:c}];if(b){this.repairBtn=new SYNO.ux.Button({text:this.helper.T("repair_all"),btnStyle:"orange",width:"auto",hidden:true,scope:this,handler:this.repairAll});this.upgradeBtn=new SYNO.ux.Button({text:this.helper.T("update_all"),btnStyle:"green",width:"auto",hidden:true,scope:this,handler:this.updateAll});a.push("->");a.push(this.repairBtn);a.push({xtype:"displayfield",width:"3px"});a.push(this.upgradeBtn)}return new SYNO.ux.Toolbar({style:{borderStyle:"none"},items:a})},repairAll:function(){this._onClickUpdateAll(true)},updateAll:function(){this._onClickUpdateAll(false)},createListView:function(){return new SYNO.SDS.PkgManApp.Utils.PkgListListView({store:this.store,panel:this.owner,owner:this})},setGroupBtnAndRefreshView:function(){this.setGroupBtn();this._view.refresh();this._view._onStoreLoad()},createCardView:function(){return new SYNO.SDS.PkgManApp.Utils.PkgListCardView({store:this.store,panel:this.owner,owner:this})}});Ext.define("SYNO.SDS.PkgManApp.All.SynologyCardView",{extend:"SYNO.SDS.PkgManApp.Utils.PkgListCardView",constructor:function(a){this.callParent([a])},collectData:function(a,c){if(this.goSearch){return this.filterCollectData(a,c)}var b=[];Ext.each(a,function(d){if(0>d.data.maintainer.indexOf("Synology")){return}b.push(d.data)});this.determineVisibility(b);return b},getBetaClass:function(a){return""},getPrice:function(a){return SYNO.SDS.PkgManApp.Utils.Helper.getPriceFormatString(a.price,SYNO.SDS.PkgManApp.Window.synoAccountInfo.currency)},getIcon:SYNO.SDS.PkgManApp.Utils.Helper.getIconFromServer});Ext.define("SYNO.SDS.PkgManApp.All.SynologyPkgList",{extend:"SYNO.SDS.PkgManApp.Utils.PkgList",constructor:function(a){this.callParent([a])},createCardView:function(){return new SYNO.SDS.PkgManApp.All.SynologyCardView({store:this.store,panel:this.owner,panelName:this.panelName,goSearch:this.goSearch,owner:this})}});Ext.define("SYNO.SDS.PkgManApp.All.ThirdPartyCardView",{extend:"SYNO.SDS.PkgManApp.Utils.PkgListCardView",constructor:function(a){this.callParent([a])},collectData:function(a,c){var b=[];Ext.each(a,function(d){if(0<=d.data.maintainer.indexOf("Synology")){return}b.push(d.data)});this.determineVisibility(b);return b},getBetaClass:function(a){return""},getPrice:function(a){return SYNO.SDS.PkgManApp.Utils.Helper.getPriceFormatString(a.price,SYNO.SDS.PkgManApp.Window.synoAccountInfo.currency)},getIcon:SYNO.SDS.PkgManApp.Utils.Helper.getIconFromServer});Ext.define("SYNO.SDS.PkgManApp.All.ThirdPartyPkgList",{extend:"SYNO.SDS.PkgManApp.Utils.PkgList",constructor:function(a){this.callParent([a])},createCardView:function(){return new SYNO.SDS.PkgManApp.All.ThirdPartyCardView({store:this.store,panel:this.owner,panelName:this.panelName,owner:this})}});Ext.ns("SYNO.SDS.PkgManApp.All");Ext.define("SYNO.SDS.PkgManApp.All.SortBtnItemMenu",{extend:"SYNO.ux.Menu",helper:SYNO.SDS.PkgManApp.Utils.Helper,constructor:function(a){this.callParent([this.fillConfig(a)])},fillConfig:function(a){var b={hideOnScroll:true,cls:"syno-ux-searchfield-menu",autoDestroy:true,width:260,items:[{xtype:"menucheckitem",group:"type",itemId:"type_popularity",text:this.helper.T("sort_by_recent_popularity")},{xtype:"menucheckitem",group:"type",itemId:"type_name",text:this.helper.T("sort_by_name"),checked:true},"-",{xtype:"menucheckitem",toggleGroup:"filter",itemId:"filter_installed",text:this.helper.T("filter_installed")}]};Ext.each(b.items,function(c){Ext.QuickTips.register({target:c,text:c.text})});Ext.apply(b,a);return b},onRender:function(b,a){SYNO.SDS.PkgManApp.All.SortBtnItemMenu.superclass.onRender.call(this,b,a);this.keyNav.destroy();this.keyNav=null;this.keyNav=new SYNO.ux.ScheduleMenuNav(this)}});Ext.define("SYNO.SDS.PkgManApp.All.SortBtn",{extend:"Ext.form.TriggerField",helper:SYNO.SDS.PkgManApp.Utils.Helper,overCls:"syno-ux-triggerfield-hover",triggerClass:"syno-ux-triggerfield-trigger",constructor:function(a){this.menu=new SYNO.SDS.PkgManApp.All.SortBtnItemMenu();this.callParent([this.fillConfig(a)]);this.addClass("syno-ux-triggerfield");this.menu.mon(this.menu,"hide",this.onHide,this);this.menu.mon(this.menu,"click",this.onSortMenuClick,this);this.mon(this,"afterrender",function(){this.setSortText();if(!this.keyNav){this.keyNav=new Ext.KeyNav(this.el,{down:function(b){if(!this.menu.isVisible()){this.onTriggerClick()}},scope:this})}});Ext.QuickTips.register({target:this,text:this.text})},fillConfig:function(a){this.filterInstalled=false;var b={allowBlank:false,editable:false,width:260,height:32,text:this.helper.T("sort_by_name")};Ext.apply(b,a);return b},onTriggerClick:function(){this.menu.show(this.el)},onHide:function(){this.setSortText();this.focus()},onMouseover:function(){this.addClass("syno-ux-triggerfield-hover");this.trigger.addClass("x-form-trigger-over")},onMouseout:function(){this.removeClass("syno-ux-triggerfield-hover");this.trigger.removeClass("x-form-trigger-over")},markInvalid:function(a){this.callParent(arguments);this.trigger.addClass("syno-ux-trigger-invalid")},clearInvalid:function(){this.callParent(arguments);this.trigger.removeClass("syno-ux-trigger-invalid")},onRender:function(b,a){this.callParent(arguments);if(this.label){this.label.addClass("syno-ux-item-label")}SYNO.ux.Utils.setFormItemIndent(this);SYNO.ux.Utils.setFormFieldWidth(this)},onDestroy:function(){this.keyNav.destroy()},getSortType:function(){return this._sortType||"type_name"},setSortType:function(a){this._sortType=a},onSortMenuClick:function(b,a){if(a.itemId==="filter_installed"){this.filterInstalled=a.checked}else{this.setSortType(a.itemId)}this.setSortText();this.owner.onFilterStore(true)},setSortText:function(){var a=this.menu.getComponent(this.getSortType()).text;Ext.QuickTips.register({target:this,text:a});SYNO.SDS.PkgManApp.All.SortBtn.superclass.setValue.call(this,a)},sortStore:function(d){var c="dname",b="ASC",e=this.getSortType();if(e==="type_popularity"){c="recent_download_count";b="DESC"}var f=function(g,h){if(Ext.isNumber(g.data[c])){return g.data[c]-h.data[c]}else{return g.data[c].localeCompare(h.data[c])}};var a=function(g,h){if(Ext.isNumber(g.data[c])){return h.data[c]-g.data[c]}else{return h.data[c].localeCompare(g.data[c])}};d.data.sort("ASC",("ASC"==b)?f:a);d.fireEvent("datachanged",this)}});Ext.define("SYNO.SDS.PkgManApp.All.Panel",{extend:"SYNO.ux.Panel",helper:SYNO.SDS.PkgManApp.Utils.Helper,pkgListPaddingRight:20,constructor:function(a){this.callParent([this.fillConfig(a)]);this.pkgLists.each(function(b){this.mon(b._view,"widthset",this.updateListviewFleXcroll,this)},this);this.mon(this.store,"load",this.onFilterStore,this);this.needFilter=true;this.mon(this.store,"load",function(){this.getEl().unmask()},this);this.mon(this.store,"exception",function(){this.getEl().unmask();this.getEl().mask(this.helper.T("commfail"),"")},this)},fillConfig:function(a){this.panelName="SYNO.SDS.PkgManApp.All.Panel";this.listView=this.createListView();this.listView.updateFleXcroll=this._updateFleXcroll;var b=[this.listView,new SYNO.SDS.PkgManApp.Detail.Container({panel:"all",targetStore:"stable"})];var c={layout:"card",border:false,activeItem:0,items:b,store:SYNO.SDS.PkgManApp.Window.getStore("stable"),listeners:{activate:this._onActivate}};Ext.apply(c,a);return c},_updateFleXcroll:function(){this.superclass().updateFleXcroll.call(this);var b=Ext.fly(Ext.DomQuery.selectNode("a.syno-pkg-tof",this.getEl().dom));if(b&&this.getEl().dom.fleXdata){var a=this.getEl().dom.fleXdata.scrollPosition[1][1];if(false!==a){b.setStyle("position","static")}else{b.setStyle("position","absolute");b.setStyle("bottom",-(this.getEl().getBottom(true)-this.getEl().dom.firstChild.firstChild.getHeight()-12)+"px")}}},createBanner:function(){return new SYNO.SDS.PkgManApp.All.Banner({cls:"syno-pkg-banner",owner:this,store:SYNO.SDS.PkgManApp.Window.getStore("banner")})},createTBar:function(){this.category="all";this.categorySelector=new SYNO.ux.ComboBox({itemId:"category",displayField:"dname",cls:"syno-pkg-combobox",valueField:"id",width:280,store:SYNO.SDS.PkgManApp.Window.getStore("category"),value:this.helper.T("class_all"),listeners:{scope:this,select:this.onCategoryChange,afterrender:function(){var a=document.createElement("div");a.className="syno-pkg-category-icon x-combo-list-item-all";var b=document.getElementsByClassName("syno-pkg-combobox")[0];b.parentNode.insertBefore(a,b);Ext.QuickTips.register({target:this.categorySelector,text:this.categorySelector.value})}.createDelegate(this)},tpl:'<tpl for="."><div class="x-combo-list-item" ext:qtip="{dname}"><div class="x-combo-list-item-{id}"></div>{dname}</div></tpl>'});this.sortBtn=new SYNO.SDS.PkgManApp.All.SortBtn({owner:this});return new SYNO.ux.Toolbar({cls:"syno-pkg-category-toolbar",items:[this.categorySelector,{xtype:"displayfield",width:"6px"},this.sortBtn],style:{height:"32px",padding:"0",borderStyle:"none"}})},createListView:function(){this.synologyPkgList=new SYNO.SDS.PkgManApp.All.SynologyPkgList({owner:this,style:{marginTop:"12px"},showTBar:true,store:SYNO.SDS.PkgManApp.Window.getStore("stable"),viewType:"card",panelName:this.panelName,headerText:this.helper.T("synology")});this.thirdPartyPkgList=new SYNO.SDS.PkgManApp.All.ThirdPartyPkgList({owner:this,style:{marginTop:"12px"},showTBar:true,store:SYNO.SDS.PkgManApp.Window.getStore("stable"),viewType:"card",panelName:this.panelName,headerText:this.helper.T("thirdparty")});this.banner=this.createBanner();this.banner.hide();this.pkgLists=[this.synologyPkgList,this.thirdPartyPkgList];var a=[this.banner,this.createTBar(),this.synologyPkgList,this.thirdPartyPkgList,new Ext.Container({cls:"syno-pkg-tof-container",html:String.format('<center><a href="{0}" target="_blank" class="syno-pkg-tof">{1}</a></center>',SYNO.SDS.PkgManApp.TOFURL,this.helper.T("termsofservice"))})];return new Ext.Container({owner:this,autoFlexcroll:true,cls:"syno-pkg-view",style:{paddingRight:this.pkgListPaddingRight+"px"},listeners:{resize:this._onResize},items:a})},updateListviewFleXcroll:function(){this.widthSetCount=this.widthSetCount||0;this.widthSetCount=(this.widthSetCount+1)%2;if(this.widthSetCount!==0){return}this.listView.updateFleXcroll()},_onResize:function(e,d,b,a,c){this.owner.pkgLists.each(function(f){f.getComponent(1).containerWidth=d-this.owner.pkgListPaddingRight},this)},onFilterStore:function(a){if(!this.isVisible()){this.needFilter=true;return}this.store.suspendEvents();this.store.filterBy(function(b){if("all"!==this.category&&-1===b.get("category").indexOf(this.category)){return false}if(this.sortBtn.filterInstalled&&SYNO.SDS.PkgManApp.Utils.Utils.isOnlyInstStatus(b.data)){return false}return true},this);this.sortBtn.sortStore(this.store);this.store.resumeEvents();if(a){this.refreshPkglistView()}},_onActivate:function(b){var a=SYNO.SDS.PkgManApp.Window.getStore("stable");if(a.exception){this.getEl().mask(this.helper.T("commfail"),"");return}if(!a.loading&&0===a.getTotalCount()){a.reload()}else{if(a.loading){this.getEl().mask(this.helper.T("common","loading"),"x-mask-loading")}else{if(this.needFilter){this.needFilter=false;this.onFilterStore(false)}this.refreshPkglistView()}}},refreshPkglistView:function(){this.pkgLists.each(function(a){a._activate()},this)},onCategoryChange:function(c,a){var b=document.getElementsByClassName("syno-pkg-category-icon")[0];Ext.QuickTips.register({target:this.categorySelector,text:a.data.dname});this.category=a.get("id");b.className="syno-pkg-category-icon x-combo-list-item-"+this.category;this.onFilterStore(true)}});Ext.define("SYNO.SDS.PkgManApp.Beta.BetaCardView",{extend:"SYNO.SDS.PkgManApp.Utils.PkgListCardView",constructor:function(a){this.callParent([a])},collectData:function(a,c){if(this.goSearch){return this.filterCollectData(a,c)}var b=[];Ext.each(a,function(d){b.push(d.data)});b.sort(this.sortFunction);this.determineVisibility(b);return b},getBetaClass:function(a){return"syno-pkglist-beta"},getPrice:function(a){return SYNO.SDS.PkgManApp.Utils.Helper.getPriceFormatString(a.price,SYNO.SDS.PkgManApp.Window.synoAccountInfo.currency)},isBeta:function(){return true},getIcon:SYNO.SDS.PkgManApp.Utils.Helper.getIconFromServer});Ext.define("SYNO.SDS.PkgManApp.Beta.BetaPkgList",{extend:"SYNO.SDS.PkgManApp.Utils.PkgList",constructor:function(a){this.callParent([a])},createCardView:function(){return new SYNO.SDS.PkgManApp.Beta.BetaCardView({store:this.store,panel:this.owner,panelName:this.panelName,goSearch:this.goSearch,owner:this})}});Ext.define("SYNO.SDS.PkgManApp.Beta.Panel",{extend:"SYNO.ux.Panel",helper:SYNO.SDS.PkgManApp.Utils.Helper,pkgListPaddingRight:20,constructor:function(a){this.callParent([this.fillConfig(a)]);this.mon(this.betaPkgList._view,"widthset",this.updateListviewFleXcroll,this);var b=SYNO.SDS.PkgManApp.Window.getStore("stable");this.mon(b,"load",function(){this.getEl().unmask();this.determineEmptyMask()},this);this.mon(b,"exception",function(){this.getEl().unmask();this.getEl().mask(this.helper.T("commfail"),"")},this)},fillConfig:function(a){this.panelName="SYNO.SDS.PkgManApp.Beta.Panel";this.listView=this.createListView();this.listView.updateFleXcroll=this._updateFleXcroll;var b=[this.listView,new SYNO.SDS.PkgManApp.Detail.Container({panel:"beta",targetStore:"beta"})];var c={layout:"card",border:false,activeItem:0,items:b,listeners:{activate:this._onActivate}};Ext.apply(c,a);return c},_updateFleXcroll:function(){this.superclass().updateFleXcroll.call(this);var b=Ext.fly(Ext.DomQuery.selectNode("a.syno-pkg-tof",this.getEl().dom));if(b&&this.getEl().dom.fleXdata){var a=this.getEl().dom.fleXdata.scrollPosition[1][1];if(false!==a){b.setStyle("position","static")}else{b.setStyle("position","absolute");b.setStyle("bottom",-(this.getEl().getBottom(true)-this.getEl().dom.firstChild.firstChild.getHeight()-12)+"px")}}},createListView:function(){this.betaPkgList=new SYNO.SDS.PkgManApp.Beta.BetaPkgList({owner:this,store:SYNO.SDS.PkgManApp.Window.getStore("beta"),panelName:this.panelName,viewType:"card"});var a=[this.betaPkgList,new Ext.Container({cls:"syno-pkg-tof-container",html:String.format('<center><a href="{0}" target="_blank" class="syno-pkg-tof">{1}</a></center>',SYNO.SDS.PkgManApp.TOFURL,this.helper.T("termsofservice"))})];return new Ext.Container({owner:this,autoFlexcroll:true,cls:"syno-pkg-view",style:{paddingRight:this.pkgListPaddingRight+"px"},listeners:{resize:this._onResize},items:a})},_onResize:function(e,d,b,a,c){if(this.owner.betaPkgList){this.owner.betaPkgList.getComponent(0).containerWidth=d-this.owner.pkgListPaddingRight}},_onActivate:function(b){if(!SYNO.SDS.UserSettings.getProperty("SYNO.SDS.PkgManApp.Instance","agreed_beta")){SYNO.SDS.PkgManApp.Window.getMsgBox().show({title:this.helper.T("tree","leaf_packagemanage"),msg:this.helper.T("pkgmgr","update_channel_desc"),buttons:Ext.MessageBox.OK,fn:function(){SYNO.SDS.UserSettings.setProperty("SYNO.SDS.PkgManApp.Instance","agreed_beta",true)},scope:this,cls:"syno-pkg-agree-beta-window"})}var a=SYNO.SDS.PkgManApp.Window.getStore("stable");if(a.exception){this.getEl().mask(this.helper.T("commfail"),"");return}if(!a.loading&&0===a.getTotalCount()){a.reload()}else{if(a.loading){this.getEl().mask(this.helper.T("common","loading"),"x-mask-loading")}else{this.determineEmptyMask();this.betaPkgList._activate()}}},determineEmptyMask:function(){var a=SYNO.SDS.PkgManApp.Window.getStore("beta");if(0===a.getTotalCount()){this.showEmptyMask()}else{this.hideEmptyMask()}},showEmptyMask:function(){if(this.emptyMask){this.emptyMask.show();return}this.emptyMask=this.body.createChild({tag:"div",cls:"synopkg-empty-pkglist-mask",children:[{tag:"div",cls:"synopkg-empty-pkglist-icon"},{tag:"div",cls:"synopkg-empty-pkglist-msg",html:_T("pkgmgr","empty_beta_pkg_list")}]})},hideEmptyMask:function(){if(this.emptyMask){this.emptyMask.hide()}},updateListviewFleXcroll:function(){this.listView.updateFleXcroll()}});Ext.define("SYNO.SDS.PkgManApp.Community.CommunityCardView",{extend:"SYNO.SDS.PkgManApp.Utils.PkgListCardView",constructor:function(a){this.callParent([a])},collectData:function(a,c){if(this.goSearch){return this.filterCollectData(a,c)}var b=[];Ext.each(a,function(d){b.push(d.data)});b.sort(this.sortFunction);this.determineVisibility(b);return b},getBetaClass:function(a){if(a.beta){return"syno-pkglist-beta"}else{return""}},getSubTitle:function(a){var b=this.getActionStatus(a);if(b){return b}return String.format('<span ext:qtip="{0}">{0}</span>',a.maintainer||"")},getPrice:function(a){return""},getIcon:SYNO.SDS.PkgManApp.Utils.Helper.getIconFromServer});Ext.define("SYNO.SDS.PkgManApp.Community.CommunityPkgList",{extend:"SYNO.SDS.PkgManApp.Utils.PkgList",constructor:function(a){this.callParent([a])},createCardView:function(){return new SYNO.SDS.PkgManApp.Community.CommunityCardView({store:this.store,panel:this.owner,panelName:this.panelName,goSearch:this.goSearch,owner:this})}});Ext.define("SYNO.SDS.PkgManApp.Community.Panel",{extend:"SYNO.ux.Panel",helper:SYNO.SDS.PkgManApp.Utils.Helper,pkgListPaddingRight:20,constructor:function(a){this.callParent([this.fillConfig(a)]);this.mon(this.communityPkgList._view,"widthset",this.updateListviewFleXcroll,this);var b=SYNO.SDS.PkgManApp.Window.getStore("community");this.mon(b,"load",function(){this.getEl().unmask()},this);this.mon(b,"exception",function(){this.getEl().unmask();this.getEl().mask(this.helper.T("commfail"),"")},this)},fillConfig:function(a){this.panelName="SYNO.SDS.PkgManApp.Community.Panel";this.listView=this.createListView();this.listView.updateFleXcroll=this._updateFleXcroll;var b=[this.listView,new SYNO.SDS.PkgManApp.Detail.Container({panel:"community",targetStore:"community"})];var c={layout:"card",border:false,activeItem:0,items:b,listeners:{activate:this._onActivate}};Ext.apply(c,a);return c},_updateFleXcroll:function(){this.superclass().updateFleXcroll.call(this);var b=Ext.fly(Ext.DomQuery.selectNode("a.syno-pkg-tof",this.getEl().dom));if(b&&this.getEl().dom.fleXdata){var a=this.getEl().dom.fleXdata.scrollPosition[1][1];if(false!==a){b.setStyle("position","static")}else{b.setStyle("position","absolute");b.setStyle("bottom",-(this.getEl().getBottom(true)-this.getEl().dom.firstChild.firstChild.getHeight()-12)+"px")}}},createListView:function(){this.communityPkgList=new SYNO.SDS.PkgManApp.Community.CommunityPkgList({owner:this,store:SYNO.SDS.PkgManApp.Window.getStore("community"),panelName:this.panelName,viewType:"card"});var a=[this.communityPkgList,new Ext.Container({cls:"syno-pkg-tof-container",html:String.format('<center><a href="{0}" target="_blank" class="syno-pkg-tof">{1}</a></center>',SYNO.SDS.PkgManApp.TOFURL,this.helper.T("termsofservice"))})];return new Ext.Container({owner:this,autoFlexcroll:true,cls:"syno-pkg-view",style:{paddingRight:this.pkgListPaddingRight+"px"},listeners:{resize:this._onResize},items:a})},_onResize:function(e,d,b,a,c){if(this.owner.communityPkgList){this.owner.communityPkgList.getComponent(0).containerWidth=d-this.owner.pkgListPaddingRight}},_onActivate:function(b){var a=SYNO.SDS.PkgManApp.Window.getStore("community");if(a.exception){this.getEl().mask(this.helper.T("commfail"),"");return}if(!a.loading&&0===a.getTotalCount()){a.reload()}else{if(a.loading){this.getEl().mask(this.helper.T("common","loading"),"x-mask-loading")}else{this.communityPkgList._activate()}}},updateListviewFleXcroll:function(){this.listView.updateFleXcroll()}});Ext.ns("SYNO.SDS.PkgManApp");SYNO.SDS.PkgManApp.Config={};Ext.apply(SYNO.SDS.PkgManApp.Config,{RECOMMEND_LIST_BIG_NUMBER:4,LIST_PKG_CELL_WIDTH:152,DEFAULT_CURRENCY:"USD",DEFICON_72:"images/package_center_72.png",DEFICON_256:"images/package_center_256.png",myDSRemindPassURL:"https://myds.synology.com/support/register_password_remind.php",myDSRegister:"https://myds.synology.com/support/register_form.php",agreed_tos_hash_key:"agreed_tos_hash",tos_hash_key:"tos_hash",tos_hash_timestamp_key:"tos_hash_timestamp"});SYNO.SDS.PkgManApp.SERVICE={};Ext.apply(SYNO.SDS.PkgManApp.SERVICE,{PKG_SERVICES_SSH:8,PKG_SERVICES_PGSQL:16});SYNO.SDS.PkgManApp.TOFURL="http://www.synology.com/company/term_packagecenter.php";Ext.define("SYNO.SDS.PkgManApp.Detail.RelatedPkgCardView",{extend:"SYNO.SDS.PkgManApp.Utils.PkgListCardView",constructor:function(a){this.callParent([a])},createTpl:function(){return new Ext.XTemplate('<tpl for=".">','<div data-id="{id}" class="syno-pkglist-related-card">','<div class="syno-pkglist-icon">','<img class="syno-pkg-icon-img" src="{[this.getTransparentDataURI()]}" style="background:url(\'{[this.getIcon(values, undefined)]}\');background-size:64px;">',"</div>",'<div class="syno-pkglist-info">','<span class="syno-pkglist-title">',"{[this.getTitle(values)]}","</span>",'<span class="syno-pkglist-subtitle">',"{[this.getSubTitle(values)]}","</span>","</div>",'<div class="syno-pkglist-btn">',"{[this.getActionBtn(values)]}","</div>","</div>","</tpl>",{compiled:true,disableFormats:true,getActionBtn:this.getActionBtn.createDelegate(this),getSubTitle:this.getSubTitle.createDelegate(this),getTransparentDataURI:SYNO.SDS.PkgManApp.Utils.Helper.getTransparentDataURI.createDelegate(this)})},collectData:function(a,i){var d=[];var b=this.owner.owner.getPkgData();var e=b.category;var h=[];var g=[];var c=3;var f=c;if(!e||!Ext.isArray(e)){return d}e.each(function(l){var j=SYNO.SDS.PkgManApp.Window.getStore("category");var k=j.getById(l);if(k.get("isCompilation")){h.push(l)}else{g.push(l)}},this);d=this.getRelatedPkgs(a,d,f,b,h,false,false);f=c-d.length;if(f>0){d=this.getRelatedPkgs(a,d,f,b,e,false,false);f=c-d.length}if(f>0){d=this.getRelatedPkgs(a,d,f,b,h,false,true);f=c-d.length}if(f>0){d=this.getRelatedPkgs(a,d,f,b,e,false,true);f=c-d.length}if(f>0){d=this.getRelatedPkgs(a,d,f,b,h,true,false);f=c-d.length}if(f>0){d=this.getRelatedPkgs(a,d,f,b,e,true,false);f=c-d.length}if(f>0){d=this.getRelatedPkgs(a,d,f,b,h,true,true);f=c-d.length}if(f>0){d=this.getRelatedPkgs(a,d,f,b,e,true,true);f=c-d.length}this.determineVisibility(d);return d},getRelatedPkgs:function(c,g,f,d,b,e,a){Ext.each(c,function(h){var i=h.get("thirdparty")||false;if(f===0||h.id===d.id){return}if(this._IsInstNormal(h.id)===e&&this.categoryIntersect(h.get("category"),b)&&i===a&&(!d.conflictpkgs||!(h.id in d.conflictpkgs))&&-1==g.indexOf(h.data)){g.push(h.data);f--}},this);return g},categoryIntersect:function(c,b){var a=false;if(!Ext.isArray(c)||!Ext.isArray(b)){return false}c.each(function(d){b.each(function(e){if(d===e){a=true}},this)},this);return a},getCardClass:function(){return".syno-pkglist-related-card"},getBetaClass:function(a){return""},getSubTitle:function(b){var d=this.getActionStatus(b);if(d){return d}var a=[];var c=SYNO.SDS.PkgManApp.Window.getStore("category");Ext.each(b.category,function(e){if(c.getById(e)){a.push(c.getById(e).get("dname"))}else{a.push(e)}});return a.join(", ")},onViewResize:function(){return},delayedViewResize:function(){return},getIcon:SYNO.SDS.PkgManApp.Utils.Helper.getIconFromServer});Ext.define("SYNO.SDS.PkgManApp.Detail.RelatedPkgList",{extend:"SYNO.SDS.PkgManApp.Utils.PkgList",constructor:function(a){this.callParent([a])},createCardView:function(){return new SYNO.SDS.PkgManApp.Detail.RelatedPkgCardView({store:this.store,panel:this.owner,panelName:this.panelName,owner:this})},refreshView:function(){return},onViewResize:function(){return}});Ext.define("SYNO.SDS.PkgManApp.Installed.CautionListView",{extend:"SYNO.SDS.PkgManApp.Utils.PkgListListView",constructor:function(a){SYNO.SDS.PkgManApp.Utils.Utils._initWinWrappers.call(this,a);this.callParent([a])},collectData:function(a,c){var b=[];Ext.each(a,function(d){if(SYNO.SDS.PkgManApp.Utils.Utils.isBrokenStatus(d.data)||this._isUpgradable(d.data.id)||this._isUpgradableFromBetaToStable(d.data.id)){b.push(d.data)}},this);b.sort(this.sortFunction);this.determineVisibility(b);return b},sortFunction:function(b,g){var c,a;var f=function(h){if(!SYNO.SDS.PkgManApp.Utils.Utils.isBrokenStatus(h)){return 3}switch(SYNO.SDS.PkgManApp.Utils.Utils.getBrokenStatus(h)){case"broken":case"license_error":case"broken_by_other":return 0;case"version_limit":return 1;default:return 2}};c=f(b);a=f(g);if(c===a){var e=b.dname||b.id;var d=g.dname||g.id;return e.localeCompare(d)}else{return c>a?1:-1}},getDesc:function(a){var b;var c=this._getReplacerRecByReplaceeId(a.id);if(c){return String.format("{0}",c.get("replace_message"))}if(SYNO.SDS.PkgManApp.Utils.Utils.isBrokenStatus(a)){switch(a.status){case"version_limit":if(this._isRepairable(a)){return _T("pkgmgr","broken_version_desc")}else{if(this._hasNewVersion(a.id,true)){return _T("pkgmgr","broken_version_update_to_beta_desc")}else{return _T("pkgmgr","broken_version_wo_update_desc")}}break;case"builtin":return _T("pkgmgr","buildin_desc");case"non_support":return String.format(_T("pkgmgr","pkgmgr_pkg_not_support_platform"),_D("product"));case"license_error":return _T("pkgmgr","license_err_desc");case"broken_by_other":return String.format(_T("pkgmgr","broken_by_pkg_desc"),a.broken_by);default:return _T("pkgmgr","broken_desc")}}if(this._isUpgradable(a.id)){b=this.getRecFromSameChannel(a.id);if(b){return String.format("{0}: {1}<br/>{2}",this.helper.T("pkgmgr_pkg_version"),b.get("version"),b.get("changelog"))}}else{if(this._isUpgradableFromBetaToStable(a.id)){b=SYNO.SDS.PkgManApp.Window.getStore("stable").getById(a.id);if(b){return String.format("{0}: {1}<br/>{2}",this.helper.T("pkgmgr_pkg_version"),b.get("version"),b.get("changelog"))}}}return SYNO.SDS.PkgManApp.Utils.Utils.encodedMsg(a.desc)},getActionBtn:function(d){var b=this._isRepairable(d);var a=this._isUpgradable(d.id)||this._isUpgradableFromBetaToStable(d.id);var e="";if(a||b){var c=this.getActionTemplate(d);e=c.actiontext}return e},getActionTemplate:function(o){var g=Ext.copyTo({},o,Object.keys(o));SYNO.SDS.PkgManApp.Window.applyStatusData(g,this.panelName==="SYNO.SDS.PkgManApp.Beta.Panel");var k=this._isQuickInstll(g);var b=this._isUpgradable(g.id)||this._isUpgradableFromBetaToStable(g.id);var n=g.status==="loading";var e=this.helper.getInstallationText(n,b,false,false,g.beta);var f="";var m=false;var h=(SYNO.SDS.PkgManApp.Utils.Utils.isBrokenStatus(g));var d=n?"":(h?"syno-ux-button-orange":"syno-ux-button-green");var i=false;var c='<div class="syno-pkg-btn';if(h){e=SYNO.SDS.PkgManApp.Utils.Utils.getBrokenStr(g)}if(k&&-1!==this._getInstallAll_Background().indexOf(g.id)){i=true;e=_T("vpnc","waiting")}var j=this._GetProcessStatus(g.status);if(j.blProcessing){f=j.msg;i=true}else{if(this._IsInstalling(g)){f=b?_T("pkgmgr","upgrading"):_T("pkgmgr","installing");i=true}}if(Ext.isDefined(g.progress)&&g.progress){if(0<g.progress){e=_T("common","cancel")}if(g.progress==1){}else{if(g.progress>0){d=" syno-ux-button-grey";if(0.00001>=g.progress){f=_T("vpnc","waiting")}else{f=Math.floor(g.progress*100)+"%<br>";if(this._IsInstalling(g)){if(j.blProcessing){f+=j.msg}else{f+=b?_T("pkgmgr","upgrading"):_T("pkgmgr","installing")}}else{f+=_T("download","download_task_downloading")}}}else{if(g.progress<0){m=true;f=b?_T("pkgmgr","upgrade_pkg_fail"):_T("pkgmgr","install_pkg_fail");f=String.format(f,g.dname,"");if(h){e=SYNO.SDS.PkgManApp.Utils.Utils.getBrokenStr(g)}else{e=this.helper.getInstallationText(n,b,false,false,g.beta)}}}}}var a;if(g&&g.progress<0){m=true;f=this._IsInstalling(g)?_T("pkgmgr","install_pkg_fail"):_T("pkgmgr","download_pkg_fail");f=String.format(f,g.dname,"")}if(_S("demo_mode")){i=true;c+=('" ext:qtip="'+_JSLIBSTR("uicommon","error_demo"))}if(n){i=true}c+='">'+this.getBtnTemplate(e,d,i,g.dname)+"</div>";var l=f;if(!m&&f){l="<div class='syno-pkg-status'>";l+="<font style='color:#0086E6;display:table;margin:auto;' ext:qtip='"+f+"'>";l+="&nbsp;";l+=f;l+="</font></div>"}return{actiontext:c,statustext:l,callback:a?a.callback:undefined}},getBtnTemplate:function(f,b,e,d){var a=String.format("aria-label='{0} {1}'",f,d?d:"");var c='<span cellspacing="0" class="x-btn syno-ux-button '+(b||"syno-ux-button-grey")+(e?" x-item-disabled":"")+' x-btn-noicon" style="width: auto; margin-left: 0px;"><em class=" x-unselectable" unselectable="on"><button type="button" class=" x-btn-text" '+a+">"+f+"</button></em></span>";return c},getIcon:function(b,c){var a=this._getOperableExceptReplaceTargetStoreById(b.id);var d=SYNO.SDS.PkgManApp.Window.getStore(a).getById(b.id);if(a==="installed"){return this.helper.getIconFromDS(d.data,c)}else{return this.helper.getIconFromServer(d.data,c)}},getBetaClass:function(a){var b=a.beta;if(this._isUpgradableFromBetaToStable(a.id)){b=false}if(b){return"syno-pkglist-beta"}else{return""}}});Ext.define("SYNO.SDS.PkgManApp.Installed.CautionPkgList",{helper:SYNO.SDS.PkgManApp.Utils.Helper,extend:"SYNO.SDS.PkgManApp.Utils.PkgList",constructor:function(a){this.callParent([a]);this.mon(SYNO.SDS.PkgManApp.Window.getStore("stable"),"load",this.setGroupBtnAndRefreshView,this);this.mon(SYNO.SDS.PkgManApp.Window.getStore("community"),"load",this.setGroupBtnAndRefreshView,this);this.mon(SYNO.SDS.PkgManApp.Window.getStore("installed"),"load",this.setGroupBtnAndRefreshView,this);this.setGroupBtn()},createListView:function(){return new SYNO.SDS.PkgManApp.Installed.CautionListView({store:this.store,panel:this.owner,panelName:this.panelName,owner:this})}});Ext.define("SYNO.SDS.PkgManApp.Installed.InstalledCardView",{extend:"SYNO.SDS.PkgManApp.Utils.PkgListCardView",constructor:function(a){this.callParent([a])},collectData:function(a,c){if(this.goSearch){return this.filterCollectData(a,c)}var b=[];Ext.each(a,function(d){if(SYNO.SDS.PkgManApp.Utils.Utils.isBrokenStatus(d.data)||this._isUpgradable(d.data.id)||this._isUpgradableFromBetaToStable(d.data.id)){return}b.push(d.data)},this);b.sort(this.sortFunction);this.determineVisibility(b);return b},sortFunction:function(a,b){return b.updated_at.localeCompare(a.updated_at)},getBetaClass:function(a){if(a.beta){return"syno-pkglist-beta"}else{return""}},getSubTitle:function(a){if(a.status==="loading"){return String.format('<span ext:qtip="{0}><font class="syno-pkg-status" style="color:#0086E6;">{0}</font></span>',_T("pkgmgr","loading"))}else{if(a.updated_at){var d=a.updated_at.split("/");var b=new Date(d[0],d[1]-1,d[2]);var c=SYNO.SDS.DateTimeFormatter(b,{type:"date"});return String.format('<span ext:qtip="{0}">{0}</span>',c)}}return""},getPrice:function(a){return""},getIcon:SYNO.SDS.PkgManApp.Utils.Helper.getIconFromDS});Ext.define("SYNO.SDS.PkgManApp.Installed.InstalledPkgList",{extend:"SYNO.SDS.PkgManApp.Utils.PkgList",constructor:function(a){this.callParent([a]);this.mon(SYNO.SDS.PkgManApp.Window.getStore("stable"),"load",this.setGroupBtnAndRefreshView,this);this.mon(SYNO.SDS.PkgManApp.Window.getStore("community"),"load",this.setGroupBtnAndRefreshView,this)},createCardView:function(){return new SYNO.SDS.PkgManApp.Installed.InstalledCardView({store:this.store,panel:this.owner,panelName:this.panelName,goSearch:this.goSearch,owner:this})}});Ext.define("SYNO.SDS.PkgManApp.Installed.Panel",{extend:"SYNO.ux.Panel",helper:SYNO.SDS.PkgManApp.Utils.Helper,pkgListPaddingRight:20,constructor:function(a){this.callParent([this.fillConfig(a)]);this.mon(this.cautionPkgList._view,"widthset",this.updateListviewFleXcroll,this);this.mon(this.installedPkgList._view,"widthset",this.updateListviewFleXcroll,this)},fillConfig:function(a){this.panelName="SYNO.SDS.PkgManApp.Installed.Panel";this.listView=this.createListView();var b=[this.listView,new SYNO.SDS.PkgManApp.Detail.Container({panel:"installed",targetStore:"installed"})];var c={layout:"card",border:false,activeItem:0,items:b,listeners:{activate:this._onActivate}};Ext.apply(c,a);return c},createListView:function(){this.cautionPkgList=new SYNO.SDS.PkgManApp.Installed.CautionPkgList({owner:this,showTBar:true,style:{marginBottom:"17px"},store:SYNO.SDS.PkgManApp.Window.getStore("installed"),viewType:"list",showTBarBtns:true,panelName:this.panelName,headerText:this.helper.T("status_broken_title")});this.installedPkgList=new SYNO.SDS.PkgManApp.Installed.InstalledPkgList({owner:this,showTBar:true,store:SYNO.SDS.PkgManApp.Window.getStore("installed"),viewType:"card",panelName:this.panelName,headerText:this.helper.T("install_packages")});var a=[this.cautionPkgList,this.installedPkgList];return new Ext.Container({owner:this,autoFlexcroll:true,cls:"syno-pkg-view",style:{paddingRight:this.pkgListPaddingRight+"px",paddingBottom:"17px"},listeners:{resize:this._onResize},items:a})},_onResize:function(e,d,b,a,c){if(this.owner.installedPkgList){this.owner.installedPkgList.getComponent(1).containerWidth=d-this.owner.pkgListPaddingRight}},_onActivate:function(a){this.cautionPkgList._activate();this.installedPkgList._activate()},updateListviewFleXcroll:function(){this.listView.updateFleXcroll()}});Ext.ns("SYNO.SDS.PkgManApp");SYNO.SDS.PkgManApp.TermConfirmDialog=Ext.extend(SYNO.SDS.ModalWindow,{constructor:function(a){Ext.apply(this,a);var b=Ext.apply({owner:a.owner,resizable:false,minimizable:false,maximizable:false,closable:false,stateful:false,footer:true,title:_T("tree","leaf_packagemanage"),cls:"x-window-dlg",items:[{xtype:"syno_formpanel",items:[{xtype:"syno_displayfield",htmlEncode:false,value:a.msg||String.format(_T("pkgmgr","termsofservice_desc"),String.format('<a href="{0}" target="_blank" class="pathlink">{1}</a>',SYNO.SDS.PkgManApp.TOFURL,_T("pkgmgr","termsofservice")))},{ctCls:"syno-pkg-termdlg-check",xtype:"syno_checkbox",itemId:"option",boxLabel:_T("pkgmgr","termsofservice_accept"),listeners:{check:{fn:function(d,c){this.btnOK.setDisabled(!c)},scope:this}}}]}],fbar:new Ext.Toolbar({items:[this.btnOK=new SYNO.ux.Button({btnStyle:"blue",id:this.btnOKId=Ext.id(),text:_T("common","ok"),scope:this,disabled:true,handler:this.onClickOK}),{xtype:"syno_button",text:_T("common","cancel"),scope:this,handler:this.onClickClose}],enableOverflow:false}),keys:[{key:27,fn:this.onClickClose,scope:this}]},a);SYNO.SDS.PkgManApp.TermConfirmDialog.superclass.constructor.call(this,b)},onClickOK:function(){this.owner.appInstance.setUserSettings(SYNO.SDS.PkgManApp.Config.termofservice,true);this.owner.appInstance.setUserSettings(SYNO.SDS.PkgManApp.Config.termofservice_4_2,true);this.owner.appInstance.setUserSettings(SYNO.SDS.PkgManApp.Config.agreed_tos_hash_key,this.tos_hash);this.owner.appInstance.setUserSettings(SYNO.SDS.PkgManApp.Config.tos_hash_key,this.tos_hash);this.owner.appInstance.setUserSettings(SYNO.SDS.PkgManApp.Config.tos_hash_timestamp_key,this.tos_hash_timestamp);this.close()},onClickClose:function(){this.owner.close()}});Ext.define("SYNO.SDS.PkgManApp.Term.Base",{extend:SYNO.ux.Panel,EXPAND_CLS:"expanded",COLLAPSE_CLS:"collapsed",constructor:function(a){Ext.apply(this,a);var b={items:this.createItems(),cls:String.format("syno-pkg-term-field {0}",this.termCollapsed?this.COLLAPSE_CLS:this.EXPAND_CLS),width:680};this.callParent([Ext.apply(b,a)]);this.relayEvents(this.getCheckBox(),["check"])},createItems:function(){return[{xtype:"box",cls:"syno-pkg-term-title",itemId:"syno-pkg-term-title",html:this.title,listeners:{afterrender:this.onTitleAfterRender.bind(this)}},{xtype:"container",cls:"syno-pkg-term-container",itemId:"syno-pkg-term-container",items:[{xtype:"box",cls:"syno-pkg-term-subtitle",html:this.subTitle,height:48},new SYNO.ux.Panel({xtype:"box",cls:"syno-pkg-term-content",itemId:"syno-pkg-term-content",autoFlexcroll:true,items:[{xtype:"box",cls:"syno-pkg-term-content-inner",itemId:"syno-pkg-term-content-inner",html:this.termContent||["<h1>Privacy</h1>","<h2>Privacy Statement</h2>","<p>Synology Inc. is commited to protecting ","the personal information .....</p>"].join("")}],height:262}),{xtype:"syno_checkbox",cls:"syno-pkg-term-check",itemId:"syno-pkg-term-check",height:28,boxLabel:this.checkBoxMsg}]}]},isExpanded:function(){return this.el.hasClass(this.EXPAND_CLS)},isAgree:function(){return this.getCheckBox().getValue()},expand:function(){this.el.replaceClass(this.COLLAPSE_CLS,this.EXPAND_CLS)},collapse:function(){this.el.replaceClass(this.EXPAND_CLS,this.COLLAPSE_CLS)},getCheckBox:function(){var a=this.getComponent("syno-pkg-term-container");return a.getComponent("syno-pkg-term-check")},onTitleAfterRender:function(a){a.el.on("click",function(){var b=this.isExpanded();this.fireEvent("titleclick",this,!b);this[b?"collapse":"expand"]()},this);a.el.on("mouseover",function(){var b=this.isExpanded();if(!b){this.el.addClass("titlehover")}},this);a.el.on("mouseout",function(){this.el.removeClass("titlehover")},this)}});Ext.define("SYNO.SDS.PkgManApp.Term.Service",{extend:SYNO.SDS.PkgManApp.Term.Base,constructor:function(a){var b={title:_T("pkgmgr","termofservice_title")||"Synology Package Center Terms of Service",subTitle:_T("pkgmgr","termofservice_subtitle")||["Your Synology device is easily customizable with ","additional functionality. Before we begin, you will ","need to read and agree to the Package Center Terms ","of Service."].join(""),termContent:_T("pkgmgr","termofservice_content"),checkBoxMsg:_T("pkgmgr","termofservice_confirm")||["I have read and agreed to the Package Center ","Terms of Service"].join("")};this.callParent([Ext.apply(b,a)])}});Ext.define("SYNO.SDS.PkgManApp.Term.Privacy",{extend:SYNO.SDS.PkgManApp.Term.Base,constructor:function(a){var b={title:_T("pkgmgr","termofprivacy_title")||"Synology Package Center Privacy Statement",subTitle:_T("pkgmgr","termofprivacy_subtitle")||["In order to ensure security services and great ","user experience, Synology products may need ","essential data collection and usage. At any ","time, we process the information we receive ","according to Synology Privacy Statement."].join(""),termContent:_T("pkgmgr","termofprivacy_content"),checkBoxMsg:_T("pkgmgr","termofprivacy_confirm")||"I acknowledge the Privacy Statement"};this.callParent([Ext.apply(b,a)])}});Ext.define("SYNO.SDS.PkgManApp.TermDialog",{extend:SYNO.SDS.ModalWindow,constructor:function(a){Ext.apply(this,a);this.closeOwner=true;var b={width:720,height:592,closable:true,resizable:false,cls:"syno-pkg-term",itemId:"syno-pkg-term",title:_T("tree","leaf_packagemanage"),items:[this.createItems()]};this.callParent([Ext.apply(b,a)]);this.bindEvents()},createItems:function(){this.btnOk=new SYNO.ux.Button({btnStyle:"blue",cls:"syno-pkg-term-btn",text:_T("common","ok"),scope:this,disabled:true,handler:this.onClickOk});Ext.QuickTips.register({target:this.btnOk,text:_T("pkgmgr","term_remind")||"Please read term of service and privacy"});var a=[new SYNO.SDS.PkgManApp.Term.Service({itemId:"ToS",termCollapsed:false}),{xtype:"box",cls:"divider",width:680,height:1},new SYNO.SDS.PkgManApp.Term.Privacy({itemId:"ToP",termCollapsed:true}),this.btnOk];return a},bindEvents:function(){var b=this.getComponent("ToS"),a=this.getComponent("ToP");this.mon(b,"check",function(d,c){this.onCheck(b,a,c)},this,{delay:10});this.mon(a,"check",function(d,c){this.onCheck(a,b,c)},this,{delay:10});this.mon(b,"titleclick",function(c,d){a[d?"collapse":"expand"]()});this.mon(a,"titleclick",function(c,d){b[d?"collapse":"expand"]()});this.mon(this,"close",function(){if(this.closeOwner){this.owner.fireEvent.defer(10,this.owner,["disagreeterm"])}},this)},onCheck:function(d,a,c){var b=!(d.isAgree()&&a.isAgree());if(c&&!a.isAgree()){d.collapse.defer(200,d);a.expand.defer(200,a)}this.btnOk.setDisabled(b);if(b){Ext.QuickTips.register({target:this.btnOk,text:_T("pkgmgr","term_remind")||"Please read term of service and privacy"})}else{Ext.QuickTips.unregister(this.btnOk)}},onClickOk:function(){if(this.curr_term_version){SYNO.SDS.UserSettings.setProperty("SYNO.SDS.PkgManApp.Instance","agreed_term_version",this.curr_term_version)}this.closeOwner=false;this.close()}});Ext.ns("SYNO.SDS.PkgManApp.Utils");SYNO.SDS.PkgManApp.Utils.StoreHelper={createInstalledStore:function(){return new SYNO.API.Store({autoLoad:false,remoteSort:false,proxy:new Ext.data.MemoryProxy([]),reader:new Ext.data.JsonReader({root:"packages",id:"id"},[{name:"id"},{name:"dname",mapping:"name"},{name:"desc",mapping:"additional.description"},{name:"desc_enu",mapping:"additional.description_enu"},{name:"version"},{name:"status",mapping:"additional.status"},{name:"broken_by",mapping:"additional.broken_by"},{name:"progress",mapping:"additional.installing_progress"},{name:"maintainer",mapping:"additional.maintainer"},{name:"maintainer_url",mapping:"additional.maintainer_url"},{name:"distributor",mapping:"additional.distributor"},{name:"distributor_url",mapping:"additional.distributor_url"},{name:"url",mapping:"additional.url"},{name:"pkgstartable",mapping:"additional.startable",type:"boolean"},{name:"ctl_uninstall",mapping:"additional.ctl_uninstall",type:"boolean"},{name:"pkgisuninstui",mapping:"additional.is_uninstall_pages"},{name:"icon"},{name:"pkgreporturl",mapping:"additional.report_beta_url"},{name:"support_center",mapping:"additional.support_center"},{name:"beta",mapping:"additional.beta",type:"boolean"},{name:"support_url",mapping:"additional.support_url"},{name:"dsm_apps",mapping:"additional.dsm_apps"},{name:"pkgtarget",mapping:"additional.installed_info"},{name:"install_type",mapping:"additional.install_type"},{name:"inst_type"},{name:"autoupdate",mapping:"additional.autoupdate"},{name:"silent_upgrade",mapping:"additional.silent_upgrade"},{name:"updated_at",mapping:"additional.updated_at"}]),listeners:{scope:this}})},createBetaStore:function(){return new SYNO.API.Store({autoLoad:false,remoteSort:false,proxy:new Ext.data.MemoryProxy([]),reader:new Ext.data.JsonReader({root:"beta_packages",id:"id"},this.getServerStoreItem())})},createBannerStore:function(){return new SYNO.API.Store({autoLoad:false,remoteSort:false,proxy:new Ext.data.MemoryProxy([]),reader:new Ext.data.JsonReader({root:"banners"},[{name:"title"},{name:"descr"},{name:"background"},{name:"icon"},{name:"type"},{name:"keyword"},{name:"link"},{name:"beta",type:"boolean"},{name:"css_icon",mapping:"css.icon"},{name:"css_title",mapping:"css.title"},{name:"css_desc",mapping:"css.desc"},{name:"css_triangle",mapping:"css.triangle"},{name:"css_string",mapping:"css.string"}])})},createReplacementStore:function(){return new SYNO.API.Store({autoLoad:false,remoteSort:false,proxy:new Ext.data.MemoryProxy([]),reader:new Ext.data.JsonReader({root:"replacement",id:"id"},[{name:"id"},{name:"replacedby"}])})},createCategoryStore:function(){return new SYNO.API.Store({autoLoad:false,remoteSort:false,proxy:new Ext.data.MemoryProxy([]),reader:new Ext.data.JsonReader({root:"categories",id:"id"},[{name:"id"},{name:"dname"},{name:"descr"},{name:"isCompilation",type:"boolen"}])})},getServerStoreItem:function(){return[{name:"id"},{name:"desc"},{name:"desc_enu"},{name:"changelog"},{name:"version"},{name:"icon"},{name:"link"},{name:"md5"},{name:"source"},{name:"dsm_apps"},{name:"url"},{name:"open"},{name:"thumbnail"},{name:"thumbnail_retina"},{name:"snapshot"},{name:"install_type"},{name:"install_on_cold_storage"},{name:"depsers"},{name:"deppkgs"},{name:"conflictpkgs"},{name:"breakpkgs"},{name:"replacepkgs"},{name:"replaceforcepkgs"},{name:"replace_message"},{name:"maintainer"},{name:"maintainer_url"},{name:"distributor"},{name:"distributor_url"},{name:"blupgrade"},{name:"beta"},{name:"support_url"},{name:"broken_by"},{name:"thirdparty"},{name:"info"},{name:"dname",sortType:function(a){if(!a){return""}return a.toLowerCase()}},{name:"size",type:"int"},{name:"progress",type:"float"},{name:"qinst",type:"boolean"},{name:"qupgrade",type:"boolean"},{name:"qstart",type:"boolean"},{name:"start",type:"boolean"},{name:"download_count",type:"int"},{name:"recent_download_count",type:"int"},{name:"type",type:"int"},{name:"price",type:"object"},{name:"category"}]}};Ext.define("SYNO.SDS.PkgManApp.Utils.SearchField",{extend:"SYNO.ux.TextFilter",constructor:function(a){this.callParent([this.fillConfig(a)])},fillConfig:function(a){var b={enableKeyEvents:true,listeners:{keypress:this._onKeypress}};Ext.apply(b,a);return b},_onKeypress:function(b,a){if(a.getKey()==Ext.EventObject.ENTER){a.preventDefault();if(this.isSearchPageActive()){SYNO.SDS.PkgManApp.Window.pageCt.ownerCt.pageCt.getComponent("SYNO.SDS.PkgManApp.SearchResult.Panel")._onActivate()}else{SYNO.SDS.PkgManApp.Window.pageList.getNodeById("SYNO.SDS.PkgManApp.SearchResult.Panel").select()}}},onTriggerClick:function(){this.callParent(arguments);if(this.isSearchPageActive()){SYNO.SDS.PkgManApp.Window.pageList.getNodeById("SYNO.SDS.PkgManApp.All.Panel").select()}},isSearchPageActive:function(){return SYNO.SDS.PkgManApp.Window.pageList.getNodeById("SYNO.SDS.PkgManApp.SearchResult.Panel").isSelected()},onResize:function(){}});Ext.define("SYNO.SDS.PkgManApp.SearchResult.Panel",{extend:"SYNO.ux.Panel",helper:SYNO.SDS.PkgManApp.Utils.Helper,pkgListPaddingRight:20,constructor:function(a){this.callParent([this.fillConfig(a)]);this.pkgLists.each(function(b){this.mon(b._view,"widthset",this.updateListviewFleXcroll,this);this.mon(b._view.store,"load",this.determineEmptyResultMask,this)},this)},fillConfig:function(a){this.panelName="SYNO.SDS.PkgManApp.SearchResult.Panel";this.listView=this.createListView();var b=[this.listView,new SYNO.SDS.PkgManApp.Detail.Container()];var c={searchtext:"",id:"SYNO.SDS.PkgManApp.SearchResult.Panel",layout:"card",border:false,activeItem:0,items:b,listeners:{activate:this._onActivate}};Ext.apply(c,a);return c},createDescriptionStore:function(){return new Ext.data.JsonStore({autoDestroy:true,fields:["title","description"]})},createDescription:function(){this.descriptionStore=this.createDescriptionStore();return new Ext.DataView({cls:"synopkg-search-result",tpl:new Ext.XTemplate('<tpl for=".">','<div class="title">',"<span>{title}</span>","</div>",'<div class="banner_robot">','<div class="robot_head"></div>','<span class="font">{description}</span>',"</div>","</tpl>",{compiled:true,disableFormats:true}),style:{marginBottom:"17px"},store:this.descriptionStore})},createListView:function(){this.description=this.createDescription();this.synologyPkgList=new SYNO.SDS.PkgManApp.All.SynologyPkgList({owner:this,style:{marginBottom:"17px"},showTBar:true,store:SYNO.SDS.PkgManApp.Window.getStore("stable"),viewType:"card",panelName:"SYNO.SDS.PkgManApp.All.Panel",goSearch:true,headerText:this.helper.T("class_all")});this.betaPkgList=new SYNO.SDS.PkgManApp.Beta.BetaPkgList({owner:this,style:{marginBottom:"17px"},showTBar:true,store:SYNO.SDS.PkgManApp.Window.getStore("beta"),viewType:"card",panelName:"SYNO.SDS.PkgManApp.Beta.Panel",goSearch:true,headerText:this.helper.T("class_beta")});this.communityPkgList=new SYNO.SDS.PkgManApp.Community.CommunityPkgList({owner:this,showTBar:true,store:SYNO.SDS.PkgManApp.Window.getStore("community"),viewType:"card",panelName:"SYNO.SDS.PkgManApp.Community.Panel",goSearch:true,headerText:this.helper.T("class_community")});var a=[this.description,this.synologyPkgList,this.betaPkgList,this.communityPkgList];this.pkgLists=a.slice(1);return new Ext.Container({owner:this,autoFlexcroll:true,cls:"syno-pkg-view",style:{paddingRight:this.pkgListPaddingRight+"px",paddingBottom:"17px"},listeners:{resize:this._onResize},items:a})},_onResize:function(e,d,b,a,c){this.owner.pkgLists.each(function(f){f.getComponent(1).containerWidth=d-this.owner.pkgListPaddingRight},this)},onLoadData:function(){this.searchtext=SYNO.SDS.PkgManApp.Window.toolBar.searchField.getValue().toLowerCase();var a=SYNO.SDS.PkgManApp.Window.getStore("category");var b=a.getById(this.searchtext);Ext.each(this.pkgLists,function(c){c.hide()});if(b&&b.get("isCompilation")){this.descriptionStore.loadData([{title:b.get("dname"),description:b.get("descr")}]);this.description.show();this.synologyPkgList._activate()}else{this.description.hide();Ext.each(this.pkgLists,function(c){c._activate()})}this.determineEmptyResultMask();this.scrollToTop()},determineEmptyResultMask:function(){var a=false;Ext.each(this.pkgLists,function(b){if(b.isVisible()){a=true;return false}},this);if(a){this.hideEmptyResultMask()}else{this.showEmptyResultMask()}},showEmptyResultMask:function(){if(this.emptyMask){this.emptyMask.show();return}this.emptyMask=this.body.createChild({tag:"div",cls:"synopkg-empty-pkglist-mask",children:[{tag:"div",cls:"synopkg-empty-pkglist-icon"},{tag:"div",cls:"synopkg-empty-pkglist-msg",html:_T("search","no_search_result")}]})},hideEmptyResultMask:function(){if(this.emptyMask){this.emptyMask.hide()}},_onActivate:function(){SYNO.SDS.PkgManApp.Window.getStore("stable").clearFilter();SYNO.SDS.PkgManApp.Window.setCurrentPage(this.panelName,0,SYNO.SDS.PkgManApp.Window.toolBar.searchField.getValue());this.onLoadData()},updateListviewFleXcroll:function(){this.listView.updateFleXcroll()},scrollToTop:function(){if(this.listView.el.dom.fleXcroll){this.listView.el.dom.fleXcroll.setScrollPos(false,0);this.listView.updateFleXcroll()}}});Ext.ns("SYNO.SDS.PkgManApp.Action");SYNO.SDS.PkgManApp.Action={};Ext.apply(SYNO.SDS.PkgManApp.Action,{_isQuickInstll:function(a){var b=(false!==a.qinst);if(this._isUpgradable(a.id)||this._isUpgradableFromBetaToStable(a.id)){b=false!==a.qupgrade}if(a&&a.info&&a.info.blqinst===false){b=false}return b},_isUpgradable:function(d){if(this._getReplacerRecByReplaceeId(d)){return true}if(!this._getSynoServerObj().blUpgradeList){return false}var a=false;var c=this._getInstalledStore().getById(d);var b;if(c&&c.get("beta")){b=this._getBetaServerObj().store.getById(d)}else{b=this._getSynoServerObj().store.getById(d)}if(b){a=b.get("blupgrade")}else{if(this._getOtherServerObj().blUpgradeList){b=this._getOtherServerObj().store.getById(d);if(b){a=b.get("blupgrade")}}}return a},_isUpgradableFromBetaToStable:function(c){if(!this._getSynoServerObj().blUpgradeList){return false}var b=this._getInstalledStore().getById(c);var a=this._getSynoServerObj().store.getById(c);return !Ext.isEmpty(b)&&b.get("beta")&&!Ext.isEmpty(a)&&a.get("blupgrade")},_IsInstalling:function(b){var c=SYNO.SDS.PkgManApp.Window.progressDatas;var a;if(b.id in c&&b.beta==c[b.id].beta){a=c[b.id]}if(!b){return false}if(b.status==="installing"||b.status==="upgrading"){return true}if((a&&a.info&&a.info.installing)&&(b.status!=="starting"&&b.status!=="stopping")){return true}return false},_GetProcessStatus:function(a,b){var c,d=true;switch(a){case"installing":c=_T("pkgmgr","installing");if(b){c=Math.floor(b*100)+"% "+c}break;case"upgrading":c=_T("pkgmgr","upgrading");if(b){c=Math.floor(b*100)+"% "+c}break;case"uninstalling":c=_T("background_task","task_processing")+"...";break;case"starting":c=_T("pkgmgr","starting");break;case"stopping":c=_T("pkgmgr","stopping");break;default:d=false;break}return{status:a,msg:c,blProcessing:d}},_getOperableExceptReplaceTargetStoreById:function(e){var a="installed";var d=this._isUpgradableFromBetaToStable(e);var c=this._isRepairableFromBetaToStable(e);if(d||c){a="stable"}else{var b=this._getInstalledStore().getById(e);if(b&&b.get("beta")&&this._hasNewVersion(e,true)){a="beta"}else{if(b&&!b.get("beta")&&this._hasNewVersion(e,false)){a="stable"}}}if(!SYNO.SDS.PkgManApp.Window.getStore(a).getById(e)){a="community"}return a},_getUpgradeRec:function(a){return this._isUpgradable(a)?(this._getAvalRec(a)):null},_hasNewVersion:function(b,c){var d=this._getInstalledStore().getById(b);if(Ext.isEmpty(d)){return false}var a=this._getAvalRecByChannel(d.id,c);return(!Ext.isEmpty(a)&&SYNO.SDS.PkgManApp.Utils.Helper.versionCompare(">=",a.get("version"),d.get("version")))},_isRepairable:function(a){var b=this._getInstalledStore().getById(a.id);if(Ext.isEmpty(b)||!SYNO.SDS.PkgManApp.Utils.Utils.isBrokenStatus(b.data)){return false}if(this._getReplacerRecByReplaceeId(a.id)){return true}return this._hasNewVersion(a.id,b.get("beta"))||this._isRepairableFromBetaToStable(a.id)},_isRepairableFromBetaToStable:function(a){var b=this._getInstalledStore().getById(a);if(Ext.isEmpty(b)||!SYNO.SDS.PkgManApp.Utils.Utils.isBrokenStatus(b.data)||!b.get("beta")){return false}return this._hasNewVersion(a,false)},_getAvalRec:function(a){return(this._getSynoServerObj().store.getById(a)||this._getBetaServerObj().store.getById(a)||this._getOtherServerObj().store.getById(a))},_getAvalRecByChannel:function(b,a){if(a){return(this._getBetaServerObj().store.getById(b)||this._getOtherServerObj().store.getById(b))}else{return(this._getSynoServerObj().store.getById(b)||this._getOtherServerObj().store.getById(b))}},_getAvalReplacerRec:function(a){var b=this._getSynoServerObj().store.getById(a);if(b&&Ext.isObject(b.data.replaceforcepkgs)){return b}b=this._getBetaServerObj().store.getById(a);if(b&&Ext.isObject(b.data.replaceforcepkgs)){return b}return null},_getReplaceeRecsByReplacerId:function(e){var f=this._getAvalReplacerRec(e);if(!f){return[]}var d=[];var a=f.get("replaceforcepkgs");for(var b in a){if(a.hasOwnProperty(b)){var c=this._getInstalledStore().getById(b);if(c){d.push(c)}}}return d},_getReplaceeIdsByReplacerId:function(c){var b=this._getReplaceeRecsByReplacerId(c);var a=[];b.each(function(d){a.push(d.get("id"))});return a},_getReplacerRecByReplaceeId:function(a){var b=this._getReplacementStore().getById(a);if(b){return this._getAvalReplacerRec(b.get("replacedby"))}return null},_onRequestInstall:function(b,c){var a=0;if(this._isUpgradable(b.get("id"))){a=1}this.setStatusBusy();this.sendWebAPI({api:"SYNO.Core.Package.Installation.Download",method:"check",version:1,timeout:3600000,params:{taskid:"@SYNOPKG_DOWNLOAD_"+b.get("id")},callback:function(f,e){this.clearStatusBusy();var d;d=this._getAvalRecByChannel(b.get("id"),b.get("beta"));if(!f){this.clearProgress(d.get("id"));if(!e||!e.code){this._onResetInstPkgs();this.getMsgBox().alert(_T("tree","leaf_packagemanage"),_T("error","error_error_system"));return}else{this._onCheckPKGFail(e,b.get("dname"))}}else{this._applyCodesignCheck(e,(function(g){this._prepareVolume(a,e,c,d,g)}).createDelegate(this),(function(){this._onRequestCancelDownload(b);c()}).createDelegate(this))}},scope:this})},_onRequestCancelDownload:function(b){this.setStatusBusy();var a=SYNO.SDS.PackageTaskMgr.getTask("@SYNOPKG_DOWNLOAD_"+b.get("id"));if(a){a.cancel()}else{this.clearProgress(b.get("id"));this.sendWebAPI({api:"SYNO.Core.Package.Installation",method:"cancel",version:1,params:{taskid:"@SYNOPKG_DOWNLOAD_"+b.get("id")},callback:function(d,c){this._onLoadPkgStore(b.get("id"),false,(function(){this.clearStatusBusy()}).createDelegate(this))},scope:this})}},_onCheckInstall:function(c,d,b){var a=!Ext.isFunction(d);if(a){this.setStatusBusy()}this._onCheckEnv(b,c,function(m,g){if(a){this.clearStatusBusy()}if(!m){if(!g||!g.code){this._onResetInstPkgs();this.getMsgBox().alert(_T("tree","leaf_packagemanage"),_T("error","error_error_system"),function(){if(Ext.isFunction(d)){d()}},this)}else{this._onCheckEnvFail(g,c,d,{fn:this._onCheckInstall,args:[c,d,b],scope:this})}return}var k=(false!==this._isQuickInstll(c.data)&&false!==c.get("qstart"))||false===c.get("start");var l=[];if(!g.volume_count||0===g.volume_count){if("system"===c.get("install_type")){}else{this.getMsgBox().alert(_T("tree","leaf_packagemanage"),_T("pkgmgr","volume_no_volumes"),function(i){if("ok"===i){SYNO.SDS.AppLaunch("SYNO.SDS.StorageManager.Instance")}this._onResetInstPkgs()});return}}var e=this._isUpgradable(c.get("id"));if(!g.volume_list||g.volume_list.length<=1||!Ext.isEmpty(g.volume_path)){var f=!Ext.isEmpty(g.volume_path)?g.volume_path:(g.volume_list?g.volume_list[0].mount_point:"");if(e||!k){this._onRequestQuickInstall(c,f,this._isRepairable(c.data)?true:undefined,d)}else{if(Ext.isFunction(d)){this._onRequestQuickInstall(c,f,true,d)}else{this._onRequestQuickInstall(c,f,true)}}}else{for(var h=0;h<g.volume_count;h++){var n=g.volume_list[h];l.push({mount_point:n.mount_point,name:n.display,description:n.desc})}var j=new SYNO.SDS.PkgManApp.WizardDialog({owner:this,mode:e?1:0,volumes:l},{id:c.get("id"),name:c.get("dname"),version:c.get("version"),description:c.get("desc"),maintainer:c.get("maintainer"),distributor:c.get("distributor"),support_url:c.get("support_url"),startable:k,pkgqinst:true,pkgqinstrec:c,install_type:c.get("install_type"),install_on_cold_storage:c.get("install_on_cold_storage")});j.mon(j,"beforeclose",function(){this.installing_fore_pkg=null;if(Ext.isFunction(d)){(function(){d()}).defer(100)}if(!j.isFinished){this._onResetInstPkgs()}},this,{single:true});if(!j.isDestroyed){j.open()}}})},_onRequestQuickInstall:function(f,d,b,g){var a=!Ext.isFunction(g);var c=this._isUpgradable(f.get("id"))?"upgrade":"install";SYNO.SDS.StatusNotifier.fireEvent("pkgctl",f.id,c,"pre");if(a){this.setStatusBusy()}var e={name:f.get("id"),blqinst:this._isQuickInstll(f.data),volume_path:d,is_syno:"syno"===f.get("source"),beta:f.get("beta")||false,installrunpackage:b};this.sendWebAPI({api:"SYNO.Core.Package.Installation",method:"install",version:1,params:e,callback:function(k,j){if(a){this.clearStatusBusy()}if(!k||!j){this._onResetInstPkgs();this.getMsgBox().alert(_T("tree","leaf_packagemanage"),_T("error","error_error_system"));return}if(j&&0>j.progress){this._onResetInstPkgs();var h={msg:_T("error","error_error_system"),callback:Ext.emptyFn};if(j.code){h=this._onCheckPKGFailMsg(f.get("dname"),j,_T("error","error_error_system"))}this.getMsgBox().alert(f.get("dname")||_T("tree","leaf_packagemanage"),h.msg,h.callback,this)}else{this.fireEvent("pollinginstpage");var i=new SYNO.SDS.PkgManApp.DownloadAction({owner:this,data:j,id:f.get("id"),beta:f.get("beta"),foreground:false});if(Ext.isFunction(g)){this.mon(i,"finish",function(){g();return true},this,{single:true})}}},scope:this})},_onCheckEnv:function(a,b,c){this.setStatusBusy();this.sendWebAPI({api:"SYNO.Core.Package.Installation",method:"check",version:2,params:{depsers:b.get("depsers"),deppkgs:b.get("deppkgs"),conflictpkgs:b.get("conflictpkgs"),breakpkgs:b.get("breakpkgs"),replacepkgs:b.get("replacepkgs"),ver:b.get("version"),size:b.get("size"),id:b.get("id"),blupgrade:this._isUpgradable(b.get("id")),install_type:b.get("install_type"),install_on_cold_storage:b.get("install_on_cold_storage"),blCheckDep:false},scope:this,callback:function(e,d){this.clearStatusBusy();if(Ext.isFunction(c)){c.apply(this,arguments)}}})},_onRequestDownload:function(c,b,d,a){b=Ext.isBoolean(b)?b:this._isQuickInstll(c.data);this.setStatusBusy();this._onCheckEnv(a,c,function(f,e){this.clearStatusBusy();if(!f){if(!e||!e.code){this._onResetInstPkgs();this.getMsgBox().alert(_T("tree","leaf_packagemanage"),_T("error","error_error_system"),function(){if(Ext.isFunction(d)){d()}},this)}else{this._onCheckEnvFail(e,c,d,{fn:this._onRequestDownload,args:[c,b,d,a],scope:this})}return}if(!b&&e.is_occupied){this.getMsgBox().alert(c.get("dname"),_T("pkgmgr","error_occupied"),function(){if(Ext.isFunction(d)){d()}},this);return}this.setStatusBusy();this.sendWebAPI({api:"SYNO.Core.Package.Installation",method:"install",version:1,timeout:3600000,params:{name:c.get("id"),url:c.get("link"),checksum:c.get("md5"),filesize:c.get("size"),type:c.get("type"),blqinst:b,operation:this._isUpgradable(c.get("id"))?"upgrade":"install"},callback:function(j,h){this.clearStatusBusy();if(!j||!h){this._onResetInstPkgs();this.getMsgBox().alert(_T("tree","leaf_packagemanage"),_T("error","error_error_system"),function(){},this);return}if(h&&0>h.progress){this._onResetInstPkgs();if(h.code&&4502==h.code){this.getMsgBox().alert(_T("tree","leaf_packagemanage"),_T("pkgmgr","volume_no_volumes"),function(k){if("ok"===k){SYNO.SDS.AppLaunch("SYNO.SDS.StorageManager.Instance")}});return}var i=_T("error","error_error_system");if(h.code){i=SYNO.API.getErrorString(h.code)}this.getMsgBox().alert(_T("tree","leaf_packagemanage"),i,function(){if(Ext.isFunction(d)){d()}},this)}else{this.fireEvent("pollinginstpage");this._onLoadPkgStore(c.get("id"),false);var g=new SYNO.SDS.PkgManApp.DownloadAction({owner:this,data:h,id:c.get("id"),beta:c.get("beta"),foreground:true});if(Ext.isFunction(d)){this.mon(g,"finish",function(){this._onRequestInstall(c,d);return false},this,{single:true})}}},scope:this})})},_onResetInstPkgs:function(){this.fore_pkg=[];this.back_pkg=[];this.installing_fore_pkg=null},_confirmPkgPausedDuringUpgrade:function(b,a,d){var c=String.format(_T("pkgmgr","error_upgrade_dep_statable_packages"),b.join(", "),a.join(", "));c+="<br/>"+_T("common","cfrm_continue");this.getMsgBox().confirm(_T("tree","leaf_packagemanage"),c,function(e,f){if(e==="yes"){d()}else{this._onResetInstPkgs()}},this)},_constructOperationMsg:function(m,f,h,e){var j,c,l;var a={title:"",operations:[]};if(1===m.length){j=m[0].pkg;c=this._getAvalRecByChannel(j,m[0].beta);l=c.get("beta")?String.format("({0})",_T("pkgmgr","beta")):"";if(Ext.isEmpty(this._getInstalledStore().getById(j))){a.title=String.format(_T("pkgmgr","install_operation_desc"),c.get("dname")+l)}else{a.title=String.format(_T("pkgmgr","upgrade_operation_desc"),c.get("dname")+l)}}else{a.title=String.format(_T("pkgmgr","operation_desc"))}a.title+=String.format(" {0}",_T("common","cfrm_continue").toLowerCase());for(var d=0,g=f.length;d<g;d++){if(!Ext.isEmpty(j)&&j===f[d].pkg){continue}c=this._getAvalRecByChannel(f[d].pkg,f[d].beta);l=c.get("beta")?String.format("({0})",_T("pkgmgr","beta")):"";if(Ext.isEmpty(this._getInstalledStore().getById(f[d].pkg))){a.operations.push(String.format(_T("pkgmgr","install_pkg"),c.get("dname")+l))}else{if(SYNO.SDS.PkgManApp.Utils.Utils.isBrokenStatus(this._getInstalledStore().getById(f[d].pkg).data)){a.operations.push(String.format(_T("pkgmgr","repair_pkg"),c.get("dname")+l))}else{a.operations.push(String.format(_T("pkgmgr","update_pkg"),c.get("dname")+l))}}}var k=function(i){if(i.pkg===h[d]){n=true;return false}};for(d=0,g=h.length;d<g;d++){var n=false;Ext.each(f,k,this);if(!n){var b=this._getInstalledStore().getById(h[d]);if(b&&b.get("dname")){a.operations.push(String.format(_T("pkgmgr","stop_pkg"),b.get("dname")))}else{a.operations.push(String.format(_T("pkgmgr","stop_pkg"),h[d]))}}}return a},_onClickInstall:function(b){var a={};a[b.get("id")]={rec:b};this._onParsePkgs(a)},_onClickUpdateAll:function(a){if(!Ext.isEmpty(this._getInstallAll_Background())){this.getMsgBox().alert(_T("tree","leaf_packagemanage"),_T("pkgmgr","error_occupied"));return}var b={};this._getUpgradePkg(a,this._getSynoServerObj().store,b);this._getUpgradePkg(a,this._getBetaServerObj().store,b);this._getUpgradePkg(a,this._getOtherServerObj().store,b);this._applyFeasibilityCheck({type:"install_check",packages:Object.keys(b)},(function(){this._onParsePkgs(b)}).createDelegate(this))},_onParsePkgs:function(b){var c=[];for(var a in b){if(b.hasOwnProperty(a)){c.push({pkg:a,beta:b[a].rec.get("beta")||false})}}this.setStatusBusy();this.sendWebAPI({api:"SYNO.Core.Package.Installation",method:"get_queue",version:1,params:{pkgs:c},callback:function(h,g,f){this.clearStatusBusy();if(!h){this.getMsgBox().alert(_T("tree","leaf_packagemanage"),_T("error","error_error_system"));return}if(g.non_exist_pkgs.length>0){this.getMsgBox().alert(_T("tree","leaf_packagemanage"),_T("pkgmgr","missing_pkgs")+"<br>"+g.non_exist_pkgs.join(", "));return}var e=(function(){b={};for(var o=0,j=g.queue.length;o<j;o++){var m=g.queue[o].pkg;var n=this._getAvalRecByChannel(m,g.queue[o].beta);b[m]={rec:n}}var k=[];this._genDepGraphNodes(b,k);var l=SYNO.SDS.PkgManApp.Utils.Utils.tsort(k);l.splice(l.length-1,1);this._getForeAndBackPkg(b,l);this._onCheckInstallAll(b,this._getDepSers(b),this._getInstallType(b))}).createDelegate(this);if(f.pkgs.length!=g.queue.length||g.broken_pkgs.length>0){var d=this._constructOperationMsg(f.pkgs,g.queue,g.broken_pkgs,g.replaced_pkgs);this.getMsgBox().confirmGrid(_T("tree","leaf_packagemanage"),d.title,d.operations,function(i,j){if(i==="yes"){if(g.paused_pkgs.length>0){this._confirmPkgPausedDuringUpgrade(g.cause_pausing_pkgs,g.paused_pkgs,e)}else{e()}}else{this._onResetInstPkgs()}},this)}else{if(g.paused_pkgs.length>0){this._confirmPkgPausedDuringUpgrade(g.cause_pausing_pkgs,g.paused_pkgs,e)}else{e()}}},scope:this})},_getForeAndBackPkg:function(d,a){var f=d;var e;this.back_pkg=this.back_pkg||[];this.fore_pkg=this.fore_pkg||[];for(var c=0;c<a.length;c++){e=f[a[c]];if(e){if(!this.existsInForeBackPkgs(this.fore_pkg,e.rec.id)){this.fore_pkg.push(e.rec)}}}for(var b in f){if(f.hasOwnProperty(b)){e=f[b];if(e){if(!this.existsInForeBackPkgs(this.back_pkg,e.rec.id)&&!this.existsInForeBackPkgs(this.fore_pkg,e.rec.id)){this.back_pkg.push(e.rec)}}}}},_getUpgradePkg:function(a,b,d){var c=b.snapshot||b.data;c.each(function(h){var g=this.getProgressData(h).progress;var e=this._getReplaceeIdsByReplacerId(h.get("id"));var f;if(((a&&this._isRepairable(h.data))||(!a&&h.get("blupgrade")&&!this._isRepairable(h.data))||!Ext.isEmpty(e))&&(!Ext.isNumber(g)||!(g>0&&g<1))){f=h.get("id");if(!d.hasOwnProperty(f)){d[f]={rec:h}}}},this)},_checkVersion:function(c,b){if(Ext.isEmpty(c)){return null}if(Ext.isEmpty(b)){return c}for(var a in b){if(!this.helper.versionCompare(a,c.get("version"),b[a])){return null}}return c},_IsInstNormal:function(a){var b=this._getInstalledStore().getById(a);if(!b){return false}b=this._getAvalRecByChannel(a,b.get("beta"));if(!b||b.get("blupgrade")||this._isRepairable(b.data)){return false}return true},_IsAllInstNormal:function(b){var a;for(a in b){if(b.hasOwnProperty(a)){if(!this._IsInstNormal(a)){return false}}}return true},_IsInstingOrInsted:function(c){var b,d,a;if(Ext.isEmpty(c)){return true}for(b in c){if(c.hasOwnProperty(b)){d=this._getSynoServerObj().store.getById(b)||this._getOtherServerObj().store.getById(b);if(!d){continue}a=this.getProgressData(d).progress;if(a>0&&a<=1){return true}d=this._getInstalledStore().getById(b);if(d){return true}}}return false},_IsInsting_Background:function(){return this._IsInstingOrInsted(this._getInstallAll_Background())},_IsInsting_Foreground:function(){return this._IsInstingOrInsted(this._getInstallAll_Foreground())},_genDepGraphNodes:function(e,a){if(Ext.isEmpty(e)){return}var f,d,c;for(var b in e){if(e.hasOwnProperty(b)){f=e[b].rec;if(!this._isFirstBuy(f)&&this._isQuickInstll(f.data)&&!this._inQueue(e,f.get("deppkgs"))){continue}a.push([f.get("id"),""]);d=f.get("deppkgs")||{};for(c in d){if(d.hasOwnProperty(c)){a.push([c,f.get("id")])}}}}},_inQueue:function(a,c){for(var b in c){if(c.hasOwnProperty(b)&&a.hasOwnProperty(b)){return true}}return false},_getDepSers:function(d){var f=[],e,c,b;for(var a in d){if(d.hasOwnProperty(a)){e=d[a].rec;if(!Ext.isEmpty(e.get("depsers"))){c=e.get("depsers").split(" ");for(b=0;b<c.length;b++){if(-1==f.indexOf(c[b])){f.push(c[b])}}}}}return f.join(" ")},_getInstallType:function(c){var d,a="";for(var b in c){if(c.hasOwnProperty(b)){d=c[b].rec;if(d.get("install_type")){a=d.get("install_type");break}}}return a},_onCheckInstallAll:function(d,b,f){var e=true,c=0;for(var a in d){if(d.hasOwnProperty(a)){c++;if(c>=2){e=false;break}}}if(e||(Ext.isEmpty(b)&&Ext.isEmpty(f))){this._onInstallAll();return}this.setStatusBusy();this.sendWebAPI({api:"SYNO.Core.Package.Installation",method:"check",version:2,timeout:3600000,params:{depsers:b,install_type:f},callback:function(h,g){this.clearStatusBusy();if(!h){if(!g){this._onResetInstPkgs();this.getMsgBox().alert(_T("tree","leaf_packagemanage"),_T("error","error_error_system"))}else{this._onResetInstPkgs();this._onCheckPKGFail(g)}return}if(0<this._getInstallAll_Foreground().length&&g.is_occupied){this._onResetInstPkgs();this.getMsgBox().alert(_T("tree","leaf_packagemanage"),_T("pkgmgr","error_occupied"));return}this._onInstallAll()},scope:this})},_onInstallAll:function(){if(!Ext.isEmpty(this.fore_pkg)&&!Ext.isEmpty(this.fore_pkg[0])){this._onInstallAll_Foreground()}else{this._onInstallAll_Background()}},_onInstallAll_Foreground:function(){if(Ext.isEmpty(this.fore_pkg)||Ext.isEmpty(this.fore_pkg[0])){return}if(this.installing_fore_pkg&&this.existsInForeBackPkgs(this.fore_pkg,this.installing_fore_pkg.id)){return}var a=this.fore_pkg[0];this.installing_fore_pkg=a;this._onInstallAll_One(a,false)},_onInstallAll_Background:function(){if(Ext.isEmpty(this.back_pkg)||Ext.isEmpty(this.back_pkg[0])){return}var c;for(c=0;c<this.back_pkg.length;c++){var b=this.back_pkg[c];if(!b){continue}var d=b;var a=this.getProgressData(d).progress;if(((a>0&&a<1)||-1===a)){continue}this._onInstallAll_One.defer(80,this,[b,true])}this.back_pkg=[]},_isHasUpgradable:function(a){var b=false;var c=a.snapshot||a.data;c.each(function(e){var d=this.getProgressData(e).progress;if(e.get("blupgrade")&&!(d>0&&d<1)){b=true;return false}});return b},_getInstallAll_Foreground:function(){return this.fore_pkg||[]},_getInstallAll_Background:function(){return this.back_pkg||[]},_onInstallAll_One:function(c,e,d){var b=c.id;if(this.isDestroyed){return}d=d||0;if(!c){this._onInstallAll();return}var a=this.getProgressData(c).progress;var f=c;var g=(function(){if(this.isDestroyed){return}var h;if(this.existsInForeBackPkgs(this.fore_pkg,b)){this.fore_pkg.splice(h,1);this.installing_fore_pkg=null}this._onLoadOtherPkgStore(false);this._onLoadSynoPkgStore(false);this._onLoadBetaPkgStore(false);this.fireEvent("pollinginstpage");this._onInstallAll()}).createDelegate(this);if(1!==a&&a>0){if(e){g()}else{if(180>=d){d++;this._onInstallAll_One.defer(1000,this,[b,e,d])}else{this._onResetInstPkgs();this.getMsgBox().alert(_T("tree","leaf_packagemanage"),_T("pkgmgr","error_occupied"));return}}}else{if(this._isFirstBuy(f)||this._isLicenseError(f)){this._onRequestSynoPkg(f,e,a,g)}else{if(e){if(a===1){g()}else{this._onCheckInstall(f,g)}}else{this._onRequestDownload(f,e,g)}}}},_onLoadPkgStore:function(){var a=SYNO.SDS.PkgManApp.Window;a.onLoadPkgStore.apply(a,arguments)},_onLoadOtherPkgStore:function(){var a=SYNO.SDS.PkgManApp.Window;a.onLoadOtherPkgStore.apply(a,arguments)},_onLoadSynoPkgStore:function(){var a=SYNO.SDS.PkgManApp.Window;a.onLoadSynoPkgStore.apply(a,arguments)},_onLoadBetaPkgStore:function(){var a=SYNO.SDS.PkgManApp.Window;a.onLoadBetaPkgStore.apply(a,arguments)},_onRefresh:function(a){a=Ext.isBoolean(a)?a:false;this._onLoadOtherPkgStore(true,false);this._onLoadSynoPkgStore(true,false);this._onLoadBetaPkgStore(true,false);this.fireEvent("pollinginstpage");this.loadCfg()},_getSynoServerObj:function(){return SYNO.SDS.PkgManApp.Window.synoObj},_getBetaServerObj:function(){return SYNO.SDS.PkgManApp.Window.betaObj},_getOtherServerObj:function(){return SYNO.SDS.PkgManApp.Window.otherObj},_getInstalledStore:function(){return SYNO.SDS.PkgManApp.Window.getStore("installed")},_getReplacementStore:function(){return SYNO.SDS.PkgManApp.Window.getStore("replacement")},applyStatusData:function(f,e,d){e=(e||false);d=(d||false);var g=this._getInstalledStore().getById(f.id);var a=this.getProgressData(null,f.id,e,d);var b=false;var c=["dsm_apps","status","url","broken_by","progress"];if(g&&(d||e===g.get("beta"))){c.each(function(h){f[h]=g.get(h)});b=true}if(a&&(d||e==(a.beta||false))){Ext.apply(f,a);if(!b&&a.blNewlyInstalled){f.status="loading"}}},_prepareVolume:function(e,a,f,d,c){var b=new SYNO.SDS.PkgManApp.WizardDialog({owner:this,mode:e,check_codesign:undefined!==c?c:true,type:d?d.get("type"):undefined},a);b.mon(b,"beforeclose",function(){this.installing_fore_pkg=null;if(Ext.isFunction(f)){(function(){f()}).defer(100)}if(!b.isFinished){this._onResetInstPkgs()}},this,{single:true});b.open()},_onRequestSynoPkg:function(d,g,b,i,e){var f={};var j=this._isLicenseError(d);for(var h in SYNO.SDS.PkgManApp.Config){if(SYNO.SDS.PkgManApp.Config.hasOwnProperty(h)){if("myds_id"===h||"auth_key"===h||"serial"===h){f[h]=SYNO.SDS.PkgManApp.Config[h]}else{var c=h.substr(0,3);if("ds_"===c){f[h]=SYNO.SDS.PkgManApp.Config[h]}}}}var a=(function(l,m,k){if(j){this._onStartPkg(d);if(Ext.isFunction(i)){i()}}else{if(b===1){if(g){if(Ext.isFunction(i)){i()}else{this._onLoadPkgStore(d.get("id"),false)}}else{this._onRequestDownload(d,g,i,k)}}else{if(g){this._onCheckInstall(d,i,k)}else{this._onRequestDownload(d,g,i,k)}}}}).createDelegate(this);this.setStatusBusy();this._onCheckEnv(e,d,function(l,k){this.clearStatusBusy();if(!l){if(!k){this._onResetInstPkgs();this.getMsgBox().alert(d.get("dname")||_T("tree","leaf_packagemanage"),_T("error","error_error_system"),function(){if(Ext.isFunction(i)){i()}},this)}else{this._onCheckEnvFail(k,d,i,{fn:this._onRequestSynoPkg,args:[d,g,b,i,e],scope:this})}return}if(!g&&k.is_occupied){this._onResetInstPkgs();this.getMsgBox().alert(d.get("dname"),_T("pkgmgr","error_occupied"));if(Ext.isFunction(i)){i()}return}if(!this._isFirstBuy(d)&&!this._isLicenseError(d)){a.call(this,this,k,e)}else{this.setStatusBusy();this.sendWebAPI({api:"SYNO.Core.Package.MyDS",method:"get",version:1,params:{},callback:function(p,o){var m;if(this.isDestroyed){return}this.clearStatusBusy();if(p&&Ext.isDefined(o)&&Ext.isDefined(o.myds_id)){Ext.apply(SYNO.SDS.PkgManApp.Config,o);this._showMyDSDialog(f,d,a,k,e)}else{if(Ext.isDefined(o)&&4571==o.code){m=new SYNO.SDS.MyDSCenter.LoginDialog({owner:this.owner,listeners:{scope:this,cancel_login:this._onResetInstPkgs,login_success:function(s,r,q){if(q){this._showMyDSDialog(f,d,a,k,e)}else{this._onResetInstPkgs()}}}});m.show()}else{this._onResetInstPkgs();var n=_T("common","error_system");if(o.code){n=SYNO.API.getErrorString(o.code)}this.getMsgBox().alert(this.title,n,function(){},this)}}},scope:this})}})},_onClickSynoPkgActionBtn:function(c,a){var b=this.getProgressData(c).progress;if(!Ext.isDefined(a)){a=false}if(this._IsInstalling(c.data)){this._onLoadPkgStore(c.get("id"),false)}else{if(b>0){if(!a){this._onRequestCancelDownload(c)}}else{this._applyVersionAndBetaCheck(c,(function(){this._applyFeasibilityCheck({type:"install_check",packages:[c.id]},(function(){this._onClickInstall(c)}).createDelegate(this))}).createDelegate(this))}}},_isFirstBuy:function(b){var a=b.data;if(!Ext.isEmpty(a.status)||b.data.source!=="syno"){return false}if(0!==a.type){return true}return false},_isLicenseError:function(b){var a=b.data;return 0!==a.type&&"syno"===a.source&&"license_error"===a.status},_onStartPkg:function(a){this._applyFeasibilityCheck({type:"start_check",packages:[a.id]},(function(){this.setStatusBusy();SYNO.SDS.StatusNotifier.fireEvent("pkgctl",a.id,"start","pre");var b={id:a.id,dsm_apps:a.get("dsm_apps")?a.get("dsm_apps").split(" "):[]};this.sendWebAPI({api:"SYNO.Core.Package.Control",method:"start",version:1,timeout:3600000,params:b,scope:this,callback:function(f,c,e,d){this.clearStatusBusy();this._handleApplyDone(f,c,e,d)}})}).createDelegate(this))},_onStopPkg:function(a){this._applyFeasibilityCheck({type:"stop_check",packages:[a.id]},(function(){this.getMsgBox().confirm(_T("tree","leaf_packagemanage"),_T("pkgmgr","pkgmgr_pkg_stop_warn"),function(b,d){if(b=="yes"){SYNO.SDS.StatusNotifier.fireEvent("pkgctl",a.id,"stop","pre");this.setStatusBusy();var c={id:a.id};this.sendWebAPI({api:"SYNO.Core.Package.Control",method:"stop",version:1,timeout:3600000,params:c,scope:this,callback:function(h,e,g,f){this.clearStatusBusy();this._handleApplyDone(h,e,g,f)}})}},this)}).createDelegate(this))},_onUninstallPkg:function(c,b){if(c.get("pkgisuninstui")){var a=new SYNO.SDS.PkgManApp.UninstallWizardDialog({owner:this,packagename:c.id,dsm_apps:c.get("dsm_apps")});a.mon(a,"uninstalldone",function(){b()},this);a.open()}else{this.getMsgBox().confirm(_T("tree","leaf_packagemanage"),_T("pkgmgr","pkgmgr_pkg_uninstall_warn"),function(d,f){if(d=="yes"){this.setStatusBusy();var e={id:c.id,dsm_apps:c.get("dsm_apps")};SYNO.SDS.StatusNotifier.fireEvent("pkgctl",c.id,"uninstall","pre");this.sendWebAPI({api:"SYNO.Core.Package.Uninstallation",method:"uninstall",version:1,params:e,timeout:3600000,scope:this,callback:function(k,g,j,h){if(SYNO.SDS.PkgManApp.Window.isDestroyed){return}if(b){b()}if(k,j,j.id){var i=this._getInstalledStore().getById(j.id);if(i){this._getInstalledStore().remove(i)}this.clearProgress(j.id)}this.clearStatusBusy();this._handleApplyDone(k,g,j,h)}})}},this)}},_showLog:function(b){var a=new SYNO.SDS.PkgManApp.LogDialog({owner:this},b);a.open()},_showMyDSDialog:function(a,e,f,d,b){var c=new SYNO.SDS.PkgManApp.MyDSDialog({owner:this,myds_params:Ext.apply({appId:e.get("id"),version:e.get("version")},a),type:e.data.type,listeners:{scope:this,payevent:f.createDelegate(this,[this,d,b]),payfailed:this._onResetInstPkgs}});c.show()},getIconFromServerOrDSM:function(c,a,b){var d=this._getAvalRec(c.id);if(d){return SYNO.SDS.PkgManApp.Utils.Helper.getIconFromServer(d.data,a,b)}else{return SYNO.SDS.PkgManApp.Utils.Helper.getIconFromDS(c,a)}},getStatusStyle:function(d,e){var c=this._isUpgradable(e.id);var f=false;var b=this._isRepairable(e);if(b||c){f=(0<e.progress&&1>e.progress);if(f||this._IsInstalling(e)){d=b?"repairing":"upgrading"}}var a={color:"",text:""};switch(d){case"stop":case"non_support":case"builtin":a={color:"#666666",text:_T("pkgmgr","pkgmgr_pkg_stopped")};break;case"stopped_by_dep_limit":a={color:"#666666",text:_T("pkgmgr","stopped_by_dep_limit")};break;case"running":a={color:"#78c52d",text:_T("pkgmgr","pkgmgr_pkg_running")};break;case"installing":a={color:"#78c52d",text:_T("pkgmgr","installing")};break;case"upgrading":a={color:"#78c52d",text:_T("pkgmgr","upgrading")};break;case"repairing":a={color:"#78c52d",text:_T("pkgmgr","repairing")};break;case"uninstalling":a={color:"#78c52d",text:_T("background_task","task_processing")+"..."};break;case"starting":a={color:"#78c52d",text:_T("pkgmgr","starting")};break;case"stopping":a={color:"#78c52d",text:_T("pkgmgr","stopping")};break;case"loading":a={color:"#0086E6",text:_T("pkgmgr","loading")};break;case"broken":case"license_error":case"broken_by_other":a={color:"#EB5F5F",text:_T("pkgmgr","pkgmgr_pkg_broken")};break;case"version_limit":if(b){a={color:"#f4982d",text:_T("pkgmgr","status_version_limit")}}else{a={color:"#666666",text:_T("pkgmgr","pkgmgr_pkg_stopped")}}break;default:break}return a},existsInForeBackPkgs:function(a,c){if(!Ext.isArray(a)){return false}var b=false;a.each(function(d){if(d.id===c){b=true}},this);return b},getRecFromSameChannel:function(b){var a=this._getInstalledStore().getById(b).get("beta")?"beta":"stable";var c=SYNO.SDS.PkgManApp.Window.getStore(a);return c.getById(b)||this._getOtherServerObj().store.getById(b)},getProgressData:function(e,c,d,b){d=(d||false);b=(b||false);if(e){c=e.get("id");d=e.get("beta")}else{e=this._getAvalRecByChannel(c,d)}var a=SYNO.SDS.PkgManApp.Window.progressDatas[c];if(a&&(b||d==(a.beta||false))){return a}return{progress:e?e.get("progress"):null}},clearProgress:function(f){var e=SYNO.SDS.PkgManApp.Window.getStore("installed");var d=SYNO.SDS.PkgManApp.Window.getStore("stable");var c=SYNO.SDS.PkgManApp.Window.getStore("community");var b=SYNO.SDS.PkgManApp.Window.getStore("beta");var a=this._getReplaceeIdsByReplacerId(f);var g=[f].concat(a);g.each(function(h){delete SYNO.SDS.PkgManApp.Window.progressDatas[h];this.triggerUpdate(e,h);this.triggerUpdate(c,h);this.triggerUpdate(d,h);this.triggerUpdate(b,h)},this)},triggerUpdate:function(b,c){var a=b.getById(c);if(a===undefined){return}b.fireEvent("update",b,a,Ext.data.Record.COMMIT)}});SYNO.SDS.PkgManApp.ActionUtils={};Ext.apply(SYNO.SDS.PkgManApp.ActionUtils,{_onCheckPKGFail:function(a,c,d){var b=this._onCheckPKGFailMsg(c,a,undefined);if(Ext.isFunction(d)){d=Ext.createInterceptor(b.callback,d,this)}else{d=b.callback}this.getMsgBox().alert(c||_T("tree","leaf_packagemanage"),b.msg,d,this);this._onResetInstPkgs()},_onCheckEnvFail:function(a,f,g,b){var e=f.get("dname");var c=this._onCheckPKGFailMsg(e,a,undefined);if(Ext.isFunction(g)){g=Ext.createInterceptor(c.callback,g,this)}else{g=c.callback}if(a&&a.code===4552&&(a.errors.packages||a.errors.brokenPkgs||a.errors.replacedPkgs)){var d="";if(a.errors.packages){d+=String.format(_T("pkgmgr","error_upgrade_dep_statable_packages"),e,a.errors.packages)+"<br/>"}if(a.errors.brokenPkgs){d+=String.format(_T("pkgmgr","error_break_packages"),e,a.errors.brokenPkgs)+"<br/>"}if(a.errors.replacedPkgs){d+=String.format(_T("pkgmgr","error_replace_packages"),e,a.errors.replacedPkgs)+"<br/>"}d+=_T("common","cfrm_continue");this.getMsgBox().confirm(e||_T("tree","leaf_packagemanage"),d,function(h){if("yes"===h){if(b.args){b.args[b.args.length-1]={blCheckDep:false}}b.fn.apply(b.scope,b.args||[])}else{this._onResetInstPkgs()}},this)}else{this.getMsgBox().alert(e||_T("tree","leaf_packagemanage"),c.msg,g,this);this._onResetInstPkgs()}},_notifyServiceStatus:function(k,e,f,b){var l=false,c=false;if(!f){return}var d=SYNO.API.Util.GetReqByAPI(b,"SYNO.Core.Package","get","id")||f.id;d=SYNO.SDS.PkgManApp.Utils.Utils.unquote(d);var j=SYNO.API.Util.GetValByAPI(e,"SYNO.Core.Package","get");var a=f.method;if(b&&b.params&&b.params.method){a=b.params.method}var g=(e.result)?e.result.length:0;for(var h=0;h<g;h++){if(e.result[h].method==="install"&&e.result[h].success===true){l=true}else{if(e.result[h].method==="start"&&e.result[h].success===true){c=true}}}if(l){a=this.blUpgradeOrRepair?"upgrade":"install"}else{if(c){a="start"}}this._notifyPackage(d,a,j||e,f);SYNO.SDS.StatusNotifier.fireEvent("thirdpartychanged",d,a,"uninstall"===a?f.dsm_apps.split(" "):"");SYNO.SDS.StatusNotifier.fireEvent("pkgctl",d,a,"post",true)},_handleApplyDone:function(a,e,d,b){if(a&&e&&!e.has_fail){if(SYNO.API.Util.GetValByAPI(e,"SYNO.Core.Package.Installation","install","reboot")){this._showDoneMessage(a,e,d,b);SYNO.SDS.System.RebootWithMsg(_T("pkgmgr","reboot_warn"))}else{this._showDoneMessage(a,e,d,b)}}else{this._showErrMsg(e,b,d)}var c=SYNO.SDS.PkgManApp.Window;c.setStatusBusy();c.mon(c,"status_load",function(){c.clearStatusBusy();this._onLoadOtherPkgStore(true);this._onLoadSynoPkgStore(true);this._onLoadBetaPkgStore(true)},this,{single:true});this.blProcessing=true;c.fireEvent("pollinginstpage")},_notifyPackage:function(a,c,b,d){var e=[];if(d&&Ext.isArray(d.dsm_apps)){e=d.dsm_apps}else{if(b&&b.dsm_apps){e=b.dsm_apps.split(" ")}else{if(b&&b.additional&&b.additional.dsm_apps){e=b.additional.dsm_apps.split(" ")}}}SYNO.SDS.StatusNotifier.on("jsconfigLoaded",function(){if(("install"===c||"upgrade"===c)&&!Ext.isEmpty(e)){SYNO.SDS.AppView.notifyInstalled(e);Ext.each(e,function(g){var f=SYNO.SDS.Config.FnMap[g];if(f&&f.config&&f.config.useCSPRule){if(!SYNO.SDS.Config.CheckCSPRefresh){SYNO.SDS.Config.CheckCSPRefresh=[]}SYNO.SDS.Config.CheckCSPRefresh.push(g)}})}else{SYNO.SDS.AppView.refresh()}},this,{single:true,delay:100})},_parseDepPkg:function(a){var f="";for(var b in a){if(a.hasOwnProperty(b)){if(f!==""){f+=", "}var e=this._getAvalRec(b),d=e?e.get("dname"):b,c="";for(var g in a[b]){if(a[b].hasOwnProperty(g)){switch(Ext.util.Format.htmlDecode(g)){case">=":c=String.format(_T("pkgmgr","version_bigger_equal"),d,a[b][g]);break;case"<=":c=String.format(_T("pkgmgr","version_less_equal"),d,a[b][g]);break;case"=":c=String.format(_T("pkgmgr","version_equal"),d,a[b][g]);break;case">":c=String.format(_T("pkgmgr","version_bigger"),d,a[b][g]);break;case"<":c=String.format(_T("pkgmgr","version_less"),d,a[b][g]);break;default:c=d;break}break}}f+=(c||d)}}return f},_onCheckPKGFailMsg:function(d,c,f){c=(c&&c.error)||c||{};var a=f||_T("user","user_file_upload_fail");var h=Ext.emptyFn;var g;var i=c;if(i.code){g=i.code;if(Ext.isObject(i.errors)){i=i.errors}}switch(g){case 4502:case 4503:a=(4502==g)?_T("pkgmgr","volume_no_volumes"):_T("error","volume_creating");h=function(j){if("ok"===j){SYNO.SDS.AppLaunch("SYNO.SDS.StorageManager.Instance")}};break;case 4526:var b=this._parseDepPkg(i.uninstall_packages);if(!Ext.isEmpty(i.unstart_packages)&&!Ext.isEmpty(b)){a=String.format(_T("pkgmgr","depend_uninst_unstart"),"<br>"+b+", "+i.unstart_packages)}else{if(!Ext.isEmpty(i.unstart_packages)){a=String.format(_T("pkgmgr","depend_unstart"),"<br>"+i.unstart_packages)}else{a=String.format(_T("pkgmgr","depend_packages"),"<br>"+b)}}break;case 4531:a=_T("pkgmgr","pkgmgr_not_syno_publish");break;case 4532:a=_T("pkgmgr","pkgmgr_unknown_publisher");break;case 4533:a=_T("pkgmgr","pkgmgr_no_signature");break;case 4534:a=_T("pkgmgr","pkgmgr_cert_expired");break;case 4535:a=_T("pkgmgr","broken_package");break;case 4536:if(i.require_os.search("Surveillance")!=-1){a=_T("pkgmgr","pkgmgr_pkg_os_require_surveillance")}else{a=String.format(_T("pkgmgr","pkgmgr_pkg_os_not_support"),i.current_os,i.require_os)}break;case 4582:a=String.format(_T("pkgmgr","error_stop_dep_packages"),i.packages);break;case 4583:a=String.format(_T("pkgmgr","version_less_than_limit"),i.current_version,i.require_version);break;case 4546:a=String.format(_T("pkgmgr","downgrade_version"),i.current_version,i.install_version);break;case 4547:case 4552:if(d){a=String.format(_T("pkgmgr","error_upgrade_dep_packages_with_name"),i.packages,d)}else{a=String.format(_T("pkgmgr","error_upgrade_dep_packages"),i.packages)}break;case 4525:var e=this._decodeServiceErr(i.services);a=e.msg;h=e.callback;break;default:a=SYNO.SDS.PkgManApp.Utils.Utils.getWebAPIErr(false,c,{},d)}if(d){a=d+":<br>"+a}return{msg:a,callback:h}},_showDoneMessage:function(k,f,g,b){var e="",m="",n,l,h,d;if(b&&b.params){var j=false;var c=SYNO.API.Util.GetValByAPI(f,"SYNO.Core.Package","get","additional");if(c&&"running"===c.status){j=true}var a=SYNO.API.Util.GetReqByIndex(b,0,"method");switch(a){case"uninstall":e=_T("pkgmgr","pkgmgr_pkg_uninstall_success");break;case"install":if(1===this.mode){e=j?"":_T("pkgmgr","pkgmgr_pkg_upgrade_wizard_done")}else{e=j?"":_T("pkgmgr","pkgmgr_pkg_install_wizard_done")}break;case"upgrade":e=j?"":_T("pkgmgr","pkgmgr_pkg_upgrade_wizard_done");break;default:break}}if(Ext.isArray(f.result)){n=f.result;for(h=0;h<n.length;h++){d=SYNO.API.Util.GetValByIndex(f,h,"message");if(!d||d===m){continue}e+=(e?"<br>":"")+d;m=d}}else{if(f.message){e+=(e?"<br>":"")+f.message}}if(Ext.isDefined(f.worker_message)){e+=(e?"<br>":"")+SYNO.SDS.PkgManApp.Utils.Utils.localizeWorkerMsg(f.worker_message)}if(e){l=this.dname||this.pkgName||_T("tree","leaf_packagemanage");this.getMsgBox().alert(l,e,function(){this.isFinished=true;if(this.goNext){this.goNext(null)}},this)}else{this.isFinished=true;if(this.goNext){this.goNext(null)}}if(g){this._notifyServiceStatus(k,f,g,b)}},_decodeServiceErr:function(g){var f,b,a="",h=_T("controlpanel","leaf_service"),d=0;var e=[],j=[];for(var c=0;c<g.length;c++){switch(g[c]){case"ssh-shell":d|=SYNO.SDS.PkgManApp.SERVICE.PKG_SERVICES_SSH;break;case"pgsql":d|=SYNO.SDS.PkgManApp.SERVICE.PKG_SERVICES_PGSQL;break}}if(d&SYNO.SDS.PkgManApp.SERVICE.PKG_SERVICES_SSH){f="SYNO.SDS.AdminCenter.TerminalSNMP.Main";a=_T("pkgmgr","require_sshd");h=_T("tree","leaf_terminal");b="terminal"}else{if("yes"===_D("usbstation","no")&&d&SYNO.SDS.PkgManApp.SERVICE.PKG_SERVICES_PGSQL){f="SYNO.SDS.AdminCenter.SystemDatabase.Main";a=_T("pkgmgr","require_pgsql");h=_T("metadata","metadata_title");b=undefined}else{if(d&SYNO.SDS.PkgManApp.SERVICE.PKG_SERVICES_PGSQL){return{msg:_T("pkgmgr","wait_pgsql"),callback:function(){if(this.goNext){this.goNext(null)}}}}else{for(c=0;c<g.length;c++){if(g[c].includes(":")){j=g[c].split(":");e.push(_T(j[0],j[1]))}else{e.push(g[c])}}return{msg:String.format(_T("pkgmgr","require_service"),e.join(", ")),callback:function(){if(this.goNext){this.goNext(null)}}}}}}a+=(a?"<br>":"")+String.format(_T("pkgmgr","prompt_enable_serviece"),h);return{msg:a,callback:function(i){if("ok"===i){SYNO.SDS.AppLaunch("SYNO.SDS.AdminCenter.Application",{fn:f,tab:b});if(this.goNext){this.goNext(null)}}}}},_showErrMsg:function(o,b,g){var n;var f=_T("error","error_error_system"),l=this.dname||this.pkgName||_T("tree","leaf_packagemanage"),e;if(o){f="";var d=SYNO.API.Util.GetFirstError(o),m=true,j,i,a,k;if(d){j=SYNO.API.Util.GetFirstErrorIndex(o);i=SYNO.API.Util.GetReqByIndex(b,j,"api");if("SYNO.Core.Package.Control"===i){a=SYNO.API.Util.GetReqByIndex(b,j,"method");k=SYNO.SDS.PkgManApp.Utils.Utils.unquote(SYNO.API.Util.GetReqByIndex(b,j,"id"));if(0===j){f=("start"===a)?_T("pkgmgr","pkgmgr_pkg_start_failed"):_T("pkgmgr","pkgmgr_pkg_stop_failed");SYNO.SDS.StatusNotifier.fireEvent("pkgctl",k,a,"post",false)}else{m=true;f=this.mode?_T("pkgmgr","pkgmgr_pkg_upgrade_wizard_done"):_T("pkgmgr","pkgmgr_pkg_install_wizard_done")}}else{if(i==="SYNO.Core.Package"){if(SYNO.API.Util.GetReqByAPI(b,"SYNO.Core.Package.Control","start")){k=SYNO.SDS.PkgManApp.Utils.Utils.unquote(SYNO.API.Util.GetReqByAPI(b,"SYNO.Core.Package.Control","start","id"));SYNO.SDS.StatusNotifier.fireEvent("pkgctl",k,"start","post",false);f=_T("pkgmgr","pkgmgr_pkg_start_failed")}else{if(SYNO.API.Util.GetReqByAPI(b,"SYNO.Core.Package.Control","stop")){k=SYNO.SDS.PkgManApp.Utils.Utils.unquote(SYNO.API.Util.GetReqByAPI(b,"SYNO.Core.Package.Control","stop","id"));SYNO.SDS.StatusNotifier.fireEvent("pkgctl",k,"stop","post",false);f=_T("pkgmgr","pkgmgr_pkg_stop_failed")}else{f=this.mode?_T("pkgmgr","pkgmgr_pkg_upgrade_wizard_done"):_T("pkgmgr","pkgmgr_pkg_install_wizard_done")}}}else{if(i==="SYNO.Core.Package.Installation"){a=SYNO.API.Util.GetReqByIndex(b,j,"method");if("install"===a){if(this.dname||this.pkgName){SYNO.SDS.StatusNotifier.fireEvent("pkgctl",this.pkgName,this.mode?"upgrade":"install","post",false);f=String.format((this.mode?_T("pkgmgr","upgrade_pkg_fail"):_T("pkgmgr","install_pkg_fail")),this.dname||this.pkgName,"")}else{f=this.mode?_T("pkgmgr","upgrade_fail"):_T("pkgmgr","install_fail")}}}else{if(i==="SYNO.Core.Package.Uninstallation"){k=SYNO.SDS.PkgManApp.Utils.Utils.unquote(SYNO.API.Util.GetReqByIndex(b,j,"id"));SYNO.SDS.StatusNotifier.fireEvent("pkgctl",k,"uninstall","post",false)}}}}e=d.code;d=d.errors||d;switch(e){case 4502:f=_T("pkgmgr","volume_no_volumes");n=function(p){if("ok"===p){SYNO.SDS.AppLaunch("SYNO.SDS.StorageManager.Instance")}};break;case 4503:f=_T("error","volume_creating");n=function(p){if("ok"===p){SYNO.SDS.AppLaunch("SYNO.SDS.StorageManager.Instance")}};break;case 4525:var h=this._decodeServiceErr(d.services);if(m){f=_T("pkgmgr","pkgmgr_pkg_start_failed")+"<br>"}f+=h.msg;n=h.callback;break;case 4562:f=String.format(_T("pkgmgr","error_uninst_dep_packages"),d.packages);break;case 4547:if(this.dname||this.pkgName){f=String.format(_T("pkgmgr","error_upgrade_dep_packages_with_name"),d.packages,this.dname||this.pkgName)}else{f=String.format(_T("pkgmgr","error_upgrade_dep_packages"),d.packages)}break;case 4552:a=SYNO.API.Util.GetReqByIndex(b,j,"method");if(a==="check"&&b.compound){var c=this.dname||this.pkgName;f="";if(d.packages){f+=String.format(_T("pkgmgr","error_upgrade_dep_statable_packages"),c,d.packages)+"<br/>"}if(d.brokenPkgs){f+=String.format(_T("pkgmgr","error_break_packages"),c,d.brokenPkgs)+"<br/>"}if(d.replacedPkgs){f+=String.format(_T("pkgmgr","error_replace_packages"),c,d.replacedPkgs)+"<br/>"}f+=_T("common","cfrm_continue");this.getMsgBox().confirm(this.dname||_T("tree","leaf_packagemanage"),f,function(p){if("yes"===p){this.setStatusBusy();SYNO.API.Util.GetReqByIndex(b,j+1).params.force=true;this.sendWebAPI({timeout:3600000,compound:{stopwhenerror:b.compound.stopwhenerror,params:b.compound.params.slice(1,b.compound.params.length)},scope:this,callback:function(t,q,s,r){this.clearStatusBusy();this._handleApplyDone(t,q,s,r)}})}},this);return}if(this.dname||this.pkgName){f=String.format(_T("pkgmgr","error_upgrade_dep_packages_with_name"),d.packages,this.dname||this.pkgName)}else{f=String.format(_T("pkgmgr","error_upgrade_dep_packages"),d.packages)}break;case 4582:f=String.format(_T("pkgmgr","error_stop_dep_packages"),d.packages);break;case 4546:f=String.format(_T("pkgmgr","downgrade_version"),d.current_version,d.install_version);break;case 4583:f=String.format(_T("pkgmgr","version_less_than_limit"),d.current_version,d.require_version);break;case 4548:f=String.format(_T("pkgmgr","version_less_than_limit"),d.current_version,d.require_version);break;default:f=SYNO.SDS.PkgManApp.Utils.Utils.getWebAPIErr(false,SYNO.API.Util.GetFirstError(o),{},this.dname||this.pkgName,f);break}}if(d.message&&""!==d.message){f+=(f?"<br>":"")+SYNO.SDS.PkgManApp.Utils.Utils.localizeMsg(d.message,d.message,this.dsm_apps)}if(Ext.isDefined(d.worker_message)){f+=(f?"<br>":"")+SYNO.SDS.PkgManApp.Utils.Utils.localizeWorkerMsg(d.worker_message)}if(f===""){f=_T("error","error_error_system")}}this.getMsgBox().alert(l,f,n||function(){var p=SYNO.API.Util.GetReqByIndex(b,0,"method");if(this.goNext&&((p!=="install"&&p!=="check")||e===4580)){this.goNext(null)}},this);SYNO.SDS.reloadJSConfig()},_applyFeasibilityCheck:function(b,a){this.setStatusBusy();this.sendWebAPI({api:"SYNO.Core.Package",method:"feasibility_check",version:1,params:b,callback:function(e,d){this.clearStatusBusy();if(e){a.call(this)}else{if(d.code===4556){var c=SYNO.SDS.PkgManApp.Utils.Utils.GetFeasibilityMsgList(d.errors.reasons);if(d.errors.check_type==="hard"){this.getMsgBox().alert(_T("tree","leaf_packagemanage"),_T("pkgmgr",b.type+"_alert")+c)}else{this.getMsgBox().confirm(_T("tree","leaf_packagemanage"),_T("pkgmgr",b.type+"_confirm")+c,function(f){if(f==="yes"){a.call(this)}},this)}}}},scope:this})},_applyCodesignCheck:function(c,b,e){if(!c.hasOwnProperty("codesign_error")){b.call(this,true)}else{var a={code:c.codesign_error};var d=this._onCheckPKGFailMsg(null,a);this.getMsgBox().confirm(_T("tree","leaf_packagemanage"),d.msg+" "+_T("common","ask_cont"),function(f){if(f==="yes"){b.call(this,false)}else{e.call(this)}},this)}},_applyVersionAndBetaCheck:function(c,a){var d=this._getInstalledStore().getById(c.id);if(d&&this.helper.versionCompare(">",d.get("version"),c.get("version"))){var b=String.format(this.helper.T("downgrade_version"),d.get("version"),c.get("version"));this.getMsgBox().alert(_T("tree","leaf_packagemanage"),b);return}if(d&&!d.get("beta")&&c.get("beta")){this.getMsgBox().confirm(_T("tree","leaf_packagemanage"),String.format(this.helper.T("join_beta_confirm"),c.get("dname")||c.id),function(e){if(e==="yes"){a.call(this)}},this)}else{a.call(this)}}});SYNO.SDS.PkgManApp.DownloadAction=Ext.extend(Ext.util.Observable,{constructor:function(a,d){this.owner=a.owner;this.foreground=a.foreground;this.id=a.id;this.beta=a.beta;if(!d){var b=a.data.taskid||a.data.data.taskid;d=SYNO.SDS.PackageTaskMgr.addWebAPITask({id:b,interval:1200,query:{api:"SYNO.Core.Package.Installation",method:"status",version:1,params:{task_id:b}},cancel:{api:"SYNO.Core.Package.Installation",method:"cancel",version:1,params:{taskid:b}}})}d.addCallback(this.onDownloadCallBack,this);var c;if(this.beta){c=this.owner._getBetaServerObj().store.getById(this.id)||this.owner._getOtherServerObj().store.getById(this.id)}else{c=this.owner._getSynoServerObj().store.getById(this.id)||this.owner._getOtherServerObj().store.getById(this.id)}if(this.foreground){this.showProgress("",_T("download","download_task_downloading"),(function(){this.onSetProgress(this.id,0);d.cancel()}).createDelegate(this))}this.onSetProgress(this.id,0.00001);this.addEvents({finish:true});SYNO.SDS.PkgManApp.DownloadAction.constructor.call(this)},onDownloadCallBack:function(b,d,f,c,e){if(this.owner.isDestroyed){if("cancel"!==d&&f){this.owner._notifyPackage(this.id,this.blupgrad?"upgrade":"install",e);SYNO.SDS.StatusNotifier.fireEvent("thirdpartychanged",this.id,this.blupgrad?"upgrade":"install");SYNO.SDS.StatusNotifier.fireEvent("pkgctl",this.id,this.blupgrad?"upgrade":"install","post",true)}return}var a;if(this.beta){a=this.owner._getBetaServerObj().store.getById(this.id)||this.owner._getOtherServerObj().store.getById(this.id)}else{a=this.owner._getSynoServerObj().store.getById(this.id)||this.owner._getOtherServerObj().store.getById(this.id)}if(!a||a.isDestroyed){return}if("cancel"===d){return this.onCancelTask(b,e)}else{if(f){this.onFinishTask(c,e)}else{if(c||(e&&e.installing)){this.onProgressTask(c,e)}}}},onCancelTask:function(a,c){var d,b=true;if(this.beta){d=this.owner._getBetaServerObj().store.getById(this.id)||this.owner._getOtherServerObj().store.getById(this.id)}else{d=this.owner._getSynoServerObj().store.getById(this.id)||this.owner._getOtherServerObj().store.getById(this.id)}if(this.foreground){this.owner._onResetInstPkgs();this.owner.getMsgBox().hide()}var e=d?d.get("blupgrade"):false;if(c&&c.code){this.owner.getMsgBox().alert(_T("tree","leaf_packagemanage"),SYNO.API.getErrorString(c.code));if(4506===c.code){b=false;a.restart(true)}}else{this.onSetProgress(this.id,0)}SYNO.SDS.PkgManApp.Window.clearStatusBusy();this.owner._onLoadPkgStore(this.id,false,function(){if(e){this.fireEvent("pollinginstpage")}});return b},onFinishTask:function(c,d){var e;if(this.beta){e=this.owner._getBetaServerObj().store.getById(this.id)||this.owner._getOtherServerObj().store.getById(this.id)}else{e=this.owner._getSynoServerObj().store.getById(this.id)||this.owner._getOtherServerObj().store.getById(this.id)}if(d&&d.success){var b=this.owner._getInstalledStore().getById(this.id);if(b){b.set("status","loading")}if(this.foreground){this.onSetProgress(this.id,Ext.isDefined(c)?c:1,d)}else{this.onSetProgress(this.id,null,null,true)}}else{this.onSetProgress(this.id)}this.fireEvent("pollinginstpage");var a=this.owner.addTask({interval:1000,run:function(){this.owner._onLoadPkgStore(this.id,false);a.remove()},scope:this}).start(false);var f=e?e.get("blupgrade"):false;if(this.foreground){this.owner.getMsgBox().hide();if(!d||!d.success){this.owner.getMsgBox().alert(_T("tree","leaf_packagemanage"),_T("pkgmgr","download_fail"));this.owner._onResetInstPkgs();return}if(false!==this.fireEvent("finish")){this.owner._onRequestInstall(e)}}else{this.owner._notifyPackage(this.id,f?"upgrade":"install",d);SYNO.SDS.StatusNotifier.fireEvent("thirdpartychanged",this.id,f?"upgrade":"install");SYNO.SDS.StatusNotifier.fireEvent("pkgctl",this.id,f?"upgrade":"install","post",d.success);this.fireEvent("finish")}},onProgressTask:function(a,d){if(d&&d.success){this.onSetProgress(this.id,a,d)}if(this.foreground&&a){var c=(a*100).toFixed(0);var b;b="<center>"+c+"&#37;</center>";this.owner.getMsgBox().updateProgress(a,b,this.msg)}},showProgress:function(e,d,a){this.msg=d;var c={title:e,msg:d,width:300,progress:true,progressText:"<center>0&#37;</center>",closable:false,buttons:Ext.Msg.CANCEL,fn:a};var b=this.owner.getMsgBox();this.owner.mon(this.owner.msgBox,"beforeshow",SYNO.SDS.PkgManApp.Utils.Utils.setGlobalValue,this);this.owner.mon(this.owner.msgBox,"beforeclose",SYNO.SDS.PkgManApp.Utils.Utils.cleanGlobalValue,this);b.show(c)},onSetProgress:function(d,b,f,c){var a=this.owner._getReplaceeIdsByReplacerId(d);var e=[d].concat(a);e.each(function(h){this.owner.progressDatas[h]={progress:b,info:f,beta:this.beta,blNewlyInstalled:c};this.owner.triggerUpdate(this.owner.stores.installed,h);this.owner.triggerUpdate(this.owner.stores.stable,h);this.owner.triggerUpdate(this.owner.stores.beta,h);this.owner.triggerUpdate(this.owner.stores.community,h);if(f&&f.dsm_apps){var g=f.dsm_apps.split(" ");Ext.each(g,function(i){var j=SYNO.SDS.AppMgr.getByAppName(i);Ext.each(j,function(k){k.destroy()});SYNO.SDS.JSLoad.RemoveJSSatusByAppName(i)})}},this)}});Ext.ns("SYNO.SDS.PkgManApp.Utils.Utils");SYNO.SDS.PkgManApp.Utils.Utils={mode:{open:"open",more:"more"},localizeMsg:function(e,a,f){var d,c,b;e=e.replace(/[\r\n]+/g,"");c=e.split(":");if(c.length<2){return e}d=c[0]+":"+c[1];b=this.getFirstDsmAppName(f);c[1]=SYNO.SDS.Utils.GetLocalizedString(d,b);if(a&&a!==""&&(!c[1]||c[1]===d)){return a}c.shift();return String.format.apply(String,c)},localizeArrMsg:function(f,b,c){var d=[];if(!Ext.isArray(f)){f=[f]}for(var a=0;a<f.length;a++){if(Ext.isString(f[a])){d.push(SYNO.SDS.Utils.GetLocalizedString(f[a],c))}else{d.push(f[a])}}var e=String.format.apply(String,d);if(b){return Ext.util.Format.stripTags(e)}else{return e}},localizeWorkerMsg:function(b){var c=function(g){var d=(Ext.isString(g.message))?g.message:"";var f=(Ext.isString(g.message_i18n))?g.message_i18n.split(":",3):[];var e=(Ext.isArray(g.args))?g.args:[];if(f.size()===2){e.unshift(_T(f[0],f[1]))}else{if(f.size()===3){e.unshift(_TT(f[0],f[1],f[2]))}else{return d}}return String.format.apply(String,e)||d};var a="";if(!Ext.isArray(b)){return""}Ext.each(b,function(d){var e=(Ext.isObject(d))?c(d):"";if(!e.empty()){a+=(a.empty())?e:"<br>"+e}});return a},getFirstDsmAppName:function(b){var a;if(Ext.isArray(b)){if(b.length>0){return b[0]}}else{if(Ext.isString(b)){a=b.split(" ");if(a.length>0){return a[0]}}else{return""}}},tsort:function(d){var c={},b=[],a={};var e=function(h){this.id=h;this.afters=[]};Ext.each(d,function(h){var j=h[0],i=h[1];if(!c[j]){c[j]=new e(j)}if(!c[i]){c[i]=new e(i)}c[j].afters.push(i)});var g=function(j,h){var i=c[j],k=i.id;if(a[j]){return}if(!Ext.isArray(h)){h=[]}h.push(k);a[j]=true;Ext.each(i.afters,function(l){if(h.indexOf(l)>=0){SYNO.Debug("cycle: "+l+" is in "+k);return}g(l.toString(),SYNO.Util.copy(h))});b.unshift(k)};for(var f in c){if(c.hasOwnProperty(f)){g(f,c[f])}}return b},getWebAPIErr:function(b,g,d,f,c){if(!b){if(g&&g.code<400){return SYNO.API.CheckResponse(b,g,d)}else{var a=g,e;if(g.code&&Ext.isObject(g.errors)){a=g.errors}switch(g.code){case 4500:case 4501:return c||_T("error","error_error_system");case 4502:return _T("pkgmgr","pkgmgr_space_not_ready");case 4503:return _T("error","volume_creating");case 4504:return _T("pkgmgr","error_sys_no_space");case 4505:return _T("error","no_external_devices");case 4520:return _T("error","error_space_not_enough");case 4521:return _T("pkgmgr","pkgmgr_file_not_package");case 4522:return _T("pkgmgr","broken_package");case 4523:return String.format(_T("pkgmgr","pkgmgr_pkg_required_newer_version"),a.firmware);case 4524:return String.format(_T("pkgmgr","conflict_packages"),a.packages);case 4525:break;case 4526:break;case 4527:return String.format(_T("pkgmgr","port_conflict"),a.port);case 4528:return String.format(_T("pkgmgr","pkgmgr_pkg_not_support_platform"),_D("product"));case 4529:return _T("pkgmgr","pkgmgr_pkg_cannot_upgrade");case 4530:return _T("pkgmgr","error_occupied");case 4537:return String.format(_T("pkgmgr","pkgmgr_pkg_required_older_version"),a.firmware);case 4538:return String.format(_T("pkgmgr","pkgmgr_pkg_required_newer_version"),a.firmware);case 4540:return _T("pkgmgr","pkgmgr_file_install_failed");case 4541:return _T("pkgmgr","upgrade_fail");case 4542:return _T("error","error_error_system");case 4543:return _T("pkgmgr","pkgmgr_file_not_package");case 4544:return _T("pkgmgr","pkgmgr_pkg_install_already");case 4545:return _T("pkgmgr","pkgmgr_pkg_not_available");case 4546:break;case 4547:case 4552:if(f){return String.format(_T("pkgmgr","error_upgrade_dep_packages_with_name"),a.packages,f)}return String.format(_T("pkgmgr","error_upgrade_dep_packages"),a.packages);case 4548:return _T("pkgmgr","install_version_less_than_limit");case 4549:return _T("pkgmgr","depend_cycle");case 4550:break;case 4551:break;case 4560:return _T("pkgmgr","pkgmgr_pkg_uninstall_failed");case 4561:break;case 4562:break;case 4580:return _T("pkgmgr","pkgmgr_pkg_start_failed");case 4581:return _T("pkgmgr","pkgmgr_pkg_stop_failed");case 4582:break;case 4583:break;case 4584:if(!Ext.isEmpty(a.unstart_packages)){return _T("pkgmgr","start_depend_unstart")+"<br>"+a.unstart_packages}break}if(!e){return c||SYNO.API.getErrorString(g.code)||_T("error","error_error_system")}}}},_initWinWrappers:function(a){this._getOwner=function(){if(this.owner){return this.owner}else{if(a&&a.owner){return(this.owner=a.owner)}else{if(this===SYNO.SDS.PkgManApp.Window){return SYNO.SDS.PkgManApp.Window}}}return(this.owner=SYNO.SDS.PkgManApp.Window)};Ext.each(["_getAbsoluteURL","_getEllipsis"],function(b){this[b]=function(){var c=SYNO.SDS.PkgManApp.Window;return c[b].apply(c,arguments)}},this);Ext.each(["_getCurId","_getHistoryInfo"],function(b){this[b]=function(){var c=SYNO.SDS.PkgManApp.Util;return c[b].apply(SYNO.SDS.PkgManApp.Window,arguments)}},this);Ext.iterate(SYNO.SDS.PkgManApp.Action,function(b,c){if(Ext.isFunction(c)){this[b]=function(){var d=SYNO.SDS.PkgManApp.Window;return c.apply(d,arguments)}}},this);Ext.iterate(SYNO.SDS.PkgManApp.ActionUtils,function(b,c){if(Ext.isFunction(c)){if(this instanceof SYNO.SDS.PkgManApp.UninstallWizardDialog||this instanceof SYNO.SDS.PkgManApp.WizardDialog){this[b]=c.createDelegate(this)}else{this[b]=function(){var d=SYNO.SDS.PkgManApp.Window;return c.apply(d,arguments)}}}},this)},_getCurId:function(){return SYNO.SDS.PkgManApp.Window.getPanelScope("SYNO.SDS.PkgManApp.PathHistoryMgr").getCurId()},_getHistoryInfo:function(){return SYNO.SDS.PkgManApp.Window.getPanelScope("SYNO.SDS.PkgManApp.PathHistoryMgr").getHistoryInfo()},encodedMsg:function(c,a){var b=c;if(!Ext.isDefined(c)){b=""}else{if(a){b=Ext.util.Format.stripTags(b)}}return Ext.util.Format.htmlEncode(b)},isOnlyInstStatus:function(b){var a=Ext.copyTo({},b,Object.keys(b));SYNO.SDS.PkgManApp.Window.applyStatusData(a);if(SYNO.SDS.PkgManApp.Utils.Utils.isBrokenStatus(a)){}else{if(!Ext.isEmpty(a.status)&&!a.blupgrade){return true}}return false},isBrokenStatus:function(b){if(Ext.isEmpty(b)){return false}var a=b;if(Ext.isObject(b)){a=b.status;if(Ext.isObject(b.additional)){a=b.status||b.additional.status}}return"broken"===a||"version_limit"===a||"non_support"===a||"builtin"===a||"license_error"===a||"broken_by_other"===a},getBrokenStatus:function(b){if(Ext.isEmpty(b)){return false}var a=b;if(Ext.isObject(b)){a=b.status;if(Ext.isObject(b.additional)){a=b.status||b.additional.status}}return a},getBrokenStr:function(a){return _T("pkgmgr","repair")},isBuyable:function(a){return(a&&0!==a.type&&a.price)},getValue:function(b,a){if(!Ext.isObject(b)){return b||""}if(b.additional&&b.additional[a]!==undefined){return b.additional[a]}if(b[a]!==undefined){return b[a]}return""},setGlobalValue:function(){SYNO.SDS.PkgManApp.isRunningPkgForeground=true},cleanGlobalValue:function(){SYNO.SDS.PkgManApp.isRunningPkgForeground=undefined},GetFeasibilityMsgList:function(b){var a="";Ext.each(b,function(c){a+=String.format("<li>{0}</li>",SYNO.SDS.Utils.GetFeasibilityCheckMsg(c))});return String.format("<ul>{0}</ul>",a)},AppLaunch:function(b){var a=SYNO.SDS.Config.FnMap[b];if(Ext.isEmpty(a)){return}a=a.config;if("url"===a.type||"standalone"===a.type||("legacy"===a.type&&"url"===a.urlDefMode)){SYNO.SDS.WindowLaunch(a.jsID);return}SYNO.SDS.AppLaunch(a.jsID)},IsPkgOpenable:function(a){var b=a.dsm_apps;if(a.dsm_apps){if(!Ext.isArray(a.dsm_apps)){b=a.dsm_apps.split(" ")}if("running"==a.status&&SYNO.SDS.StatusNotifier.isAppEnabled(b[0])){return true}}else{if(a.url&&a.url[0]){return true}}return false},unquote:function(a){return a.replace(/^"(.*)"$/,"$1")}};SYNO.SDS.PkgManApp.ModalWindow=Ext.extend(SYNO.SDS.ModalWindow,{_getAbsoluteURL:function(){return this._getOwner()._getAbsoluteURL.apply(this._getOwner(),arguments)},_getOwner:function(){if(this.owner){return this.owner}else{if(this===SYNO.SDS.PkgManApp.Window){return SYNO.SDS.PkgManApp.Window}}return(this.owner=SYNO.SDS.PkgManApp.Window)}});Ext.ns("SYNO.SDS.PkgManApp");SYNO.SDS.PkgManApp.SettingDialog=Ext.extend(SYNO.SDS.ModalWindow,{constructor:function(a){SYNO.SDS.PkgManApp.SettingDialog.superclass.constructor.call(this,Ext.apply(a,{dsmStyle:"v5",title:_T("download","download_table_heading_setting"),width:700,height:580,layout:"fit",border:false,items:[{xtype:"syno_tabpanel",plain:true,itemId:"tab",activeTab:0,deferredRender:false,items:this.createTabItems()}],buttons:[{text:_T("common","ok"),scope:this,btnStyle:"blue",handler:this.saveHandler},{text:_T("common","cancel"),scope:this,handler:this.closeHandler}],keys:[{key:[10,13],fn:this.saveHandler,scope:this},{key:27,fn:this.closeHandler,scope:this}],listeners:{scope:this,single:true,afterlayout:this.onAfterLayout}}));this.defineBehaviors()},defineBehaviors:function(){this.channelForm=this.get("tab").get("channel");this.generalForm=this.get("tab").get("general");this.grid=this.get("tab").get("grid")},createTabItems:function(){var b=[];var a=new Ext.data.SimpleStore({fields:["mount_point","display","size_free","description"],data:[]});b.push({xtype:"syno_formpanel",itemId:"general",border:false,autoScroll:true,trackResetOnLoad:true,title:_T("common","general"),items:[this.vol_fieldset=new SYNO.ux.FieldSet({xtype:"syno_fieldset",title:_T("pkgmgr","default_vol"),hidden:true,items:[{xtype:"syno_displayfield",value:_T("pkgmgr","default_vol_desc")},{xtype:"syno_storage_combobox",itemId:"default_vol",name:"default_vol",fieldLabel:_T("pkgmgr","default_vol"),store:a,displayField:"display",descriptionField:"description",valueField:"mount_point",grow:true,width:300,indent:0,tpl:new Ext.XTemplate('<tpl for=".">',"<tpl if=\"mount_point === 'no_default_vol'\">",'<div class="x-combo-list-item" style="height: 26px">',"</tpl>","<tpl if=\"mount_point !== 'no_default_vol'\">",'<div ext:qtip="{description:htmlEncode}" class="x-combo-list-item" style="height: 52px">',"</tpl>",'<div class="sds-combo-list-item-name">{display}</div>','<div class="sds-combo-list-item-description">{description}</div>',"</div>","</tpl>"),listeners:{scope:this,select:function(e){var f=e.ownerCt.ownerCt.form.findField("volume_status_text");f.hide();var c=e.getStore();var d=c.findExact("mount_point",e.getValue());if(0!==d&&209715200>=parseInt(c.getAt(d).get("size_free"),10)){f.setValue('<font color="red">'+_T("status","status_no_space")+"</font>");f.show()}else{if(!e.isDirty()&&(!Ext.isEmpty(f.originalValue))){f.setValue(f.originalValue);f.show()}}}}},{fieldLabel:"",labelStyle:"color:red;width:180px",xtype:"syno_displayfield",htmlEncode:false,name:"volume_status_text",value:""}]}),{xtype:"syno_fieldset",title:_T("tree","leaf_notification"),items:[{xtype:"syno_displayfield",value:_T("pkgmgr","notification_desc")},{xtype:"syno_checkbox",name:"enable_email",boxLabel:_T("autoblock","autoblock_notify")},{xtype:"syno_checkbox",name:"enable_dsm",boxLabel:_T("pkgmgr","desktop_notification")}]},{xtype:"syno_fieldset",title:_T("pkgmgr","trust_level"),items:[{xtype:"syno_displayfield",value:_T("pkgmgr","allow_pkg_publisher")},{xtype:"syno_radio",name:"trust_level",inputValue:0,boxLabel:_T("common","synology")},{xtype:"syno_radio",name:"trust_level",inputValue:1,boxLabel:_T("pkgmgr","synology_trust_developer")},{xtype:"syno_radio",name:"trust_level",inputValue:2,boxLabel:_T("pkgmgr","disable_trust_level")}]}]});b.push({xtype:"syno_formpanel",itemId:"channel",border:false,trackResetOnLoad:true,title:_T("pkgmgr","update_channel"),items:[{xtype:"syno_displayfield",value:_T("pkgmgr","update_channel_desc"),htmlEncode:false},{xtype:"syno_checkbox",boxLabel:_T("pkgmgr","update_channel_beta_yes"),name:"update_channel"}]});b.push(this.createPackageUpdatePanel());if(!SYNO.SDS.Utils.isInAliDSM()){b.push(this.createFeedGridPanel())}b.push(this.createKeyringGridPanel());return b},createFeedStore:function(){return new Ext.data.Store({autoLoad:true,autoDestroy:true,remoteSort:false,proxy:new SYNO.API.Proxy({api:"SYNO.Core.Package.Feed",method:"list",version:1}),reader:new Ext.data.JsonReader({root:"items",id:"feed"},[{name:"name"},{name:"feed"}]),listeners:{scope:this,load:function(a){this.owner.loadCfg()}}})},colRender:function(g,d,f,c,e,a){var b=Ext.util.Format.htmlEncode(g);d.attr='ext:qtip="'+Ext.util.Format.htmlEncode(b)+'"';return b},sourceRender:function(h,e,g,d,f,a){var c=a.reader.jsonData.items[d];if(c.user_added){h=_T("rsrcmonitor","cpu_user")}else{if(c.source){h=c.source[0]}else{h=_T("common","synology")}}var b=Ext.util.Format.htmlEncode(h);e.attr='ext:qtip="'+Ext.util.Format.htmlEncode(b)+'"';return b},createKeyStore:function(){return new Ext.data.Store({autoLoad:true,autoDestroy:true,proxy:new SYNO.API.Proxy({api:"SYNO.Core.Package.Feed.Keyring",method:"list",version:1}),reader:new Ext.data.JsonReader({root:"items",id:"keyring"},[{name:"name"},{name:"length"},{name:"algorithm"},{name:"fingerprint"},{name:"source"}]),listeners:{scope:this,load:function(a){this.owner.loadCfg()}}})},createKeyringGridPanel:function(){this.keystore=this.createKeyStore();var a={title:_T("certificate","certificate"),itemId:"keygrid",store:this.keystore,autoExpandColumn:"fingerprint",enableColumnMove:false,enableHdMenu:false,stripeRows:true,colModel:new Ext.grid.ColumnModel([{header:_T("common","name"),dataIndex:"name",id:"name",renderer:this.colRender},{header:_T("pkgmgr","key_length"),dataIndex:"length",id:"length",renderer:this.colRender},{header:_T("pkgmgr","key_algorithm"),dataIndex:"algorithm",width:120,id:"algorithm",renderer:this.colRender},{header:_T("pkgmgr","key_fingerprint"),dataIndex:"fingerprint",id:"fingerprint",renderer:this.colRender},{header:_T("helpbrowser","help_source"),dataIndex:"source",id:"source",renderer:this.sourceRender}]),selModel:new Ext.grid.RowSelectionModel({listeners:{scope:this,buffer:100,selectionchange:this.updateBtn}}),tbar:{items:[{xtype:"syno_button",text:_T("nfs","nfs_kerberos_import_keys"),itemId:"addkey",scope:this,handler:this.onAddKeyHandler},{xtype:"syno_button",text:_T("common","delete"),itemId:"delkey",disabled:true,scope:this,handler:function(c){var b=c.ownerCt.ownerCt;if(!this.isSelectUserKeys(b.getSelectionModel().getSelections())){this.getMsgBox().alert(this.title,_T("pkgmgr","error_remove_syno_cert"));return}this.onDeleteHandler(c,"keyring","fingerprint")}}]}};return new SYNO.ux.GridPanel(a)},onAddKeyHandler:function(){var a=new SYNO.SDS.PkgManApp.KeyringDialog({owner:this},{jsConfig:this.jsConfig,success:function(){this.keystore.reload()},scope:this});a.show()},isSelectUserKeys:function(c){for(var a=0;a<c.size();++a){var b=c[a].json;if(true!==b.user_added){return false}}return true},onDeleteHandler:function(d,a,b){var c=d.ownerCt.ownerCt;var f=c.getSelectionModel();var e=f.getSelections();if(e.length<1){return}this.getMsgBox().confirm(_T("tree","leaf_packagemanage"),_T("common","remove_cfrmrmv"),function(h){if("yes"==h){var j=[];for(var g=0;g<e.length;g++){j.push(e[g].get(b))}this.setStatusBusy({text:_T("filetable","filetable_deleting")});var k={list:Ext.encode(j)};this.sendWebAPI({api:"feed"==a?"SYNO.Core.Package.Feed":"SYNO.Core.Package.Feed.Keyring",method:"delete",params:k,callback:this.onDeleteDone,version:1,scope:this})}},this);return},createFeedGridPanel:function(){var a=this.createFeedStore();this.feedstore=a;var b={title:_T("pkgmgr","feed_server"),itemId:"grid",store:a,autoExpandColumn:"feed",enableColumnMove:false,enableHdMenu:false,stripeRows:true,colModel:new Ext.grid.ColumnModel({columns:[{header:_T("common","name"),dataIndex:"name",width:100,renderer:this.colRender},{header:_T("pkgmgr","feed"),dataIndex:"feed",id:"feed",renderer:this.colRender}]}),selModel:new Ext.grid.RowSelectionModel({singleSelect:false,listeners:{scope:this,buffer:100,selectionchange:this.updateBtn}}),tbar:{items:[{xtype:"syno_button",text:_T("common","add"),itemId:"add",scope:this,handler:function(){this.onEditHandler()}},{xtype:"syno_button",text:_T("common","alt_edit"),itemId:"edit",disabled:true,scope:this,handler:function(){this.onEditHandler(this.get("tab").get("grid").getSelectionModel().getSelected())}},{xtype:"syno_button",text:_T("common","delete"),itemId:"delete",disabled:true,scope:this,handler:function(d){this.onDeleteHandler(d,"feed","feed")}}]}};var c=new SYNO.ux.GridPanel(b);return c},onEditHandler:function(b){var a=new SYNO.SDS.PkgManApp.FeedDialog({owner:this},{jsConfig:this.jsConfig,blEdit:b?true:false,success:function(){this.feedstore.reload();this.keystore.reload()},scope:this});a.load(b)},updateBtn:function(d){if(this.isDestroyed){return}var b=d.grid;var e=b.getTopToolbar();var a=b.getSelectionModel();var c=a.getSelections();if("grid"===d.grid.itemId){e.getComponent("delete").setDisabled(c.length===0);e.getComponent("edit").setDisabled(c.length!==1)}else{if("keygrid"===d.grid.itemId){e.getComponent("delkey").setDisabled(c.length===0)}}},onSetVolField:function(d){var c=this.generalForm.form;if(!d.volume_list||1>=d.volume_list.length||(!d.volume_list&&!d.volume_status)){this.vol_fieldset.hide();return}this.vol_fieldset.show();var b=c.findField("default_vol").store;var a=[["no_default_vol",_T("pkgmgr","no_default_vol"),undefined,""]];Ext.each(d.volume_list,function(h,f,g){a.push([h.mount_point,h.display,h.size_free,Ext.util.Format.htmlEncode(h.desc)])},this);b.loadData(a);if(Ext.isEmpty(d.default_vol)){c.setValues({default_vol:"no_default_vol"})}else{c.setValues({default_vol:d.default_vol});if(!Ext.isEmpty(d.volume_status)){var e=_T("volume","volume_status_crashed");if("no_space"===d.volume_status){e=_T("status","status_no_space")}c.setValues({volume_status_text:'<font class="red-status">'+e+"</font>"})}}},onAfterLayout:function(){this.setStatusBusy();this.sendWebAPI({api:"SYNO.Core.Package.Setting",method:"get",version:1,callback:function(b,a){if(!b||!a){this.getMsgBox().alert(this.title,_T("error","error_error_system"));return}this.generalForm.getForm().setValues(a);this.channelForm.getForm().setValues(a);this.updateAllForm.getForm().setValues(a);this.updateAllForm.getForm().setValues({autoupdateall:a.autoupdateall?"autoupdateall_all":"autoupdateall_some"});this.mailset=a.mailset;this.onSetVolField(a);this.generalForm.updateScroller();this.clearStatusBusy()},scope:this})},saveHandler:function(){var a=this.generalForm.getForm();if(!this.mailset&&a.findField("enable_email").getValue()){this.getMsgBox().show({title:this.title,msg:_T("pkgmgr","pkg_email_set_err"),buttons:Ext.MessageBox.OKCANCEL,fn:function(b){if("ok"==b){SYNO.SDS.AppLaunch("SYNO.SDS.AdminCenter.Application",{fn:"SYNO.SDS.AdminCenter.Notification.Main"})}this.close()},scope:this});return}if(!this.isAnyFormDirty()){this.close();return}this.onSendSaveHandler()},onSendSaveHandler:function(){var h=this.channelForm.getForm(),e=this.generalForm.getForm(),b=this.updateAllForm.getForm(),d=[];this.setStatusBusy({text:_T("common","saving")});var i=b.findField("autoupdateall").getValue(),g=b.findField("enable_autoupdate").getValue();var c={update_channel:h.findField("update_channel").getValue()?"beta":"stable",enable_email:e.findField("enable_email").getValue(),enable_dsm:e.findField("enable_dsm").getValue(),trust_level:e.findField("trust_level").getGroupValue(),enable_autoupdate:g,autoupdateall:i};if(g&&!i){var f=this.updateAllGrid.getStore().getModifiedRecords();if((f&&f.length)||b.findField("autoupdateall").isDirty()){this.updateAllGrid.getStore().each(function(j){if(j.data.autoupdate){d.push(j.id)}});c.packages=Ext.encode(d)}}var a=e.findField("default_vol");if(a.isDirty()){Ext.apply(c,{default_vol:a.getValue()})}this.sendWebAPI({api:"SYNO.Core.Package.Setting",method:"set",version:1,timeout:3600000,params:c,callback:function(k,j){if(this.isUpdateChannelSwitched()){if(c.update_channel==="beta"&&!SYNO.SDS.UserSettings.getProperty("SYNO.SDS.PkgManApp.Instance","agreed_beta")){SYNO.SDS.UserSettings.setProperty("SYNO.SDS.PkgManApp.Instance","agreed_beta",true)}this.setForceReload()}if(!k){this.clearStatusBusy();if(!j||!j.code){this.getMsgBox().alert(_T("tree","leaf_packagemanage"),_T("error","error_error_system"));return}else{this.getMsgBox().alert(_T("tree","leaf_packagemanage"),SYNO.API.getErrorString(j.code))}}else{this.owner.loadCfg((function(){this.clearStatusBusy();this.close()}).createDelegate(this))}},scope:this})},closeHandler:function(){if(this.isAnyFormDirty()){this.getMsgBox().confirm(this.title,_T("common","confirm_lostchange"),function(a){if("yes"==a){this.close()}else{return}},this)}else{this.close()}},isUpdateChannelSwitched:function(){var a=this.channelForm.getForm().findField("update_channel");return a.isDirty()},setForceReload:function(){if(this.owner._onRefresh){this.owner._onRefresh()}},isAnyFormDirty:function(){var a=this.getAllForms(),b=false;if(this.updateAllForm.getForm().isDirty()){return true}if(!Ext.isEmpty(this.updateAllGrid.getStore().getModifiedRecords())){return true}Ext.each(a,function(e,c,d){if(e.isDirty()){b=true;return false}},this);return b},getAllForms:function(){var a=[],b=this.get("tab");b.items.each(function(f,c,e){if(!f.getForm){return}var d=f.getForm();a.push(d)},this);return a},onDeleteDone:function(d,c,b,a){this.clearStatusBusy();if(!d){if(!c||!Ext.isDefined(c.code)){this.setStatusError()}else{this.setStatusError({text:SYNO.API.getErrorString(c.code)})}}else{if("SYNO.Core.Package.Feed"===a.params.api){this.grid.getStore().reload();this.keystore.reload()}else{if("SYNO.Core.Package.Feed.Keyring"===a.params.api){this.keystore.reload()}}}},getUpdateStore:function(){if(this.update_store){return this.update_store}this.update_store=new SYNO.API.Store({autoLoad:true,proxy:new SYNO.API.Proxy({api:"SYNO.Core.Package",method:"list",version:1,listeners:{scope:this,beforeload:function(a,b){var c=a.activeRequest.read;if(c){Ext.Ajax.abort(c)}}}}),sortInfo:{field:"name",direction:"ASC"},baseParams:{additional:["silent_upgrade","autoupdate"]},reader:new Ext.data.JsonReader({root:"packages",id:"id"},[{name:"id"},{name:"name"},{name:"silent_upgrade",mapping:"additional.silent_upgrade"},{name:"autoupdate",mapping:"additional.autoupdate"}])});return this.update_store},createPackageUpdatePanel:function(){this.updateAllColumn=new SYNO.ux.EnableColumn({bindRowClick:true,dataIndex:"autoupdate",align:"center",width:40,sortable:false,hideable:false,menuDisabled:true,enableFastSelectAll:true,isIgnore:function(c,b){if(!b.data.silent_upgrade){return true}return false},renderer:function(d,b,c){if(!c.data.silent_upgrade){d="disabled";b.css="x-item-disabled"}return String.format('<div class="syno-ux-grid-enable-column-{0}">&nbsp;</div>',("disabled"===d?"disabled":d?"checked":"unchecked"))}});var a={loadMask:true,disabled:true,cls:"syno-pkg-gridpanel",margins:{left:30,right:30},region:"center",itemId:"grid",store:this.getUpdateStore(),autoExpandColumn:"name",enableColumnMove:false,enableHdMenu:false,stripeRows:true,plugins:[this.updateAllColumn],colModel:new Ext.grid.ColumnModel({columns:[this.updateAllColumn,{id:"name",header:_T("common","name"),dataIndex:"name",width:100,renderer:function(h,e,g,d,f,b){var c=Ext.util.Format.htmlEncode(h);e.attr='ext:qtip="'+Ext.util.Format.htmlEncode(c)+'"';return c}}]})};this.updateAllGrid=new SYNO.ux.GridPanel(a);return{title:_T("pkgmgr","auto_update"),layout:"border",items:[this.updateAllForm=new SYNO.ux.FormPanel({height:"auto",region:"north",xtype:"syno_formpanel",trackResetOnLoad:true,autoFlexcroll:false,items:[{xtype:"syno_checkbox",boxLabel:_T("pkgmgr","auto_update_enable"),name:"enable_autoupdate",listeners:{scope:this,check:function(d,c){var b=this.updateAllForm.getForm();b.findField("autoupdateall_some").setDisabled(!c);b.findField("autoupdateall_all").setDisabled(!c);if(!c){this.updateAllGrid.setDisabled(!c);this.updateAllNote.setDisabled(!c)}else{if(b.findField("autoupdateall_some").getValue()){this.updateAllGrid.setDisabled(false);this.updateAllNote.setDisabled(false)}}}}},{xtype:"syno_displayfield",value:String.format(_T("pkgmgr","auto_update_desc"),_D("product")),indent:1},{dataIndex:"autoupdateall_all",disabled:true,xtype:"syno_radio",boxLabel:_T("pkgmgr","auto_update_all_packages"),checked:true,name:"autoupdateall",hideLabel:true,inputValue:"autoupdateall_all",indent:1},{dataIndex:"autoupdateall_some",disabled:true,xtype:"syno_radio",boxLabel:_T("pkgmgr","auto_update_some_packages"),name:"autoupdateall",hideLabel:true,inputValue:"autoupdateall_some",indent:1,listeners:{scope:this,check:function(d,c){if(c&&0===this.update_store.getTotalCount()){this.update_store.load()}var b=d.disabled||!c;this.updateAllGrid.setDisabled(b);this.updateAllNote.setDisabled(b)}}}]}),this.updateAllGrid,this.updateAllNote=new SYNO.ux.DisplayField({region:"south",xtype:"syno_displayfield",value:_T("pkgmgr","auto_update_note"),indent:1})]}}});SYNO.SDS.PkgManApp.KeyringDialog=Ext.extend(SYNO.SDS.ModalWindow,{constructor:function(b,a){Ext.apply(this,a||{});this.owner=b.owner;var c=this.fillConfig(b);SYNO.SDS.PkgManApp.KeyringDialog.superclass.constructor.call(this,c);this.defineBehaviors()},fillConfig:function(a){var b={owner:a.owner,width:550,height:180,constrainHeader:true,monitorResize:true,title:_T("certificate","import_crt"),layout:"fit",items:[this.initFormConfig()],buttons:[{text:_T("common","ok"),handler:this.onApplyHandler,scope:this},{text:_T("common","cancel"),handler:this.close,scope:this}],keys:[{key:27,fn:this.close,scope:this}]};Ext.apply(b,a);return b},initFormConfig:function(){var a={xtype:"syno_formpanel",itemId:"formpanel",trackResetOnLoad:true,labelAlign:"left",border:false,labelWidth:150,fileUpload:true,url:SYNO.API.currentManager.getBaseURL("SYNO.Core.Package.Feed.Keyring","add",1),items:[{xtype:"syno_displayfield",value:_T("pkgmgr","import_cert_desc")},{xtype:"syno_filebutton",fieldLabel:_T("common","file"),name:"upload_keyring",itemId:"file"}],listeners:{actioncomplete:{scope:this,fn:this.onActionComplete},actionfailed:{scope:this,fn:this.onActionFailed}}};return a},defineBehaviors:function(){this.form=this.get("formpanel").form},onApplyHandler:function(){var a=this.form;if(!a.isValid()){return}if(!a.isDirty()){this.close()}else{this.setStatusBusy({text:_T("common","saving")});a.doAction("apply")}},onActionComplete:function(b,a){this.clearStatusBusy();this.success.call(this.scope);this.close()},onActionFailed:function(c,b){this.clearStatusBusy();var a=b.result;this.setStatusError({text:SYNO.API.getErrorString(a.error.code)})}});SYNO.SDS.PkgManApp.FeedDialog=Ext.extend(SYNO.SDS.ModalWindow,{constructor:function(b,a){Ext.apply(this,a||{});this.owner=b.owner;var c=this.fillConfig(b);SYNO.SDS.PkgManApp.FeedDialog.superclass.constructor.call(this,c);this.defineBehaviors()},fillConfig:function(a){var b={owner:a.owner,width:550,height:210,minWidth:100,minHeight:120,collapsible:false,autoScroll:false,constrainHeader:true,monitorResize:true,title:this.blEdit?_T("common","alt_edit"):_T("common","add"),layout:"fit",items:[this.initFormConfig()],buttons:[{text:_T("common","ok"),handler:this.onApplyHandler,scope:this},{text:_T("common","cancel"),handler:this.onCloseHandler,scope:this}],keys:[{key:[10,13],fn:this.onApplyHandler,scope:this},{key:27,fn:this.onCloseHandler,scope:this}]};Ext.apply(b,a);return b},initFormConfig:function(){var a={xtype:"syno_formpanel",itemId:"formpanel",labelAlign:"left",trackResetOnLoad:true,waitMsgTarget:true,border:false,labelWidth:150,items:[{xtype:"syno_textfield",itemId:"name",fieldLabel:_T("common","name"),name:"name",width:320},{xtype:"syno_textfield",itemId:"feed",allowBlank:false,fieldLabel:_T("pkgmgr","feed"),name:"feed",width:320}]};return a},defineBehaviors:function(){this.form=this.get("formpanel").form},onCloseHandler:function(){this.close()},onApplyHandler:function(){var a=this.form;if(!a.isValid()){return}if(a.isDirty()){var b={name:Ext.util.Format.trim(a.findField("name").getValue()),feed:Ext.util.Format.trim(a.findField("feed").getValue())};if(this.blEdit){Ext.apply(b,{orifeed:a.findField("feed").originalValue})}var c={list:Ext.encode(b)};this.setStatusBusy({text:_T("common","saving")});this.sendWebAPI({api:"SYNO.Core.Package.Feed",params:c,version:1,method:this.blEdit?"set":"add",callback:this.SaveDone,scope:this})}else{this.onCloseHandler()}},load:function(a){if(a){this.form.loadRecord(a)}this.show()},SaveDone:function(c,b){this.clearStatusBusy();if(!c){if(!b||!Ext.isDefined(b.code)){this.setStatusError({text:_T("error","save"),clear:true})}else{this.setStatusError({text:SYNO.API.getErrorString(b.code)})}}else{var a=this.owner;this.success.call(this.scope);this.close();if(b&&b.has_keyrings){a.getMsgBox().alert(_T("report","title_global_setting"),_T("pkgmgr","trust_feed_server_keys"))}}}});Ext.namespace("SYNO.SDS.PkgManApp");Ext.define("SYNO.SDS.PkgManApp.WizardDialog",{extend:"SYNO.SDS.Wizard.ModalWindow",enumInstallMode:Object.freeze({install:1,upgrade:2,repair:4}),constructor:function(c,a){SYNO.SDS.PkgManApp.Utils.Utils._initWinWrappers.call(this,c);this.upload_task_id=null;this.uploadFilename=null;this.isFinished=false;this.mode=c.mode;this.orimode=this.mode;this.type=c.type;this.check_codesign=true;var b=[];if(!a){b.push(this.getBasicPanel({itemId:"uploadStep",nextId:"licenceStep"}))}if(!a||a.licence){b.push(this.getLicencePanelConfig({itemId:"licenceStep",nextId:"volumeStep"}))}b.push(this.getVolumePanelConfig({itemId:"volumeStep",nextId:"applyStep"}));b.push(this.getInfoPanelConfig({itemId:"applyStep",nextId:null}));SYNO.SDS.PkgManApp.WizardDialog.superclass.constructor.call(this,Ext.apply(c,{dsmStyle:"v5",title:(this.orimode===3)?_T("pkgmgr","install_upgrade_title"):(this.orimode?_T("pkgmgr","pkgmgr_pkg_upgrade"):_T("pkgmgr","pkgmgr_pkg_install")),width:700,height:500,steps:b}));this.mon(this,"beforeshow",function(){SYNO.SDS.PkgManApp.Window.loadCfg();SYNO.SDS.PkgManApp.Utils.Utils.setGlobalValue()});Ext.EventManager.on(window,"unload",this.onSyncCleanTmp,this);SYNO.SDS.StatusNotifier.on("logout",this.onSyncCleanTmp,this);this.mon(this,"beforeclose",function(){SYNO.SDS.PkgManApp.Action.clearProgress(this.pkgName);this.onAsyncCleanTmp();SYNO.SDS.PkgManApp.Utils.Utils.cleanGlobalValue()},this);if(a){if(a.errmsg){var e;if(a&&a.dname){e=a.dname}this._onCheckPKGFail(a,e)}else{this.onCheckPKGDone(a,false)}return}var d=this.getStep("uploadStep").getForm();d.on("actioncomplete",function(g,i){Ext.get(this.id).unmask();if(!i.success||!i.result){this.getMsgBox().alert(_T("tree","leaf_packagemanage"),_T("error","error_unknown"));return}var h=i.result.data;var f=SYNO.SDS.PkgManApp.Utils.Utils.getValue(h,"id");this.mode=("non_installed"!==h.additional.status)?1:0;this._applyFeasibilityCheck({type:"install_check",packages:[f]},(function(){this._applyCodesignCheck(h,(function(j){this.check_codesign=j;this.onCheckPKGDone(h,true)}).createDelegate(this),(function(){this.upload_task_id=SYNO.SDS.PkgManApp.Utils.Utils.getValue(h,"task_id");this.onAsyncCleanTmp()}).createDelegate(this))}).createDelegate(this))},this);d.on("actionfailed",function(f,g){this._onCheckPKGFail(g.result)},this)},onCheckPKGDone:function(a,f){var b=SYNO.SDS.PkgManApp.Utils.Utils;this.upload_task_id=b.getValue(a,"task_id");this.uploadFilename=a.filename;this.pkgName=b.getValue(a,"id");this.dname=b.getValue(a,"name");this.pkgVersion=b.getValue(a,"version");this.desc=b.getValue(a,"description");this.maintainer=b.getValue(a,"maintainer");this.pkgDistributor=b.getValue(a,"distributor");this.pkgLicence=b.getValue(a,"licence");this.pkgStartable=b.getValue(a,"startable");this.pkgNeedReboot=b.getValue(a,"install_reboot");this.pkgqinst=a.pkgqinst;this.pkgqinstrec=a.pkgqinstrec;this.break_pkgs=b.getValue(a,"break_pkgs");this.replace_pkgs=b.getValue(a,"replace_pkgs");this.install_type=b.getValue(a,"install_type");this.install_on_cold_storage=b.getValue(a,"install_on_cold_storage");this.originalStatus=b.getValue(a,"status");this.dsm_apps=[];var d=b.getValue(a,"dsm_apps");if(Ext.isString(d)){this.dsm_apps=d.split(" ")}this.isUploaed=true;var e=b.getValue(a,"install_pages");if(e){var c=this.parseCustomui(e);c[c.length-1].nextId="applyStep";this.customuiIds=this.appendSteps(c)}else{this.customuiIds=undefined}if(!Ext.isEmpty(SYNO.SDS.PkgManApp.Config.def_void)){this.installVolume=SYNO.SDS.PkgManApp.Config.def_void}this.blUpgradeOrRepair=false;switch(this.orimode){case 0:this.installMode=this.enumInstallMode.install;break;case 1:this.installMode=b.isBrokenStatus(a)?this.enumInstallMode.repair:this.enumInstallMode.upgrade;this.blUpgradeOrRepair=true;break;default:if("non_installed"==this.originalStatus){this.installMode=this.enumInstallMode.install;break}this.installMode=b.isBrokenStatus(a)?this.enumInstallMode.repair:this.enumInstallMode.upgrade;this.blUpgradeOrRepair=true}var h=this.dname||this.pkgName||"";if(h){h+=" - "}if(this.blUpgradeOrRepair){this.setTitle(h+_T("pkgmgr","pkgmgr_pkg_upgrade"))}else{this.setTitle(h+_T("pkgmgr","pkgmgr_pkg_install"))}Ext.get(this.id).mask(_T("common","msg_waiting"),"x-mask-loading");var g=[{api:"SYNO.Core.Package.Setting.Volume",method:"get",version:1},{api:"SYNO.Core.Storage.Volume",method:"list",version:1,params:{offset:0,limit:-1,location:"internal",option:this.install_on_cold_storage?"include_cold_storage":""}}];this.sendWebAPI({compound:{stopwhenerror:false,params:g},scope:this,callback:function(s,m,k,j){Ext.get(this.id).unmask();if(!s||m.has_fail){var o=SYNO.API.Util.GetFirstErrorIndex(m);if(1===o){var l=SYNO.API.Util.GetFirstError(m);this.getMsgBox().alert("",SYNO.API.Erros.core[l.code]||_T("common","commfail"));return}}this.installVolume=SYNO.API.Util.GetValByAPI(m,"SYNO.Core.Package.Setting.Volume","get","default_vol");var r=SYNO.API.Util.GetValByAPI(m,"SYNO.Core.Storage.Volume","list","volumes"),q=[],p,n,t;if(r){p=r.length;for(n=0;n<p;n++){t=r[n];q.push({mount_point:t.volume_path,name:SYNO.SDS.Utils.StorageUtils.VolumeNameSizeRenderer(t),description:t.description})}}if(Ext.isEmpty(q)&&"system"!==this.install_type){this.getMsgBox().alert(_T("tree","leaf_packagemanage"),_T("pkgmgr","volume_no_volumes"),function(i){if("ok"===i){SYNO.SDS.AppLaunch("SYNO.SDS.StorageManager.Instance")}this.goNext(null)},this);return}this.volumes=q;if(b.getValue(a,"licence")){this.goNext("licenceStep",f)}else{if(this.volumes&&this.volumes.length>1&&!this.blUpgradeOrRepair&&Ext.isEmpty(this.installVolume)&&"system"!==this.install_type){this.goNext("volumeStep",f)}else{if(this.customuiIds&&this.customuiIds.length>0){this.goNext(this.customuiIds[0],f)}else{if(f){this.goNext("applyStep",f)}else{if(this.goNext("applyStep",f)){this.goNext(this.getActiveStep().getNext(),f)}}}}}}})},parseCustomui:function(pkgcustomui){if(Ext.isString(pkgcustomui)){try{pkgcustomui=Ext.decode(decodeURIComponent(pkgcustomui))}catch(e){pkgcustomui=Ext.decode(window.unescape(pkgcustomui))}}var step_title,i,j,type,synotype,steps=[],desc,textType;for(i=0;i<pkgcustomui.length;i++){if(!Ext.isArray(pkgcustomui[i].items)){continue}var item,items=pkgcustomui[i].items,compitems=[],config,keys=["labelHtmlEncode","labelStyle","style"],pkguicfg=pkgcustomui[i];var labelWidth_array=[];for(j=0;j<items.length;j++){type=items[j].type;textType=undefined;if(type==="multiselect"){synotype="syno_checkbox"}else{if(type==="singleselect"){synotype="syno_radio"}else{if(type==="textfield"){synotype="syno_textfield"}else{if(type==="password"){synotype="syno_textfield";textType="password"}else{if(type==="combobox"){synotype="syno_combobox"}else{if(!type&&!items[j].subitems&&Ext.isString(items[j].desc)){keys=keys.concat(["htmlEncode"]);item=items[j];config={xtype:"syno_displayfield",htmlEncode:false,value:SYNO.SDS.Utils.GetLocalizedString(item.desc,this.dsm_apps[0])||item.desc};Ext.copyTo(config,item,keys);compitems.push(config)}else{continue}}}}}}if(!Ext.isArray(items[j].subitems)){continue}var subitems=items[j].subitems;var v;var items_desc_indent=0;if(items[j].desc){compitems.push({xtype:"syno_displayfield",htmlEncode:false,value:SYNO.SDS.Utils.GetLocalizedString(items[j].desc,this.dsm_apps[0])||items[j].desc});items_desc_indent=30}for(var k=0;k<subitems.length;k++){item=subitems[k];config={xtype:synotype,name:(type==="singleselect")?("radiogroup_"+j):item.key,htmlEncode:false,invalid_next_disabled_v2:pkguicfg.invalid_next_disabled_v2,itemId:item.key};if(textType){Ext.apply(config,{textType:textType})}if(type==="password"||type==="textfield"||type==="combobox"){if(!item.hidden){var strDesc=(typeof(item.desc)==="string"?item.desc:"")+"??? ";var desc_labelWidth=Ext.util.TextMetrics.measure(this.el,strDesc).width+items_desc_indent;if(item.indent){desc_labelWidth=desc_labelWidth+item.indent*30}labelWidth_array.push(desc_labelWidth)}config.width=285;if(type==="combobox"){var id=Ext.id();Ext.apply(config,Ext.apply(item,{id:id}));if(Ext.isObject(item.api_store)){config.mode="remote";config.store=new SYNO.API.JsonStore(Ext.apply(item.api_store,{autoDestroy:true,autoLoad:true,appWindow:this,listeners:{single:true,load:function(store,records){if(records&&records[0]&&records[0].id){var combo=Ext.getCmp(id);if(combo){combo.setValue(records[0].id)}}}}}));delete config.api_store}}else{Ext.apply(config,item)}if(item.emptyText){config.emptyText=item.emptyText}if(item.defaultValue){config.value=item.defaultValue}if(Ext.isObject(item.validator)){v=item.validator;if(Ext.isBoolean(v.allowBlank)){config.allowBlank=v.allowBlank}if(Ext.isNumber(v.minLength)){config.minLength=v.minLength}if(Ext.isNumber(v.maxLength)){config.maxLength=v.maxLength}if(Ext.isString(v.vtype)){config.vtype=v.vtype}if(Ext.isObject(v.regex)&&Ext.isString(v.regex.expr)){try{var regex;eval(String.format("regex = {0};",v.regex.expr));config.regex=regex;if(Ext.isString(v.regex.errorText)){config.regexText=Ext.util.Format.htmlEncode(v.regex.errorText)}}catch(e){SYNO.Debug(e);return true}}if(Ext.isString(v.fn)){config.fnstring=v.fn;config.validator=function(val){try{var fn;eval(String.format("fn = function(){0};",this.fnstring));var ret=fn(val,this,this.ownerCt);return Ext.isString(ret)?Ext.util.Format.htmlEncode(ret):ret}catch(e){SYNO.Debug(e);return true}}}}}else{if(Ext.isBoolean(item.defaultValue)){config.checked=item.defaultValue}if(Ext.isObject(item.validator)){v=item.validator;if(Ext.isString(v.fn)){config.fnstring=v.fn;config.getErrors=function(val){try{var fn;eval(String.format("fn = function(){0};",this.fnstring));var r=fn(this.getValue(),this,this.ownerCt);if(Ext.isBoolean(r)){return r===false?[""]:[]}if(Ext.isString(r)){try{this.ownerCt.ownerCt.owner.getMsgBox().alert(_T("tree","leaf_packagemanage"),r)}catch(e){}}return Ext.isString(r)?Ext.util.Format.htmlEncode(r):[]}catch(e){SYNO.Debug(e);return[]}}}}}desc=SYNO.SDS.Utils.GetLocalizedString(item.desc,this.dsm_apps[0])||item.desc;if(desc){config.boxLabel=config.fieldLabel=desc}if(k===0&&type==="singleselect"){config.checked=true}if(items[j].desc){config.indent=1}if(type==="combobox"){keys=keys.concat(["autoSelect","displayField","editable","forceSelection","handleHeight","listAlign","listEmptyText","listWidth","maxHeight","minChars","minHeight","minListWidth","mode","pageSize","queryDelay","queryParam","resizable","selectOnFocus","store","title","triggerAction","typeAhead","typeAheadDelay","valueField"])}if(type==="password"||type==="textfield"||type==="combobox"){keys=keys.concat(["blankText","grow","growMax","growMin","htmlEncode","maxLengthText","minLengthText"])}keys=keys.concat(["autoScroll","disabled","height","hidden","invalidText","margins","preventMark","width"]);Ext.copyTo(config,item,keys);config.listeners={buffer:100,check:function(){if((this.invalid_next_disabled_v2&&this.ownerCt&&this.ownerCt.getForm)||(undefined===this.invalid_next_disabled_v2&&pkguicfg.invalid_next_disabled&&this.ownerCt&&this.ownerCt.getForm)){this.ownerCt.owner.getButton("next").setDisabled(!this.ownerCt.getForm().isValid())}},change:function(field,newValue,oldValue){if(this.ownerCt&&this.ownerCt.owner&&this.ownerCt.owner.getActiveStep&&this.ownerCt!=this.ownerCt.owner.getActiveStep()){return}if((this.invalid_next_disabled_v2&&this.ownerCt&&this.ownerCt.getForm)||(undefined===this.invalid_next_disabled_v2&&pkguicfg.invalid_next_disabled&&this.ownerCt&&this.ownerCt.getForm)){this.ownerCt.owner.getButton("next").setDisabled(!this.ownerCt.getForm().isValid())}}};compitems.push(config)}}step_title=pkguicfg.step_title;config={headline:SYNO.SDS.Utils.GetLocalizedString(step_title,this.dsm_apps[0])||step_title,xtype:"syno_formpanel",border:false,items:compitems,labelWidth:labelWidth_array.length>0?Ext.max(labelWidth_array):200,invalid_next_disabled_v2:pkguicfg.invalid_next_disabled_v2,checkState:function(){SYNO.SDS.Wizard.Step.prototype.checkState.apply(this,arguments);if((this.invalid_next_disabled_v2&&this.getForm)||(undefined===this.invalid_next_disabled_v2&&pkguicfg.invalid_next_disabled&&this.getForm)){this.owner.getButton("next").setDisabled(!this.getForm().isValid())}},activateParam:pkguicfg.activate_v2,activate:function(){var fn;if(this.activateParam){eval(String.format("fn = function(){0};",this.activateParam));fn(this,this.ownerCt)}else{if(pkguicfg.activeate){eval(String.format("fn = function(){0};",pkguicfg.activeate));fn(this,this.ownerCt)}}},deactivateParam:pkguicfg.deactivate_v2,deactivate:function(action){var fn,r;if(this.deactivateParam){eval(String.format("fn = function(){0};",this.deactivateParam));r=fn(this,this.ownerCt,action);if(Ext.isBoolean(r)){return r}}else{if(pkguicfg.deactivate){eval(String.format("fn = function(){0};",pkguicfg.deactivate));r=fn(this,this.ownerCt,action);if(Ext.isBoolean(r)){return r}}}if(action==="next"&&this.getForm&&!this.getForm().isValid()){return false}return true}};steps.push(config)}return steps},getBasicPanel:function(a){var b=new SYNO.SDS.Utils.FormPanel(Ext.apply({labelWidth:200,headline:_T("pkgmgr","pkgmgr_pkg_install_wizard_upload_title"),description:_T("service","service_file_nofileselected_tip"),webapi:{api:"SYNO.Core.Package.Installation",method:"upload",version:1},fileUpload:true,border:false,items:[{xtype:"hidden",name:"additional",value:Ext.encode(["description","maintainer","distributor","startable","dsm_apps","status","install_reboot","install_type","install_on_cold_storage","break_pkgs","replace_pkgs"])},{fieldLabel:_T("common","file"),xtype:"syno_filebutton",name:"file"}],activate:function(){this.owner.isUploaed=false;if(this.owner.orimode===3){this.owner.setTitle(_T("pkgmgr","install_upgrade_title"))}if(a.itemId==="uploadStep"){this.owner.onSendCleanTmp(true)}},getNext:function(){if(this.owner.isUploaed){return this.nextId}var d=this.getForm().findField("file").getValue();if(d===""){this.owner.getMsgBox().alert(_T("tree","leaf_packagemanage"),_T("error","error_nochoosefile"));return false}var f=0;var h=["spk"];var c=d.toString().split(".");var g=c.pop();if(g!==undefined){for(var e=0;e<h.length;e++){if(g.toLowerCase()==h[e]){f=1;break}}}if(f){Ext.get(this.owner.id).mask(_T("common","msg_waiting"),"x-mask-loading");this.getForm().doAction("submit")}else{this.owner.getMsgBox().alert(_T("tree","leaf_packagemanage"),_T("pkgmgr","pkgmgr_file_not_package"))}return false}},a));return b},getLicencePanelConfig:function(a){var b=Ext.apply({hideMode:"offsets",headline:_T("pkgmgr","license_title"),description:_T("pkgmgr","license_desc_short"),xtype:"syno_formpanel",border:false,items:[{hideLabel:true,xtype:"syno_textarea",name:"licence",autoCreate:{tag:"textarea",autocomplete:"off",wrap:"Physical"},readOnly:true,cls:"selectabletext allowDefCtxMenu",width:650,height:220,value:""},{xtype:"syno_checkbox",boxLabel:_T("pkgmgr","license_accept"),name:"checklicence",listeners:{scope:this,check:function(c,d){this.getButton("next").setDisabled(!d)}}}],checkState:function(){SYNO.SDS.Wizard.Step.prototype.checkState.apply(this,arguments);this.getForm().findField("checklicence").setValue(false);this.owner.getButton("next").setDisabled(true)},activate:function(){try{this.getForm().findField("licence").setValue(decodeURIComponent(this.owner.pkgLicence))}catch(c){this.getForm().findField("licence").setValue(window.unescape(this.owner.pkgLicence))}},getNext:function(){var c;if(this.owner.volumes.length>1&&!this.owner.blUpgradeOrRepair&&Ext.isEmpty(this.owner.installVolume)&&"system"!==this.owner.install_type){c="volumeStep"}else{if(this.owner.customuiIds&&this.owner.customuiIds.length>0){c=this.owner.customuiIds[0]}else{c="applyStep"}}return c}},a);return b},getVolumePanelConfig:function(a){var d=new Ext.data.Record.create([{name:"name"},{name:"mount_point"},{name:"description"}]),b,f;this.volumeStore=new Ext.data.ArrayStore({fields:["mount_point","name","description"],data:[]});var c=new SYNO.ux.StorageComboBox({store:this.volumeStore,name:"voulme_list",displayField:"name",descriptionField:"description",valueField:"mount_point",mode:"local",editable:false,hideLabel:true,triggerAction:"all",width:285});var e=Ext.apply({headline:_T("pkgmgr","pkgmgr_pkg_install_wizard_selectvol_title"),xtype:"syno_formpanel",border:false,items:[c,{xtype:"syno_displayfield",height:195},{xtype:"syno_checkbox",boxLabel:_T("pkgmgr","be_default_vol"),name:"be_default_vol"}],activate:function(){this.owner.blSetDefaultVol=false;var g=this.getForm().findField("be_default_vol");g.setVisible(!this.owner.install_on_cold_storage);if(!c.getValue()){this.owner.volumeStore.removeAll();if(this.owner.volumes){for(b=0;b<this.owner.volumes.length;b++){f=new d({name:this.owner.volumes[b].name,mount_point:this.owner.volumes[b].mount_point,description:Ext.util.Format.htmlEncode(this.owner.volumes[b].description)});this.owner.volumeStore.add(f)}c.setValue(this.owner.volumes[0].mount_point)}}},getNext:function(){var g=this.getForm().findField("be_default_vol").getValue();var j=this.getForm().findField("voulme_list").getValue();if(this.owner.blSetDefaultVol){this.owner.installVolume=j;return(this.owner.customuiIds&&this.owner.customuiIds.length>0)?this.owner.customuiIds[0]:"applyStep"}this.owner.setStatusBusy({text:_T("common","saving")});var i=this.owner.volumeStore.findExact("mount_point",j);var h=g?this.owner.volumeStore.getAt(i).get("mount_point"):"";this.owner.sendWebAPI({api:"SYNO.Core.Package.Setting.Volume",method:"set",version:1,params:{default_vol:h},scope:this.owner,callback:function(l,k){this.clearStatusBusy();if(!l){if(!k||!k.code){this.getMsgBox().alert(_T("tree","leaf_packagemanage"),_T("error","error_error_system"))}else{this.getMsgBox().alert(_T("tree","leaf_packagemanage"),SYNO.API.getErrorString(k.code))}return}this.blSetDefaultVol=true;this.goNext(this.getActiveStep().getNext())}});return false}},a);return e},getInfoPanelConfig:function(a){var b=Ext.apply({description:_T("pkgmgr","pkgmgr_pkg_install_wizard_summary_desc"),headline:_T("pkgmgr","pkgmgr_pkg_install_wizard_summary_title"),xtype:"syno_formpanel",items:[{xtype:"syno_gridpanel",border:false,stripeRows:true,height:250,viewConfig:{getRowClass:function(c){if(c.data.id==="description"){return"syno-pkg-wizard-desc"}return""}},columns:[{header:_T("status","header_item"),width:100,sortable:false,dataIndex:"name",renderer:function(e,d){var c=Ext.util.Format.htmlEncode(e);d.attr='ext:qtip="'+Ext.util.Format.htmlEncode(c)+'"';return c}},{header:_T("status","header_value"),width:220,sortable:false,dataIndex:"value",renderer:function(e,d){var c=Ext.util.Format.htmlEncode(e);d.attr='ext:qtip="'+Ext.util.Format.htmlEncode(c)+'"';return c}}],store:this.getDetailsStore()},{xtype:"syno_checkbox",boxLabel:_T("pkgmgr","install_runpackage"),name:"runafterinstall"}],activate:function(){this.owner.loadInfo();var c=this.getForm().findField("runafterinstall");var d=this.owner.pkgStartable&&!this.owner.pkgNeedReboot&&!this.owner.blUpgradeOrRepair;c.setVisible(d);c.setValue(d);if(this.owner.mode){this.description=_T("pkgmgr","pkgmgr_pkg_upgrade_wizard_summary_desc")}},getNext:function(){var h=this.getForm().findField("runafterinstall").getValue();var e=this.owner.pkgNeedReboot?false:(this.owner.enumInstallMode.install===this.owner.installMode&&(h||!this.owner.pkgStartable))||this.owner.enumInstallMode.repair===this.owner.installMode||(this.owner.enumInstallMode.upgrade===this.owner.installMode&&"running"===this.owner.originalStatus);if(this.owner.pkgqinst){var c=this.owner.owner;var j=this.owner.pkgqinstrec;var f=this.owner.installVolume;this.owner.goNext(null);c._onRequestQuickInstall(j,f,e);return false}var d=this.owner.blUpgradeOrRepair?_T("pkgmgr","upgrading"):_T("pkgmgr","installing");this.owner.setStatusBusy({text:d});var k=this.owner.getComponent("steps");var g=[{api:"SYNO.Core.Package.Installation",method:"check",version:2,params:{id:this.owner.pkgName,install_type:this.owner.install_type,install_on_cold_storage:this.owner.install_on_cold_storage,breakpkgs:((""===this.owner.break_pkgs)?null:this.owner.break_pkgs),blCheckDep:this.owner.getStep("uploadStep")?true:false,replacepkgs:((""===this.owner.replace_pkgs)?null:this.owner.replace_pkgs)}},{api:"SYNO.Core.Package.Installation",method:"install",version:1,params:{volume_path:this.owner.installVolume,extra_values:Ext.encode(this.owner.getCustData(k)),type:this.type||0,check_codesign:this.owner.check_codesign,force:this.owner.getStep("uploadStep")?false:true}}];if(this.owner.upload_task_id){g[1].params.task_id=this.owner.upload_task_id}else{g[1].params.path=this.owner.uploadFilename}if(e){g.push({api:"SYNO.Core.Package.Control",method:"start",version:1,params:{id:this.owner.pkgName,type:"install"}})}g.push({api:"SYNO.Core.Package",method:"get",version:1,params:{id:this.owner.pkgName,additional:["status","dsm_apps"]}});var i=function(p){var m=p.getById(this.owner.pkgName);if(!m||this.owner.isDestroyed){return}var n=m.data.progress;var l=m.data.status;var o;var q=this.owner._GetProcessStatus(l,n);if(q.blProcessing){if(l==="stopping"){o=_T("pkgmgr","upgrading")}else{o=q.msg}}else{if(n){o=Math.floor(n*100)+"% "+d;this.owner.el.mask(Math.floor(n*100)+"% "+d,"x-mask-loading")}}this.owner.el.mask(o||d,"x-mask-loading")};SYNO.SDS.StatusNotifier.fireEvent("pkgctl",this.owner.pkgName,this.owner.blUpgradeOrRepair?"upgrade":"install","pre");this.sendWebAPI({timeout:3600000,compound:{stopwhenerror:true,params:g},scope:this,callback:function(o,l,n,m){if(!(o&&l&&!l.has_fail)){this.owner.el.unmask()}this.mun(this.owner.owner.stores.installed,"load",i,this);this.owner.clearStatusBusy();this.owner._handleApplyDone(o,l,n,m)}});if(this.owner.dsm_apps){Ext.each(this.owner.dsm_apps,function(l){var m=SYNO.SDS.AppMgr.getByAppName(l);Ext.each(m,function(n){if(n.window){n.window.close()}});SYNO.SDS.JSLoad.RemoveJSSatusByAppName(l)})}this.owner.owner.fireEvent("pollinginstpage");this.mon(this.owner.owner.stores.installed,"load",i,this);return false}},a);return b},getCustData:function(a){var b={};Ext.each(this.customuiIds,function(e){var c=a.get(e).getForm();var d={};c.items.each(function(g){if("displayfield"!==g.getXType()&&"syno_displayfield"!==g.getXType()){d[g.itemId]=g.getValue()}});Ext.apply(b,d)},this);return b},getDetailsStore:function(){this.store=new Ext.data.JsonStore({autoLoad:false,autoDestroy:true,root:"items",fields:["id","name","value"]});return this.store},loadInfo:function(){var b=[{id:"name",name:_T("pkgmgr","pkgmgr_pkg_name"),value:this.dname||this.pkgName},{id:"version",name:_T("pkgmgr","pkgmgr_pkg_version"),value:this.pkgVersion},{id:"maintainer",name:_T("pkgmgr","pkgmgr_pkg_maintainer"),value:this.maintainer}];if(this.pkgDistributor){b.push({id:"distributor",name:_T("pkgmgr","pkgmgr_pkg_distributor"),value:this.pkgDistributor})}if(this.install_type==="system"){b.push({id:"volume",name:_T("pkgmgr","pkgmgr_pkg_install_volume"),value:_T("pkgmgr","system_volume")})}else{if(this.volumes&&1<=this.volumes.length){for(var a=0;a<this.volumes.length;a++){if(this.volumes[a].mount_point==this.installVolume){b.push({id:"volume",name:_T("pkgmgr","pkgmgr_pkg_install_volume"),value:this.volumes[a].name});break}}}}b.push({id:"description",name:_T("pkgmgr","pkgmgr_pkg_description"),value:this.desc});this.store.loadData({items:b})},onSyncCleanTmp:function(){Ext.EventManager.un(window,"unload",this.onSyncCleanTmp,this);SYNO.SDS.StatusNotifier.un("logout",this.onSyncCleanTmp,this);this.onSendCleanTmp(false)},onAsyncCleanTmp:function(){Ext.EventManager.un(window,"unload",this.onSyncCleanTmp,this);SYNO.SDS.StatusNotifier.un("logout",this.onSyncCleanTmp,this);this.onSendCleanTmp(true)},onSendCleanTmp:function(a){var b;if(this.uploadFilename){b={path:this.uploadFilename};this.sendWebAPI({api:"SYNO.Core.Package.Installation",method:"delete",version:1,params:b,async:a,timeout:a?30000:1000})}else{if(this.upload_task_id){b={task_id:this.upload_task_id};this.sendWebAPI({api:"SYNO.Core.Package.Installation",method:"clean",version:1,params:b,async:a,timeout:a?30000:1000})}}this.uploadFilename=null;this.upload_task_id=null}});SYNO.SDS.PkgManApp.UninstallWizardDialog=Ext.extend(SYNO.SDS.PkgManApp.WizardDialog,{constructor:function(a){SYNO.SDS.PkgManApp.Utils.Utils._initWinWrappers.call(this,a);this.packagename=a.packagename;this.dsm_apps=[];if(a.dsm_apps){this.dsm_apps=a.dsm_apps.split(" ")}SYNO.SDS.PkgManApp.WizardDialog.superclass.constructor.call(this,Ext.apply(a,{dsmStyle:"v5",title:_T("tree","leaf_packagemanage"),width:700,height:500,steps:[this.getBasicPanel({itemId:"confirmStep",nextId:true})]}));this.mon(this,"beforeshow",function(){SYNO.SDS.PkgManApp.Utils.Utils.setGlobalValue()});this.mon(this,"beforeclose",function(){SYNO.SDS.PkgManApp.Utils.Utils.cleanGlobalValue()},this)},getBasicPanel:function(a){var b=Ext.apply({headline:_T("pkgmgr","pkgmgr_pkg_uninstall"),xtype:"syno_formpanel",border:false,items:[{xtype:"syno_displayfield",value:_T("pkgmgr","pkgmgr_pkg_uninstall_warn")}],getNext:function(){this.owner.loadUIfile();return false}},a);return b},loadUIfile:function(){Ext.get(this.id).mask(_T("common","msg_waiting"),"x-mask-loading");var a={id:this.packagename,additional:["uninstall_pages"]};this.sendWebAPI({api:"SYNO.Core.Package",method:"get",version:1,params:a,scope:this,callback:this.handelloadUIfileDone})},handelloadUIfileDone:function(f,b,e,d){Ext.get(this.id).unmask();if(!f||!b.additional||!b.additional.uninstall_pages){this._showErrMsg(b);return}var c=b.additional.uninstall_pages;if(c){var a=this.parseCustomui(c);a[a.length-1].getNext=function(){var h=this.owner.getActiveStep(),g;if(h){g=h.getItemId();if(Ext.isFunction(h.deactivate)){if(false===h.deactivate("next")){return false}}}this.owner.setStatusBusy();var i={id:this.owner.packagename,extra_values:Ext.encode(this.owner.getCustData(this.owner.getComponent("steps"))),dsm_apps:this.owner.dsm_apps};SYNO.SDS.StatusNotifier.fireEvent("pkgctl",i.id,"uninstall","pre");this.sendWebAPI({api:"SYNO.Core.Package.Uninstallation",method:"uninstall",version:1,params:i,timeout:3600000,scope:this,callback:function(n,j,m,k){if(!this.owner.isDestroyed&&n){this.owner.fireEvent("uninstalldone")}if(k&&k.params&&k.params.id){var l=SYNO.SDS.PkgManApp.Action._getInstalledStore().getById(k.params.id);if(l){SYNO.SDS.PkgManApp.Action._getInstalledStore().remove(l)}}this.owner.clearStatusBusy();this.owner._handleApplyDone(n,j,m,k)}});return false};this.customuiIds=this.appendSteps(a)}else{this.customuiIds=undefined}if(this.customuiIds&&this.customuiIds.length>0){this.goNext(this.customuiIds[0])}else{this._showErrMsg()}}});Ext.define("SYNO.SDS.PkgManApp.Toolbar",{extend:"SYNO.ux.Toolbar",helper:SYNO.SDS.PkgManApp.Utils.Helper,constructor:function(a){this.callParent([this.fillConfig(a)])},fillConfig:function(a){var b={height:40,cls:"syno-pkg-toolbar",backStack:[],forwardStack:[],currentPage:{},items:[this.createItems()]};Ext.apply(b,a);return b},createItems:function(){this.searchField=new SYNO.SDS.PkgManApp.Utils.SearchField({width:"100%",owner:this,style:{width:"calc(100% - 30px - 3px)"}});this.backBtn=new Ext.Action({cls:"syno-pkg-backbtn-container",iconCls:"syno-pkg-backbtn",scope:this,handler:this.jumpBack,height:28,disabled:true});this.nextBtn=new Ext.Action({cls:"syno-pkg-nextbtn-container",iconCls:"syno-pkg-nextbtn",scope:this,handler:this.jumpForward,height:28,disabled:true});this.refreshBtn=new Ext.Action({cls:"syno-pkg-refreshbtn-container",iconCls:"syno-pkg-refreshbtn",scope:this,handler:this.onClickRefreshBtn,height:28,disabled:false});var a=[this.backBtn,this.nextBtn,this.refreshBtn,this.searchField,{xtype:"displayfield",width:16},new Ext.Action({scope:this,handler:function(){this.owner._prepareVolume(3)},height:28,text:this.helper.T("install_upgrade_title")}),new Ext.Action({scope:this,handler:function(){var b=new SYNO.SDS.PkgManApp.SettingDialog({owner:this.owner});b.show()},height:28,text:this.helper.T("common","common_settings")})];return a},setNavBtn:function(){this.backBtn.disable();this.nextBtn.disable();if(this.backStack.length>0){this.backBtn.enable()}if(this.forwardStack.length>0){this.nextBtn.enable()}},onClickRefreshBtn:function(){var a=this.refreshBtn;this.owner.setStatusBusy();a.disable();this.owner.onLoadSynoPkgStore(true,function(){this.clearStatusBusy();a.enable()});this.owner.onLoadOtherPkgStore()},jumpTo:function(b,a,c,d){if(this.currentPage.tab===b&&this.currentPage.card===a&&this.currentPage.pkgId===c&&this.currentPage.searchtext===d){return}this.backStack.push(this.currentPage);this.currentPage={tab:b,card:a,pkgId:c,searchtext:d};this._jumpTo(this.currentPage);this.forwardStack.length=0;this.setNavBtn()},_jumpTo:function(b){this.owner.pageList.getNodeById(b.tab).select();if(b.pkgId){this.owner.pageCt.ownerCt.pageCt.getComponent(b.tab).getComponent(b.card).setPkg(b.pkgId)}if(b.searchtext&&b.tab==="SYNO.SDS.PkgManApp.All.Panel"){var a=this.owner.pageCt.ownerCt.pageCt.getComponent(b.tab).categorySelector;var c=a.setValue(b.searchtext);a.fireEvent("select",a,c.getStore().getById(b.searchtext))}else{if(b.searchtext){this.searchField.setValue(b.searchtext);this.owner.pageCt.ownerCt.pageCt.getComponent(b.tab).onLoadData()}}this.owner.pageCt.ownerCt.pageCt.getComponent(b.tab).layout.setActiveItem(b.card);if(b.pkgId){this.owner.pageCt.ownerCt.pageCt.getComponent(b.tab).getComponent(b.card).onActivate()}},jumpBack:function(){this.forwardStack.push(this.currentPage);this.currentPage=this.backStack.pop();this._jumpTo(this.currentPage);if(this.backStack.length<1){this.backBtn.disable()}this.setNavBtn()},jumpForward:function(){this.backStack.push(this.currentPage);this.currentPage=this.forwardStack.pop();this._jumpTo(this.currentPage);if(this.forwardStack.length<1){this.nextBtn.disable()}this.setNavBtn()},setCurrentPage:function(b,a,c){if(b===this.currentPage.tab&&a===this.currentPage.card&&this.currentPage.searchtext===c){return}if(this.currentPage.tab){this.backStack.push(this.currentPage)}this.currentPage={tab:b,card:a,searchtext:c};this.forwardStack.length=0;this.setNavBtn()}});Ext.define("SYNO.SDS.PkgManApp.Instance",{extend:"SYNO.SDS.AppInstance",appWindowName:"SYNO.SDS.PkgManApp.MainWindow"});Ext.define("SYNO.SDS.PkgManApp.MainWindow",{extend:"SYNO.SDS.PageListAppWindow",defaultWinSize:{width:1060,height:580},minWinSize:{width:880,height:580},helper:SYNO.SDS.PkgManApp.Utils.Helper,storeHelper:SYNO.SDS.PkgManApp.Utils.StoreHelper,constructor:function(a){SYNO.SDS.PkgManApp.Window=this;this.synopkglistHash=0;this.progressDatas={};this.synoAccountInfo={};SYNO.SDS.PkgManApp.Utils.Utils._initWinWrappers.call(this,a);this.initStoreObjs();this.callParent([this.fillConfig(a)]);this.loadCfg();this.checkTerm();this.mon(this.pageList,"click",this.setToListView);this.mon(this,"pollinginstpage",this.onRestartPollingInst,this,{buffer:500});this.mon(this,"pollingserverlistcheck",this.startServerListCheckPolling,this);this.mon(this,"disagreeterm",function(){this.close()});this.addEvents("status_load")},fillConfig:function(a){this.createStores();var b=[{text:this.helper.T("install_packages"),iconCls:"icon-installed",fn:"SYNO.SDS.PkgManApp.Installed.Panel"},{text:this.helper.T("class_all"),iconCls:"icon-dsm-apps",fn:"SYNO.SDS.PkgManApp.All.Panel"},{text:this.helper.T("class_beta"),iconCls:"icon-beta",hidden:true,fn:"SYNO.SDS.PkgManApp.Beta.Panel"},{text:this.helper.T("class_community"),iconCls:"icon-community",hidden:true,fn:"SYNO.SDS.PkgManApp.Community.Panel"},{hidden:true,fn:"SYNO.SDS.PkgManApp.SearchResult.Panel"}];this.toolBar=new SYNO.SDS.PkgManApp.Toolbar({owner:this});var c={width:this.defaultWinSize.width,height:this.defaultWinSize.height,minWidth:this.minWinSize.width,minHeight:this.minWinSize.height,tbar:this.toolBar,listItems:b,activePage:"SYNO.SDS.PkgManApp.Installed.Panel",listeners:{activate:this.onActivate,deactivate:this.onDeactivate}};Ext.apply(c,a);return c},onOpen:function(a){this.getSynoAccountInfo();this.callParent(arguments);this.createPollingTask(a)},setToListView:function(b){var a=b.ownerTree.ownerCt.pageCt.getComponent(b.id);if(a){SYNO.SDS.PkgManApp.Window.setCurrentPage(a.panelName,0);a.layout.setActiveItem(0)}},setDynamicTabs:function(a,b){if(a){this.pageList.getNodeById("SYNO.SDS.PkgManApp.Beta.Panel").getUI().show()}else{if(this.pageList.getNodeById("SYNO.SDS.PkgManApp.Beta.Panel").isSelected()){this.pageList.getNodeById("SYNO.SDS.PkgManApp.Installed.Panel").select()}this.pageList.getNodeById("SYNO.SDS.PkgManApp.Beta.Panel").getUI().hide()}if(b){this.pageList.getNodeById("SYNO.SDS.PkgManApp.Community.Panel").getUI().show()}else{if(this.pageList.getNodeById("SYNO.SDS.PkgManApp.Community.Panel").isSelected()){this.pageList.getNodeById("SYNO.SDS.PkgManApp.Installed.Panel").select()}this.pageList.getNodeById("SYNO.SDS.PkgManApp.Community.Panel").getUI().hide()}},loadCfg:function(a){a=a||Ext.emptyFn;this.sendWebAPI({api:"SYNO.Core.Package.Info",method:"get",version:1,scope:this,callback:function(c,b){if(!c||!b||Ext.isEmpty(b.myPayBaseURL)){if(!b.code){this.getMsgBox().alert(this.title,this.helper.T("common","commfail"))}else{this.getMsgBox().alert(this.title,SYNO.API.getErrorString(b.code))}}else{Ext.apply(SYNO.SDS.PkgManApp.Config,b);Ext.apply(SYNO.SDS.PkgManApp.Config,{myDSURL:SYNO.SDS.PkgManApp.Config.myPayBaseURL+"/api/purchase5_1.html"})}this.pageList.getNodeById("SYNO.SDS.PkgManApp.SearchResult.Panel").getUI().hide();this.setDynamicTabs(b.blBetaChannel,b.blOtherServer);a.call(this)}})},createPollingTask:function(a){if(!this.firstLoadInstPkg){this.setStatusBusy()}this.instListPolling=this.addWebAPITask({id:"pkgManPollingTask",scope:this,interval:this.getPollingInterval.createDelegate(this),api:"SYNO.Core.Package",method:"list",version:2,params:{additional:["description","description_enu","beta","distributor","distributor_url","maintainer","maintainer_url","dsm_apps","report_beta_url","support_center","startable","installed_info","support_url","is_uninstall_pages","install_type","autoupdate","silent_upgrade","installing_progress","ctl_uninstall","updated_at"],polling_interval:15},callback:function(d,c,b){if(this.isDestroyed){this.instListPolling.stop();return}if(!d&&(!c||c.isTimeout||c.isAbort||c.statusText==="communication failure")){this.fireEvent.defer(3000,this,["pollinginstpage"]);return}this.onData(c);if(!this.firstLoadInstPkg){this.firstLoadInstPkg=true;this.clearStatusBusy();this.blForceSelectPage=true;this.pageList.getNodeById("SYNO.SDS.PkgManApp.All.Panel").select();this.blForceSelectPage=false;SYNO.SDS.PkgManApp.Window.setCurrentPage("SYNO.SDS.PkgManApp.All.Panel",0);this.instListPolling.reqConfig.params.additional.push("status","url");this.fireEvent("pollinginstpage")}else{this.updateNotificationBubble();this.fireEvent("status_load")}if(a&&a.action){this.beforeAction(a);a=null}}});this.serverListCheckPolling=this.addWebAPITask({id:"serverListCheckPolling",scope:this,interval:15000,api:"SYNO.Core.Package.Server",method:"get_hash",version:1,callback:function(c,b){if(this.isDestroyed){this.serverListCheckPolling.stop();return}if(!c||!b||!b.hasOwnProperty("hash")||!b.hash){return}if(this.synopkglistHash&&b.hash!=this.synopkglistHash){this.setStatusBusy();this.onLoadSynoPkgStore(true,(function(){this.clearStatusBusy()}).createDelegate(this))}this.synopkglistHash=b.hash}})},beforeAction:function(b){var a=this._getSynoServerObj().store;this.installData=b;if(0===a.getTotalCount()||a.loading){this.mon(a,"load",this.onLoadCallBack,this);a.reload()}else{this.doAction(b,a)}},doAction:function(b,a){if(!b){return}if("open"===b.action){this.doOpenAction(b,a)}else{if("install"===b.action){this.doInstallAction(b,a)}}},onLoadCallBack:function(a,b){this.mun(a,"load",this.onLoadCallBack,this);this.doAction(this.installData,a)},doOpenAction:function(b,a){this.jumpTo("SYNO.SDS.PkgManApp.All.Panel",1,b.packages[0])},doInstallAction:function(d,b){var c=0,a=[],f="";for(c=0;c<d.packages.size();c++){var e=b.getById(d.packages[c]);if(e&&this._isQuickInstll(e.data)&&!this._isFirstBuy(e)&&!this._isLicenseError(e)&&SYNO.SDS.PkgManApp.Utils.Utils.mode.open!==e.data.open){this._onClickSynoPkgActionBtn(e,true)}else{if(e&&SYNO.SDS.PkgManApp.Utils.Utils.mode.open!==e.data.open){a.push(e)}}}if(1===a.length){this._onClickSynoPkgActionBtn(a[0],true)}if(1<a.length){for(c=1;c<a.length;c++){f=f+a[c].id+" "}f=String.format(_T("pkgmgr","auto_install"),a[0].id,f);this.getMsgBox().alert("title",f,function(){this._onClickSynoPkgActionBtn(a[0],true)},this)}},onData:function(f){var c=this.stores.installed;var d={};c.each(function(g){this.clearStatus(this.stores.stable,g.id);this.clearStatus(this.stores.beta,g.id);this.clearStatus(this.stores.community,g.id);d[g.id]=g},this);c.suspendEvents();c.loadData(f);c.resumeEvents();this.blProcessing=false;for(var b in this.progressDatas){if(this.progressDatas.hasOwnProperty(b)){var a=this.progressDatas[b];if(c.getById(b)&&a.blNewlyInstalled){delete SYNO.SDS.PkgManApp.Window.progressDatas[b]}if((a.progress&&a.progress>0)||a.info){this.blProcessing=true;break}}}c.each(function(g){if(this._GetProcessStatus(g.data.status).blProcessing){this.blProcessing=true}if(!g.data.status){g.data.status="loading"}d[g.id]=g},this);c.fireEvent("datachanged",c);c.fireEvent("load",c,c.data.items);for(var e in d){if(d.hasOwnProperty(e)){this.triggerUpdate(this.stores.stable,e);this.triggerUpdate(this.stores.beta,e);this.triggerUpdate(this.stores.community,e)}}},clearStatus:function(b,c){var a=b.getById(c);if(a===undefined){return}["dsm_apps","status","url","broken_by"].each(function(d){a.data[d]=""},this)},onActivate:function(){this.fireEvent("pollinginstpage");this.callParent(arguments)},onDeactivate:function(){if(!this.isVisible()){this.instListPolling.stop()}this.callParent(arguments)},onClose:function(){if(this.isUpdating()&&!(window.confirm(_T("pkgmgr","close_updateall_confirm")))){return false}this.instListPolling.remove();this.callParent(arguments)},getStore:function(a){return this.stores[a]},onRestartPollingInst:function(){if(this.isDestroyed){return}this.instListPolling.reqConfig.params.polling_interval=this.getPollingInterval()/1000;this.instListPolling.restart(true)},startServerListCheckPolling:function(){this.serverListCheckPolling.start()},getPollingInterval:function(){var a=15000;if(this.blProcessing){a=3000}else{if(this.modalWin&&this.modalWin[0]&&this.modalWin[0].jsConfig&&this.modalWin[0].jsConfig.jsID==="SYNO.SDS.PkgManApp.WizardDialog"){a=3000}}if(this.instListPolling){if(this.instListPolling.reqConfig.params.polling_interval!=(a/1000)){this.instListPolling.reqConfig.params.polling_interval=a/1000;this.instListPolling.restart(true)}}return a},initStoreObjs:function(){this.synoObj={blUpgradeList:false,blFirstLoadStore:false};this.otherObj={blUpgradeList:false,blFirstLoadStore:false};this.betaObj={blUpgradeList:false,blFirstLoadStore:false}},onLoadPkgStore:function(c,a,b){if(this.synoObj.store.getById(c)){this.onLoadSynoPkgStore(a,b)}else{if(this.betaObj.store.getById(c)){this.onLoadBetaPkgStore(a,b)}else{this.onLoadOtherPkgStore(a,b)}}},onLoadOtherPkgStore:function(a,b){this.onLoadPkgStoreFn(this.otherObj,a,b)},onLoadSynoPkgStore:function(a,b){this.onLoadPkgStoreFn(this.synoObj,a,b)},onLoadBetaPkgStore:function(a,b){this.onLoadPkgStoreFn(this.betaObj,a,b)},onLoadPkgStoreFn:function(b,a,c){if(false===c){b.store.reload()}else{b.store.load({callback:c,scope:this})}},generateReplacementData:function(a){var b={replacement:[]};["packages","beta_packages"].each(function(c){a[c].each(function(e){if(e.replaceforcepkgs){for(var d in e.replaceforcepkgs){if(e.replaceforcepkgs.hasOwnProperty(d)){b.replacement.push({id:d,replacedby:e.id})}}}})});return b},createStore:function(c){var b=(c===this.synoObj);var a=new Ext.data.Store({autoLoad:true,autoDestroy:false,remoteSort:false,baseParams:{blforcereload:false,blloadothers:!b},proxy:new SYNO.API.Proxy({api:"SYNO.Core.Package.Server",method:"list",version:2,listeners:{scope:this,load:function(f,e){c.blUpgradeList=true;if(b){this.synopkglistHash=0;this.betaObj.blUpgradeList=true;var d={categories:[{id:"all",dname:this.helper.T("class_all")}].concat(e.categories)};SYNO.SDS.PkgManApp.Window.getStore("category").loadData(d);SYNO.SDS.PkgManApp.Window.getStore("beta").loadData(e);SYNO.SDS.PkgManApp.Window.getStore("banner").loadData(e);SYNO.SDS.PkgManApp.Window.getStore("replacement").loadData(this.generateReplacementData(e))}if(!c.store.isDestroyed){c.store.each(function(g){if(this._IsInstalling(g.data)){this._getOwner().fireEvent("pollinginstpage");return false}},this)}if(!c.blFirstLoadStore&&b){SYNO.API.Request({api:"SYNO.Core.Package.Server",method:"check",version:1});this.fireEvent("pollingserverlistcheck")}c.blFirstLoadStore=true}}}),reader:new Ext.data.JsonReader({root:"packages",id:"id"},this.storeHelper.getServerStoreItem()),listeners:{scope:this,beforeLoad:this._onBeforeLoad,exception:this._onExceptionLoad,load:this._onAfterLoad}});this.addManagedComponent(a);return a},updateNotificationBubble:function(){var a=0;this._getInstalledStore().each(function(b){if(this._isUpgradable(b.data.id)||SYNO.SDS.PkgManApp.Utils.Utils.isBrokenStatus(b.data)||this._isUpgradableFromBetaToStable(b.data.id)){a++}},this);if(this.previousOperablePkgNum==a){return}this.previousOperablePkgNum=a;if(a>0){SYNO.SDS.PkgManApp.Window.setNotification("SYNO.SDS.PkgManApp.Installed.Panel",a)}else{SYNO.SDS.PkgManApp.Window.clearNotification("SYNO.SDS.PkgManApp.Installed.Panel")}},_onBeforeLoad:function(a,b){if(Ext.isEmpty(b)||Ext.isEmpty(b.params)){return}a.loading=true},_onAfterLoad:function(b,a,c){if(Ext.isEmpty(c)){return}b.exception=false;b.loading=false},_onExceptionLoad:function(d,e,f,c){var a=c.params.blloadothers?"community":"stable";var b=this.getStore(a);b.exception=true},setCurrentPage:function(){this.toolBar.setCurrentPage.apply(this.toolBar,arguments)},jumpTo:function(){this.toolBar.jumpTo.apply(this.toolBar,arguments)},createStores:function(){this.stores={};this.stores.installed=this.storeHelper.createInstalledStore();this.betaObj.store=this.stores.beta=this.storeHelper.createBetaStore();this.stores.category=this.storeHelper.createCategoryStore();this.stores.banner=this.storeHelper.createBannerStore();this.stores.replacement=this.storeHelper.createReplacementStore();this.synoObj.store=this.stores.stable=this.createStore(this.synoObj);this.otherObj.store=this.stores.community=this.createStore(this.otherObj)},isUpdating:function(){return(!this._IsInsting_Background())},showTermDialog:function(b){var a=new SYNO.SDS.PkgManApp.TermDialog({owner:this,curr_term_version:b?b.curr_term_version:undefined});if(!b||!b.hasOwnProperty("agreed_term_version")||b.curr_term_version!=b.agreed_term_version){a.show()}},checkTerm:function(){if(!_S("demo_mode")){this.get_term_version()}},get_term_version:function(){this.setStatusBusy();this.sendWebAPI({api:"SYNO.Core.Package.Term",method:"get_version",version:1,scope:this,callback:function(b,a){this.clearStatusBusy();if(!b||!a){this.showTermDialog();return}this.showTermDialog(a)}})},getSynoAccountInfo:function(){this.sendWebAPI({api:"SYNO.Core.Package.Account",method:"get",version:1,params:{options:["currency"]},scope:this,callback:function(b,a){this.synoAccountInfo={};if(b&&a){this.synoAccountInfo=a}}})},onBeforeSelect:function(){if(this.blForceSelectPage){return true}return this.callParent(arguments)}});