/* Copyright (c) 2020 Synology Inc. All rights reserved. */

Ext.namespace("SYNO.SDS.iSCSI.LUN");SYNO.SDS.iSCSI.LUN.Status=function(){var a="blue-status";return{defragging:{text:_T("iscsilun","defragging"),color:a},transforming:{text:_T("iscsilun","converting"),color:a}}}();Ext.namespace("SYNO.SDS.iSCSI.Utils");SYNO.SDS.iSCSI.Utils=function(){var a=SYNO.SDS.Utils.StorageUtils.UiRenderHelperInitializer();return{SpaceIDParser:function(b){return b?SYNO.SDS.Utils.StorageUtils.SpaceIDParser(b):""},TargetStatusRender:a.TargetStatusRender,SizeRender:a.SizeRender,LunStatusRender:a.LunStatusRender,PercentRender:a.PercentRender,StatusNameRender:function(b){var c=SYNO.SDS.iSCSI.LUN.Status[b];if(undefined!==c){return String.format('<span class="{0}">{1}</span>',c.color,c.text)}else{return a.StatusNameRender(b)}},RootPathParser:function(b){var c="";if(0===b.search("/volume")){c=b.replace("/volume","volume_")}return this.SpaceIDParser(c)},SetActionLunParentStatus:function(c){var b=function(e,f){var d;Ext.each(e,function(g){if(f===g.iscsi_lun.lid){d=g;return false}});return d};Ext.each(c,function(e){var d;if("cloning"===e.status){d=b(c,e.iscsi_lun.parent.plid);if(Ext.isDefined(d)&&!d.is_actioning){d.status="using";d.is_actioning=true}}})},LunParentRender:function(e,b){var g,d,f,c;if(!Ext.isObject(b.parent)||b.lid===b.parent.plid){return false}g=e.getMatched(function(){if(this.get("iscsi_lun").lid===b.parent.plid){return true}});if(0===g.length){return false}d=g[0].get("iscsi_lun");f=d.name;if(0===b.parent.psid){return f}Ext.each(d.snapshots,function(h){if(b.parent.psid===h.sid){c=h.name;return false}});if(c){return f+" / "+c}else{return f}},SupportSnapshot:function(){if("yes"===_D("support_vaai","no")){return true}return false},genNewSnapShotName:function(d){var c="SnapShot-",b=c.length,e=0;Ext.each(d,function(f){var g=parseInt(f.name.slice(b),10);if(e<g){e=g}});e=e+1;return c+e},renderPermission:function(c){var b={rw:_T("share","share_permission_writable"),r:_T("share","share_permission_readonly"),"-":_T("share","share_permission_none")};if(c in b){return b[c]}else{return c}},renderIQN:function(d,c){var b=(SYNO.SDS.iSCSI.TARGET.DefaultIQN===d)?_T("iscsitrg","iscsitrg_masking_default"):d;if(c){c.attr='ext:qtip="'+Ext.util.Format.htmlEncode(b)+'"'}return b},stringNaturalSort:function(d,c){return Ext.data.SortTypes.asNaturalUCString(d).localeCompare(Ext.data.SortTypes.asNaturalUCString(c))}}}();SYNO.SDS.iSCSI.Utils.ISCSITRG_UNIT_GB=1024*1024*1024;SYNO.SDS.iSCSI.Utils.T=function(b,a){return _TT("SYNO.SDS.DisasterRecovery.Application",b,a)};SYNO.SDS.iSCSI.Utils.TipRender=function(b,a){a.attr='ext:qtip="'+Ext.util.Format.htmlEncode(Ext.util.Format.htmlEncode(b))+'"';return Ext.util.Format.htmlEncode(b)};SYNO.SDS.iSCSI.Utils.lunCanSnapshot=function(b){var a;if(!b){return false}if(!!(b.get("is_actioning"))){return false}a=b.get("status");if("crashed"===a||"unavailabling"===a){return false}if(true!==b.get("support_snapshot")){return false}if("be_cloning"!==a&&"using"!==a&&"snapshotting"!==a&&!!(b.get("is_actioning"))){return false}return true};SYNO.SDS.iSCSI.Utils.LunCanManage=function(a){return !SYNO.SDS.iSCSI.Utils.IsOwnedByCinder(a)};SYNO.SDS.iSCSI.Utils.IsOwnedByCinder=function(a){return("cinder"===a.get("used_by"))};SYNO.SDS.iSCSI.Utils.isUpToiSCSILunMaxCount=function(a){var b=parseInt(_D("max_iscsiluns",10),10);if(!a){return false}return(a.length>=b)};SYNO.SDS.iSCSI.Utils.UIRenderInitializer=function(){var c="green-status",e="blue-status",d="red-status",b="orange-status",a={unknown:{title:SYNO.SDS.iSCSI.Utils.T("snapmgr","status_checking"),desc:SYNO.SDS.iSCSI.Utils.T("snapmgr","status_checking_desc"),overview_icon:"running",status_icon:"none",color:e,type:"normal"},checking:{title:SYNO.SDS.iSCSI.Utils.T("snapmgr","status_checking"),desc:SYNO.SDS.iSCSI.Utils.T("snapmgr","status_checking_desc"),overview_icon:"running",status_icon:"running",color:e,type:"checking"},ready:{title:SYNO.SDS.iSCSI.Utils.T("snapmgr","status_ready_title"),desc:SYNO.SDS.iSCSI.Utils.T("snapmgr","status_ready_desc"),local_rep_desc:SYNO.SDS.iSCSI.Utils.T("snapmgr","status_ready_share_desc"),overview_icon:"success",status_icon:"success",color:c,type:"normal"},stopping:{title:SYNO.SDS.iSCSI.Utils.T("snapmgr","status_stopping_title"),desc:SYNO.SDS.iSCSI.Utils.T("snapmgr","status_stopping_desc"),overview_icon:"running",status_icon:"running",color:e,type:"processing"},stop:{title:SYNO.SDS.iSCSI.Utils.T("snapmgr","status_stopping_title"),desc:SYNO.SDS.iSCSI.Utils.T("snapmgr","status_stopping_desc"),overview_icon:"running",status_icon:"running",color:e,type:"processing"},create:{title:SYNO.SDS.iSCSI.Utils.T("snapmgr","status_create_title"),desc:SYNO.SDS.iSCSI.Utils.T("snapmgr","status_create_desc"),overview_icon:"running",status_icon:"running",color:e,type:"processing"},deleting:{title:SYNO.SDS.iSCSI.Utils.T("snapmgr","status_delete_title"),desc:SYNO.SDS.iSCSI.Utils.T("snapmgr","status_delete_desc"),overview_icon:"running",status_icon:"running",color:e,type:"processing"},edit:{title:SYNO.SDS.iSCSI.Utils.T("snapmgr","status_edit_title"),desc:SYNO.SDS.iSCSI.Utils.T("snapmgr","status_edit_desc"),overview_icon:"running",status_icon:"running",color:e,type:"processing"},edit_failed:{title:SYNO.SDS.iSCSI.Utils.T("snapmgr","status_edit_failed_title"),desc:SYNO.SDS.iSCSI.Utils.T("snapmgr","status_edit_failed_desc"),overview_icon:"warning",status_icon:"warning",color:b,type:"warning"},sync:{title:SYNO.SDS.iSCSI.Utils.T("snapmgr","status_sync_title"),desc:SYNO.SDS.iSCSI.Utils.T("snapmgr","status_sync_desc"),overview_icon:"running",status_icon:"running",color:e,type:"processing"},sync_failed:{title:SYNO.SDS.iSCSI.Utils.T("snapmgr","status_sync_failed_title"),desc:SYNO.SDS.iSCSI.Utils.T("snapmgr","status_sync_failed_desc"),overview_icon:"warning",status_icon:"warning",color:b,type:"warning"},switchover:{title:SYNO.SDS.iSCSI.Utils.T("snapmgr","status_switchover_title"),desc:SYNO.SDS.iSCSI.Utils.T("snapmgr","status_switchover_desc"),overview_icon:"running",status_icon:"running",color:e,type:"processing"},switchover_failed:{title:SYNO.SDS.iSCSI.Utils.T("snapmgr","status_switchover_failed_title"),desc:SYNO.SDS.iSCSI.Utils.T("snapmgr","status_switchover_failed_desc"),overview_icon:"warning",status_icon:"warning",color:b,type:"warning"},failover:{title:SYNO.SDS.iSCSI.Utils.T("snapmgr","status_failover_title"),desc:SYNO.SDS.iSCSI.Utils.T("snapmgr","status_failover_desc"),overview_icon:"running",status_icon:"running",color:e,type:"processing"},failover_failed:{title:SYNO.SDS.iSCSI.Utils.T("snapmgr","status_failover_failed_title"),desc:SYNO.SDS.iSCSI.Utils.T("snapmgr","status_failover_failed_desc"),overview_icon:"warning",status_icon:"warning",color:b,type:"warning"},reprotect:{title:SYNO.SDS.iSCSI.Utils.T("snapmgr","status_reprotect_title"),desc:SYNO.SDS.iSCSI.Utils.T("snapmgr","status_reprotect_desc"),overview_icon:"running",status_icon:"running",color:e,type:"processing"},reprotect_failed:{title:SYNO.SDS.iSCSI.Utils.T("snapmgr","status_reprotect_failed_title"),desc:SYNO.SDS.iSCSI.Utils.T("snapmgr","status_reprotect_failed_desc"),overview_icon:"warning",status_icon:"warning",color:b,type:"warning"},commit_failover:{title:SYNO.SDS.iSCSI.Utils.T("snapmgr","status_commitfailover_title"),desc:SYNO.SDS.iSCSI.Utils.T("snapmgr","status_commitfailover_desc"),overview_icon:"running",status_icon:"running",color:e,type:"processing"},commit_failover_failed:{title:SYNO.SDS.iSCSI.Utils.T("snapmgr","status_commitfailover_failed_title"),desc:SYNO.SDS.iSCSI.Utils.T("snapmgr","status_commitfailover_failed_desc"),overview_icon:"warning",status_icon:"warning",color:b,type:"warning"},undo_failover:{title:SYNO.SDS.iSCSI.Utils.T("snapmgr","status_undofailover_title"),desc:SYNO.SDS.iSCSI.Utils.T("snapmgr","status_undofailover_desc"),overview_icon:"running",status_icon:"running",color:e,type:"processing"},undo_failover_failed:{title:SYNO.SDS.iSCSI.Utils.T("snapmgr","status_undofailover_failed_title"),desc:SYNO.SDS.iSCSI.Utils.T("snapmgr","status_undofailover_failed_desc"),overview_icon:"warning",status_icon:"warning",color:b,type:"warning"},"export":{title:SYNO.SDS.iSCSI.Utils.T("snapmgr","status_export_title"),desc:SYNO.SDS.iSCSI.Utils.T("snapmgr","status_export_desc"),overview_icon:"running",status_icon:"running",color:e,type:"processing"},export_failed:{title:SYNO.SDS.iSCSI.Utils.T("snapmgr","status_export_failed_title"),desc:SYNO.SDS.iSCSI.Utils.T("snapmgr","status_export_failed_desc"),overview_icon:"warning",status_icon:"warning",color:b,type:"warning"},"import":{title:SYNO.SDS.iSCSI.Utils.T("snapmgr","status_import_title"),desc:SYNO.SDS.iSCSI.Utils.T("snapmgr","status_import_desc"),overview_icon:"running",status_icon:"running",color:e,type:"processing"},import_failed:{title:SYNO.SDS.iSCSI.Utils.T("snapmgr","status_import_failed_title"),desc:SYNO.SDS.iSCSI.Utils.T("snapmgr","status_import_failed_desc"),overview_icon:"warning",status_icon:"warning",color:b,type:"warning"},testfailover:{title:SYNO.SDS.iSCSI.Utils.T("snapmgr","status_testfailover_title"),desc:SYNO.SDS.iSCSI.Utils.T("snapmgr","status_testfailover_desc"),overview_icon:"running",status_icon:"running",color:e,type:"processing"},testfailover_failed:{title:SYNO.SDS.iSCSI.Utils.T("snapmgr","status_testfailover_failed_title"),desc:SYNO.SDS.iSCSI.Utils.T("snapmgr","status_testfailover_failed_desc"),overview_icon:"warning",status_icon:"warning",color:b,type:"warning"},cleanup_testfailover:{title:SYNO.SDS.iSCSI.Utils.T("snapmgr","status_cleanup_testfailover_title"),desc:SYNO.SDS.iSCSI.Utils.T("snapmgr","status_cleanup_testfailover_desc"),overview_icon:"running",status_icon:"running",color:e,type:"processing"},cleanup_testfailover_failed:{title:SYNO.SDS.iSCSI.Utils.T("snapmgr","status_cleanup_testfailover_failed_title"),desc:SYNO.SDS.iSCSI.Utils.T("snapmgr","status_cleanup_testfailover_failed_desc"),overview_icon:"warning",status_icon:"warning",color:b,type:"warning"},init:{title:SYNO.SDS.iSCSI.Utils.T("snapmgr","status_init_title"),desc:SYNO.SDS.iSCSI.Utils.T("snapmgr","status_init_desc"),local_rep_desc:SYNO.SDS.iSCSI.Utils.T("snapmgr","status_init_share_desc"),overview_icon:"waiting",status_icon:"none",color:b,type:"warning"},init_eximport:{title:SYNO.SDS.iSCSI.Utils.T("snapmgr","status_init_eximport_title"),desc:SYNO.SDS.iSCSI.Utils.T("snapmgr","status_init_eximport_desc"),overview_icon:"waiting",status_icon:"none",color:b,type:"warning"},error:{title:SYNO.SDS.iSCSI.Utils.T("snapmgr","status_error_title"),desc:SYNO.SDS.iSCSI.Utils.T("snapmgr","status_error_desc"),overview_icon:"error",status_icon:"error",color:d,type:"error"},local_failover:{title:SYNO.SDS.iSCSI.Utils.T("snapmgr","status_localfailover_title"),local_rep_title:SYNO.SDS.iSCSI.Utils.T("snapmgr","status_localfailover_share_title"),desc:SYNO.SDS.iSCSI.Utils.T("snapmgr","status_localfailover_desc"),local_rep_desc:SYNO.SDS.iSCSI.Utils.T("snapmgr","status_localfailover_share_desc"),overview_icon:"warning",status_icon:"warning",color:b,type:"warning"},remote_failover:{title:SYNO.SDS.iSCSI.Utils.T("snapmgr","status_remotefailover_title"),local_rep_title:SYNO.SDS.iSCSI.Utils.T("snapmgr","status_remotefailover_share_title"),desc:SYNO.SDS.iSCSI.Utils.T("snapmgr","status_remotefailover_desc"),local_rep_desc:SYNO.SDS.iSCSI.Utils.T("snapmgr","status_remotefailover_share_desc"),overview_icon:"warning",status_icon:"warning",color:b,type:"warning"},insuff_bandwidth:{title:SYNO.SDS.iSCSI.Utils.T("snapmgr","status_insuff_bandwidth_title"),desc:SYNO.SDS.iSCSI.Utils.T("snapmgr","status_insuff_bandwidth_desc"),overview_icon:"warning",status_icon:"warning",color:b,type:"warning"},broken:{title:SYNO.SDS.iSCSI.Utils.T("snapmgr","status_broken_title"),desc:SYNO.SDS.iSCSI.Utils.T("snapmgr","status_broken_desc"),overview_icon:"warning",status_icon:"warning",color:b,type:"warning"},local_disconnect:{title:SYNO.SDS.iSCSI.Utils.T("snapmgr","status_disconnect_title"),desc:SYNO.SDS.iSCSI.Utils.T("snapmgr","status_disconnect_desc"),overview_icon:"warning",status_icon:"warning",color:b,type:"warning"},remote_disconnect:{title:SYNO.SDS.iSCSI.Utils.T("snapmgr","status_remote_disconnect_title"),desc:SYNO.SDS.iSCSI.Utils.T("snapmgr","status_remote_disconnect_desc"),overview_icon:"warning",status_icon:"warning",color:b,type:"warning"},local_volume_crash:{title:SYNO.SDS.iSCSI.Utils.T("snapmgr","status_volume_crash_title"),desc:SYNO.SDS.iSCSI.Utils.T("snapmgr","status_volume_crash_desc"),overview_icon:"error",status_icon:"error",color:d,type:"error"},remote_volume_crash:{title:SYNO.SDS.iSCSI.Utils.T("snapmgr","status_remote_volume_crash_title"),desc:SYNO.SDS.iSCSI.Utils.T("snapmgr","status_remote_volume_crash_desc"),overview_icon:"error",status_icon:"error",color:d,type:"error"},local_target_unavailable:{title:SYNO.SDS.iSCSI.Utils.T("snapmgr","status_local_target_unavailable_title"),desc:SYNO.SDS.iSCSI.Utils.T("snapmgr","status_local_target_unavailable_desc"),overview_icon:"error",status_icon:"error",color:d,type:"error"},remote_target_unavailable:{title:SYNO.SDS.iSCSI.Utils.T("snapmgr","status_remote_target_unavailable_title"),desc:SYNO.SDS.iSCSI.Utils.T("snapmgr","status_remote_target_unavailable_desc"),overview_icon:"error",status_icon:"error",color:d,type:"error"},local_no_permission:{title:SYNO.SDS.iSCSI.Utils.T("snapmgr","status_no_permission_title"),desc:SYNO.SDS.iSCSI.Utils.T("snapmgr","status_no_permission_desc"),overview_icon:"warning",status_icon:"warning",color:b,type:"warning"},remote_no_permission:{title:SYNO.SDS.iSCSI.Utils.T("snapmgr","status_remote_no_permission_title"),desc:SYNO.SDS.iSCSI.Utils.T("snapmgr","status_remote_no_permission_desc"),overview_icon:"warning",status_icon:"warning",color:b,type:"warning"},pkg_not_compatible:{title:SYNO.SDS.iSCSI.Utils.T("snapmgr","status_not_compatible_title"),desc:SYNO.SDS.iSCSI.Utils.T("snapmgr","status_not_compatible_desc"),overview_icon:"warning",status_icon:"warning",color:b,type:"warning"},local_not_supported:{title:"",desc:"",overview_icon:"warning",status_icon:"warning",color:b,type:"warning"},remote_not_supported:{title:SYNO.SDS.iSCSI.Utils.T("snapmgr","status_remote_not_supported_title"),desc:SYNO.SDS.iSCSI.Utils.T("snapmgr","status_remote_not_supported_desc"),overview_icon:"warning",status_icon:"warning",color:b,type:"warning"},remote_pkg_not_running:{title:SYNO.SDS.iSCSI.Utils.T("snapmgr","status_remote_pkg_not_running_title"),desc:SYNO.SDS.iSCSI.Utils.T("snapmgr","status_remote_pkg_not_running_desc"),overview_icon:"warning",status_icon:"warning",color:b,type:"warning"}};return{getManagedByRender:function(f){switch(f){case"cinder":return"Openstack Cinder";default:return"DSM"}},planNextTimeRender:function(i,k,f){var h=true;var g=SYNO.SDS.iSCSI.Utils,j=g.GetTime(i-k,h);if(SYNO.SDS.iSCSI.invalid===j){return j}return String.format(_T("iscsimgr","next_time_msg"),g.TextRender(j.value,f),j.unit)},targetDesc:function(f,g){return String.format("[{0}] {1}",f,g)},targetStatusType:function(g){switch(g){case"local_volume_crash":return"crashed";case"local_target_unavailable":return"unavailable";default:break}var f=a[g];if(!f){return g}return f.type},lockIconRenderer:function(f){return(true===f?'<div class="iscsi-snapshot-lock-icon"></div>':"")}}};SYNO.SDS.iSCSI.Utils.UIRender=SYNO.SDS.iSCSI.Utils.UIRenderInitializer();SYNO.SDS.iSCSI.Utils.UpdateGridCheckMsg=function(b,d,a){var c,e;for(c=0;c<d.length;++c){e=SYNO.SDS.Utils.GetFeasibilityCheckMsg(d[c]);if(0===c){a.appendSub(b,e)}else{a.appendSub("",e)}}};SYNO.SDS.iSCSI.Utils.CheckMsg=function(b,g,e,c){var f,a=SYNO.SDS.iSCSI.Utils,d;if(!b||!b[e]){return}for(f in b[e]){if(b[e].hasOwnProperty(f)){d=f;if(g){if(b[e][f].hard){a.UpdateGridCheckMsg(d,b[e][f].hard,c)}}else{if(b[e][f].soft){a.UpdateGridCheckMsg(d,b[e][f].soft,c)}}}}};SYNO.SDS.iSCSI.Utils.CheckFailedMsg=function(b){var d,a,c="pass";if(!b){return c}for(d in b){if(b.hasOwnProperty(d)){if("hard_failed"===c){break}for(a in b[d]){if(b[d].hasOwnProperty(a)){if(b[d][a].hard){c="hard_failed";break}else{if(b[d][a].soft){c="soft_failed"}}}}}}return c};function fillGridByFeasMsgWithType(b,d,c){var j=SYNO.SDS.iSCSI.Utils;var f=false;var k={};var h="";k.iscsiObjs={};if("feasibility_hard"===c){f=true;h="hard"}else{h="soft"}if(b.hasOwnProperty(c)){var a=b[c];for(var e=0;e<a.length;e++){k.iscsiObjs[a[e].name]={};k.iscsiObjs[a[e].name][h]=a[e].check_message}}var g=Object.keys(k.iscsiObjs);if("lun"===b.objType){d.append("iSCSI LUN",g.join(", "))}else{if("target"===b.objType){d.append("iSCSI Target",g.join(", "))}}j.CheckMsg(k,f,"iscsiObjs",d)}SYNO.SDS.iSCSI.Utils.fillGridByFeasMsg=function(a,b){if(a.hasOwnProperty("feasibility_soft")){fillGridByFeasMsgWithType(a,b,"feasibility_soft")}else{if(a.hasOwnProperty("feasibility_hard")){fillGridByFeasMsgWithType(a,b,"feasibility_hard")}}};SYNO.SDS.iSCSI.Utils.ReportWebapiFailure=function(a,c){var b=_T("error","error_subject");if(undefined===c||undefined===a){return}b=SYNO.SDS.iSCSI.Utils.API.getErrorString(c);if(a.getMsgBox){a.getMsgBox().alert(a.title,b)}else{if(a.owner.getMsgBox){a.owner.getMsgBox().alert(a.title,b)}else{throw Error("Not found 'getMsgBox'")}}};SYNO.SDS.iSCSI.Utils.HARemoteCheckErrParsing=function(b){var a=[];var c;if(!_S("ha_running")){return}if(undefined===b||!b.hasOwnProperty("errors")){return}c=b.errors;if(undefined!==c.ha_remote_empty_err_disks&&0<c.ha_remote_empty_err_disks.size()){a.push(String.format(_TT("SYNO.SDS.HA.Instance","wizard","error_disk_empty"),c.ha_remote_empty_err_disks.map(SYNO.SDS.HA.HADiskIndexRenderer).join(", ")))}if(undefined!==c.ha_remote_size_err_disks&&0<c.ha_remote_size_err_disks.size()){a.push(String.format(_TT("SYNO.SDS.HA.Instance","wizard","error_disk_size"),c.ha_remote_size_err_disks.map(SYNO.SDS.HA.HADiskIndexRenderer).join(", ")))}if(undefined!==c.ha_remote_type_err_disks&&0<c.ha_remote_type_err_disks.size()){a.push(String.format(_TT("SYNO.SDS.HA.Instance","wizard","error_disk_type"),c.ha_remote_type_err_disks.map(SYNO.SDS.HA.HADiskIndexRenderer).join(", ")))}if(undefined!==c.ha_remote_log_sect_size_err_disks&&0<c.ha_remote_log_sect_size_err_disks.size()){a.push(String.format(_TT("SYNO.SDS.HA.Instance","wizard","error_disk_log_sect_size"),c.ha_remote_log_sect_size_err_disks.map(SYNO.SDS.HA.HADiskIndexRenderer).join(", ")))}if(true===c.ha_remote_offline){a.push(_TT("SYNO.SDS.HA.Instance","ui","error_passive_not_online"))}if(true===c.ha_remote_space_failed){a.push(_TT("SYNO.SDS.HA.Instance","wizard","error_passive_space_unmatched"))}if(true===c.ha_remote_memory_size_mismatch){a.push(_TT("SYNO.SDS.HA.Instance","ui","error_fcache_memsize"))}b.text=a.join("<br><br>");if(""===b.text){b.text=_T("error","error_error_system")}};SYNO.SDS.iSCSI.Utils.getLUNNameByLidOrUUID=function(c,b){var a=b.find(function(d){return d.get("uuid")===c||d.get("lid")==c});if(a){return a.get("name")}return c};SYNO.SDS.iSCSI.Utils.getLUNPoolInfo=function(c,a){var d;for(var b=0;b<c.length;b++){if(-1<a.search(c[b].space_path)){d={pool_id:c[b].id,status:c[b].status,used_size:c[b].size.used,total_size:c[b].size.total};break}}if(!d){return{pool_id:"",status:"unknown",used_size:0,total_size:0}}return d};SYNO.SDS.iSCSI.Utils.checkLUNSnapCompoundError=function(c,b,a){return SYNO.SDS.iSCSI.Utils.checkCompoundError.call(this,c,b,a,SYNO.SDS.iSCSI.LUNSnapGetErrMsg)};SYNO.SDS.iSCSI.Utils.checkCompoundError=function(i,b,f,g){var e=this;var c={};var d=false;var a=_T("common","commfail");Ext.each(b.result,function(k,j){if(k.success){return true}var l=SYNO.SDS.iSCSI.Utils.getLUNNameByLidOrUUID(f.compound[j].src_lun_uuid,e.luns)||SYNO.SDS.iSCSI.Utils.getLUNNameByLidOrUUID(f.compound[j].name,e.luns);d=true;var m=g(k.error.code,e)||_T("common","error_system");if(c.hasOwnProperty(m)){c[m].push(l)}else{c[m]=[l]}},e);if(d){a=_T("iscsimgr","following_targets_failed")+"<br><br>";for(var h in c){if(c.hasOwnProperty(h)){a+=c[h].join(", ")+": "+h+"<br>"}}}return a};SYNO.SDS.iSCSI.Utils.GetTime=function(c){if(isNaN(c)||c<0){return SYNO.SDS.iSCSI.invalid}var b,a;if(2>c){b=c/1;a=_T("common","time_second")}else{if(60>c){b=c/1;a=_T("common","time_seconds")}else{if(2*60>c){b=c/60;a=_T("common","time_minute")}else{if(60*60>c){b=c/60;a=_T("common","time_minutes")}else{if(2*60*60>c){b=c/(60*60);a=_T("common","time_hour")}else{if(24*60*60>c){b=c/(60*60);a=_T("common","time_hours")}else{if(2*24*60*60>c){b=c/(24*60*60);a=_T("common","time_day")}else{b=c/(24*60*60);a=_T("common","time_days")}}}}}}}b=Math.floor(b);return{value:b,unit:a}};SYNO.SDS.iSCSI.Utils.GetSizeGB=function(b,f){var e=Ext.isNumber(f);var c=Math.pow(10,(e)?f:2);var d=b/SYNO.SDS.iSCSI.Utils.ISCSITRG_UNIT_GB;var a=d;if(c>1){a=Math.round(d*c)/c}else{if(c==1){a=d.floor()}}return a};SYNO.SDS.iSCSI.Utils.TextRender=function(b,a){if(a){return'<span style="'+a+'">'+b+"</span>"}return b};SYNO.SDS.iSCSI.Utils.GetDailySchedule=function(a){return{week_name:"0,1,2,3,4,5,6",repeat_hour:0,repeat_min:0,hour:a,min:0,last_work_hour:a}};SYNO.SDS.iSCSI.Utils.volumeFsTypeRender=function(a){if(!a){return""}if("btrfs"===a){return _T("volume","volume_add_fs_btrfs_type")}if("ext4"===a){return _T("volume","volume_add_fs_ext4_type")}return a};SYNO.SDS.iSCSI.Utils.volumePathRenderer=function(a){return _T("volume","volume")+" "+a.split("/volume")[1]};SYNO.SDS.iSCSI.Utils.volumeInfoRenderer=function(c,b){var a=SYNO.SDS.iSCSI.Utils;var d=String.format(_T("volume","volume_default_desc"),a.volumePathRenderer(c));return b?String.format("{0}, {1}",d,a.volumeFsTypeRender(b)):d};SYNO.SDS.iSCSI.Utils.lunVolumeInfoRenderer=function(c){var a=SYNO.SDS.iSCSI.Utils;var b=("block"===c.device_type);return(b)?a.blockLunVolumeInfoRenderer(c.location):a.volumeInfoRenderer(c.vol_path,c.vol_fs_type)};SYNO.SDS.iSCSI.Utils.blockLunVolumeInfoRenderer=function(b){var d=("yes"===_D("supportraidgroup","no"));var c=(d)?_T("volume","volume_storage_pool"):_T("volume","volume_pool");var a=b.split("_")[1];return String.format(_T("volume","volume_default_desc"),c+" "+a)};SYNO.SDS.iSCSI.Utils.TipRenderer=function(b,a){a.attr='ext:qtip="'+Ext.util.Format.htmlEncode(Ext.util.Format.htmlEncode(b))+'"';return Ext.util.Format.htmlEncode(b)};SYNO.SDS.iSCSI.Utils.check=function(){var a,b;for(a=0;a<arguments.length;a++){b=arguments[a];if(Ext.isFunction(b)&&!b.call(this)){return false}else{if(Ext.isString(b)&&!this[b]()){return false}}}return true};SYNO.SDS.iSCSI.Utils.IsALUN=function(a){return a===SYNO.SDS.iSCSI.LUN_TYPE_ADV};SYNO.SDS.iSCSI.Utils.IsBLUN=function(a){return a===SYNO.SDS.iSCSI.LUN_TYPE_BTRFS};SYNO.SDS.iSCSI.Utils.LunSnapTypeRenderer=function(b){var a="";switch(b){case SYNO.SDS.iSCSI.LUN_TYPE_ADV:break;case SYNO.SDS.iSCSI.LUN_TYPE_BTRFS:a=_T("iscsimgr","instant_snapshot");break;case SYNO.SDS.iSCSI.LUN_TYPE_NOT_SUPPORT:a=SYNO.SDS.iSCSI.invalid;break;default:break}return a};SYNO.SDS.iSCSI.Utils.IsAnyMappedTargetConnected=function(b,a){var c=false;Ext.each(a,function(d){if("connected"!==d.get("status")){return true}if(d.isMappedToLUN(b)){c=true;return false}});return c};SYNO.SDS.iSCSI.Utils.IsMultiController=function(){return"yes"===_D("support_ntbha","no")};SYNO.SDS.iSCSI.Utils.NoteRenderer=function(a){return'<span class="syno-ux-note">'+_T("common","note")+_T("common","colon")+" </span>"+a};SYNO.SDS.iSCSI.Utils.API={convertToMsg:function(a){switch(a){case 18990002:return _T("iscsitrg","iscsitrg_set_failed_space_not_enough");case 18990433:return _T("iscsimgr","err_connect_to_isns_server");case 18990538:return _T("iscsimgr","err_lunname_duplicated");case 18990541:return _T("iscsimgr","lun_up_to_max");case 18990542:return _T("iscsimgr","target_up_to_max");case 18990543:return _T("iscsimgr","snap_up_to_max");case 18990718:return _T("iscsimgr","err_enable_target");case 18990744:return _T("iscsitrg","iscsitrg_name_exists");case 18990745:return _T("iscsitrg","iscsitrg_iqn_exists");default:return _T("error","error_subject")}},getErrorString:function(c){var b,a,d;if(Ext.isNumber(c)){b=c}else{if(Ext.isObject(c)){a=SYNO.API.Util.GetFirstError(c);b=Ext.isNumber(a.code)?a.code:100}}d=this.convertToMsg(b);return d}};SYNO.SDS.iSCSI.invalid="--";Ext.namespace("SYNO.SDS.iSCSI.TARGET");SYNO.SDS.iSCSI.TARGET.DefaultIQN="iqn.2000-01.com.synology:default.acl";SYNO.SDS.iSCSI.TARGET.FAKE_PWD="1234567890AB";SYNO.SDS.iSCSI.TARGET.FAKE_PWDC="BA0987654321";SYNO.SDS.iSCSI.TARGET.MAX_MAPPING_LUNS=256;SYNO.SDS.iSCSI.TP_HARD_THRESHOLD_MAX_SIZE=1073741824;SYNO.SDS.iSCSI.TP_HARD_THRESHOLD_MIN_SIZE=134217728;SYNO.SDS.iSCSI.TP_HARD_THRESHOLD_DEFAULT_SIZE=SYNO.SDS.iSCSI.TP_HARD_THRESHOLD_MAX_SIZE;SYNO.SDS.iSCSI.Utils.htmlEncodeRender=function(c,b){var a=Ext.util.Format.htmlEncode(c);b.attr='ext:qtip="'+Ext.util.Format.htmlEncode(a)+'"';return a};SYNO.SDS.iSCSI.Utils.htmlEventEncodeRender=function(d,c){var b=/([12]\d{3}\/(0[1-9]|1[0-2])\/(0[1-9]|[12]\d|3[01]) ([01]\d|2[0-3]):([0-5]\d):([0-5]\d))/g;if(d.match(b)){var a=Date.parseDate(d.match(b)[0],"Y/n/j h:i:s");var e=SYNO.SDS.DateTimeFormatter(a,{type:"datetimesec"});d=d.replace(b,e)}return SYNO.SDS.iSCSI.Utils.htmlEncodeRender(d,c)};Ext.define("SYNO.SDS.iSCSI.DataView",{extend:"SYNO.ux.ExpandableListView",singleExpanded:true,constructor:function(a){var c=this,b;c.expandedItemId={};c.selectedItemId={};c.appWin=a.appWin;c.owner=a.owner;c.usageTpl=a.usageTpl;c.detailTpl=a.detailTpl;b={tpl:this.createTpl(),trackResetOnLoad:false};c.callParent([Ext.apply(b,a)])},createTpl:function(){var b=this;var a=new Ext.XTemplate('<tpl for=".">','<div class="item-wrap" itemId="{id}" id="{id}">','<div class="item-summary">','<div class="item-icon {iconPic} {iconCls}"></div>','<div class="iscsi-list-status-icon {statusIconCls}"></div>','<div style="display:inline-block;width:73%;">','<span class="item-title">{displayName}</span>',"{summaryStatus}","{progressStatus}",'<div class="item-status">{desc}</div>',"</div>",(b.usageTpl)?b.usageTpl.html:"",'<tpl if="property">',((b.detailTpl)?'<div class="item-toggle"><div class="item-toggle-img"></div></div>':""),"</tpl>","</div>",'<tpl if="property">','<div class="item-detail" style="display:none">',(b.detailTpl)?b.detailTpl.html:"","</div>","</tpl>","</div>","</tpl>",'<div class="x-clear"></div>',{compiled:true,hasValues:function(c){if(!c){return false}return 0<c.length}});return a},getSelectedItemIds:function(){var a,b,c=[];a=this.getSelectedRecords();for(b=0;b<a.length;++b){if(!a[b]){continue}c.push(a[b].get("id"))}return c},getSelectedItems:function(){var c=this,a=c.getSelectedItemIds(),d=c.appWin[c.dataType].data,b=[];Ext.each(a,function(e){if(e in d){if(d[e]){b.push(d[e])}}});return b},getSelectedItem:function(){var b=this;var a=b.getSelectedItems();if(0===a.length){return}return a[0]},onClick:function(c,b,a){this.callParent(arguments)},onDblClick:function(c,b,a){this.callParent(arguments)}});Ext.define("SYNO.SDS.iSCSI.ListDataView",{extend:"SYNO.ux.ExpandableListView",singleExpanded:true,constructor:function(a){var c=this,b;c.appWin=a.appWin;c.owner=a.owner;c.progressTpl=a.progressTpl;c.innerTpl=a.innerTpl;c.blRestore=a.blRestore;c.descField=a.descField?a.descField:"snapStatus";b={trackResetOnLoad:false,tpl:c.createTpl()};c.callParent([Ext.apply(b,a)])},createTpl:function(){var c=this;var a='<tpl if="values.vol_info && values.capacity && capacity == \'--\'"><div class="item-status" style="color:#505A64;">{vol_info}</div></tpl><tpl if="values.capacity && capacity != \'--\' && values.lun_snap_type_desc"><div class="item-status" style="color:#505A64;">{vol_info}, {lun_snap_type_desc}, {capacity}</div></tpl><tpl if="values.capacity && capacity != \'--\' && !values.lun_snap_type_desc"><div class="item-status" style="color:#505A64;">{vol_info}, {capacity}</div></tpl>';var d='<div class="item-status" style="color:#505A64;">{vol_info}, {restorePageLastSnapshot}</div>';var b=new Ext.XTemplate('<tpl for=".">','<div class="item-wrap {cls}" id="{name}">','<div class="item-summary">','<div class="item-icon {iconCls}"></div>','<div class="{statusCls}"></div>',(c.progressTpl)?'<div class="iscsi-item-title-progress-{displayProg}">':"<div>",'<span class="item-title">{name}</span>',String.format("{{0}}",c.descField),(c.blRestore)?d:a,"</div>",(c.progressTpl)?c.progressTpl.html:"",'<tpl if="false != values.support_snapshot">',(c.innerTpl)?'<div class="item-toggle"><div class="item-toggle-img"></div></div>':"","</tpl>","</div>",'<tpl if="false != values.support_snapshot">','<div class="item-detail" style="display:none">',(c.innerTpl)?c.innerTpl.html:"","</div>","</tpl>","</div>","</tpl>",'<div class="x-clear"></div>',{hasValues:function(e){if(!e){return false}return 0<e.length}});return b},getSelectedItems:function(){return this.getSelectedItemIds()},getSelectedItem:function(){var a=this.getSelectedItems();if(0===a.length){return}return a[0]},expandDetail:function(b,c){if(!this.innerTpl||!b){return}var d,a;d=this.getRecord(b.dom);if(b.child(".item-toggle-expanded")){this.doExpand(true,b,false)}else{this.doExpand(true,b,c);a=this.toggledItemIds.indexOf(d.id);if(0>a){this.toggledItemIds.push(d.id)}}}});Ext.define("SYNO.SDS.iSCSI.LunList.Store",{extend:"Ext.data.JsonStore",constructor:function(a){var c=this,b;c.sortField="name";c.sortDir="ASC";b={autoDestroy:true,idProperty:"name",fields:[{name:"name",sortType:"asNaturalUCString"},"id","lid","snapshots","extent_based","is_actioning","status","snapStatus","isProtected","capacity","snapshotProp","restoreProp","iconCls","type","isSnapScheduled","progress","barWidth","displayProg","lastSnapshot","plans","device_type","vol_path","vol_info","restorePageLastSnapshot","replicationTest","recoveryDesc","statusCategory","next_run_time","scheduleTask","support_snapshot","volume_crashed","uuid","size","used_by","lun_type","lun_snap_type_desc","thin_provision"],listeners:{load:function(){c.sort(c.sortField,c.sortDir)},scope:c}};c.callParent([Ext.apply(b,a)])}});Ext.define("SYNO.SDS.iSCSI.ModalWindow",{extend:"SYNO.SDS.ModalWindow",constructor:function(){this.callParent(arguments);this.addClass("syno-app-iscsi")},setMaskMsgVisible:function(b){if(!this.el.isMasked()){return}var a=Ext.Element.data(this.el,"maskMsg");if(a&&a.dom){a.setVisibilityMode(Ext.Element.VISIBILITY);a.setVisible(b)}},setMaskOpacity:function(a){SYNO.SDS.AppWindow.superclass.setMaskOpacity.call(this,a);this.setMaskMsgVisible(a!==0)},delayedMask:function(b,a,d,c){if(this.getFooterToolbar()){this.callParent(arguments);return}a=a||200;if(!this.maskTask){this.maskTask=new Ext.util.DelayedTask(this.setMaskOpacity,this,[b])}this.mask(0,d,c);this.setMaskMsgVisible(false);this.maskTask.delay(a)},setStatusBusy:function(c,b,a){if(this.getFooterToolbar()){this.callParent(arguments);return}c=c||{};Ext.applyIf(c,{text:_T("common","loading"),iconCls:"x-mask-loading"});b=b||0.4;a=a||400;this.delayedMask(b,a,c.text,c.iconCls);this.canClose=false},clearStatusBusy:function(a){if(this.getFooterToolbar()){this.callParent(arguments);return}this.unmask();this.canClose=true}});SYNO.SDS.iSCSI.ShareSnapGetErrMsg=function(a,b){var c;switch(a){case 3118:case 3328:case 3337:c=SYNO.API.Errors.core[a];break;default:break}return c};Ext.define("SYNO.SDS.iSCSI.Snapshot.MultiDeleteError",{extend:"SYNO.SDS.iSCSI.ModalWindow",constructor:function(a){var c=this;c.appWin=a.appWin;c.owner=a.owner;c.data=a.errorData;var b={layout:"fit",items:[],width:350,height:300,minHeight:200,buttons:[{text:_T("common","alt_close"),scope:c,handler:c.onCancel}]};c.callParent([Ext.apply(b,a)])},initComponent:function(){var a=this;a.items.push(a.createPanel());a.callParent(arguments)},onCancel:function(){this.close()},initEvents:function(){this.callParent(arguments);var e=this;var f=[];var d=0;for(var a in e.data){if(e.data.hasOwnProperty(a)){var b="";var g="";for(var c in e.data[a]){if(e.data[a].hasOwnProperty(c)){b=c;g=e.data[a][c]}}f[d]=[];f[d][0]=d;f[d][1]=String(b);f[d][2]=String(g);++d}}e.store.loadData(f);e.setHeight(350)},createPanel:function(){var h=this;var g;var f;var a=Ext.data.Record.create([{name:"idIndex"},{name:"name"},{name:"error"}]);var b=new Ext.data.Store({appWindow:h.appWin,autoDestroy:true,reader:new Ext.data.ArrayReader({idIndex:0},a)});h.store=b;g="snapshot_time";f=_T("time","time_time");var d=new Ext.grid.ColumnModel({defaults:{width:120,sortable:false},columns:[{id:"idIndex",header:_T("time","time_time"),dataIndex:"idIndex",hidden:true},{id:g,header:f,dataIndex:"name",renderer:function(j){var i=new Date(j*1000);return SYNO.SDS.DateTimeFormatter(i,{type:"datetimesec"})}},{id:"error",header:_T("error","error_error_reason"),dataIndex:"error",renderer:function(l,j,k){var i=parseInt(l,10);return SYNO.SDS.iSCSI.ShareSnapGetErrMsg(i,this)||_T("error","error_error_system")}}]});var e={forceFit:true,onLoad:Ext.emptyFn,listeners:{beforerefresh:function(i){i.scrollTop=i.scroller.dom.scrollTop},refresh:function(i){i.scroller.dom.scrollTop=i.scrollTop}}};var c={layout:"fit",xtype:"syno_gridpanel",itemId:"snapshots",style:{padding:"0px 12px 0px 16px"},store:b,colModel:d,selModel:new Ext.grid.RowSelectionModel({singleSelect:false}),enableHdMenu:false,viewConfig:e,enableColumnMove:false,cls:"without-dirty-red-grid"};return c}});Ext.define("SYNO.SDS.iSCSI.Lun.TextFilter",{extend:"SYNO.ux.TextFilter",reset:function(){if(this.localFilterField===false&&this.store){this.store.clearFilter(false);this.trigger.hide()}}});Ext.define("SYNO.SDS.iSCSI.Snapshot.SearchField",{extend:"SYNO.ux.SearchField",constructor:function(a){var c=this;c.appWin=a.appWin;c.owner=a.owner;c.allDisaplayText=a.allDisaplayText;var b=this.fillConfig(a);SYNO.SDS.iSCSI.Snapshot.SearchField.superclass.constructor.call(this,b)},fillConfig:function(a){var c=this;var b={iconStyle:"search",itemId:"searchShareName",listeners:{keyup:function(){c.owner.fireEvent("data_ready")},scope:c.owner}};Ext.apply(b,a);return b},getSearchText:function(){return this.getValue().trim()},onTriggerClick:function(){SYNO.SDS.iSCSI.Snapshot.SearchField.superclass.onTriggerClick.apply(this,arguments);this.owner.fireEvent("data_ready")},getMenu:function(){if(this.menu){return this.menu}var a=[];a.push({text:this.allDisaplayText,checked:true,itemId:SYNO.SDS.iSCSI.STATUS_ALL,checkHandler:this.setSearchFilter});a.push({text:_T("iscsimgr","snap_filter_with_schedule"),checked:false,itemId:SYNO.SDS.iSCSI.STATUS_SCHEDULE,checkHandler:this.setSearchFilter});a.push({text:_T("iscsimgr","snap_filter_no_protected"),checked:false,itemId:SYNO.SDS.iSCSI.STATUS_NO_PROTECTED,checkHandler:this.setSearchFilter});return(this.menu=new SYNO.ux.Menu({defaults:{group:"filter",scope:this},items:a,listeners:{scope:this,beforeshow:function(b){b.items.get(this.getSearchFilter()).setChecked(true)}}}))},setSearchFilter:function(b){var a=b.itemId;if(a===this.gSearchFilter){return}this.gSearchFilter=a;this.owner.fireEvent("data_ready")},getSearchFilter:function(){return this.gSearchFilter||"all"}});Ext.define("SYNO.SDS.iSCSI.AdvancedSearchField",{extend:"SYNO.ux.SearchField",initEvents:function(){this.callParent(arguments);this.mon(Ext.getDoc(),"mousedown",this.onMouseDown,this);this.mon(this,"keypress",function(b,a){if(a.getKey()===Ext.EventObject.ENTER){this.searchPanel.setKeyWord(this.getValue());this.searchPanel.onSearch()}},this);this.mon(this,"destroy",function(){this.searchPanel.destroy()},this)},isInnerComponent:function(c,b){var a=false;b.items.each(function(d){if(d instanceof Ext.form.ComboBox){if(d.view&&c.within(d.view.getEl())){a=true;return false}}else{if(d instanceof Ext.form.DateField){if(d.menu&&c.within(d.menu.getEl())){a=true;return false}}else{if(d instanceof Ext.form.CompositeField){if(this.isInnerComponent(c,d)){a=true;return false}}}}},this);return a},onMouseDown:function(b){var a=this.searchPanel;if(a&&a.isVisible()&&!a.inEl&&!b.within(a.getEl())&&!b.within(this.searchtrigger)&&!this.isInnerComponent(b,this.searchPanel.getForm())){a.hide()}},onSearchTriggerClick:function(){if(this.searchPanel.isVisible()){this.searchPanel.hide();return}this.searchPanel.getEl().alignTo(this.wrap,"tr-br?",[6,0]);this.searchPanel.show();this.searchPanel.setKeyWord(this.getValue())},onTriggerClick:function(){this.callParent();this.searchPanel.onReset()}});Ext.define("SYNO.SDS.iSCSI.SearchFormPanel",{extend:"SYNO.ux.FormPanel",constructor:function(a){this.dateType={custom:1,today:2,yesterday:4,lastweek:8,lastmonth:16};this.dataRange=[[this.dateType.custom,_T("log","date_custom")],[this.dateType.today,_T("log","date_today")],[this.dateType.yesterday,_T("log","date_yesterday")],[this.dateType.lastweek,_T("log","date_lastweek")],[this.dateType.lastmonth,_T("log","date_lastmonth")]];this.logLevelType={info:"info",warn:"warning",error:"err"};this.logLevel=[[this.logLevelType.info,_T("log","info_level")],[this.logLevelType.warn,_T("log","warn_level")],[this.logLevelType.error,_T("log","error_level")]];this.defaultAnimation=["#000",1,{duration:0.35}];Ext.apply(this,a||{});var b=this.fillConfig(a);this.callParent([b]);this.mon(this,"afterlayout",function(){this.defineBehaviors()},this)},initComponent:function(){this.callParent(arguments);this.addEvents("search")},fillConfig:function(b){var a,f,g,e;var c=[];a=this.createKeyword();f=this.createFriendlyDate();g=this.createCustDate();e=this.createLevel();c.push(a);c.push(f);c.push(g);c.push(e);c.push({xtype:"toolbar",border:false,itemId:"btns",toolbarCls:"search-panel-fbar-btnPanel",items:[{xtype:"lctbtext",itemId:"search-loading",text:""},{xtype:"lctbtext",itemId:"msg",height:26,style:"-webkit-text-size-adjust:none;font-size:11px;height:26px;overflow:hidden;",cls:"red-status",text:""},{xtype:"tbfill"},{xtype:"syno_button",btnStyle:"blue",style:"margin-right: 10px",text:_T("log","search"),itemId:"btn_search",handler:this.onSearch,scope:this},{xtype:"syno_button",btnStyle:"blue",style:"margin-right: 10px",text:_T("smart","smart_test_button_stop"),itemId:"btn_stop",hidden:true,handler:this.onStop,scope:this},{xtype:"syno_button",minWidth:80,text:_T("common","reset"),handler:this.onReset,scope:this}]});var d={width:368,heigh:480,floating:true,labelAlign:"left",trackResetOnLoad:true,waitMsgTarget:true,border:true,bodyStyle:"padding: 20px; padding-top: 0px; font-size: 24px;",autoFlexcroll:false,defaults:{hideLabel:true,anchor:"100%"},items:c,listeners:{actionfailed:{fn:function(){this.setMsg("");this.form.reset()},scope:this},beforeshow:{fn:function(){this.doLayout()},single:true},show:{fn:this.doLayout,single:true}},keys:[{key:[10,13],fn:function(){if(!this.isVisible()){return}if(!this.btnSearch.hidden&&!this.btnSearch.disabled){this.onSearch()}else{if(!this.btnStop.hidden&&!this.btnStop.disabled){this.onStop()}}},scope:this}]};return d},setComboBoxValue:function(b,a){this.frameAnimation(b.el,this.defaultAnimation);if(b.setMultiValue){b.setMultiValue(a.split(","))}},getComboBoxValue:function(b){var a=this.getForm().findField(b);return a.getMultiValue?a.getMultiValue().toString():a.getValue()},multiSelect:function(c,e,a,d,b){Ext.applyIf(c,{setMultiValue:function(f){if(!Ext.isArray(f)){f=[f]}this.multiValue=f},getMultiValue:function(){return this.multiValue&&this.multiValue.length>0?this.multiValue:this.getValue().split(",")}});if("more"===e.get("value")){this.attriWin=new SYNO.SDS.LogCenter.MultiSelectedDialog({title:d,combo:c,emptyValue:b,anim:this.defaultAnimation,owner:this.owner.appInst});this.attriWin.showUp();c.collapse();return false}},createTpl:function(){return new Ext.XTemplate('<tpl for=".">','<div class="x-combo-list-item" ext:qtip="{displayText:htmlEncode}">',"{displayText:htmlEncode}","</div>","</tpl>")},logSelect:function(c,a,b){this.setComboBoxValue(c,c.getValue())},createKeyword:function(){return[{xtype:"syno_displayfield",value:_T("log","attr_keyword")+_T("common","colon"),flex:1},{xtype:"syno_textfield",msgTarget:"qtip",validateOnBlur:true,validationEvent:"blur",name:"keyword",flex:2,vaule:""}]},setDate:function(c,b,a){if(a===true){this.frameAnimation(this.form.findField("searchdatefrom").el,this.defaultAnimation);this.frameAnimation(this.form.findField("searchdateto").el,this.defaultAnimation)}this.form.findField("searchdatefrom").setMaxValue(b);this.form.findField("searchdateto").setMinValue(c);this.form.findField("searchdatefrom").setValue(c);this.form.findField("searchdateto").setValue(b)},getFromToDate:function(c){var e,d,b=new Date();if(c===this.dateType.today){e=b;d=b}else{if(c===this.dateType.yesterday){e=b.add(Date.DAY,-1);d=e}else{if(c===this.dateType.lastweek){var a=b.getDay();e=b.add(Date.DAY,-7-a);d=e.add(Date.DAY,6)}else{if(c===this.dateType.lastmonth){b=b.add(Date.MONTH,-1);e=b.getFirstDateOfMonth();d=b.getLastDateOfMonth()}}}}return{from:e,to:d}},friendlyDateSelect:function(c,e,a){var b=e.get("id"),d=this.getFromToDate(b);this.setDate(d.from,d.to,true)},getFriendlyDateStore:function(){var a=this.dataRange;return new Ext.data.ArrayStore({autoDestroy:true,fields:["id","displayText"],data:a})},createFriendlyDate:function(){this.FriendlyDate=new SYNO.ux.ComboBox({mode:"local",editable:false,name:"dateRange",tpl:this.createTpl(),resizable:true,store:this.getFriendlyDateStore(),displayField:"displayText",valueField:"id",triggerAction:"all",lazyRender:true,flex:6,value:this.dateType.custom,listeners:{scope:this,beforequery:function(a){delete a.combo.lastQuery},beforeselect:this.friendlyDateSelect}});return[{xtype:"syno_displayfield",value:_T("log","date_range")+_T("common","colon"),flex:1},this.FriendlyDate]},createCustDate:function(){this.DateFrom=new SYNO.ux.DateField({name:"searchdatefrom",editable:false,emptyText:_T("log","date_from"),value:"",listeners:{scope:this,select:function(b,a){this.form.findField("searchdateto").setMinValue(a)}}});this.DateTo=new SYNO.ux.DateField({name:"searchdateto",editable:false,emptyText:_T("log","date_to"),value:"",listeners:{scope:this,select:function(b,a){this.form.findField("searchdatefrom").setMaxValue(a)}}});return[{xtype:"syno_displayfield",value:_T("time","time_date")+_T("common","colon")},{xtype:"syno_compositefield",hideLabel:true,defaults:{flex:1},defaultMargins:"0 8 0 0",items:[this.DateFrom,this.DateTo]}]},getLogLevelStore:function(){var a=this.logLevel.slice(0,this.logLevel.length);if(a.length>1){a.splice(0,0,["",_T("log","log_all")])}return new Ext.data.ArrayStore({autoDestroy:true,fields:["value","displayText"],data:a})},multiLogLevelSelect:function(b,c,a){this.multiSelect(b,c,a,_T("log","logattr"),"")},createLevel:function(){this.LogLevel=new SYNO.ux.ComboBox({xtype:"syno_combobox",mode:"local",editable:false,name:"logLevel",tpl:this.createTpl(),resizable:true,store:this.getLogLevelStore(),displayField:"displayText",valueField:"value",triggerAction:"all",lazyRender:true,flex:3,value:"",listeners:{scope:this,beforequery:function(a){delete a.combo.lastQuery},beforeselect:this.multiLogLevelSelect,select:this.logSelect}});return[{xtype:"syno_displayfield",name:"logLevelLabel",value:_T("log","logattr")+_T("common","colon"),flex:1},this.LogLevel]},hideItems:function(b){var c;if(!Ext.isArray(b)){b=[b]}for(var a=b.length-1;a>=0;a--){c=this.form.findField(b[a]);if(c){c.setVisible(false)}}},frameAnimation:function(a,b){if(a&&a.isVisible()){Ext.Element.prototype.frame.apply(a,b)}},defineBehaviors:function(){var a=this.get("btns");this.btnSearch=a.get("btn_search");this.btnStop=a.get("btn_stop")},setMsg:function(c){var a=this.get("btns");var b=a.get("msg");b.setText(c);if(c.trim()!==""){this.frameAnimation(b.el,this.defaultAnimation)}},setKeyWord:function(a){var b=this.form.findField("keyword");if(b&&Ext.isString(a)){b.setValue(a)}b.focus("",1)},onShowHideBtn:function(a){if(a){this.btnSearch.hide();this.btnStop.show()}else{this.btnSearch.show();this.btnStop.hide()}},onEnableDisableBtn:function(a){if(a){this.btnSearch.enable();this.btnStop.enable()}else{this.btnSearch.disable();this.btnStop.disable()}},isOwnerDestroyed:function(){return(this.owner&&this.owner.isDestroyed)},showMsg:function(b,a){if(!this.isOwnerDestroyed()){this.owner.getMsgBox().alert(b,a)}},hideMsg:function(){if(!this.isOwnerDestroyed()){this.owner.getMsgBox().hide()}},isFieldDirty:function(a){return this.form.findField(a).isDirty()},validateForm:function(){if(!this.form.isValid()){return false}return this.isFieldDirty("searchdatefrom")||this.isFieldDirty("searchdateto")||this.isFieldDirty("keyword")},onSearch:function(c,f){var d,b,i,h,a;var g;d=this.getForm();b=d.findField("keyword").getValue();i=d.findField("searchdatefrom").getRawValue();h=d.findField("searchdateto").getRawValue();a=this.getComboBoxValue("logLevel");g={keyword:b};if(a){g.log_level=[a]}if(i){g.date_from=i}if(h){g.date_to=h}this.fireEvent("search",this,g)},onReset:function(){this.form.items.each(function(a){if(a.isDirty()){this.frameAnimation(a.el,this.defaultAnimation)}},this);this.setMsg("");this.form.reset();this.form.findField("searchdatefrom").setMaxValue(null);this.form.findField("searchdateto").setMinValue(null);this.form.findField("logLevel").multiValue="";this.onSearch()}});Ext.define("SYNO.SDS.iSCSI.SmartRetention",{extend:"SYNO.SDS.iSCSI.ModalWindow",constructor:function(b){var f=this;var a=SYNO.SDS.iSCSI.Utils;f=Ext.apply(f,b);Ext.apply(f,{MAX_RET_HOURLY:f.maxSnapshot,MAX_RET_DAILY:f.maxSnapshot,MAX_RET_WEEKLY:f.maxSnapshot,MAX_RET_MONTHLY:120,MAX_RET_YEARLY:10});f.helpLinkId=Ext.id();var g='<span id="'+f.helpLinkId+'" class="link-font" tabindex="0" role="link" style="cursor:pointer">';var e="</span>";var c=[{xtype:"syno_displayfield",value:_T("snapmgr","ret_pol_desc")},{xtype:"syno_compositefield",hideLabel:true,height:28,items:[{xtype:"syno_numberfield",value:f.hourly,width:60,name:"hourly",me:f,id:f.ret_hourly_id=Ext.id(),minValue:0,maxValue:f.MAX_RET_HOURLY,maxLength:f.countDigitLength(f.MAX_RET_HOURLY)},{xtype:"syno_displayfield",width:10,value:""},{xtype:"syno_displayfield",id:f.ret_hourly_desc_id=Ext.id(),value:_T("snapmgr","ret_hourly")}]},{xtype:"syno_compositefield",hideLabel:true,height:28,items:[{xtype:"syno_numberfield",value:f.daily,width:60,name:"daily",me:f,id:f.ret_daily_id=Ext.id(),minValue:0,maxValue:f.MAX_RET_DAILY,maxLength:f.countDigitLength(f.MAX_RET_DAILY)},{xtype:"syno_displayfield",width:10,value:""},{xtype:"syno_displayfield",value:_T("snapmgr","ret_daily")}]},{xtype:"syno_compositefield",hideLabel:true,height:28,items:[{xtype:"syno_numberfield",value:f.weekly,width:60,name:"weekly",me:f,id:f.ret_weekly_id=Ext.id(),minValue:0,maxValue:f.MAX_RET_WEEKLY,maxLength:f.countDigitLength(f.MAX_RET_WEEKLY)},{xtype:"syno_displayfield",width:10,value:""},{xtype:"syno_displayfield",value:_T("snapmgr","ret_weekly")}]},{xtype:"syno_compositefield",hideLabel:true,height:28,items:[{xtype:"syno_numberfield",value:f.monthly,width:60,name:"monthly",me:f,id:f.ret_monthly_id=Ext.id(),minValue:0,maxValue:f.MAX_RET_MONTHLY,maxLength:f.countDigitLength(f.MAX_RET_MONTHLY)},{xtype:"syno_displayfield",width:10,value:""},{xtype:"syno_displayfield",value:_T("snapmgr","ret_monthly")}]},{xtype:"syno_compositefield",hideLabel:true,height:28,items:[{xtype:"syno_numberfield",value:f.yearly,width:60,name:"yearly",me:f,id:f.ret_yearly_id=Ext.id(),minValue:0,maxValue:f.MAX_RET_YEARLY,maxLength:f.countDigitLength(f.MAX_RET_YEARLY)},{xtype:"syno_displayfield",width:10,value:""},{xtype:"syno_displayfield",value:_T("snapmgr","ret_yearly")}]},{xtype:"syno_displayfield",htmlEncode:false,value:a.NoteRenderer(String.format(_T("iscsimgr","refer_to"),g,e)),listeners:{afterrender:f.addLinks,scope:f,single:true,buffer:100}}];var d={width:560,height:330,resizable:false,title:_T("snapmgr","setting"),id:f.id=Ext.id(),buttons:[{itemId:"btApply",xtype:"syno_button",btnStyle:"blue",text:_T("common","apply"),scope:f,handler:f.onApply},{xtype:"syno_button",text:_T("common","alt_cancel"),scope:f,handler:f.close}],items:[{id:f.formpanel=Ext.id(),xtype:"syno_formpanel",padding:"20px 20px 0px 20px",height:245,me:f,items:c}]};f.callParent([Ext.apply(d,b)])},countDigitLength:function(a){if(undefined===a||isNaN(a)){return -1}return a.toString().length},onOpen:function(){this.callParent();if(this.isHourlyFieldDisabled){this.addHourlyTip()}},addHourlyTip:function(){var b=this;var a=_T("snapmgr","retention_hourly_tooltip");var c=Ext.getCmp(b.ret_hourly_id);c.setDisabled(true);c.originalValue=0;c.setValue(0);SYNO.SDS.Utils.AddTip(Ext.getCmp(b.ret_hourly_desc_id).getEl(),Ext.util.Format.htmlEncode(a))},addLinks:function(c){var a=this;var b="iSCSIManager/snapshot.html";if(SYNO.SDS.iSCSI.Utils.IsMultiController()){b="taipei_"+b}a.mon(Ext.get(a.helpLinkId),"click",function(){SYNO.SDS.AppLaunch("SYNO.SDS.HelpBrowser.Application",{topic:"SYNO.SDS.iSCSI.Application:"+b,anchor:"smart_retention"},false)},a)},onApply:function(){var c=this,b=Ext.getCmp(c.formpanel).getForm();if(!b.isValid()){return}c.ret_hourly=Ext.getCmp(c.ret_hourly_id).getValue();c.ret_daily=Ext.getCmp(c.ret_daily_id).getValue();c.ret_weekly=Ext.getCmp(c.ret_weekly_id).getValue();c.ret_monthly=Ext.getCmp(c.ret_monthly_id).getValue();c.ret_yearly=Ext.getCmp(c.ret_yearly_id).getValue();if(c.maxSnapshot<c.ret_hourly+c.ret_daily+c.ret_weekly+c.ret_monthly+c.ret_yearly){var a=_T("snapmgr","err_max_rtt_cfg");c.getMsgBox().alert(_T("snapmgr","app_title"),String.format(a,c.maxSnapshot));return}if(b.isDirty()){c.fireEvent("ret_adv_edited",{ret_hourly:c.ret_hourly,ret_daily:c.ret_daily,ret_weekly:c.ret_weekly,ret_monthly:c.ret_monthly,ret_yearly:c.ret_yearly})}c.close()}});SYNO.SDS.iSCSI.UsageTpl=function(){var a=new Ext.XTemplate('<div class="iscsi-usage">',"<div>{usage}</div>",'<div class="iscsi-usage-bg">','<div class="iscsi-usage-bar" style="width:{barWidth}%"></div>',"</div>","</div>");return a};SYNO.SDS.iSCSI.PropertyTpl=function(b){if(undefined===b){b="property"}var a=new Ext.XTemplate("<div>",String.format('<tpl for="{0}">',b),"<dl>",'<dt class="iscsi-grid-property-name">{name}</dt>','<dt class="iscsi-grid-property-value">{value}','<tpl if="this.hasValues(values.iconTip) == true">','<div class="iscsi-grid-property-icon iscsi-grid-property-icon-info" ext:qtip="{iconTip}" style="display:inline-block"></div>',"</tpl>","</dt>",'<div style="clear:both"></div>',"</dl>","</tpl>",'<div class="x-clear"></div>',"</div>");return a};SYNO.SDS.iSCSI.ProgressTpl=function(){var a=new Ext.XTemplate('<div class="iscsi-progress iscsi-progress-{displayProg}">',"<div>{progress}</div>",'<div class="iscsi-progress-bg">','<div class="iscsi-progress-bar" style="width:{barWidth}px"></div>',"</div>","</div>");return a};SYNO.SDS.iSCSI.ListTpl=function(b){var a,g,e,c=[],f=[],h,d;g=b.title||_T("smart","smart_toolbar_disk_info");a=b.emptyText||_T("volume","volume_status_none");e=100/b.columns.length;Ext.each(b.columns,function(i){c.push(String.format('<dt class="iscsi-grid-list-column" style="width:{0}%">{1}</dt>',i.width?i.width:e,i.header));f.push(String.format('<dt class="iscsi-grid-list-column" style="width:{0}%">{{1}}</dt>',i.width?i.width:e,i.dataIndex))});h=new Ext.XTemplate(String.format('<tpl if="this.hasValues(values.{0}) == false">',b.scope),String.format('<div style="padding-left:10px;height:28px;line-height:28px">{0}</div>',a),"</tpl>",String.format('<tpl for="{0}">',b.scope),'<dl class="iscsi-grid-list-row">',f.join(""),'<div class="x-clear"></div>',"</dl>","</tpl>");d=new Ext.XTemplate(String.format('<div class="iscsi-grid-section-header">{0}</div>',g),'<div class="iscsi-grid-list">','<div class="iscsi-grid-list-header">','<dl style="padding-left:10px;">',c.join(""),'<div class="x-clear"></div>',"</dl>","</div>",'<div class="iscsi-grid-list-body">',h.html,"</div>","</div>",'<div class="x-clear"></div>');return d};SYNO.SDS.iSCSI.TargetTpl=function(b){var a,d,e,c;d=b.title||_T("smart","smart_toolbar_disk_info");a=b.emptyText||_T("volume","volume_status_none");e=new Ext.XTemplate(String.format('<tpl if="this.hasValues(values.{0}) == false">',b.scope),String.format('<div style="padding-left:10px;height:28px;line-height:28px">{0}</div>',a),"</tpl>",String.format('<tpl for="{0}">',b.scope),'<dl class="iscsi-grid-list-row">','<dt class="iscsi-grid-list-column" style="width:50%">{name}</dt>','<dt class="iscsi-grid-list-column" style="width:50%">{status}</dt>','<div class="x-clear"></div>',"</dl>","</tpl>");c=new Ext.XTemplate(String.format('<div class="iscsi-grid-section-header">{0}</div>',d),'<div class="iscsi-grid-list">','<div class="iscsi-grid-list-header">','<dl style="padding-left:10px;">',String.format('<dt class="iscsi-grid-list-column" style="width:50%">{0}</dt>',_T("common","name")),String.format('<dt class="iscsi-grid-list-column" style="width:50%">{0}</dt>',_T("volume","volume_volumestatus")),'<div class="x-clear"></div>',"</dl>","</div>",'<div class="iscsi-grid-list-body">',e.html,"</div>","</div>",'<div class="x-clear"></div>');return c};SYNO.SDS.iSCSI.SnapshotTpl=function(){var c=SYNO.SDS.iSCSI.ScheduleTpl();var b=SYNO.SDS.iSCSI.PropertyTpl("snapshotProp");var a=new Ext.XTemplate('<tpl if="support_snapshot === true">',c.html,"</tpl>",b.html);Ext.destroy(c);Ext.destroy(b);return a};SYNO.SDS.iSCSI.ScheduleTpl=function(){var b,a;b=new Ext.XTemplate('<tpl if="this.hasValues(values.scheduleTask) === false">',String.format('<div style="padding-left:10px;height:28px;line-height:28px">{0}</div>',_T("iscsimgr","snap_no_schedule")),"</tpl>",'<tpl for="scheduleTask">','<dl class="iscsi-grid-list-row">','<dt class="iscsi-grid-list-column" style="width:40%">{type}</dt>','<dt class="iscsi-grid-list-column" style="width:30%">{date}</dt>','<dt class="iscsi-grid-list-column" style="width:30%">{freq}</dt>','<div class="x-clear"></div>',"</dl>","</tpl>");a=new Ext.XTemplate(String.format('<div class="iscsi-grid-section-header">{0}</div>',_T("iscsimgr","snap_snapshot_schedule")),'<div class="iscsi-grid-list">','<div class="iscsi-grid-list-header">','<dl style="padding-left:10px;">',String.format('<dt class="iscsi-grid-list-column" style="width:40%">{0}</dt>',_T("iscsimgr","snap_schedule_snapshot_type")),String.format('<dt class="iscsi-grid-list-column" style="width:30%">{0}</dt>',_T("iscsimgr","sche_exec_day")),String.format('<dt class="iscsi-grid-list-column" style="width:30%">{0}</dt>',_T("iscsimgr","sche_repeat_every")),'<div class="x-clear"></div>',"</dl>","</div>",'<div class="iscsi-grid-list-body">',b.html,"</div>","</div>",'<div class="x-clear"></div>');Ext.destroy(b);return a};SYNO.SDS.iSCSI.GetDRErrMsg=function(a){var b;switch(a){case 1001:b=_T("s2s","err_invalid_param_value");break;case 1002:b=_T("iscsimgr","err_get_ret_policy");break;case 1003:b=_T("iscsimgr","err_set_ret_policy");break;default:b=_T("common","error_system");break}return b};SYNO.SDS.iSCSI.LUNSnapGetErrMsg=function(a,b){var c;switch(a){case 18990543:c=String.format(_T("iscsilun","iscsitrg_max_snapshot_per_lun"),_D("max_snapshot_per_lun","256"));break;case 18990002:c=_T("iscsitrg","iscsitrg_set_failed_space_not_enough");break;case 18990535:c=_T("backup","target_busy");break;default:c=_T("common","error_system");break}return c};Ext.define("SYNO.SDS.iSCSI.Comp.TextItem",{extend:"Ext.Toolbar.TextItem",onRender:function(b,a){this.autoEl={cls:"xtb-text",html:this.text||"","ext:qtip":this.text||""};SYNO.SDS.iSCSI.Comp.TextItem.superclass.onRender.call(this,b,a)},setText:function(a){SYNO.SDS.iSCSI.Comp.TextItem.superclass.setText.call(this,a);if(this.rendered){this.el.set({"ext:qtip":a})}}});Ext.reg("lctbtext",SYNO.SDS.iSCSI.Comp.TextItem);Ext.define("SYNO.SDS.iSCSI.LUN.DisplayField",{extend:"SYNO.ux.DisplayField",rawData:undefined,height:28,setValue:function(c){this.callParent(arguments);this.rawData=c;this.originalValue=c;if(c===undefined||this.store===undefined){return}for(var a=0;a<this.store.length;a++){if(c===this.store[a][0]){this.callParent([this.store[a][1]]);return}}if(this.store.data!==undefined&&this.store.data.items!==undefined){for(var b=0;b<this.store.data.items.length;b++){if(c==this.store.data.items[b].data.value){this.callParent([this.store.data.items[b].data.display]);return}}}},getValue:function(){if(this.rawData!==undefined){return this.rawData}return this.callParent(arguments)},enable:function(){return},disable:function(){return},isDirty:function(){return false}});Ext.reg("syno_lun_displayfield",SYNO.SDS.iSCSI.LUN.DisplayField);Ext.define("SYNO.SDS.iSCSI.Comp.TooltipMenu",{extend:"SYNO.ux.Menu",afterRender:function(){SYNO.SDS.iSCSI.Comp.TooltipMenu.superclass.afterRender.apply(this,arguments);var b=this;this.tip=new Ext.ToolTip({target:this.getEl().getAttribute("id"),renderTo:document.body,delegate:".x-menu-item",title:"dummy title",listeners:{beforeshow:function a(d){var c=b.findById(d.triggerElement.id);if(!c||!c.initialConfig.tooltip||!c.initialConfig.tooltip.text){return false}var e=typeof(c.initialConfig.tooltip.title)=="undefined"?"":c.initialConfig.tooltip.title;d.header.dom.firstChild.innerHTML=e;d.body.dom.innerHTML=c.initialConfig.tooltip.text}}})},setTooltip:function(b,a,c){this.get(b).initialConfig.tooltip={text:a,title:c}},resetTooltip:function(a){this.setTooltip(a,"","")}});Ext.reg("syno_iscsi_tooltip_menu",SYNO.SDS.iSCSI.Comp.TooltipMenu);SYNO.SDS.iSCSI.RTT_KEEP_ALL=(1<<31);SYNO.SDS.iSCSI.RTT_ALL=0;SYNO.SDS.iSCSI.RTT_POL_TIME=(1<<0);SYNO.SDS.iSCSI.RTT_DEL_OLD=(1<<2)|(1<<4);SYNO.SDS.iSCSI.RTT_DEL_OLD_DEPRECATED=(1<<4);SYNO.SDS.iSCSI.RTT_TRRIGER_BY_TIME=(1<<5);SYNO.SDS.iSCSI.TARGET_TYPE_UNKNOWN=0;SYNO.SDS.iSCSI.TARGET_TYPE_LUN=1;SYNO.SDS.iSCSI.TARGET_TYPE_SHARE=2;SYNO.SDS.iSCSI.ROLE_UNKNOWN=0;SYNO.SDS.iSCSI.ROLE_MAINSITE=1;SYNO.SDS.iSCSI.ROLE_DRSITE=2;SYNO.SDS.iSCSI.SOLUTION_UNKNOWN=0;SYNO.SDS.iSCSI.SOLUTION_SYNOLOGY_DR=1;SYNO.SDS.iSCSI.SOLUTION_VMWARE_SRM=2;SYNO.SDS.iSCSI.LUN_ADVANCED=(1<<3);SYNO.SDS.iSCSI.REPLICATED_SITE_MAX=3;SYNO.SDS.iSCSI.DEFAULT_MAX_REPLICA="64";SYNO.SDS.iSCSI.DATASITE_MAX=4;SYNO.SDS.iSCSI.STATUS_ALL="all";SYNO.SDS.iSCSI.STATUS_REPLICA="isReplica";SYNO.SDS.iSCSI.STATUS_SCHEDULE="isSchedule";SYNO.SDS.iSCSI.STATUS_NOT_SUPPORT="notSupport";SYNO.SDS.iSCSI.STATUS_NO_PROTECTED="notProtected";SYNO.SDS.iSCSI.STATUS_NOT_MANAGEABLE="notManageable";SYNO.SDS.iSCSI.STATUS_VOLUME_CRASHED="volCrashed";SYNO.SDS.iSCSI.DSM_HTTP_PORT=5000;SYNO.SDS.iSCSI.DSM_HTTPS_PORT=5001;SYNO.SDS.iSCSI.STATUS_LOCAL_PREFIX="local_";SYNO.SDS.iSCSI.STATUS_REMOTE_PREFIX="remote_";SYNO.SDS.iSCSI.TARGET_NAME_HOMES="homes";SYNO.SDS.iSCSI.ADVREPLICA_ENC_SHARE="encrypted_share";SYNO.SDS.iSCSI.ADVREPLICA_HOMES="homes";SYNO.SDS.iSCSI.LUN_TYPE_BTRFS="btrfs";SYNO.SDS.iSCSI.LUN_TYPE_ADV="adv";SYNO.SDS.iSCSI.LUN_TYPE_NOT_SUPPORT="notSupport";SYNO.SDS.iSCSI.RET_TRIGGER_BY_TIME="trigger_by_time";SYNO.SDS.iSCSI.READONLY_HELP_WEB_LINK="https://www.synology.com/zh-tw/knowledgebase/DSM/tutorial/Virtualization/What_should_I_do_when_my_Thin_Provisioned_iSCSI_LUN_is_read_only";Ext.define("SYNO.SDS.iSCSI.Overview.HealthPanel",{extend:"SYNO.ux.Panel",constructor:function(a){this.callParent([this.fillConfig(a)])},fillConfig:function(a){this.iconTpl=this.createIconTpl();this.titleTpl=this.createTitleTpl();this.upperPanel=this.createUpperPanel();this.lowerPanel=this.createLowerPanel();this.descMapping={normal:_T("iscsimgr","status_desc_good"),target_abnormal:[_T("iscsimgr","target_status_desc_abnormal"),_T("iscsimgr","target_status_desc_abnormal_multi")],soft_limit_reach:[_T("iscsimgr","lun_status_desc_soft_limit"),_T("iscsimgr","lun_status_desc_soft_limit_multi")],low_capacity_write_should_turn_off:[_T("iscsimgr","low_capacity_write_should_turn_off"),_T("iscsimgr","low_capacity_write_should_turn_off")],hard_limit_reach_without_low_capacity_write:[_T("iscsimgr","lun_status_desc_hard_limit_without_low_capacity"),_T("iscsimgr","lun_status_desc_hard_limit_without_low_capacity_multi")],hard_limit_reach:[_T("iscsimgr","lun_status_desc_hard_limit"),_T("iscsimgr","lun_status_desc_hard_limit_multi")],low_capacity_write_on:[_T("iscsimgr","lun_status_desc_low_capacity_write_on"),_T("iscsimgr","lun_status_desc_low_capacity_write_on_multi")],volume_degrade:[_T("iscsimgr","lun_status_desc_volume_degrade"),_T("iscsimgr","lun_status_desc_volume_degrade_multi")],volume_crashed:[_T("iscsimgr","lun_status_desc_volume_crash"),_T("iscsimgr","lun_status_desc_volume_crash_multi")],cache_crashed:[_T("iscsimgr","lun_status_desc_cache_crash"),_T("iscsimgr","lun_status_desc_cache_crash_multi")],unavailabling:[_T("iscsimgr","lun_status_desc_unavailabling"),_T("iscsimgr","lun_status_desc_unavailabling_multi")],Unhealthy:[_T("iscsimgr","lun_status_desc_clone_fail"),_T("iscsimgr","lun_status_desc_clone_fail_multi")]};var b={layout:"hbox",layoutConfig:{align:"middle"},items:[{xtype:"box",itemId:"icon",width:176},{xtype:"syno_panel",itemId:"rightPanel",flex:1,height:62,layout:"vbox",layoutConfig:{align:"stretch"},items:[this.upperPanel,this.lowerPanel]}],listeners:{scope:this,data_ready:this.onDataReady}};Ext.apply(b,a);return b},createIconTpl:function(){return new Ext.XTemplate('<div class="iscsi-overview-health">','<div class="iscsi-overview-health-icon iscsi-overview-health-icon-{status}"></div>',"</div>",{compiled:true,disableFormats:true})},createTitleTpl:function(){return new Ext.XTemplate('<div class="iscsi-overview-health">','<div class ="iscsi-overview-health-title">','<div class="iscsi-overview-health-text iscsi-overview-health-text-{status}">{[this.getStatusText(values.status)]}</div>',"</div>","</div>",{compiled:true,disableFormats:true,statusText:{normal:_T("widget","good_status"),warning:_T("log","warn_level"),error:_T("log","crit_level")},getStatusText:function(a){return this.statusText[a]}})},createUpperPanel:function(){return new SYNO.ux.Panel({margins:"0 0 8 0",layout:"hbox",height:38,items:[{xtype:"box",height:38,itemId:"title",flex:1},{xtype:"syno_button",itemId:"leftBtn",width:22,height:20,hidden:true,cls:"iscsi-overview-health-prev-btn",scope:this,handler:this.onLeftBtnClick,text:" "},{xtype:"syno_button",itemId:"rightBtn",width:22,height:20,hidden:true,margins:"0 10 0 0",cls:"iscsi-overview-health-next-btn",scope:this,handler:this.onRightBtnClick,text:""}]})},createLowerPanel:function(){return new SYNO.ux.Panel({flex:1,items:[{xtype:"syno_displayfield",itemId:"desc",htmlEncode:false,setValue:function(d){this.constructor.prototype.setValue.apply(this,arguments);var a=this.getEl().query("a")[0];var b=Ext.get(a);var c=function(e){e.preventDefault();SYNO.SDS.AppLaunch("SYNO.SDS.StorageManager.Instance",{fn:"SYNO.SDS.StorageManager.Volume.Main"})};if(b&&_T("volume","storage_manager")===a.text){this.mon(b,"click",c,this)}}}]})},updateDesc:function(c){var j=this;var f=-1,n,m;var k=this.descs.size();var h=this.getComponent("rightPanel");var e=this.lowerPanel.getComponent("desc");var l=this.upperPanel.getComponent("leftBtn");var a=this.upperPanel.getComponent("rightBtn");var b=e.getHeight();var g=h.getHeight();var d=false;if(k===0){m=this.descMapping.normal}else{this.descs.each(function(p,o){if((j.curDesc&&j.curDesc.location&&j.curDesc.location===p.location)||(j.curDesc&&!j.curDesc.location&&j.curDesc.status==p.status)){f=o;return false}});if(f===-1){n=0}else{if(c==="cur"){n=f}else{if(c==="prev"){n=f===0?k-1:f-1}else{n=f===k-1?0:f+1}}}this.curDesc=this.descs[n];if("low_capacity_write_on"===this.curDesc.status){m=String.format(this.descMapping[this.curDesc.status][this.curDesc.num>1?1:0],this.curDesc.num,SYNO.SDS.iSCSI.Utils.volumePathRenderer(this.curDesc.location),String.format('<a target="_blank" rel="noopener noreferrer" href="{0}">',SYNO.SDS.iSCSI.READONLY_HELP_WEB_LINK),"</a>")}else{if("hard_limit_reach_without_low_capacity_write"===this.curDesc.status||"soft_limit_reach"===this.curDesc.status||"hard_limit_reach"===this.curDesc.status){m=String.format(this.descMapping[this.curDesc.status][this.curDesc.num>1?1:0],this.curDesc.num,SYNO.SDS.iSCSI.Utils.volumePathRenderer(this.curDesc.location),String.format('<a target="_blank" rel="noopener noreferrer" href="{0}">',SYNO.SDS.iSCSI.READONLY_HELP_WEB_LINK),"</a>",'<a class="link-font" href="">',"</a>")}else{m=String.format(this.descMapping[this.curDesc.status][this.curDesc.num>1?1:0],this.curDesc.num,String.format('<a class="link-font" style="cursor:pointer">{0}</a>',_T("volume","storage_manager")))}}}e.setValue(m);var i=e.getHeight();if(i!==b){g=g-b+i;d=true}if(d){h.height=g;this.doLayout()}if(this.descs.length<=1){l.hide();a.hide();return}if(l.hidden||a.hidden){l.show();a.show();this.doLayout()}},prepareSummaryStatus:function(b,d){var f=this,c=f.appWin.iscsiLuns.getAll(),g=f.appWin.volumes,e=f.appWin.pools,a=f.appWin.iscsiTargets.getAll();var h=false;Ext.each(c,function(m){var i=m.get("location");var k=m.getSpace(g,e);var l=parseInt(k.size_free_byte,10);var j=m.getCrashType(f.appWin.volumes,f.appWin.pools,f.appWin.isLowCapacityWriteEnable());if(m.isThinProvisioningLun()&&l<SYNO.SDS.iSCSI.TP_HARD_THRESHOLD_DEFAULT_SIZE){h=true}if("hard_limit_reach_without_low_capacity_write"===j||"hard_limit_reach"===j||"soft_limit_reach"===j||"low_capacity_write_on"===j){if(!d.hasOwnProperty(i)){d[i]={stat:j,count:1}}else{d[i].count+=1}}else{b[j]++}});if(!h&&f.appWin.isLowCapacityWriteEnable()){b.low_capacity_write_should_turn_off=1}b.target_abnormal=a.filter(function(i){return i.get("is_enabled")&&"offline"===i.get("status")}).length},onLeftBtnClick:function(){this.updateDesc("prev")},onRightBtnClick:function(){this.updateDesc("next")},onDataReady:function(){var f={normal:0,warning:1,error:2};var a={normal:"normal",soft_limit_reach:"warning",volume_degrade:"warning",target_abnormal:"warning",Unhealthy:"warning",low_capacity_write_should_turn_off:"warning",hard_limit_reach_without_low_capacity_write:"error",hard_limit_reach:"error",low_capacity_write_on:"error",volume_crashed:"error",cache_crashed:"error",unavailabling:"error"};var g={normal:0,low_capacity_write_should_turn_off:0,target_abnormal:0,volume_crashed:0,cache_crashed:0,unavailabling:0,volume_degrade:0,Unhealthy:0};var i={};var b="normal";this.prepareSummaryStatus(g,i);this.descs=[];for(var d in a){if(g.hasOwnProperty(d)){if(d==="normal"){continue}if(0<g[d]){if(f[a[d]]>f[b]){b=a[d]}this.descs.push({status:d,num:g[d]})}}}for(var h in i){if(i.hasOwnProperty(h)){var c=i[h].stat;var e=i[h].count;if(c==="normal"){continue}if(0<e){if(f[a[d]]>f[b]){b=a[c]}this.descs.push({status:c,num:e,location:h})}}}this.iconTpl.overwrite(this.getComponent("icon").getEl(),{status:b});this.titleTpl.overwrite(this.upperPanel.getComponent("title").getEl(),{status:b});this.updateDesc("cur")}});Ext.define("SYNO.SDS.iSCSI.Overview.StatusBoxTmpl",{extend:"Ext.XTemplate",constructor:function(a){var b=this.createTpl();b.push(this.fillConfig(a));this.callParent(b)},fillConfig:function(a){var b={compiled:true,disableFormats:true},c={target:"Target",lun:"LUN",event:"Event",status:{target:{healthy:_T("iscsitrg","iscsitrg_status_connected"),warning:_T("log","warn_level")},lun:{healthy:_T("iscsilun","healthy"),warning:_T("log","warn_level"),error:_T("log","crit_level")},event:{healthy:_T("iscsimgr","unread"),warning:_T("iscsimgr","unread_warn"),error:_T("iscsimgr","unread_crit")}}};b.getTranslate=function(d){return c[d]};b.getStatusText=function(d,e){if(d==="target"){return c.status.target[e]}else{if(d==="lun"){return c.status.lun[e]}else{if(d==="event"){return c.status.event[e]}}}};b.isBothErrorWarn=function(d,e){return d!==0&&e!==0};b.showNumber=function(d){return(d>99)?"99+":d};return Ext.apply(b,a)},createTpl:function(){return['<div class="iscsi-overview-statusbox iscsi-overview-statusbox-{type} iscsi-overview-statusbox-{errorlevel} iscsi-overview-statusbox-{clickType}">','<div class="statusbox-titlebar"></div>','<div class="statusbox-box">','<div class="statusbox-title">',"<h3>{[ this.getTranslate(values.type) ]}</h3>","</div>",'<div class="statusbox-title-right">',"<h3>{[ this.showNumber(values.total) ]}</h3>","</div>",'<div class="x-clear"></div>','<tpl if="this.isBothErrorWarn(error, warning)">','<div class="statusbox-halfblock-left statusbox-block-error">','<div class="statusbox-number">{[ this.showNumber(values.error) ]}</div>','<div class="statusbox-text">{[ this.getStatusText(values.type, "error") ]}</div>',"</div>",'<div class="statusbox-halfblock-right statusbox-block-warning">','<div class="statusbox-number">{[ this.showNumber(values.warning) ]}</div>','<div class="statusbox-text">{[ this.getStatusText(values.type, "warning") ]}</div>',"</div>","</tpl>",'<tpl if="! this.isBothErrorWarn(error, warning)">','<div class="statusbox-block statusbox-block-{errorlevel}">','<div class="statusbox-number">{[ this.showNumber(values[values.errorlevel]) ]}</div>','<div class="statusbox-text">{[ this.getStatusText(values.type, values.errorlevel) ]}</div>',"</div>","</tpl>","</div>","</div>"]}});Ext.define("SYNO.SDS.iSCSI.Overview.StatusBox",{extend:"SYNO.ux.Panel",constructor:function(a){this.callParent([this.fillConfig(a)])},fillConfig:function(a){this.appWin=a.appWin;this.tpl=new SYNO.SDS.iSCSI.Overview.StatusBoxTmpl();var b={boxMaxWidth:270,items:[{itemId:"statusBox",xtype:"box",html:""}],listeners:{scope:this,afterrender:this.onAfterRender,update:this.updateTpl,data_ready:this.onDataReady}};Ext.apply(b,a);return b},onAfterRender:function(){this.mon(this.body,"click",this.onMouseClick,this)},updateTpl:function(){this.tpl.overwrite(this.getComponent("statusBox").getEl(),Ext.apply({type:this.type,clickType:this.owner.clickedBox===this.type?"click":"unclick",errorlevel:this.errorlevel,total:this.data.total||(this.data.error+this.data.warning+this.data.healthy)},this.data))},onMouseClick:function(){this.owner.fireEvent("selectchange",this.type)},processTrgSummary:function(){var b=this,a=b.appWin.iscsiTargets.getAll();b.data.total=0;Ext.each(a,function(c){b.data.total++;if("connected"===c.get("status")){b.data.healthy++}else{if(c.get("is_enabled")&&"offline"===c.get("status")){b.data.warning++}}},b)},processLUNSummary:function(){var b=this,a=b.appWin.iscsiLuns.getAll();Ext.each(a,function(d){var c="healthy";if(d.isSummaryWarning(this.appWin.volumes,this.appWin.pools)){c="warning"}else{if(d.isSummaryCrashed(this.appWin.volumes,this.appWin.pools,this.appWin.isLowCapacityWriteEnable())){c="error"}}b.data[c]++},b)},processEventSummary:function(){var a=this.appWin.summary;this.data.warning=a.warn_count?a.warn_count:0;this.data.error=a.error_count?a.error_count:0;this.data.healthy=a.info_count?a.info_count:0},onDataReady:function(){this.data={error:0,warning:0,healthy:0};switch(this.storeKey){case"target_summ":this.processTrgSummary();break;case"lun_summ":this.processLUNSummary();break;case"event_summ":this.processEventSummary();break}this.errorlevel=0!==this.data.error?"error":0!==this.data.warning?"warning":"healthy";this.updateTpl()}});Ext.define("SYNO.SDS.iSCSI.Overview.StatusBoxsPanel",{extend:"SYNO.ux.Panel",constructor:function(a){this.callParent([this.fillConfig(a)])},fillConfig:function(a){var c={owner:this,appWin:a.appWin,flex:1};this.clickedBox="target";this.statusBoxs=[new SYNO.SDS.iSCSI.Overview.StatusBox(Ext.apply({type:"target",title:"Target",storeKey:"target_summ"},c)),new SYNO.ux.Panel({width:10,height:129}),new SYNO.SDS.iSCSI.Overview.StatusBox(Ext.apply({type:"lun",title:"LUN",storeKey:"lun_summ"},c)),new SYNO.ux.Panel({width:10,height:129}),new SYNO.SDS.iSCSI.Overview.StatusBox(Ext.apply({type:"event",title:_T("schedule","event"),storeKey:"event_summ"},c))];var b={boxMaxWidth:770,layout:"hbox",layoutConfig:{align:"stretch"},items:this.statusBoxs,listeners:{scope:this,selectchange:this.onSelectChange,data_ready:this.onDataReady}};Ext.apply(b,a);return b},onSelectChange:function(a){this.clickedBox=a;this.statusBoxs.each(function(b){b.fireEvent("update")});this.owner.panels.detailPanel.fireEvent("select",a)},onDataReady:function(){this.statusBoxs.each(function(a){a.fireEvent("data_ready")})}});Ext.define("SYNO.SDS.iSCSI.Overview.ListViewTmpl",{extend:"Ext.XTemplate",utils:SYNO.SDS.iSCSI.Utils,constructor:function(a){this.owner=a.owner;var b=this.createTpl();b.push(this.fillConfig(a));this.callParent(b)},fillConfig:function(a){var b={compiled:true,disableFormats:true};b.getTitleClass=function(c){return c==="none"?"iscsi-title-no-status":""};b.getShort=function(c){if(3<c.length){c=c.slice(0,3);return c.join(", ")+",..."}return c.join(", ")};b.getFull=function(c){return c.join(", ")};b.getMapTrgName=function(d){var c=d.mapped_trgs[d.mapTrgIdx];return c?c.name:""};b.getMapTrgStatus=function(d){var c=d.mapped_trgs[d.mapTrgIdx];return c?c.status:""};b.hasAnyMappedTrg=function(c){return c.mapped_trgs.length>0};b.hasMultiMappedTrg=function(c){return c.mapped_trgs.length>1};b.getLUNUsedInfo=function(c){return String.format("{0} / {1}",c.allocated_size,c.size)};b.getLUNUsedRatio=function(c){return 100*(c.totalUsed/c.totalSize)};b.getSpacePath=function(c){if(c.is_block_lun){var d=this.owner.getPoolInfo(c.location).pool_id;return this.utils.SpaceIDParser(d).str}else{return String.format("{0} {1}",_T("volume","volume"),this.owner.getVolumeInfo(c.location).vol_id)}};b.getSpaceUsedRatio=function(c){var f={},e=Math.pow(10,2),d;if(c.is_block_lun){f=this.owner.getPoolInfo(c.location);d=100*(f.used_size/f.total_size)}else{f=this.owner.getVolumeInfo(c.location);d=100*((f.total_size-f.free_size)/f.total_size)}return Math.round(d*e)/e};b.getPoolPath=function(c){return""};return Ext.apply(b,a)},createTpl:function(){return['<tpl for=".">','<div class="item-wrap iscsi-overview-detail-{type}" id="{id}">','<div class="item-summary">','<div class="item-icon iscsi-overview-detail-icon icon-{cls}-{type}"></div>','<div class="iscsi-title-area">','<div class="iscsi-title {[ this.getTitleClass(values.status) ]}">','<div ext:qtip="{name}" class="item-title">{name}</div>','<div class="item-status">{values.status}</div>',"</div>","</div>",'<div class="iscsi-desc-area">',"<tpl if=\"cls =='target'\">",'<div class="iscsi-mapping-wrap">','<div class="iscsi-size">','<div class="iscsi-sizespace-info">','<div class="iscsi-sizespace-title">Mapped LUNs</div>','<div class="x-clear"></div>',"</div>",'<div ext:qtip="{[ this.getFull(values.mapped_luns) ]}" class="iscsi-maplun">{[ this.getFull(values.mapped_luns) ]}</div>',"</div>","</div>",'<div class="iscsi-mapping-wrap-ex">','<div class="iscsi-space">','<div class="iscsi-sizespace-info">','<div class="iscsi-sizespace-title">IQN</div>','<div class="x-clear"></div>',"</div>",'<div ext:qtip="{values.desc}" class="iscsi-trg-iqn">{values.desc}</div>',"</div>","</div>","</tpl>","<tpl if=\"cls =='lun'\">",'<div class="iscsi-maptrg-wrap">','<tpl if="this.hasAnyMappedTrg(values)">','<div class="iscsi-maptrg-title-wrap">','<div class="iscsi-maptrg-title">{[ this.getMapTrgName(values) ]}</div>','<tpl if="this.hasMultiMappedTrg(values)">','<div class="iscsi-maptrg-title-icon"></div>',"</tpl>",'<div class="x-clear"></div>',"</div>","<div>{[ this.getMapTrgStatus(values) ]}</div>","</tpl>",'<tpl if="!this.hasAnyMappedTrg(values)">','<div class="iscsi-maptrg-no-title">',"-","</div>","</tpl>","</div>",'<div class="iscsi-mapping-wrap" style="float: right">','<div class="iscsi-space">','<div class="iscsi-sizespace-info">','<div class="iscsi-sizespace-title">{[ this.getSpacePath(values) ]} ({[ this.getSpaceUsedRatio(values) ]}%)</div>','<div class="x-clear"></div>',"</div>",'<div class="iscsi-sizespace-bar">','<div class="iscsi-sizespace-bar-progress" style="width: {[ this.getSpaceUsedRatio(values) ]}%"></div>',"</div>","</div>","</div>",'<div class="iscsi-mapping-wrap" style="float: right">','<div class="iscsi-size">','<div class="iscsi-sizespace-info">','<div class="iscsi-sizespace-title">{[ this.getLUNUsedInfo(values) ]}</div>','<div class="x-clear"></div>',"</div>",'<div class="iscsi-sizespace-bar">','<div class="iscsi-sizespace-bar-progress" style="width: {[ this.getLUNUsedRatio(values) ]}%"></div>',"</div>","</div>","</div>","</tpl>","</div>","</div>","</div>","</tpl>",'<div class="x-clear"></div>']}});Ext.define("SYNO.SDS.iSCSI.Overview.ListView",{extend:"SYNO.ux.ExpandableListView",constructor:function(a){this.owner=a.owner;this.callParent([a])},createTpl:function(a){return new SYNO.SDS.iSCSI.Overview.ListViewTmpl(a)},onClick:function(g,f,d){var b=Ext.fly(f);var c=g.getTarget(this.itemSelector,this.getTemplateTarget());var a=null;var h=b.getXY();if(c){a=this.getRecord(c)}if(b.hasClass("iscsi-maptrg-title-icon")&&!this.menuShowed){h[0]=h[0]-45;this.onMapTrgClick(this,g,a,h)}else{this.menuShowed=false;this.callParent(arguments)}},onMapTrgClick:function(c,e,b,g){var a=b.data.mapped_trgs;var d=[];d=d.concat(a.map(function(j,h){var i={};i.id=b.data.id;i.idx=h;return new Ext.Action({text:j.name,scope:this,data:i,handler:this.onMapTrgChange})},this));var f=new SYNO.ux.Menu({items:d});g[1]=g[1]+18;f.showAt(g);this.menuShowed=true},onMapTrgChange:function(a){this.owner.fireEvent("trgselectchange",a.data.id,a.data.idx);this.menuShowed=false}});Ext.define("SYNO.SDS.iSCSI.Overview.DetailTargetPanel",{extend:"SYNO.ux.Panel",constructor:function(a){this.callParent([this.fillConfig(a)])},fillConfig:function(a){this.store=this.createStore();this.listView=this.createListView(a);var b={title:"",tabCls:"iscsi-overview-detail-tab-cls",layout:"fit",items:[this.listView],listeners:{scope:this,activate:this.onActivate,data_ready:this.onActivate}};Ext.apply(b,a);return b},createStore:function(){var a=["id",{name:"name",sortType:"asNaturalUCString"},"status","cls","type","desc","mapped_luns"];return new Ext.data.JsonStore({autoDestroy:true,idProperty:"id",fields:a,sortInfo:{field:"name",direction:"ASC"}})},createListView:function(a){return new SYNO.SDS.iSCSI.Overview.ListView({owner:this,appWin:a.appWin,store:this.store,trackResetOnLoad:false})},getMappedLuns:function(e){var d=this,b=d.appWin.iscsiLuns,a=[];var c=e.get("mapped_luns");c.forEach(function(f){var g=b.getById(f.lun_uuid);a.push(g.get("name"))});return a},prepareUiData:function(){var b=this,a=b.appWin.iscsiTargets.getAll(),c;delete b.uiData;b.uiData=[];Ext.each(a,function(d){c={};c.cls="target";c.status=SYNO.SDS.iSCSI.Utils.TargetStatusRender(d.get("status"));c.type="healthy";c.id=d.get("target_id").toString();c.name=d.get("name");c.desc=d.get("iqn");c.mapped_luns=b.getMappedLuns(d);b.uiData.push(c)})},setMask:function(){if(this.isVisible()&&0===this.listView.store.getCount()){this.body.mask(_T("iscsitrg","iscsitrg_no_iscsitrg"),"syno-ux-mask-info")}if(0<this.listView.store.getCount()){this.body.unmask()}},onActivate:function(){var a=this;a.prepareUiData();a.store.loadData(a.uiData);a.setMask()}});Ext.define("SYNO.SDS.iSCSI.Overview.DetailLUNPanel",{extend:"SYNO.ux.Panel",constructor:function(a){this.lastSelectTrg={};this.callParent([this.fillConfig(a)])},fillConfig:function(a){this.store=this.createStore();this.listView=this.createListView(a);var b={title:"",tabCls:"iscsi-overview-detail-tab-cls",layout:"fit",items:[this.listView],listeners:{scope:this,trgselectchange:this.onTrgSelectChange,activate:this.onActivate,data_ready:this.onActivate}};Ext.apply(b,a);return b},createStore:function(){var a=["id","lun_uuid",{name:"name",sortType:"asNaturalUCString"},"status","cls","type","is_block_lun","location","size","allocated_size","totalSize","totalUsed","totalUsed","volume_path","mapTrgIdx","mapped_trgs"];return new Ext.data.JsonStore({autoDestroy:true,idProperty:"id",fields:a,sortInfo:{field:"name",direction:"ASC"}})},createListView:function(a){return new SYNO.SDS.iSCSI.Overview.ListView({owner:this,appWin:a.appWin,store:this.store,trackResetOnLoad:false})},getVolumeInfo:function(d){var a=this,c=a.appWin.volumes,b={};Ext.each(c,function(e){if(e.volume_path===d){b.vol_id=e.volume_id;b.free_size=e.size_free_byte;b.total_size=e.size_total_byte;return b}});return b},getPoolInfo:function(c){var a=SYNO.SDS.iSCSI.Utils,b=this.appWin.pools;return a.getLUNPoolInfo(b,c)},prepareLastSelectTrg:function(e,c){var b=this,d=e.get("uuid"),a=0;if(undefined===b.lastSelectTrg[d]){c.mapTrgIdx=0;return}for(;a<c.mapped_trgs.length;a++){if(c.mapped_trgs[a].name===b.lastSelectTrg[d]){break}}c.mapTrgIdx=a<c.mapped_trgs.length?a:0},prepareSummary:function(c,b){var a="healthy";if(c.isSummaryWarning(this.appWin.volumes,this.appWin.pools)){a="warning"}else{if(c.isSummaryCrashed(this.appWin.volumes,this.appWin.pools,this.appWin.isLowCapacityWriteEnable())){a="error"}}b.id=c.get("lun_id");b.lun_uuid=c.get("uuid");b.status=c.getSummaryStatus(this.appWin.volumes,this.appWin.pools,this.appWin.isLowCapacityWriteEnable());b.type=a;b.is_block_lun=c.isBlockLun();b.totalSize=parseInt(c.get("size"),10);b.totalUsed=parseInt(c.get("allocated_size"),10);b.location=c.get("location");b.name=c.get("name");b.mapped_trgs=this.appWin.getMappedTrgs(c.get("uuid"),true)},prepareFileLunProperty:function(c,b){var a=SYNO.SDS.iSCSI.Utils;b.size=a.SizeRender(c.get("size"));b.allocated_size=a.SizeRender(c.get("allocated_size"))},prepareUiData:function(){var b=this,a=b.appWin.iscsiLuns.getAll(),c;delete b.uiData;b.uiData=[];Ext.each(a,function(d){c={};c.cls="lun";b.prepareSummary(d,c);b.prepareFileLunProperty(d,c);b.prepareLastSelectTrg(d,c);b.uiData.push(c)},b)},onTrgSelectChange:function(a,d){var b=this.store.getById(a),c=b.data.lun_uuid;this.lastSelectTrg[c]=b.data.mapped_trgs[d].name;b.set("mapTrgIdx",d)},setMask:function(){if(this.isVisible()&&0===this.listView.store.getCount()){this.body.mask(_T("iscsilun","iscsilun_no_luns"),"syno-ux-mask-info")}if(0<this.listView.store.getCount()){this.body.unmask()}},onActivate:function(){var a=this;a.prepareUiData();a.store.loadData(a.uiData);a.setMask()}});Ext.define("SYNO.SDS.iSCSI.Overview.DetailEventPanel",{extend:"SYNO.ux.GridPanel",total:100,refreshInterval:5000,constructor:function(a){var c=this,b;c.pollingTask=this.createPollingTask();c.scrollDownFlag=false;c.scrollPosition=0;c.last_date_from=0;Ext.apply(c,a);b=c.fillConfig(a);c.callParent([b])},onPageActivate:function(){this.onActive()},getPageRecordStore:function(){var a=new Ext.data.SimpleStore({fields:["value","display"],data:[[100,100],[500,500],[1000,1000],[3000,3000]]});return a},initEvents:function(){this.mon(this,"activate",this.onActive,this);this.mon(this,"deactivate",this.onDeactive,this)},loadException:function(){this.body.mask(_T("log","no_log_available"),"iscsi-no-hover")},onBeforeStoreLoad:function(a,b){this.getEl().unmask()},onAfterStoreLoad:function(a,c,b){if(this.logStore.getCount()<1){this.body.mask(_T("log","no_log_available"),"iscsi-no-hover")}else{this.body.unmask()}},getStore:function(){var a=new SYNO.API.Store({api:"SYNO.Core.ISCSI.Node",version:1,method:"log_list",appWindow:this.appWin,remoteSort:false,reader:new Ext.data.JsonReader({idProperty:"id",root:"logs",totalProperty:"summary.total",fields:[{name:"log_level",mapping:"log_level"},{name:"time",mapping:"time"},{name:"user",mapping:"user"},{name:"event",mapping:"event"}]}),listeners:{exception:this.loadException,beforeload:this.onBeforeStoreLoad,load:this.onAfterStoreLoad,scope:this}});return a},logLevelRenderer:function(a){switch(a){case"err":return"<span class='red-status'>Error</span>";case"warning":return"<span class='orange-status'>Warning</span>";case"info":return"<span class='green-status'>Information</span>";default:return"Undefined"}},htmlTimeRender:function(b){var a=new Date(b*1000);return SYNO.SDS.DateTimeFormatter(a,{type:"datetimesec"})},htmlEncodeRender:function(c,b){var a=Ext.util.Format.htmlEncode(c);b.attr='ext:qtip="'+Ext.util.Format.htmlEncode(a)+'"';return a},getColumnModel:function(){var a=new Ext.grid.ColumnModel({columns:[{header:_TT("SYNO.SDS.LogCenter.Instance","logattr","attr_priority"),dataIndex:"log_level",width:100,align:"center",renderer:this.logLevelRenderer},{header:_T("log","log_time"),dataIndex:"time",width:150,align:"center",renderer:this.htmlTimeRender},{header:_T("log","log_account"),dataIndex:"user",width:100,align:"center",renderer:SYNO.SDS.iSCSI.Utils.htmlEncodeRender},{id:"descr",header:_T("log","log_action"),dataIndex:"event",css:"white-space:normal;",width:300,renderer:SYNO.SDS.iSCSI.Utils.htmlEventEncodeRender}],defaults:{sortable:false,menuDisabled:false}});return a},fillConfig:function(a){var c=this;c.logStore=c.getStore();c.bufferView=new SYNO.ux.FleXcroll.grid.BufferView({rowHeight:27,scrollDelay:30,borderHeight:1,trackResetOnLoad:false,templates:{cell:new Ext.XTemplate('<td class="x-grid3-col x-grid3-cell x-grid3-td-{id} x-selectable {css}" style="{style}" tabIndex="-1" {cellAttr}>','<div class="{this.selectableCls} x-grid3-cell-inner x-grid3-col-{id}" {attr}>{value}</div>',"</td>",{selectableCls:SYNO.SDS.Utils.SelectableCLS})},listeners:{scope:c,flexcroll:c.scrollHandler}});var b={border:false,trackResetOnLoad:true,title:"",tabCls:"iscsi-overview-detail-tab-cls",layout:"fit",itemId:"iscsi_log",enableColumnMove:false,enableHdMenu:false,store:c.logStore,colModel:c.getColumnModel(),view:c.bufferView,loadMask:true,stripeRows:true};Ext.apply(b,a);return b},scrollHandler:function(){var b=this.scrollPosition,a=this.bufferView.getScrollTop();if(a>b){this.scrollDownFlag=true;b=a}else{if(0===a&&this.scrollDownFlag){this.setUnread();this.scrollDownFlag=false}}},isTheSame:function(b,a){var c;for(c in a){if(a[c]!==b[c]){return false}}return true},onActive:function(){this.last_date_from=0;this.pollingTask.start(true)},onDeactive:function(){this.pollingTask.stop()},setUnread:function(){var a=this;a.sendWebAPI({api:"SYNO.Core.ISCSI.Node",version:1,method:"log_list",params:{additional:["update_unread"]},scope:a})},createPollingTask:function(){return this.addWebAPITask({scope:this,api:"SYNO.Core.ISCSI.Node",method:"log_list",version:1,params:{date_from:this.last_date_from,additional:["unread"]},interval:this.refreshInterval,callback:function(g,d,f,c){if(!g){return}var e={err:2,warning:1,info:0};var b=d.logs;if(this.last_date_from===0){this.setUnread()}if(this.last_date_from!==0){var a=Ext.pluck(this.logStore.data.items,"json");b=b.concat(a)}if(d.logs.length>0){this.last_date_from=d.logs[0].time}b.sort(function(i,h){if(i.log_level!==h.log_level){return e[h.log_level]-e[i.log_level]}else{return h.time-i.time}}).slice(0,this.total);this.logStore.loadData({summary:d.summary,logs:b})}})},setLogLevelText:function(b,a,c,e,d){if(b){d=d||"0";b.setText(String.format(a,c,e,d))}},destroy:function(){if(this.rowNav){Ext.destroy(this.rowNav);this.rowNav=null}this.callParent([this])}});Ext.define("SYNO.SDS.iSCSI.Overview.DetailTabPanel",{extend:"SYNO.ux.TabPanel",constructor:function(a){this.appWin=a.appWin;this.callParent([this.fillConfig(a)])},fillConfig:function(a){this.panels={target:new SYNO.SDS.iSCSI.Overview.DetailTargetPanel({appWin:this.appWin,itemId:"target"}),lun:new SYNO.SDS.iSCSI.Overview.DetailLUNPanel({appWin:this.appWin,itemId:"lun"}),event:new SYNO.SDS.iSCSI.Overview.DetailEventPanel({appWin:this.appWin,itemId:"event"})};var b={cls:"iscsi-overview-detail",items:Object.values(this.panels),listeners:{scope:this,select:this.onSelect,data_ready:this.onSelect}};Ext.apply(b,a);return b},onSelect:function(a){if(this.owner.loaded){this.setActiveTab(a);this.panels[a].fireEvent("data_ready")}}});Ext.define("SYNO.SDS.iSCSI.Overview.Main",{extend:"SYNO.ux.Panel",constructor:function(a){this.loaded=false;this.callParent([this.fillConfig(a)])},fillConfig:function(a){this.panels={healthPanel:new SYNO.SDS.iSCSI.Overview.HealthPanel({appWin:a.appWin,owner:this,height:170}),statusBoxsPanel:new SYNO.SDS.iSCSI.Overview.StatusBoxsPanel({appWin:a.appWin,owner:this,height:129}),detailPanel:new SYNO.SDS.iSCSI.Overview.DetailTabPanel({appWin:a.appWin,owner:this,flex:1})};var b={layout:"vbox",layoutConfig:{align:"stretch"},items:Object.values(this.panels),listeners:{scope:this,activate:this.onActivate,deactivate:this.onDeactive,data_ready:this.onDataReady}};Ext.apply(b,a);return b},onActivate:function(){var a=this;a.panels.detailPanel.fireEvent("select",a.panels.statusBoxsPanel.clickedBox);if(!a.loaded){a.appWin.setStatusBusy(null,null,50)}a.appWin.fireEvent("poll_activate")},onDeactive:function(){this.panels.detailPanel.fireEvent("deactivate",this.panels.statusBoxsPanel.clickedBox)},onDataReady:function(){var a=this;if(!a.loaded){if(a.appWin.env&&a.appWin.env.promote_storage_console){var b=new SYNO.SDS.iSCSI.Overview.PromoteWindow({appWin:a.appWin,owner:a.appWin});b.open()}a.appWin.clearStatusBusy();a.loaded=true}a.panels.healthPanel.fireEvent("data_ready");a.panels.statusBoxsPanel.fireEvent("data_ready");a.panels.detailPanel.fireEvent("data_ready",a.panels.statusBoxsPanel.clickedBox)}});Ext.define("SYNO.SDS.iSCSI.Overview.PromoteWindow",{extend:"SYNO.SDS.ModalWindow",constructor:function(a){var c=this;c.appWin=a.appWin;c.owner=a.owner;var b={title:_T("iscsimgr","storage_console_promote_title"),width:560,height:320,resizable:true,buttons:[{xtype:"syno_button",btnStyle:"blue",text:_T("common","alt_apply"),scope:c,handler:c.onSave}],items:[c.createForm()]};c.callParent([Ext.apply(b,a)])},createForm:function(){var c=this;var b="https://www.synology.com/en-global/support/download/"+_D("upnpmodelname","")+"#utilities";var a={xtype:"syno_formpanel",height:240,itemId:"info",cls:"syno-app-iscsi",trackResetOnLoad:false,items:[{xtype:"syno_panel",layout:"vbox",layoutConfig:{align:"stretch"},items:[{xtype:"syno_panel",layout:"hbox",layoutConfig:{align:"middle"},height:116,padding:"16px 0px 20px",items:[{xtype:"syno_displayfield",width:80,cls:"iscsi-storage-console-icon",value:"",htmlEncode:false},{xtype:"syno_displayfield",value:_T("iscsimgr","storage_console_promote_desc")+" "+String.format('<a href="https://www.synology.com/dsm/software_spec/iscsi_manager" target="_blank">{0}</a>',_T("iscsimgr","learn_more")),htmlEncode:false}]},{xtype:"syno_displayfield",cls:"iscsi-retention-descpanel",value:String.format(_T("iscsimgr","storage_console_download_desc"),'<a href="'+b+'" target="_blank">',"</a>"),htmlEncode:false}]}],bbar:c.checkout_panel=new SYNO.ux.Panel({itemId:"bbar_panel",padding:"0px 10px 14px 0px",items:[{xtype:"syno_checkbox",name:"never_remind",itemId:"never_remind",boxLabel:_T("iscsimgr","storage_console_promote_not_show_again")}]})};return a},onSave:function(){var a=this;if(a.checkout_panel.getComponent("never_remind").getValue()){a.sendWebAPI({api:"SYNO.Core.ISCSI.Node",method:"set",params:{promote_storage_console:false},version:1,scope:this,callback:function(b,c){SYNO.Debug("SYNO.Core.ISCSI.Node set: "+(b?"succeeded":"faileded"))}})}a.close()}});Ext.define("SYNO.SDS.iSCSI.Target.Property",{extend:"SYNO.ux.FormPanel",constructor:function(a){var c=this,b;c.appWin=a.appWin;c.owner=a.owner;c.isCinderTarget=a.isCinderTarget||false;b={title:_T("iscsitrg","iscsitrg_title_basic"),trackResetOnLoad:true,labelWidth:280,fieldWidth:280,border:false,items:[{xtype:"syno_textfield",fieldLabel:_T("common","name"),vtype:"iscsitrgname",maxlength:128,allowBlank:false,name:"name",appWin:c.appWin,disabled:c.isCinderTarget,validator:function(d){if(d===this.originalValue){return true}else{if(this.appWin.isUniqueTargetName(d)){return true}else{return _T("iscsitrg","iscsitrg_name_exists")}}}},{xtype:"syno_textfield",fieldLabel:"IQN",vtype:"iscsitrgiqn",maxlength:128,allowBlank:false,name:"iqn",appWin:c.appWin,disabled:c.isCinderTarget,validator:function(d){if(d===this.originalValue){return true}else{if(this.appWin.isUniqueIQN(d)){return true}else{return _T("iscsitrg","iscsitrg_iqn_exists")}}}},{xtype:"syno_checkbox",boxLabel:_T("iscsitrg","iscsitrg_enable_auth_chap"),name:"chap"},{xtype:"syno_textfield",indent:1,fieldLabel:_T("common","name"),allowBlank:false,maxlength:64,name:"user",vtype:"iscsitrg_username"},{xtype:"syno_textfield",textType:"password",indent:1,fieldLabel:_T("common","password"),maxlength:16,name:"password",allowBlank:false,vtype:"iscsitrg_password"},{xtype:"syno_textfield",textType:"password_confirm",indent:1,fieldLabel:_T("user","user_repswd"),maxlength:16,name:"password_confirm",confirmFor:"password",vtype:"iscsitrg_password",validator:c.iscsi_pwd_validator},{xtype:"syno_checkbox",indent:1,boxLabel:_T("iscsitrg","iscsitrg_enable_auth_mutual_chap"),name:"mutual_chap"},{xtype:"syno_textfield",indent:2,fieldLabel:_T("common","name"),maxlength:64,name:"mutual_user",vtype:"iscsitrg_username",allowBlank:false},{xtype:"syno_textfield",textType:"password",indent:2,fieldLabel:_T("common","password"),maxlength:16,name:"mutual_password",vtype:"iscsitrg_password",allowBlank:false,validator:function(f){if(!this.ownerCt){return"Failed to find ownerCt"}var e=this.ownerCt.get("password").getValue();var d=this.ownerCt.get("password_confirm").getValue();if((f==e)&&!(e===SYNO.SDS.iSCSI.TARGET.FAKE_PWD&&d===SYNO.SDS.iSCSI.TARGET.FAKE_PWDC)){return _T("iscsitrg","iscsitrg_error_same_as_password")}return true}},{xtype:"syno_textfield",textType:"password_confirm",maxlength:16,indent:2,fieldLabel:_T("user","user_repswd"),name:"mutual_password_confirm",confirmFor:"mutual_password",vtype:"iscsitrg_password",validator:c.iscsi_pwd_validator}],listeners:{afterlayout:{fn:function(d){var f=d.getForm();var e=new SYNO.ux.Utils.EnableCheckGroup(f,"chap",["user","password","password_confirm","mutual_chap"]);e=new SYNO.ux.Utils.EnableCheckGroup(f,"mutual_chap",["mutual_user","mutual_password","mutual_password_confirm"])},scope:this,single:true}}};c.callParent([Ext.apply(b,a)])},iscsi_pwd_validator:function(c){if(!this.ownerCt){return"Failed to find ownerCt"}var a=this.ownerCt.get(this.confirmFor);var b=a.getValue();if((c!==b)&&(b!==SYNO.SDS.iSCSI.TARGET.FAKE_PWD||c!==SYNO.SDS.iSCSI.TARGET.FAKE_PWDC)){return _T("pppoe","error_password")}return true},getMappingCmp:function(){return this.getComponent("mapping")}});Ext.define("SYNO.SDS.iSCSI.Target.Wizard.PropertyStep",{extend:"SYNO.SDS.iSCSI.Target.Property",constructor:function(a){var c=this,b;c.appWin=a.appWin;b={header:false,headline:_T("iscsitrg","iscsitrg_target_create")};this.callParent([Ext.apply(b,a)])},activate:function(){if(this.loaded){return}this.getForm().setValues({iqn:this.appWin.genNewIQN(this.appWin.genNewTargetName()),name:this.appWin.genNewTargetName()});this.loaded=true},getNext:function(){if(!this.getForm().isValid()){return false}return this.nextId},summary:function(c){var a=this.getForm().getValues();var b="";c.append(_T("iscsimgr","target_name"),a.name);c.append("IQN",a.iqn);b=_T("iscsitrg","iscsitrg_title_authen");if(a.mutual_chap==="true"){c.append(b,_T("iscsitrg","iscsitrg_auth_mutual_chap"))}else{if(a.chap==="true"){c.append(b,_T("iscsitrg","iscsitrg_auth_chap"))}else{c.append(b,_T("iscsitrg","iscsitrg_auth_none"))}}if(a.chap==="true"){c.append(_T("common","name"),a.user)}if(a.mutual_chap==="true"){c.append(_T("common","name"),a.mutual_user)}}});Ext.define("SYNO.SDS.iSCSI.Target.Wizard.MappingStep",{extend:"Ext.form.FormPanel",luns:null,constructor:function(a){var c=this,b;c.appWin=a.appWin;c.canCreateLun=a.canCreateLun||false;c.canMapLun=false;c.lun_create_radio=new SYNO.ux.Radio({boxLabel:_T("iscsitrg","iscsitrg_lun_create"),name:"lun_source",inputValue:"create",checked:Ext.isDefined(c.canCreateLun)?c.canCreateLun:false,disabled:!c.canCreateLun});c.map_lun_radio=new SYNO.ux.Radio({boxLabel:_T("iscsitrg","iscsitrg_map_existent_lun"),name:"lun_source",itemId:"exists",inputValue:"exists",checked:false,disabled:true,listeners:{check:function(e,d){if(d){this.ownerCt.getComponent("mapped_lun").enable()}else{this.ownerCt.getComponent("mapped_lun").disable()}}}});c.none_lun_radio=new SYNO.ux.Radio({boxLabel:_T("iscsimgr","no_map_lun_desc"),name:"lun_source",htmlEncode:false,inputValue:"none"});b={headline:_T("volume","volume_set_iscsitrg_lun_mapping"),items:[{xtype:"syno_displayfield",htmlEncode:false,style:"margin-bottom:8px",value:_T("iscsimgr","lun_mapping_step_subtitle")},c.lun_create_radio,{xtype:"syno_displayfield",htmlEncode:false,indent:1,style:"margin-bottom:8px",value:_T("iscsimgr","lun_create_desc")},c.map_lun_radio,{xtype:"syno_displayfield",htmlEncode:false,indent:1,value:_T("iscsimgr","map_exist_lun_desc")},{xtype:"syno_combobox",name:"mapped_lun",hiddenName:"mapped_lun",itemId:"mapped_lun",tpl:'<tpl for="."><div ext:qtip="{name}" class="x-combo-list-item">{name}</div></tpl>',displayField:"name",style:"margin-bottom:8px",forceSelection:true,hideLabel:true,editable:false,disabled:true,indent:1,width:250,store:this.lun_store=new Ext.data.JsonStore({autoDestroy:true,idProperty:"name",fields:["lun_id",{name:"name",sortType:"asNaturalUCString"},"uuid"],listeners:{load:function(d,e){d.sort("name","ASC");this.onLoad(e)},scope:this}})},c.none_lun_radio]};c.callParent([Ext.apply(b,a)])},getSource:function(){return this.getForm().getValues().lun_source},activate:function(){var c=this;var a=c.appWin.iscsiLuns.getAll();var d=c.appWin.volumes;var b=c.appWin.pools;var e=[];Ext.each(a,function(f){if(!f.get("is_mapped")&&f.canBeMapped(d,b)){e.push({lun_id:f.get("lun_id"),name:f.get("name"),uuid:f.get("uuid")})}});c.lun_store.loadData(e)},onLoad:function(a){this.canMapLun=(undefined!==a&&0<a.length);if(this.canMapLun){if(this.canCreateLun){this.map_lun_radio.enable()}else{this.getComponent("mapped_lun").enable();this.map_lun_radio.enable();this.map_lun_radio.setValue(true)}this.getForm().setValues({mapped_lun:a[0].id})}else{if(!this.canCreateLun){this.none_lun_radio.setValue(true)}}},getLunUUIDs:function(){var a=this.getForm().getValues().mapped_lun;return this.lun_store.getById(a).get("uuid")},getNext:function(){return this.nextId[this.getSource()]},summary:function(b){var a=this.getSource();switch(a){case"create":break;case"exists":b.append(_T("iscsitrg","iscsitrg_mapped_lun"),this.getForm().getValues().mapped_lun.toString());break;case"none":b.append(_T("iscsitrg","iscsitrg_mapped_lun"),_T("system","none_opt"));break;default:break}}});Ext.define("SYNO.SDS.iSCSI.Target.Wizard.CreateSummaryStep",{extend:"SYNO.SDS.Wizard.SummaryStep",getNext:function(){this.owner.applySettings(null);return false},descRenderer:function(e,b,a,g,d,c){var f=e.toString().replace(/<.*?>/g,"");b.attr='ext:qtip="'+f+'"';return e},disableNextInDemoMode:true});Ext.define("SYNO.SDS.iSCSI.Target.WizardCreate",{extend:"SYNO.SDS.Wizard.ModalWindow",isDataChanged:false,constructor:function(a){var c=this,b;c.appWin=a.appWin;c.owner=a.owner;c.canCreateLunTypes=c.appWin.getCanCreateLunTypes();b={title:_T("iscsitrg","iscsitrg_target_create"),width:680,height:c.appWin.supportVAAI?600:580,minHeight:475,minWidth:680,resizable:false,cls:"syno-app-iscsi",steps:[new SYNO.SDS.iSCSI.Target.Wizard.PropertyStep({appWin:c.appWin,itemId:"target_prop",nextId:"map_luns"}),new SYNO.SDS.iSCSI.Target.Wizard.MappingStep({appWin:c.appWin,canCreateLun:c.canCreateLun(),itemId:"map_luns",nextId:{create:"lun_property_step",exists:"summary",none:"summary"}}),new SYNO.SDS.iSCSI.Target.Wizard.CreateSummaryStep({appWin:c.appWin,itemId:"summary",nextId:null})]};b.steps.push(new SYNO.SDS.iSCSI.LUN.Wizard.PropertyStep({appWin:c.appWin,owner:c.owner,vol_type_of_lun:"all",mode:"create",itemId:"lun_property_step",nextId:"summary"}));c.callParent([Ext.apply(b,a)])},canCreateLun:function(){if(this.appWin.isUpToLunMaxCount()){return false}for(var a in this.canCreateLunTypes){if(this.canCreateLunTypes.hasOwnProperty(a)){return true}}return false},applySettings:function(f){var c={};var i=this.getStep("map_luns").getSource();var h=[];var a=[];var d=true;var b=false;var g={};c=this.getStep("target_prop").getForm().getValues();c.auth_type=("true"===c.chap)?1:0;if(("true"===c.chap)&&("true"===c.mutual_chap)){c.auth_type=2}h.push({api:"SYNO.Core.ISCSI.Target",method:"create",version:1,params:c});g.lun_uuids=[];if("exists"===i){g.lun_uuids.push(this.getStep("map_luns").getLunUUIDs())}else{if("create"===i){var j={};var e;e=this.getStep("lun_property_step").getProps();j.name=e.name;j.location=e.location;if(e.hasOwnProperty("size")){j.size=(parseInt(e.size,10)*SYNO.SDS.iSCSI.Utils.ISCSITRG_UNIT_GB)}if("pool"===e.volumeType){j.type="BLOCK"}else{if("btrfs"===e.volumeType){if("true"===e.thin_provision){j.type="BLUN"}else{j.type="BLUN_THICK"}}else{if("ext4"===e.volumeType){if("true"===e.adv_legacy){j.type="ADV"}else{if("true"===e.thin_provision){j.type="THIN"}else{j.type="FILE"}}}}}j.dev_attribs=[{dev_attrib:"emulate_tpws",enable:("true"===e.adv_write_same)?1:0},{dev_attrib:"emulate_caw",enable:("true"===e.adv_caw)?1:0},{dev_attrib:"emulate_3pc",enable:("true"===e.adv_xcopy)?1:0},{dev_attrib:"emulate_tpu",enable:("true"===e.adv_unmap)?1:0},{dev_attrib:"can_snapshot",enable:("true"===e.adv_snapshot)?1:0}];h.push({api:"SYNO.Core.ISCSI.LUN",method:"create",version:1,params:j});b=true}}if("none"!==i){a.push({api:"SYNO.Core.ISCSI.Target",method:"map_lun",version:1,params:g})}if(null!==f){h=f}this.getButton("next").disable();this.setStatusBusy({text:_T("common","saving")});this.sendWebAPI({scope:this,compound:{stopwhenerror:true,mode:"sequential",params:h},callback:function(t,n,o,l){var u=[];if(!t||n.has_fail){this.clearStatusBusy()}for(var p=0;p<n.result.length;p++){if(!n.result[p].success){var s;var r="",q="";h[p].params.is_soft_feas_ignored=true;for(var m=0;m<h.length;m++){if(!n.result[m].success){u.push(h[m])}}if(n.result[p].hasOwnProperty("error")&&n.result[p].error.hasOwnProperty("errors")){s=n.result[p].error.errors;if("SYNO.Core.ISCSI.Target"===h[p].api){q=h[p].params.name}else{if("SYNO.Core.ISCSI.LUN"===h[p].api){r=h[p].params.name}}if(s.hasOwnProperty("feasibility_hard")||s.hasOwnProperty("feasibility_soft")){SYNO.SDS.iSCSI.LUN.GeneralFeasChkFailCallback(s,u,r,q,this,this.getButton("next").getId());return}}SYNO.SDS.iSCSI.Utils.ReportWebapiFailure(this,n.result[p].error);return}}if(d){if(n.result[0]&&n.result[0].success&&n.result[0].data){g.target_id=n.result[0].data.target_id.toString()}}if(b){if(n.result[1]&&n.result[1].success&&n.result[1].data){g.lun_uuids=[n.result[1].data.uuid]}}this.sendWebAPI({scope:this,compound:{stopwhenerror:true,mode:"sequential",params:a},callback:function(x,k,w,v){this.clearStatusBusy();this.getButton("next").enable();this.getButton("next").setText(_T("common","alt_finish"));if(k.str){this.getMsgBox().alert(this.title,k.str,this.close,this)}else{SYNO.SDS.StatusNotifier.setServiceDisabled("SYNO.SDS.iSCSI.Target.ISCSI",false);this.isDataChanged=true;this.close()}}})}})},contFromSoftFeasCheck:function(a){this.applySettings(a)}});Ext.define("SYNO.SDS.iSCSI.Target.Delete",{extend:"SYNO.SDS.ModalWindow",isDataChanged:false,target:null,mapped_luns:null,lunbkp_tasks:[],constructor:function(a){var c=this,b;c.appWin=a.cpp;c.owner=a.owner;c.target=a.target;c.mapped_luns=a.mapped_luns;c.isCinderTarget=a.isCinderTarget||false;c.ignoreSoftFeasibility=false;b={title:_T("common","remove")+": "+_T("tree","leaf_iscsitrg"),width:600,height:475,layout:"fit",items:[{xtype:"form",itemId:"main",border:false,items:[{xtype:"syno_displayfield",hideLabel:true,itemId:"desc",style:"word-wrap:break-word;",value:String.format(_T("iscsitrg","iscsitrg_delete_warning"),c.target.get("name"))},{xtype:"syno_checkbox",boxLabel:_T("iscsitrg","iscsitrg_delete_confirm"),name:"delete_luns",itemId:"delete_luns",listeners:{check:function(e,d){this.ownerCt.getComponent("grid").setDisabled(!d)}}},c.map=new SYNO.SDS.iSCSI.Target.Mapping({height:190,itemId:"grid",header:false,disabled:true})]}],buttons:[{xtype:"syno_button",btnStyle:"red",disabled:_S("demo_mode"),tooltip:_S("demo_mode")?_JSLIBSTR("uicommon","error_demo"):"",text:_T("common","remove"),id:c.applyButtonID=Ext.id(),scope:this,handler:this.onSave},{xtype:"syno_button",text:_T("common","alt_cancel"),scope:this,handler:this.onCancel}],listeners:{afterlayout:function(g){var d=g.getComponent("main").getHeight();var f=g.getComponent("main").getComponent("desc").getHeight();var e=g.getComponent("main").getComponent("delete_luns").getHeight();g.map.setHeight(d-f-e)}}};c.callParent([Ext.apply(b,a)])},onOpen:function(){this.callParent(arguments);var a=this.mapped_luns.map(function(b){return{id:b.get("lun_id"),name:b.get("name"),uuid:b.get("uuid"),enabled:false}});this.map.getStore().loadData(a,false)},applySetting:function(f){var d={},e={};var b={};var a=[];d.is_soft_feas_ignored=this.ignoreSoftFeasibility;d.uuid="";d.uuids=[];for(var c=0;c<f.luns.length;c++){d.uuids.push(f.luns[c].uuid);b[f.luns[c].uuid]=f.luns[c].name}if(f.luns.length>0){a.push({api:"SYNO.Core.ISCSI.LUN",method:"delete",version:1,params:d})}e.target_id=f.tid.toString();a.push({api:"SYNO.Core.ISCSI.Target",method:"delete",version:1,params:e});this.doApply(a)},doApply:function(a){var c=this;c.setStatusBusy({text:_T("common","saving")});for(var b=0;b<a.length;b++){if(a[b].params.hasOwnProperty("is_soft_feas_ignored")){a[b].params.is_soft_feas_ignored=this.ignoreSoftFeasibility}}this.sendWebAPI({scope:this,compound:{stopwhenerror:true,mode:"sequential",params:a},callback:function(g,e){this.clearStatusBusy();for(var f=0;f<e.result.length;f++){if(!e.result[f].success){var d;if(e.result[f].hasOwnProperty("error")&&e.result[f].error.hasOwnProperty("errors")){d=e.result[f].error.errors;if(d.hasOwnProperty("feasibility_hard")||d.hasOwnProperty("feasibility_soft")){SYNO.SDS.iSCSI.Target.LUNBackupTaskCallback(d,this,a);return}}SYNO.SDS.iSCSI.Utils.ReportWebapiFailure(this,e);return}this.isDataChanged=true;this.close()}}})},onSave:function(){var d=this;var a=_T("iscsitrg","iscsitrg_remove_cinder_target_warning");var c=this.getComponent("main").getForm();var f={tid:this.target.id,luns:[]};var b={yes:{text:_T("common","remove"),btnStyle:"red"},no:{text:_T("common","cancel")}};var e=function(){SYNO.SDS.Utils.PasswordConfirmDialog.openDialog(d,d.applySetting,[f])};if(c.getValues().delete_luns==="true"){Ext.each(d.map.getStore().getModifiedRecords(),function(g){f.luns.push({uuid:g.json.uuid,name:g.json.name,lid:g.id})},this)}if(d.isCinderTarget){this.getMsgBox().confirmDelete(this.title,a,function(g){if("yes"==g){e()}},this,b)}else{e()}},onCancel:function(){this.close()},contFromSoftFeasCheck:function(a){this.ignoreSoftFeasibility=true;this.doApply(a)}});SYNO.SDS.iSCSI.Target.LUNBackupTaskCallback=function(c,f,h){var j={};var d="";var g="";j.iscsiluns={};if(c.hasOwnProperty("feasibility_soft")){d="feasibility_soft";g="soft"}else{if(c.hasOwnProperty("feasibility_hard")){d="feasibility_hard";g="hard"}}if(c.hasOwnProperty(d)){var b=c[d];for(var e=0;e<b.length;e++){j.iscsiluns[b[e].name]={};j.iscsiluns[b[e].name][g]=b[e].check_message}}var a=Object.keys(j.iscsiluns);f.getMsgBox().confirm(f.title,String.format(_T("lunbkp","warning_deleting_lun"),a.join(", ")),function(i){if("yes"!==i){this.close();return}f.contFromSoftFeasCheck(h)},f)};Ext.define("SYNO.SDS.iSCSI.Target.Mapping",{extend:"SYNO.ux.GridPanel",constructor:function(a){var b=this;b.appWin=a.appWin;b.callParent([this.fillConfig(a)])},fillConfig:function(a){var c,b;c=new SYNO.ux.EnableColumn({dataIndex:"enabled",width:40,align:"center",bindRowClick:true});b={title:_T("iscsitrg","iscsitrg_mapping"),plugins:c,columns:[c,{id:"name",header:_T("common","name"),dataIndex:"name",align:"left",sortable:true,renderer:SYNO.SDS.iSCSI.Utils.TipRenderer}],store:new Ext.data.JsonStore({autoDestroy:true,idProperty:"id",fields:["id","enabled",{name:"name",sortType:"asNaturalUCString"}],sortInfo:{field:"name",direction:"ASC"}}),enableHdMenu:false,autoExpandColumn:"name",listeners:{activate:function(){if(0===this.getStore().totalLength){this.mask(_T("iscsilun","iscsilun_no_luns"),"syno-ux-mask-info")}}}};return Ext.apply(b,a)}});Ext.define("SYNO.SDS.iSCSI.Target.Portal",{extend:"SYNO.SDS.Utils.FormPanel",constructor:function(a){var f=this,g,d;f.appWin=a.appWin;g=new SYNO.ux.EnableColumn({dataIndex:"enabled",width:40,align:"center",bindRowClick:true});var b=new Ext.data.JsonStore({autoDestroy:true,idProperty:"ifname",fields:["ifname","status","ip","enabled",{name:"name",sortType:"asNaturalUCString"}],sortInfo:{field:"name",direction:"ASC"}});var c=new Ext.grid.ColumnModel({defaults:{align:"center"},xtype:"datecolumn",columns:[g,{id:"name",name:"name",header:_T("network","interface"),dataIndex:"name",align:"left",width:120,sortable:true,renderer:SYNO.SDS.iSCSI.TipRenderer},{id:"status",name:"status",header:_T("common","status"),dataIndex:"status",align:"left",width:90,sortable:true,renderer:SYNO.SDS.iSCSI.TipRenderer},{id:"ip",name:"ip",header:_T("common","ip_addr"),dataIndex:"ip",align:"left",width:200,sortable:true,renderer:SYNO.SDS.iSCSI.TipRenderer}],enableHdMenu:false,autoExpandColumn:"ip"});var e=[{xtype:"syno_displayfield",value:_T("iscsimgr","network_binding_desc")},{xtype:"syno_radio",name:"sel_all_interface",inputValue:true,boxLabel:_T("iscsimgr","network_binding_all_if"),id:this.allInterface=Ext.id(),listeners:{check:function(h,j,i){if(j){f.portalGridPanel.disable()}else{f.portalGridPanel.enable()}}}},{xtype:"syno_radio",id:this.selCertainIf=Ext.id(),name:"sel_all_interface",inputValue:true,boxLabel:_T("iscsimgr","network_binding_only_selected_if")},{xtype:"syno_fieldset",itemId:"portal_selector",name:"portal_selector",id:this.portalGridPanel=Ext.id(),collapsible:false,items:[{xtype:"syno_gridpanel",id:Ext.id(),cm:c,store:b,selModel:new Ext.grid.RowSelectionModel(),height:260,enableColumnMove:false,enableHdMenu:false,hideMode:"offsets",plugins:g}]}];d={title:_T("iscsitrg","iscsitrg_network_binding"),items:e};f.callParent([Ext.apply(d,a)]);this.portalStore=b;this.allInterface=Ext.getCmp(this.allInterface);this.portalGridPanel=Ext.getCmp(this.portalGridPanel);this.selCertainIf=Ext.getCmp(this.selCertainIf)}});Ext.define("SYNO.SDS.iSCSI.Target.Edit",{extend:"SYNO.SDS.ModalWindow",isDataChanged:false,target:null,luns:null,constructor:function(a){var d=this,b,c;d.appWin=a.appWin;d.owner=a.owner;d.target=a.target;d.isCinderTarget=a.isCinderTarget||false;d.prop=new SYNO.SDS.iSCSI.Target.Property({itemId:"prop",appWin:d.appWin,owner:d,isCinderTarget:d.isCinderTarget});d.advProp=new SYNO.ux.FormPanel(d.configAdvanceForm({itemId:"advance",appWin:d.appWin,owner:d}));d.map=new SYNO.SDS.iSCSI.Target.Mapping({itemId:"map",appWin:d.appWin,owner:d});d.maskEditor=new SYNO.SDS.iSCSI.Target.MaskingEditor({itemId:"mask",appWin:d.appWin,owner:d});d.portal=new SYNO.SDS.iSCSI.Target.Portal({itemId:"portal",appWin:d.appWin,owner:d});c=[d.prop,d.advProp];if(!d.isCinderTarget){c.push(d.map);c.push(d.portal);c.push(d.maskEditor)}b={title:_T("common","alt_edit"),width:625,height:500,minWidth:625,minHeight:475,resizable:true,layout:"fit",cls:"syno-app-iscsi",border:false,items:[{itemId:"main",xtype:"syno_tabpanel",activeTab:0,plain:true,hideMode:"offsets",deferredRender:false,items:c}],buttons:[{xtype:"syno_button",btnStyle:"blue",disabled:_S("demo_mode"),tooltip:_S("demo_mode")?_JSLIBSTR("uicommon","error_demo"):"",text:_T("common","alt_apply"),scope:this,handler:this.onSave},{xtype:"syno_button",text:_T("common","alt_cancel"),scope:this,handler:this.onCancel}]};d.callParent([Ext.apply(b,a)])},configAdvanceForm:function(a){return Ext.apply({title:_T("iscsitrg","iscsitrg_title_adv"),trackResetOnLoad:true,labelWidth:300,items:[{xtype:"syno_displayfield",value:_T("iscsitrg","iscsitrg_form_crc_checksum")},{xtype:"syno_checkbox",indent:1,boxLabel:_T("iscsitrg","iscsitrg_checksum_header"),name:"has_header_checksum",value:false},{xtype:"syno_checkbox",indent:1,boxLabel:_T("iscsitrg","iscsitrg_checksum_data"),name:"has_data_checksum",value:false},{xtype:"syno_displayfield",htmlEncode:false,value:"&nbsp;"},{xtype:"syno_checkbox",boxLabel:_T("iscsitrg","iscsitrg_multi_sessions_desc"),name:"multi_sessions",value:false},{xtype:"syno_displayfield",htmlEncode:false,indent:1,value:String.format('<span class="red-status">{0}</span>',_T("iscsitrg","iscsitrg_multi_sessions_warning"))},{xtype:"syno_displayfield",htmlEncode:false,value:"&nbsp;"},{xtype:"syno_combobox",fieldLabel:_T("iscsitrg","iscsitrg_max_recv_segment"),name:"max_recv_seg_bytes",hiddenName:"max_recv_seg_bytes",itemId:"max_recv_seg_bytes",store:[[262144,262144],[65536,65536],[8192,8192],[4096,4096]],editable:false,value:4096},{xtype:"syno_combobox",fieldLabel:_T("iscsitrg","iscsitrg_max_send_segment"),name:"max_send_seg_bytes",hiddenName:"max_send_seg_bytes",itemId:"max_send_seg_bytes",store:[[262144,262144],[65536,65536],[8192,8192],[4096,4096]],editable:false,value:4096}]},a)},onOpen:function(){var a=this;a.callParent(arguments);a.loadLuns();a.loadForm();a.loadMasking();a.loadPortal()},loadForm:function(){var a=this,c,b={};b.name=a.target.get("name");b.iqn=a.target.get("iqn");c=a.target.get("auth_type");b.chap=c!==0?true:false;b.mutual_chap=c===2?true:false;if(b.chap){Ext.apply(b,{user:a.target.get("user"),password:SYNO.SDS.iSCSI.TARGET.FAKE_PWD,password_confirm:SYNO.SDS.iSCSI.TARGET.FAKE_PWDC})}if(b.mutual_chap){Ext.apply(b,{mutual_user:a.target.get("mutual_user"),mutual_password:SYNO.SDS.iSCSI.TARGET.FAKE_PWD,mutual_password_confirm:SYNO.SDS.iSCSI.TARGET.FAKE_PWDC})}Ext.apply(b,{has_header_checksum:a.target.get("has_header_checksum"),has_data_checksum:a.target.get("has_data_checksum"),max_recv_seg_bytes:a.target.get("max_recv_seg_bytes"),max_send_seg_bytes:a.target.get("max_send_seg_bytes"),multi_sessions:(a.target.get("max_sessions")===0)});a.prop.getForm().setValues(b);a.advProp.getForm().setValues(b);a.prop.getForm().clearInvalid()},loadLuns:function(){var d=this;var b=d.appWin.iscsiLuns.getAll();var f=d.appWin.volumes;var c=d.appWin.pools;var a=d.map.getStore();var e=[];a.removeAll();Ext.each(b,function(g){if(!g.canBeMapped(f,c)){return true}e.push({id:g.get("uuid"),name:g.get("name"),enabled:d.target.isMappedToLUN(g.get("uuid"))})},d);a.loadData(e,false);a.commitChanges()},loadMasking:function(){var a=this;if(Ext.isArray(a.target.get("acls"))){a.maskEditor.loadData(a.target.data,false)}else{a.maskEditor.disable()}},loadPortal:function(){var e=this;var a=this.portal.portalStore;var g=e.appWin.netInterfaces;var c=e.target.data.network_portals;var f=[];var d=false;for(var b=0;b<c.size();++b){if(0<=c[b].interface_name.search("all")){d=true;break}}if(d){e.portal.allInterface.originalValue=true;e.portal.allInterface.setValue(true);e.portal.portalGridPanel.disable()}else{e.portal.selCertainIf.originalValue=true;e.portal.selCertainIf.setValue(true);e.portal.portalGridPanel.enable()}Ext.each(g,function(o){var h=o.status;var n="";var k=false;if(-1==o.ifname.indexOf("eth")&&-1==o.ifname.indexOf("bond")){return false}if(h=="connected"){n=String.format('<span class="blue-status" style="white-space:pre-warp">{0}</span>',_T("network","status_connected"))}else{n=String.format('<span class="disable-font" style="white-space:pre-warp">{0}</span>',_T("network","status_disconnected"))}for(var l=0;l<c.size();++l){var j=c[l].interface_name;var m=new RegExp(String.format("{0}$",j));if(""===j){continue}if(0<=o.ifname.search(m)){k=true;break}}f.push({ifname:o.ifname,name:SYNO.SDS.Utils.Network.idToString(o.ifname,o.type),ip:o.ip,status:n,enabled:k})},e);a.removeAll();a.loadData(f,false);a.commitChanges()},isDirty:function(){var b=this,a;if(b.appWin.supportRaidGroup){a=b.prop.getMappingCmp().getStore()}else{a=b.map.getStore()}if(b.prop.getForm().isDirty()){return true}if(b.advProp.getForm().isDirty()){return true}if(a.getModifiedRecords().length){return true}if(b.maskEditor.isDirty()){return true}if(b.portal.portalStore.getModifiedRecords().length||b.portal.allInterface.isDirty()||b.portal.selCertainIf.isDirty()){return true}return false},onSave:function(){var y=this,w={},u,j="";var a=y.map.getStore();var q=y.maskEditor.getStore();var k=y.portal.portalStore;var s=y.target.get("status");y.maskEditor.stopEditing();y.maskEditor.removeInvalids();if(!y.prop.getForm().isValid()){y.getComponent("main").activate("prop");y.advProp.getForm().isValid();return}else{if(!y.advProp.getForm().isValid()){y.getComponent("main").activate("advance");return}}if(!y.isDirty()){y.close();return}Ext.apply(w,y.prop.getForm().getValues());Ext.apply(w,y.advProp.getForm().getValues());if(w.password===SYNO.SDS.iSCSI.TARGET.FAKE_PWD&&w.password_confirm===SYNO.SDS.iSCSI.TARGET.FAKE_PWDC){delete w.password;delete w.password_confirm}if(w.mutual_password===SYNO.SDS.iSCSI.TARGET.FAKE_PWD&&w.mutual_password_confirm===SYNO.SDS.iSCSI.TARGET.FAKE_PWDC){delete w.mutual_password;delete w.mutual_password_confirm}var g=a.getModifiedRecords();var t=[],o=[];var x={},c={};x.target_id=y.target.id.toString();c.target_id=y.target.id.toString();for(u=0;u<g.length;u++){var m=g[u].data;if(true===m.enabled){o.push(m.name)}else{t.push(m.name)}}x.lun_uuids=o;c.lun_uuids=t;var p=0;for(u=0;u<a.getCount();u++){if(a.getAt(u).get("enabled")){p+=1}}if(p>SYNO.SDS.iSCSI.TARGET.MAX_MAPPING_LUNS){j=_T("iscsitrg","iscsitrg_max_lun_per_target");j=String.format(j,SYNO.SDS.iSCSI.TARGET.MAX_MAPPING_LUNS,w.name);y.getMsgBox().alert(y.title,j);return}var f={};f.acls=[];f.target_id=y.target.id;for(u=0;u<q.getCount();u++){f.acls.push({iqn:q.getAt(u).get("iqn"),permission:q.getAt(u).get("permission")})}var n=k.getModifiedRecords();var h=[],e=[];var b={},v={};b.target_id=y.target.id.toString();v.target_id=y.target.id.toString();for(u=0;u<n.length;u++){var d=n[u].data;var l=d.ifname.replace("ovs_","");if(true===d.enabled){h.push({interface_name:l})}else{e.push({interface_name:l})}}b.network_portals=[];v.network_portals=[];if(true===y.portal.allInterface.getValue()&&y.portal.allInterface.isDirty()){b.network_portals=[{interface_name:"all"}]}else{if(true===y.portal.selCertainIf.getValue()){b.network_portals=h;v.network_portals=e}}w.target_id=y.target.id.toString();w.auth_type=("true"===w.chap)?1:0;if(("true"===w.chap)&&("true"===w.mutual_chap)){w.auth_type=2}if(w.has_header_checksum){w.has_header_checksum=("true"===w.has_header_checksum)}if(w.has_data_checksum){w.has_data_checksum=("true"===w.has_data_checksum)}if(w.multi_sessions){w.max_sessions=("true"===w.multi_sessions)?0:1}if(w.max_recv_seg_bytes){w.max_recv_seg_bytes=parseInt(w.max_recv_seg_bytes,10)}if(w.max_send_seg_bytes){w.max_send_seg_bytes=parseInt(w.max_send_seg_bytes,10)}var r=[];if(y.prop.getForm().isDirty()||y.advProp.getForm().isDirty()){r.push({api:"SYNO.Core.ISCSI.Target",method:"set",version:1,params:w})}if(y.maskEditor.isDirty()){r.push({api:"SYNO.Core.ISCSI.Target",method:"acl_masks_set",version:1,params:f})}if(o.length>0){r.push({api:"SYNO.Core.ISCSI.Target",method:"map_lun",version:1,params:x})}if(t.length>0){r.push({api:"SYNO.Core.ISCSI.Target",method:"unmap_lun",version:1,params:c})}if(b.network_portals.length>0){r.push({api:"SYNO.Core.ISCSI.Target",method:"network_portals_add",version:1,params:b})}if(v.network_portals.length>0){r.push({api:"SYNO.Core.ISCSI.Target",method:"network_portals_remove",version:1,params:v})}if(s==="connected"&&y.maskEditor.isDirty()){this.getMsgBox().confirm(this.title,_T("iscsitrg","iscsitrg_disconnect_warning"),function(i){if("yes"===i){this.doApply(r)}},this)}else{this.doApply(r)}},doApply:function(a){this.setStatusBusy({text:_T("common","saving")});this.sendWebAPI({scope:this,mode:"sequential",compound:{stopwhenerror:true,params:a},callback:function(e,b,d,c){this.clearStatusBusy();if(!e||b.has_fail){SYNO.SDS.iSCSI.Utils.ReportWebapiFailure(this,b);return}SYNO.SDS.StatusNotifier.setServiceDisabled("SYNO.SDS.StorageManager.ISCSI",false);this.isDataChanged=true;this.close()}})},onCancel:function(){var a=this;if(a.isDirty()){a.getMsgBox().confirm(a.title,_T("common","confirm_lostchange"),function(b){if("yes"===b){a.close()}},a);return}a.close()}});Ext.define("SYNO.SDS.iSCSI.Target.MaskingEditor",{extend:"SYNO.ux.EditorGridPanel",constructor:function(a){var e=this,b;var f='<div style="height: 123px;position: relative;"><div class="iscsi-target-fileter-descript-frame">{0}{1}</div></div>';var d='<div style="font-weight: bold;line-height: 20px;padding: 8px 12px 4px 12px;">'+_T("iscsitrg","iscsitrg_mask_warning_title")+"</div>";var c='<div style="line-height: 18px;padding: 0px 12px 8px 12px">'+_T("iscsitrg","iscsitrg_mask_warning_description")+"</div>";e.oldData=[];e.appWin=a.appWin;e.owner=a.owner;b={title:_T("iscsitrg","iscsitrg_masking"),tbar:{defaultType:"syno_button",items:[{itemId:"createBtn",text:_T("common","create"),scope:this,handler:this.onCreate},{itemId:"removeBtn",text:_T("common","delete"),scope:this,disabled:true,handler:this.onRemove}]},columns:[{id:"iqn",header:_T("iscsitrg","iscsitrg_initiator_iqn"),dataIndex:"iqn",align:"left",renderer:SYNO.SDS.iSCSI.Utils.renderIQN,editable:false,editor:new SYNO.ux.TextField({vtype:"iscsitrgiqn",maxlength:128,allowBlank:false,listeners:{blur:this.onIQNBlur,scope:this}})},{header:_T("iscsitrg","iscsitrg_permission"),dataIndex:"permission",align:"left",renderer:SYNO.SDS.iSCSI.Utils.renderPermission,editor:new SYNO.ux.ComboBox(SYNO.LayoutConfig.fill({triggerAction:"all",forceSelection:true,editable:false,allowBlank:false,store:[["rw",_T("share","share_permission_writable")],["r",_T("share","share_permission_readonly")],["-",_T("share","share_permission_none")]]}))}],selModel:new Ext.grid.RowSelectionModel({listeners:{selectionchange:function(h){var g=h.getSelected();if(!g||g.get("iqn")===SYNO.SDS.iSCSI.TARGET.DefaultIQN){this.getTopToolbar().getComponent("removeBtn").disable()}else{this.getTopToolbar().getComponent("removeBtn").enable()}},scope:this}}),store:new Ext.data.JsonStore({autoDestroy:true,root:"acls",fields:["iqn","permission"]}),clicksToEdit:1,autoExpandColumn:"iqn",enableHdMenu:false,listeners:{deactivate:function(){this.stopEditing()},scope:this},fbar:{xtype:"panel",items:[{html:String.format(f,d,c),border:false}]}};e.callParent([Ext.apply(b,a)])},disableAll:function(){var b=this,a=b.getTopToolbar();a.getComponent("createBtn").disable();a.getComponent("removeBtn").disable();b.getColumnModel().setEditable(0,false);b.getColumnModel().setEditable(1,false);b.getSelectionModel().lock()},enableAll:function(){var b=this,a=b.getTopToolbar(),c=b.getSelectionModel().getSelected();a.getComponent("createBtn").enable();if(c&&c.get("iqn")!==SYNO.SDS.iSCSI.TARGET.DefaultIQN){a.getComponent("removeBtn").enable()}else{a.getComponent("removeBtn").disable()}b.getColumnModel().setEditable(0,false);b.getColumnModel().setEditable(1,true);b.getSelectionModel().unlock()},onIQNBlur:function(c){var d=c.getValue();var a=true;var b=0;this.stopEditing();this.getStore().each(function(e){if(e.get("iqn")===d){b++}});if(b>1){a=false}if(c.isValid()&&a){this.enableAll()}else{if(Ext.isDefined(this.editRow)){this.getStore().getAt(this.editRow).set("iqn","");this.getStore().removeAt(this.editRow)}this.enableAll()}this.editRow=undefined},removeInvalids:function(){var a=this.getStore(),c,b,d={};for(c=a.getCount()-1;c>=0;c--){b=a.getAt(c).get("iqn");if(true!==Ext.form.VTypes.iscsitrgiqn(b)){a.removeAt(c)}else{d[b]=(b in d)?d[b]+1:1}}for(c=a.getCount()-1;c>=0;c--){b=a.getAt(c).get("iqn");if(d[b]>1){a.removeAt(c);d[b]-=1}}},loadData:function(c,a){var b;c.acls.sort(function(e,d){if(e.iqn===SYNO.SDS.iSCSI.TARGET.DefaultIQN){return -1}else{if(d.iqn===SYNO.SDS.iSCSI.TARGET.DefaultIQN){return 1}else{return SYNO.SDS.iSCSI.Utils.stringNaturalSort(e.iqn,d.iqn)}}});this.oldData=[];for(b=0;b<c.acls.length;b++){this.oldData.push({iqn:c.acls[b].iqn,permission:c.acls[b].permission})}this.getStore().loadData(c,a)},isDirty:function(){var b=this.getStore();var c=[];var a;for(a=0;a<b.getCount();a++){c.push({iqn:b.getAt(a).get("iqn"),permission:b.getAt(a).get("permission")})}if(c.length!==this.oldData.length){return true}for(a=0;a<this.oldData.length;a++){if(this.oldData[a].iqn!==c[a].iqn||this.oldData[a].permission!==c[a].permission){return true}}return false},onCreate:function(){var a=this,c=a.getStore().recordType,b=new c({iqn:"",permission:"rw"});a.stopEditing();a.getStore().add(b);a.getView().refresh();a.editRow=a.getStore().getCount()-1;a.getColumnModel().setEditable(0,true);a.startEditing(a.editRow,0);a.disableAll()},onRemove:function(){var d=this,b=d.getSelectionModel().getSelections(),a=d.getStore(),c;for(c=0;c<b.length;c++){a.remove(b[c])}}});Ext.namespace("SYNO.SDS.iSCSI.Target");Ext.define("SYNO.SDS.iSCSI.Target.iSCSITarget",{check:SYNO.SDS.iSCSI.Utils.check,get:function(a){if(this.data){return this.data[a]}return undefined},isActing:function(){return false},isMappedToLUN:function(a){return(undefined!==this.get("mapped_luns").find(function(d,b,c){return d.lun_uuid===a}))}});Ext.define("SYNO.SDS.iSCSI.Target.Main",{extend:"SYNO.ux.Panel",constructor:function(a){this.appWin=a.appWin;this.owner=a.appWin;this.loaded=false;this.view=this.createView();this.callParent([this.fillConfig(a)])},fillConfig:function(a){var c=this,b;b={border:false,layout:"fit",itemId:"iscsi_target",tbar:c.toolbar=new Ext.Toolbar({defaultType:"syno_button",items:[{itemId:"create",text:_T("common","create"),handler:c.onCreate,scope:c},{itemId:"remove",text:_T("common","remove"),handler:c.onDelete,scope:c},{itemId:"action_menu",text:_T("common","action"),menu:[{itemId:"manage",text:_T("common","alt_edit"),handler:c.onEdit,scope:c},{tooltip:_S("demo_mode")?_JSLIBSTR("uicommon","error_demo"):"",itemId:"flip",text:_T("iscsitrg","iscsitrg_enable"),handler:c.onFlip,scope:c}]}]}),items:c.view,listeners:{activate:c.onActivate,data_ready:c.onDataReady,scope:c}};Ext.apply(b,a);return b},createView:function(){var e=this;var d=SYNO.SDS.iSCSI.PropertyTpl();var a=new SYNO.SDS.iSCSI.ListTpl({scope:"map",title:_T("iscsitrg","iscsitrg_mapped_lun"),emptyText:_T("iscsitrg","iscsitrg_mapped_no_luns"),columns:[{header:_T("volume","volume_disknumber"),dataIndex:"logical_unit_number"},{header:_T("common","name"),dataIndex:"name"},{header:_T("volume","volume_totalsize"),dataIndex:"capacity"}]});var f=new SYNO.SDS.iSCSI.ListTpl({scope:"mask",title:_T("iscsitrg","iscsitrg_masking"),columns:[{header:_T("iscsitrg","iscsitrg_initiator_iqn"),dataIndex:"iqn"},{header:_T("iscsitrg","iscsitrg_permission"),dataIndex:"permission"}]});var c,b;c=new Ext.XTemplate('<div class="item-detail-inner">',d.html,a.html,f.html,"</div>");b={appWin:e.appWin,owner:e,dataType:"iscsiTargets",itemId:"targetView",multiSelect:false,singleSelect:true,detailTpl:c,store:e.createTrgStore(),listeners:{selectionchange:e.onSelectChange,scope:e}};return new SYNO.SDS.iSCSI.DataView(b)},createTrgStore:function(){var a=["id","iconPic","iconCls","statusIconCls",{name:"displayName",sortType:"asNaturalUCString"},"summaryStatus","property","map","mask"];return new Ext.data.JsonStore({autoDestroy:true,idProperty:"id",fields:a,sortInfo:{field:"displayName",direction:"ASC"}})},prepareUiData:function(){var b=this,a=b.appWin.iscsiTargets.getAll();b.uiData=a.map(function(d){var c={};b.prepareSummary(d,c);b.prepareProperty(d,c);b.prepareMap(d,c);b.prepareMask(d,c);return c})},prepareSummary:function(b,a){a.status=b.get("status");a.id=b.get("target_id").toString();a.displayName=b.get("name");a.summaryStatus=String.format("&nbsp;-&nbsp;{0}",SYNO.SDS.iSCSI.Utils.TargetStatusRender(b.get("status"),-1));a.iconPic="iscsi-general-list-icon";a.iconCls="iscsi-list-icon-target";a.desc=b.get("iqn")},prepareProperty:function(f,d){var k=[_T("iscsitrg","iscsitrg_auth_none"),_T("iscsitrg","iscsitrg_auth_chap"),_T("iscsitrg","iscsitrg_auth_mutual_chap")],h=SYNO.SDS.iSCSI.Utils,b=f.get("status"),g,j=[],e,a,c;if("connected"===b){for(c=0;c<f.get("connected_sessions").length;++c){e=f.get("connected_sessions")[c].ip;a=f.get("connected_sessions")[c].iqn;j.push(String.format("{0}  ({1})",a,e))}g=String.format('<span class="blue-status" style="white-space:pre-warp">{0}</span>',j.join("<br/>"))}else{if("processing"===b||"creating"===b||"deleting"===b){g=h.TargetStatusRender(b,f.get("progress"));if(f.get("progress")>0){g=String.format("{0} {1}",g,h.PercentRender(f.get("progress")))}}else{g=h.TargetStatusRender(b,-1)}}d.property=[];if(this.isCinderTarget(f)){d.property.push({name:_T("iscsilun","user"),value:"Openstack Cinder"})}d.property.push({name:_T("common","name"),value:f.get("name")},{name:"IQN",value:f.get("iqn")},{name:_T("volume","volume_iscsitrg_status"),value:g},{name:_T("iscsitrg","iscsitrg_title_authen"),value:k[f.get("auth_type")]},{name:_T("iscsitrg","iscsitrg_multi_sessions"),value:(0===f.get("max_sessions"))?_T("iscsitrg","iscsitrg_enable"):_T("iscsitrg","iscsitrg_disable")},{name:_T("iscsitrg","iscsitrg_checksum_header"),value:f.get("has_header_checksum")?_T("iscsitrg","iscsitrg_enable"):_T("iscsitrg","iscsitrg_disable")},{name:_T("iscsitrg","iscsitrg_checksum_data"),value:f.get("has_data_checksum")?_T("iscsitrg","iscsitrg_enable"):_T("iscsitrg","iscsitrg_disable")},{name:_T("iscsitrg","iscsitrg_max_recv_segment"),value:f.get("max_recv_seg_bytes")+" "+_T("common","size_byte")},{name:_T("iscsitrg","iscsitrg_max_send_segment"),value:f.get("max_send_seg_bytes")+" "+_T("common","size_byte")})},prepareMap:function(d,c){var b=d.get("mapped_luns");var a=this.appWin.iscsiLuns;c.map=b.map(function(g,e){var f=a.getById(g.lun_uuid);return{logical_unit_number:g.mapping_index,name:f.get("name"),capacity:SYNO.SDS.iSCSI.Utils.SizeRender(f.get("size"))}})},prepareMask:function(c,b){var a=c.get("acls");a.sort(function(e,d){if(e.iqn===SYNO.SDS.iSCSI.TARGET.DefaultIQN){return -1}else{if(d.iqn===SYNO.SDS.iSCSI.TARGET.DefaultIQN){return 1}else{return SYNO.SDS.iSCSI.Utils.stringNaturalSort(e.iqn,d.iqn)}}});b.mask=a.map(function(d){return{iqn:SYNO.SDS.iSCSI.Utils.renderIQN(d.iqn),permission:SYNO.SDS.iSCSI.Utils.renderPermission(d.permission)}})},copyToClipboard:function(d){var c=document.createElement("textarea");var a=false;c.style.position="fixed";c.style.top="-999px";c.style.left="-999px";c.style.width="1px";c.style.height="1px";c.style.padding=0;c.style.border="none";c.style.outline="none";c.style.boxShadow="none";c.style.background="transparent";c.style.color="transparent";c.value=d;document.body.appendChild(c);c.select();try{if(document.queryCommandEnabled("copy")){a=document.execCommand("copy")}else{a=false}SYNO.Debug.debug("Copying text command was "+(a?"successful":"unsuccessful"))}catch(b){a=false;SYNO.Debug.debug("Oops, unable to copy")}document.body.removeChild(c);return a},onActivate:function(){var a=this;if(!a.loaded){a.appWin.setStatusBusy(null,null,50)}a.appWin.fireEvent("poll_activate")},onDataReady:function(){var c=this,a=c.view.store,b;if(!c.loaded){c.appWin.clearStatusBusy();c.loaded=true}c.prepareUiData();a.suspendEvents(true);a.loadData(c.uiData);a.resumeEvents();b=Ext.select(".syno-app-iscsi .target-copy-iqn");b.on("click",function(f,e){var d=e.dataset?e.dataset.iqn:e.getAttribute("data-iqn");var g=String.format(_T("iscsitrg","iscsitrg_iqn_copied"),d);c.appWin.getMsgBox().alert(_T("iscsitrg","iscsitrg_copy_iqn"),c.copyToClipboard(d)?g:_T("error","clip_failed"))});if(0<c.view.store.getCount()&&0===c.view.getSelectedItemIds().length){c.view.select(0,true,true)}c.onSelectChange();c.setMask()},onSelectChange:function(){var c=this;var e=c.view.getSelectedItem();var d=c.getTopToolbar().getComponent("action_menu");var a=d.menu.getComponent("manage");var b=d.menu.getComponent("flip");if(e){b.setText((e.get("is_enabled")&&"offline"!==e.get("status"))?_T("iscsitrg","iscsitrg_disable"):_T("iscsitrg","iscsitrg_enable"))}c.enableButton(c.getButton("create"),c.canCreate());c.enableButton(c.getButton("remove"),c.canDelete(e));c.enableButton(a,c.canManage(e));c.enableButton(b,c.canManage(e))},setMask:function(){if(this.isVisible()&&0===this.view.store.getCount()){this.body.mask(_T("iscsitrg","iscsitrg_no_iscsitrg"),"syno-ux-mask-info")}if(0<this.view.store.getCount()){this.body.unmask()}},canCreate:function(){if(this.appWin.isUpToTargetMaxCount()){return false}return true},canDelete:function(a){return !!a},canManage:function(a){return !!a},canFlip:function(a){return(!a.isActing()&&!_S("demo_mode"))},getButton:function(a){return this.getTopToolbar().getComponent(a)},enableButton:function(b,a){if(!b){throw Error("could not get button")}b.setDisabled(!a)},onCreate:function(){this.openWindow("WizardCreate",{})},onDelete:function(){var b=this,c=b.view.getSelectedItem(),a;if(!c){return}a=b.appWin.iscsiLuns.getMatched(function(){return c.isMappedToLUN(this.get("uuid"))});b.openWindow("Delete",{target:c,mapped_luns:a,isCinderTarget:b.isCinderTarget(c)})},onEdit:function(){var a=this.view.getSelectedItem();if(!a){return}this.openWindow("Edit",{target:a,isCinderTarget:this.isCinderTarget(a)})},onFlip:function(){var c=this,d=c.view.getSelectedItem(),b=d.get("is_enabled")&&"offline"!==d.get("status"),a=d.get("status"),e={target_id:d.get("target_id").toString()};if(a==="connected"){this.appWin.getMsgBox().confirm(this.title,_T("iscsitrg","iscsitrg_disconnect_warning"),function(f){if("yes"===f){this.doFlip(b,e)}},this)}else{this.doFlip(b,e)}},doFlip:function(b,e){var d=b?"disable":"enable";var c=this,a=this.owner;a.setStatusBusy({text:_T("common","saving")});this.sendWebAPI({api:"SYNO.Core.ISCSI.Target",method:d,version:1,params:e,callback:function(g,f){a.clearStatusBusy();if(!g){SYNO.SDS.iSCSI.Utils.ReportWebapiFailure(a,f);return}SYNO.SDS.StatusNotifier.setServiceDisabled("SYNO.SDS.StorageManager.ISCSI",b);a.setStatusBusy();c.loaded=false;a.fireEvent("poll_activate")}})},openWindow:function(b,a){var c=this;var d=new SYNO.SDS.iSCSI.Target[b](Ext.apply({appWin:c.appWin,owner:c.owner},a));c.mon(d,"close",function(){if(Ext.isFunction(d.hideFromOwner)){d.hideFromOwner()}if(d.isDataChanged){c.owner.setStatusBusy();c.loaded=false;c.appWin.fireEvent("poll_activate")}},c,{single:true});d.open()},isCinderTarget:function(d){var c=d.get("mapped_luns");var b=this.appWin.iscsiLuns;var a=c.some(function(e){return b.getById(e.lun_uuid).isLunOwnedByCinder()});return a}});Ext.define("SYNO.SDS.iSCSI.LUN.Wizard.LunTypeBoxTmpl",{extend:"Ext.XTemplate",constructor:function(a){var b=this.createTpl();this.no_subtitle=a.no_subtitle||false;b.push(this.fillConfig(a));this.callParent(b)},fillConfig:function(a){var b={compiled:true,disableFormats:true},c={btrfs:{title:_T("iscsimgr","btrfs_lun"),subtitle:_T("iscsimgr","btrfs_lun_subtitle"),desc:_T("iscsimgr","btrfs_lun_desc")},file:{title:_T("iscsimgr","file_lun"),subtitle:_T("iscsimgr","ext4_lun_subtitle"),desc:_T("iscsimgr","file_lun_desc")},block:{title:_T("iscsimgr","block_lun"),subtitle:_T("iscsimgr","block_lun_subtitle"),desc:_T("iscsimgr","block_lun_desc")}};b.getTitle=function(d){return c[d].title};b.getSubTitle=function(d){if(this.no_subtitle){return""}return c[d].subtitle};b.getDesc=function(d){return c[d].desc};return Ext.apply(b,a)},createTpl:function(){return['<tpl if="canCreate === true">','<div class="iscsi-lun-typebox iscsi-lun-typebox-{clickType} iscsi-grid-row">',"</tpl>",'<tpl if="canCreate === false">','<div class="iscsi-lun-typebox-disable iscsi-grid-row">','<div class="lun-disable-overlap">','<div class="lun-disable-tip">',String.format(_T("iscsimgr","lun_create_tip"),'<a class="link-font" style="cursor:pointer">',"</a>"),"</div>","</div>","</tpl>",'<div class="item-icon-wrap">','<tpl if="canCreate === true">','<div class="item-icon iscsi-lun-icon-wizard iscsi-lun-icon-wizard-{type}"></div>',"</tpl>",'<tpl if="canCreate === false">','<div class="item-icon iscsi-lun-icon-wizard iscsi-lun-icon-wizard-disable"></div>',"</tpl>","</div>",'<div class="lun-title">','<p class="title">{[ this.getTitle(values.type) ]}<span class="sub-title">{[ this.getSubTitle(values.type) ]}</span></p>',"</div>",'<div class="lun-desc-wrap">','<div class="lun-desc">{[ this.getDesc(values.type) ]}</div>',"</div>",'<div class="x-clear"></div>',"<div>"]}});Ext.define("SYNO.SDS.iSCSI.LUN.Wizard.LunTypeBox",{extend:"SYNO.ux.Panel",constructor:function(a){this.type=a.type;this.hidden=a.hidden||false;this.can_create=a.can_create||true;this.callParent([this.fillConfig(a)])},fillConfig:function(a){this.tpl=new SYNO.SDS.iSCSI.LUN.Wizard.LunTypeBoxTmpl(a);var b={hidden:this.hidden,items:[{itemId:"lunBox",xtype:"box",html:""}],listeners:{scope:this,afterrender:this.onAfterRender,update:this.updateTpl}};Ext.apply(b,a);return b},onAfterRender:function(){if(this.can_create){this.mon(this.body,"click",this.onMouseClick,this)}},updateTpl:function(){this.tpl.overwrite(this.getComponent("lunBox").getEl(),{type:this.type,clickType:this.owner.lunType===this.type?"click":"unclick",canCreate:this.can_create});var a=this.getComponent("lunBox").getEl().query("a");if(a.length>0){var b=Ext.get(a[0]);var c=function(){SYNO.SDS.AppLaunch("SYNO.SDS.StorageManager.Instance",{fn:("block"===this.type?"SYNO.SDS.StorageManager.Pool.Main":"SYNO.SDS.StorageManager.Volume.Main")})};this.mon(b,"click",c,this)}},onMouseClick:function(){this.owner.typeSelect(this.type)}});Ext.define("SYNO.SDS.iSCSI.LUN.Wizard.LunTypeStep",{extend:"SYNO.ux.FormPanel",title:_T("iscsilun","iscsilun_choose_lun_title"),constructor:function(a){var c=this,b;c.loaded=false;c.appWin=a.appWin;c.isAfterCreateTarget=a.isAfterCreateTarget;c.canCreateTarget=a.canCreateTarget;c.canCreate=a.canCreate||{};c.lunType="null";c.supportBtrfsLun=this.appWin.supportBtrfsLun;this.clickedBox="host";b=c.configForm(a);c.callParent([Ext.apply(b,a)])},configForm:function(a){var c={owner:this,appWin:a.appWin,flex:1};this.lunBoxs=[new SYNO.SDS.iSCSI.LUN.Wizard.LunTypeBox(Ext.apply({type:"btrfs",can_create:this.canCreate.hasOwnProperty("btrfs_lun"),hidden:!this.supportBtrfsLun},c)),new SYNO.SDS.iSCSI.LUN.Wizard.LunTypeBox(Ext.apply({type:"file",can_create:this.canCreate.hasOwnProperty("file_lun"),no_subtitle:!this.supportBtrfsLun},c)),new SYNO.SDS.iSCSI.LUN.Wizard.LunTypeBox(Ext.apply({type:"block",can_create:this.canCreate.hasOwnProperty("block_lun"),hidden:("yes"===_D("support_iscsi_target_block"))?false:true},c))];var b={cls:"syno-app-iscsi",headline:this.title,items:this.lunBoxs};return b},typeSelect:function(a){this.lunType=a;this.lunBoxs.each(function(b){b.updateTpl()})},getType:function(){return this.lunType},activate:function(){if(this.loaded){return}this.lunBoxs.each(function(a){a.updateTpl()});this.loaded=true},getNext:function(){var a=this.lunType;if("btrfs"===a){return this.nextId.btrfs}else{if("block"===a){return this.nextId.block}else{if("file"===a){return this.nextId.file}else{this.owner.getMsgBox().alert(this.title,_T("iscsimgr","choose_lun_type_alert"));return false}}}},summary:function(a){if(!this.isAfterCreateTarget){a.append(_T("volume","volume_space"),_T("volume","volume_iscsitrg_lun"))}}});Ext.define("SYNO.SDS.iSCSI.LUN.Property",{extend:"SYNO.ux.FormPanel",constructor:function(h){var i=this,e,f,l,c,g,a,b,j,k,m;var d=[[false,_T("common","no")],[true,_T("common","yes")]];i.vol_type_of_lun=h.vol_type_of_lun||"all";i.selectedVolumeType="";i.appWin=h.appWin;i.owner=h.owner;i.mode=h.mode||"edit";i.lunType=h.lunType||"file";i.lun=null;i.isExtentBased=i.appWin.supportVAAI;i.volumes=i.appWin.volumes;i.maxExpandSizeGB=0;b={title:_T("common","properties"),trackResetOnLoad:true,labelWidth:230,fieldWidth:330,items:[{xtype:"syno_textfield",fieldLabel:_T("common","name"),vtype:"iscsilunname",maxlength:128,allowBlank:false,name:"name",validator:function(n){if(this.ownerCt.mode!=="convert"&&n===this.originalValue){return true}else{if(i.appWin.isUniqueLunName(n)){return true}else{return _T("iscsitrg","iscsitrg_lun_name_exists")}}}}]};e={xtype:i.mode==="edit"?"syno_lun_displayfield":"syno_storage_combobox",fieldLabel:_T("volume","volume_raid_location"),name:"location",hiddenName:"location",itemId:"location",forceSelection:true,displayField:"name",descriptionField:"desc",valueField:"path",allowBlank:false,editable:false,store:this.vol_store=new Ext.data.JsonStore({autoDestroy:true,idProperty:"path",fields:["id",{name:"name",sortType:"asNaturalUCString"},"size_total","size_free","fs_type","raid_type","numId","desc","path"],listeners:{load:function(n,o){n.sort("name","ASC")},scope:this}}),validator:function(o){if(!this.ownerCt.lun){return true}if(this.getValue()===""){return true}var n=this.store.getById(this.getValue());if(n){if(this.ownerCt.lun.get("allocated_size")<=n.data.size_free){return true}}return _T("iscsimgr","err_no_space")},listeners:{select:function(r,p){i.selectedVolumeType=p.get("fs_type");if(this.xtype==="syno_lun_displayfield"){this.setValue(p.data.name);return}i.maxExpandSizeGB=SYNO.SDS.iSCSI.Utils.GetSizeGB(p.get("size_free"),0);if("clone"===i.mode||"convert"===i.mode){i.getComponent("thin_provision").setValue(i.lun.isThinProvisioningLun());i.lunType="btrfs"===i.selectedVolumeType?"btrfs":"file"}if("pool"===i.vol_type_of_lun||"block"===i.lunType){var x=this.ownerCt.getComponent("size_panel");if("create"===i.mode){x.get("size").setValue(i.maxExpandSizeGB)}if(p.get("raid_type")==="Single"){x.get("size").disable();x.get("size_max").disable()}else{x.get("size").enable();x.get("size_max").enable()}return}this.ownerCt.getForm().isValid();var u=i.getComponent("thin_provision").getValue();i.getComponent("thin_provision").enable();i.getComponent("thin_provision").fireEvent("select",i.getComponent("thin_provision"),i.thin_provision_store.getAt(u?1:0),0);var q=i.getComponent("extent_based");var w=q.getComponent("adv_write_same"),t=q.getComponent("adv_caw"),v=q.getComponent("adv_xcopy"),n=q.getComponent("adv_snapshot"),o=q.getComponent("adv_unmap"),y=q.getComponent("adv_legacy");if("btrfs"===i.selectedVolumeType){w.show();t.show();v.show();n.show();o.show();y.hide()}else{if(i.isExtentBased&&"ext4"===i.selectedVolumeType){w.hide();t.hide();v.hide();n.hide();o.show();y.show()}}if("clone"===i.mode&&!i.lun.isBtrfsLun()){var s=[];if("btrfs"===i.selectedVolumeType){s.push(_T("iscsimgr","lun_adv_feature_write_same"));s.push(_T("iscsimgr","lun_adv_feature_acw"));if(i.lun.isThinProvisioningLun()){s.push(_T("iscsimgr","lun_adv_feature_xcopy"));s.push(_T("iscsilun","snapshot"))}if(i.lun.isEnableUnmap()){s.push(_T("iscsimgr","unmap_command"))}i.getForm().setValues({extent_based_display_only:s.join(", ")})}else{i.getForm().setValues({extent_based_display_only:i.lun.getAdvFeatureDesc()})}}}}};f={indent:0,xtype:"panel",layout:"hbox",itemId:"size_panel",width:330,fieldLabel:String.format("{0} ({1})",_T("common","size"),_T("common","size_gb")),items:[{xtype:"syno_lun_displayfield",fieldLabel:String.format("{0} ({1})",_T("volume","volume_totalsize"),_T("common","size_gb")),name:"size",itemId:"size",width:200}]};l={xtype:(i.mode==="clone"||i.mode==="convert")?"syno_lun_displayfield":"syno_numberfield",fieldLabel:String.format("{0} ({1})",_T("volume","volume_totalsize"),_T("common","size_gb")),name:"size",itemId:"size",value:1,allowBlank:false,minValue:1,validator:function(v){var p;if(this.ownerCt){p=this.ownerCt}else{return"Failed to find ownerCt"}var s=p.get("thin_provision").getValue();var o=p.get("location").getValue();var n=false;var u="ext4"===i.selectedVolumeType&&p.getComponent("extent_based").getComponent("adv_legacy").getValue();var q=u?10:1;if("create"===p.mode&&v<q){return true}if(v<this.originalValue||v<q){return _T("iscsitrg","iscsitrg_size_too_small")}if(s){if(v>1000*1024){return String.format(_T("volume","volume_exceed_max_size_msg"),String.format("{0} GB",1000*1024))}if(u){var t=SYNO.SDS.Utils.StorageUtils.ISCSIVAAILUN_EP_SIZE(v*1024*1024*1024);var r=SYNO.SDS.iSCSI.Utils.GetSizeGB(t,0);if(r>i.maxExpandSizeGB){return _T("iscsitrg","iscsitrg_set_failed_space_not_enough")}}i.thinprovisioningWarning=true;return true}else{i.thinprovisioningWarning=false}n=p.get("location").originalValue!==o;if(v-(n?0:this.originalValue)>i.maxExpandSizeGB){return _T("iscsitrg","iscsitrg_set_failed_space_not_enough")}return true}};c={xtype:i.mode==="create"?"syno_combobox":"syno_lun_displayfield",fieldLabel:_T("iscsimgr","space_allocation_type"),name:"thin_provision",hiddenName:"thin_provision",itemId:"thin_provision",editable:false,forceSelection:true,allowBlank:("pool"===i.vol_type_of_lun),disabled:true,value:false,tpl:'<tpl for="."><div ext:qtip="{display}" class="x-combo-list-item" role="option" aria-label="{'+this.displayField+'}" id="{[Ext.id()]}">{display}</div></tpl>',hidden:("pool"===i.vol_type_of_lun),store:this.thin_provision_store=new Ext.data.ArrayStore({autoDestroy:true,fields:["value","display"],data:[[false,i.mode==="create"?_T("iscsimgr","iscsitrg_thick_provisioning_option"):_T("iscsimgr","iscsitrg_thick_provisioning")],[true,i.mode==="create"?_T("iscsimgr","iscsitrg_thin_provisioning_option"):_T("iscsitrg","iscsitrg_thin_provisioning")]]}),valueField:"value",displayField:"display",listeners:{select:function(q,r,o){if(!i.isExtentBased){return}var u=r.data.value;if(this.xtype==="syno_lun_displayfield"){this.setValue(u)}var s=this.ownerCt.getComponent("extent_based");var w=s.getComponent("adv_write_same"),t=s.getComponent("adv_caw"),v=s.getComponent("adv_xcopy"),n=s.getComponent("adv_snapshot"),p=s.getComponent("adv_unmap"),x=s.getComponent("adv_legacy");if("btrfs"===i.selectedVolumeType){if(u){w.enable();t.enable();v.enable();n.enable();p.enable();w.setValue(true);t.setValue(true);v.setValue(true);n.setValue(true);p.setValue(false)}else{w.enable();t.enable();w.setValue(true);t.setValue(true);v.disable();n.disable();p.disable();v.setValue(false);n.setValue(false);p.setValue(false)}}else{if(this.ownerCt.getComponent("size").xtype!=="syno_lun_displayfield"){this.ownerCt.getComponent("size").setMinValue(u?10:1)}if(u){x.enable()}else{x.disable()}x.setValue(false);x.fireEvent("check",x,0);p.disable();p.setValue(false);if(!u){t.setValue(true)}}}}};g={xtype:"syno_fieldset",itemId:"extent_based",name:"extent_based",collapsible:true,collapsed:true,headerCfg:{collapseFirst:false},hidden:!i.isExtentBased||i.mode!=="create",disabled:i.mode!=="create",width:600,title:String.format("<span style=font-size:12px;line-height:28px;color:#505A64;!important>{0}</span>",_T("iscsitrg","iscsitrg_vaai")),items:[{xtype:"syno_checkbox",name:"adv_write_same",itemId:"adv_write_same",boxLabel:_T("iscsimgr","lun_adv_feature_write_same"),hidden:true,value:false,store:d,isDirty:function(){return false}},{xtype:"syno_checkbox",name:"adv_caw",itemId:"adv_caw",boxLabel:_T("iscsimgr","lun_adv_feature_acw"),hidden:true,value:false,store:d,isDirty:function(){return false}},{xtype:"syno_checkbox",name:"adv_xcopy",itemId:"adv_xcopy",boxLabel:_T("iscsimgr","lun_adv_feature_xcopy"),hidden:true,value:false,store:d,isDirty:function(){return false}},{xtype:"syno_checkbox",name:"adv_snapshot",itemId:"adv_snapshot",boxLabel:_T("iscsilun","snapshot"),hidden:true,value:false,store:d,isDirty:function(){return false}},{xtype:"syno_checkbox",name:"adv_legacy",itemId:"adv_legacy",boxLabel:_T("iscsimgr","lun_adv_feature_legacy"),hidden:true,value:false,store:d,listeners:{check:function(o,n){var p=n?10:1;var q=this.ownerCt.ownerCt.getComponent("size");if(q.getValue()<p){q.setValue(p)}if(q.xtype!=="syno_lun_displayfield"){q.setMinValue(p)}this.ownerCt.getComponent("adv_write_same").setValue(n);this.ownerCt.getComponent("adv_caw").setValue(n);this.ownerCt.getComponent("adv_xcopy").setValue(n);this.ownerCt.getComponent("adv_snapshot").setValue(n);if(n){this.ownerCt.getComponent("adv_unmap").enable()}else{this.ownerCt.getComponent("adv_unmap").disable()}this.ownerCt.getComponent("adv_unmap").setValue(false)}},isDirty:function(){return false}},{xtype:"syno_checkbox",name:"adv_unmap",itemId:"adv_unmap",boxLabel:_T("iscsimgr","unmap_command"),hidden:true,value:false,store:d,isDirty:function(){return false}}]};a={xtype:"syno_displayfield",itemId:"extent_based_display_only",name:"extent_based_display_only",hidden:!this.isExtentBased||i.appWin.isSDRRunning||"create"===i.mode,fieldLabel:_T("iscsitrg","iscsitrg_vaai"),value:""};m=String.format(_T("iscsitrg","iscsitrg_use_vaai_or_not_description"),'<a class="link-font" href="">',"</a>");j={xtype:"syno_panel",padding:"0px 10px 14px 0px",hidden:!this.isExtentBased||i.appWin.isSDRRunning||"create"!==i.mode,items:[{cls:"iscsi-retention-descpanel",xtype:"syno_displayfield",htmlEncode:false,value:m,listeners:{afterrender:function(o){var n=o.el.first("a");if(n){this.mon(n,"click",function(p){p.preventDefault();SYNO.SDS.AppLaunch("SYNO.SDS.HelpBrowser.Application",{topic:"SYNO.SDS.iSCSI.Application:iSCSIManager/lun.html",anchor:"terminologies_advanced_features"},false)})}}}}]};k={xtype:"syno_checkbox",itemId:"delete_orig_lun_after_convert",name:"delete_orig_lun_after_convert",boxLabel:_T("iscsimgr","iscsilun_convert_delete_orig_check"),checked:(i.mode==="convert")};b.items.push(e);if("block"===i.lunType){b.items.splice(1,0,f)}else{if(i.mode==="edit"){b.items.splice(1,0,l)}else{b.items.push(l)}b.items.push(c);b.items.push(g);b.items.push(a);if(i.mode==="convert"){b.items.push({xtype:"tbspacer",height:16});b.items.push(k)}b.bbar=j}i.callParent([Ext.apply(b,h)])},getField:function(a){return this.getForm().findField(a)},loadLunData:function(k){var f=this,g=SYNO.SDS.iSCSI.Utils,a=f.getForm(),h=k.get("location"),e=null,l,d="";f.lun=k;if(this.lunType==="block"){var j=this.appWin.pools;for(var c=0;c<j.length;c++){if(-1<h.search(j[c].space_path)){if("single"===j[c].raidType){f.getField("location").disable();f.getField("size").disable();f.getField("size").setValue(g.GetSizeGB(k.get("size"),0))}else{e=j[c].space_path}break}}l=e?e:k.get("location")}else{l=k.get("location")}if(f.mode==="convert"){d=k.getDefaultAdvFeatureDesc();if(k.isEnableUnmap()){d+=", "+_T("iscsimgr","unmap_command")}}else{d=k.getAdvFeatureDesc()}a.setValues({name:k.get("name"),location:l,size:g.GetSizeGB(k.get("size"),0),extent_based_display_only:d});var b=this.vol_store.getById(l);if(b){a.findField("location").fireEvent("select",a.findField("location"),b);this.maxExpandSizeGB=SYNO.SDS.iSCSI.Utils.GetSizeGB(b.get("size_free"),0)}else{a.findField("location").resetValue()}if(this.lunType==="block"){this.maxExpandSizeGB+=g.GetSizeGB(k.get("size"),0)}else{if(b){a.findField("thin_provision").fireEvent("select",a.findField("thin_provision"),this.thin_provision_store.getAt(k.isThinProvisioningLun()?1:0),0)}}if(k.isSinkLun()){f.getField("size").disable()}a.clearInvalid()},addTip:function(){SYNO.SDS.Utils.AddTip(this.getForm().findField("thin_provision").getEl(),_T("iscsitrg","iscsitrg_thin_provisioning_notify"),false)},addForceChangeVolTip:function(a){SYNO.SDS.Utils.AddTip(this.getForm().findField("location").getEl(),a)},loadPools:function(){var d=this,b=[],c,a=SYNO.SDS.iSCSI.Utils;c=d.appWin.pools;c.each(function(f){var g=parseInt(f.size.used,10);var h=parseInt(f.size.total,10);var i=""===f.desc?"&nbsp":Ext.util.Format.htmlEncode(f.desc);var e=("single"===f.raidType&&-1!=f.device_type.search("shr"));if(!e&&(d.mode==="edit"||SYNO.SDS.iSCSI.Utils.ISCSITRG_UNIT_GB<(h-g))){b.push({id:f.id,name:String.format("{0} ({1}: {2})",a.SpaceIDParser(f.id).str,_T("volume","volume_freesize"),a.SizeRender(h-g)),desc:i,size_total:h,size_free:h-g,raid_type:"single"===f.raidType?"Single":"Multiple",path:f.space_path})}});this.vol_store.loadData(b,false)},loadVolumes:function(g){var f,j,c,a=[];var h=SYNO.SDS.iSCSI.Utils;var b;if(g===undefined){g=this.volumes}var e,d;for(b=0;b<g.length;b++){d=parseInt(g[b].size_free_byte,10);f=parseInt(g[b].size_total_byte,10);j=g[b].fs_type;e=parseInt(g[b].volume_id,10);c=String.format("{0}",Ext.util.Format.htmlEncode(g[b].description));if(this.vol_type_of_lun!=="all"&&this.vol_type_of_lun!==j){continue}if(this.mode!=="clone"&&this.mode!=="edit"&&0>=h.GetSizeGB(d,0)){continue}if(this.mode!=="clone"&&this.mode!=="edit"&&"crashed"===g[b].status){continue}if(this.mode!=="clone"&&this.mode!=="edit"&&"deleting"===g[b].status){continue}a.push({id:g[b].volume_id,name:String.format("{0} ({1}: {2} {3}) - {4}",g[b].display_name,_T("volume","volume_freesize"),h.GetSizeGB(d,0),_T("common","size_gb"),j),size_total:f,size_free:d,fs_type:j,numId:e,desc:c,path:g[b].volume_path})}this.vol_store.loadData(a,false);if(0>=this.vol_store.getCount()){SYNO.Debug("no volume can create iSCSI LUN")}},isExt4orBtrfsVolume:function(b){var a=(("ext4"===b||"btrfs"===b)?true:false);return a}});Ext.define("SYNO.SDS.iSCSI.LUN.Wizard.PropertyStep",{extend:"SYNO.SDS.iSCSI.LUN.Property",isAfterCreateTarget:false,canCreateTarget:false,volumes:null,constructor:function(a){var c=this,b;c.appWin=a.appWin;c.owner=a.owner;c.mode=a.mode;c.lun=a.lun;c.avail_dst_locations=a.avail_dst_locations;b={isAfterCreateTarget:a.isAfterCreateTarget,headline:_T("volume","volume_set_iscsitrg_property_title")};c.callParent([Ext.apply(b,a)])},getProps:function(){var a=this.getForm().getValues();a.volumeType=this.selectedVolumeType;return a},activate:function(){var e=this,d=this.getForm();if(this.loaded){return}this.loaded=true;d.findField("name").setValue(this.appWin.genNewLunName());if(this.vol_type_of_lun=="pool"){this.loadPools();d.findField("location").setValue(this.vol_store.getAt(0).get("path"));d.findField("location").fireEvent("select",d.findField("location"),this.vol_store.getAt(0),0)}else{if(this.mode=="convert"){e.loadVolumes(e.avail_dst_locations);e.loadLunData(e.lun);var b=d.findField("name");b.setValue(String.format("{0}-New",b.getValue()));var f=e.avail_dst_locations.find(function(g){return g.volume_path===e.lun.get("location")});if(!f){var a=e.lun.space.fs_type==="ext4"?Ext.util.Format.htmlEncode(_T("iscsimgr","iscsilun_convert_change_vol_note_ext4")):Ext.util.Format.htmlEncode(_T("iscsimgr","iscsilun_convert_change_vol_note_btrfs"));this.addForceChangeVolTip(a)}}else{this.addTip()}this.loadVolumes();d.findField("location").setValue(this.vol_store.getAt(0).get("path"));d.findField("location").fireEvent("select",d.findField("location"),this.vol_store.getAt(0),0);if(this.mode=="convert"){var c=this.getComponent("extent_based");c.getComponent("adv_unmap").setValue(e.lun.isEnableUnmap())}}},getNext:function(){var c=this;var d;var a=SYNO.SDS.iSCSI.Utils;if(!c.getForm().isValid()){return false}if(true===c.thinprovisioningWarning){var b=this.vol_store.getById(this.getProps().location).get("size_free");var e=this.getProps().size*SYNO.SDS.iSCSI.Utils.ISCSITRG_UNIT_GB;if(e>b){d=String.format(_T("iscsitrg","iscsitrg_thin_provisioning_warning"),a.SizeRender(e),a.SizeRender(b),a.volumePathRenderer(this.getProps().location));c.owner.getMsgBox().confirm(c.owner.title,d,function(f){if("yes"===f){c.owner.goNext(c.nextId)}})}else{c.owner.goNext(c.nextId)}}else{return c.nextId}return false},summary:function(f){var i=this.getProps();var g=this.getForm().findField("thin_provision").getValue();var c=this.vol_store.getById(i.location).get("name");var m=this.getForm().findField("delete_orig_lun_after_convert");var n=m?m.getValue():false;var l=this.isAfterCreateTarget?function(o,p){f.appendSub(o,p)}:function(o,p){f.append(o,p)};var a="true"===i.adv_write_same;var d="true"===i.adv_caw;var k="true"===i.adv_xcopy;var b="true"===i.adv_unmap;var e="true"===i.adv_snapshot;var j="true"===i.adv_legacy;if(this.isAfterCreateTarget){f.append(_T("iscsitrg","iscsitrg_mapped_lun"),String.format("{0} ({1})",i.name,_T("common","create")))}else{l(_T("iscsimgr","lun_name"),i.name)}l(_T("volume","volume_raid_location"),c);l(_T("volume","volume_totalsize"),String.format("{0} ({1})",i.size||this.maxExpandSizeGB,_T("common","size_gb")));l(_T("iscsimgr","space_allocation_type"),g?_T("iscsitrg","iscsitrg_thin_provisioning"):_T("iscsimgr","iscsitrg_thick_provisioning"));if(this.appWin.supportVAAI){if("btrfs"==i.volumeType){l(_T("iscsimgr","lun_adv_feature_write_same"),a?_T("common","yes"):_T("common","no"));l(_T("iscsimgr","lun_adv_feature_acw"),d?_T("common","yes"):_T("common","no"));l(_T("iscsimgr","lun_adv_feature_xcopy"),k?_T("common","yes"):(g?_T("common","no"):_T("common","not_support")));l(_T("iscsilun","snapshot"),e?_T("common","yes"):(g?_T("common","no"):_T("common","not_support")));l(_T("iscsimgr","unmap_command"),b?_T("common","yes"):(g?_T("common","no"):_T("common","not_support")))}else{var h=g?_T("common","no"):_T("common","not_support");if(j){h=_T("iscsimgr","lun_adv_feature_legacy");h+=" "+(b?_T("iscsimgr","unmap_yes_desc"):_T("iscsimgr","unmap_no_desc"))}l(_T("iscsitrg","iscsitrg_vaai"),h)}}if(n){l(_T("pkgmgr","other_information"),_T("iscsimgr","iscsilun_convert_delete_orig_check"))}}});Ext.define("SYNO.SDS.iSCSI.LUN.Wizard.MappingStep",{extend:"Ext.form.FormPanel",luns:null,constructor:function(a){var c=this,b;c.appWin=a.appWin;c.canCreateTarget=a.canCreateTarget||false;c.canMapTarget=false;c.target_create_radio=new SYNO.ux.Radio({boxLabel:_T("iscsitrg","iscsitrg_target_create"),name:"target_source",inputValue:"create",checked:c.canCreateTarget,disabled:!c.canCreateTarget});c.mapped_target_radio=new SYNO.ux.Radio({boxLabel:_T("iscsitrg","iscsitrg_map_existent_target"),name:"target_source",itemId:"mapped_target_radio",inputValue:"exists",checked:false,disabled:true,listeners:{check:function(e,d){if(d){this.ownerCt.getComponent("mapped_target").enable()}else{this.ownerCt.getComponent("mapped_target").disable()}}}});c.none_target_radio=new SYNO.ux.Radio({boxLabel:_T("iscsimgr","no_map_lun_desc"),name:"target_source",htmlEncode:false,inputValue:"none"});b={headline:_T("volume","volume_set_iscsitrg_lun_mapping"),items:[{xtype:"syno_displayfield",htmlEncode:false,style:"margin-bottom:8px",value:_T("iscsimgr","lun_mapping_step_subtitle")},c.target_create_radio,{xtype:"syno_displayfield",htmlEncode:false,indent:1,style:"margin-bottom:8px",value:_T("iscsimgr","target_create_desc")},c.mapped_target_radio,{xtype:"syno_displayfield",htmlEncode:false,indent:1,value:_T("iscsimgr","map_exist_target_desc")},{xtype:"syno_combobox",name:"mapped_target",hiddenName:"mapped_target",itemId:"mapped_target",tpl:'<tpl for="."><div ext:qtip="{name}" class="x-combo-list-item">{name}</div></tpl>',displayField:"name",style:"margin-bottom:8px",forceSelection:true,hideLabel:true,editable:false,disabled:true,indent:1,width:250,store:c.target_store=new Ext.data.JsonStore({autoDestroy:true,idProperty:"name",fields:["target_id",{name:"name",sortType:"asNaturalUCString"}],listeners:{load:function(d,e){d.sort("name","ASC");this.onLoad(e)},scope:this}})},c.none_target_radio]};c.callParent([Ext.apply(b,a)])},getSource:function(){return this.getForm().getValues().target_source},getTargetId:function(){var a=this.getForm().getValues().mapped_target;return this.target_store.getById(a).get("target_id")},activate:function(){var a=this;this.sendWebAPI({api:"SYNO.Core.ISCSI.Target",version:1,method:"list",params:{additional:["mapped_lun"]},callback:function(c,b){a.target_store.loadData(b.targets.filter(function(d){return(0===d.mapped_luns.length)}))}})},onLoad:function(a){this.canMapTarget=(undefined!==a&&0<a.length);if(this.canMapTarget){if(this.canCreateTarget){this.mapped_target_radio.enable()}else{this.getComponent("mapped_target").enable();this.mapped_target_radio.enable();this.mapped_target_radio.setValue(true)}this.getForm().setValues({mapped_target:a[0].id})}else{if(!this.canCreateTarget){this.none_target_radio.setValue(true)}}},getNext:function(){if(!this.getForm().isValid()){return false}return this.nextId[this.getSource()]},summary:function(b){var a=this.getSource();if(a==="create"){return}if(a=="none"){b.append(_T("iscsimgr","mapped_target"),_T("system","none_opt"))}else{if(a=="exists"){b.append(_T("iscsimgr","mapped_target"),this.getForm().getValues().mapped_target.toString())}}}});Ext.define("SYNO.SDS.iSCSI.LUN.Wizard.CreateSummaryStep",{extend:"SYNO.SDS.Wizard.SummaryStep",constructor:function(b){var a=Ext.apply({headline:_T("ezinternet","ezinternet_summary_title"),description:_T("wizcommon","summary_descr"),viewConfig:{forceFit:false},columns:[{width:200,header:_T("status","header_item"),dataIndex:"key",renderer:this.fieldRenderer},{id:"value",autoExpand:true,header:_T("status","header_value"),dataIndex:"value",renderer:this.descRenderer,scope:this}],enableHdMenu:false,enableColumnMove:false,autoExpandColumn:"value",store:new SYNO.SDS.Wizard.SummaryStore()},b);SYNO.SDS.Wizard.SummaryStep.superclass.constructor.call(this,a)},getNext:function(){this.owner.applySettings(null);return false},descRenderer:function(e,b,a,g,d,c){var f=e.toString().replace(/<.*?>/g,"");b.attr='ext:qtip="'+f+'"';return e},disableNextInDemoMode:true});Ext.define("SYNO.SDS.iSCSI.LUN.FeasibilityCheck",{extend:"SYNO.SDS.ModalWindow",constructor:function(a){var c=this,b;if(a.hasOwnProperty("params")){c.parentParams=a.params}b={title:c.title,width:640,height:350,resizable:false,layout:"fit",items:[{xtype:"syno_formpanel",itemId:"main",border:false,items:[{xtype:"syno_displayfield",value:"",id:c.descID=Ext.id(),itemId:"desc"},c.grid=new SYNO.SDS.Wizard.SummaryStep({layout:"fit",height:200})]}],buttons:[{xtype:"syno_button",text:_T("common","cancel"),scope:c,handler:c.onCancel},{xtype:"syno_button",btnStyle:"red",text:_T("common","yes"),id:c.applyButtonID=Ext.id(),scope:c,handler:c.onConfirm}]};c.callParent([Ext.apply(b,a)])},onOpen:function(){var h=this;var f=h.grid.getStore();var g=false,c=false;var a="";var d=h.feasCheckMsg;var e="";if(h.feasCheckMsg.hasOwnProperty("feasibility_soft")){g=true;a="feasibility_soft"}else{if(h.feasCheckMsg.hasOwnProperty("feasibility_hard")){c=true;a="feasibility_hard"}}if(h.hasOwnProperty("srcLun")&&""!==h.srcLun.name){e=h.srcLun.name;d.objType="lun"}else{if(h.hasOwnProperty("target")&&""!==h.target.name){e=h.target.name;d.objType="target"}}var b={};b.name=e;b.check_message=d[a];d[a]=[b];h.callParent(arguments);h.setStatusBusy({text:_T("common","loading")});if(true===c){Ext.getCmp(h.applyButtonID).disable();Ext.getCmp(h.descID).setValue(_T("volume","del_hard_check_fail"))}else{if(true===g){Ext.getCmp(h.descID).setValue(_T("share","edit_soft_check_fail"))}else{h.clearStatusBusy();return}}SYNO.SDS.iSCSI.Utils.fillGridByFeasMsg(d,f);h.clearStatusBusy()},onCancel:function(){Ext.getCmp(this.parentNextBtnID).enable();this.close()},onConfirm:function(){var a={};if(this.hasOwnProperty("parentParams")){Ext.getCmp(this.parentWizardID).contFromSoftFeasCheck(this.parentParams)}else{Ext.getCmp(this.parentWizardID).contFromSoftFeasCheck(a)}this.close()}});SYNO.SDS.iSCSI.LUN.GeneralFeasChkFailCallback=function(b,h,g,e,d,c){var a="none";if(b.hasOwnProperty("feasibility_soft")){a="soft_failed"}else{if(b.hasOwnProperty("feasibility_hard")){a="hard_failed"}else{return}}var f=new SYNO.SDS.iSCSI.LUN.FeasibilityCheck({appWin:d.appWin,owner:d,title:"",parentParams:h,parentWizardID:d.getId(),parentNextBtnID:c||d.applyButtonID,srcLun:{name:g},target:{name:e},feasCheckMsg:b});f.open()};Ext.define("SYNO.SDS.iSCSI.LUN.WizardCreate",{extend:"SYNO.SDS.Wizard.ModalWindow",isDataChanged:false,canCreate:false,constructor:function(a){var c=this,b;c.appWin=a.appWin;c.owner=a.owner;b={title:_T("iscsilun","iscsilun_create_title"),cls:"syno-app-iscsi",width:680,height:c.appWin.supportVAAI?600:580,resizable:false,border:false,steps:[]};b.steps.push(new SYNO.SDS.iSCSI.LUN.Wizard.PropertyStep({appWin:c.appWin,owner:c.owner,mode:"create",itemId:"lun_property_step",nextId:"mapping_step"}));b.steps.push(new SYNO.SDS.iSCSI.LUN.Wizard.MappingStep({appWin:c.appWin,canCreateTarget:!c.appWin.isUpToTargetMaxCount(),itemId:"mapping_step",nextId:{create:"target_prop",exists:"summary",none:"summary"}}));b.steps.push(new SYNO.SDS.iSCSI.Target.Wizard.PropertyStep({appWin:c.appWin,itemId:"target_prop",nextId:"summary"}));b.steps.push(new SYNO.SDS.iSCSI.LUN.Wizard.CreateSummaryStep({appWin:c.appWin,itemId:"summary",nextId:null}));c.callParent([Ext.apply(b,a)])},getTargetInfo:function(){if(!this.inHistory("target_prop")){throw Error("wrong flow control: get target info")}return this.getStep("target_prop").getForm().getValues()},getMappedType:function(){if(!this.inHistory("mapping_step")){throw Error("wrong flow control: get mapping info")}return this.getStep("mapping_step").getSource()},applySettings:function(i){var g;var l=[];var a=[];var c=true;var f=false;var j={};var o={};var k=this.getStep("lun_property_step");g=k.getProps();o.name=g.name;o.location=g.location;if(g.hasOwnProperty("size")){o.size=(parseInt(g.size,10)*SYNO.SDS.iSCSI.Utils.ISCSITRG_UNIT_GB)}if("pool"===g.volumeType){o.type="BLOCK"}else{if("btrfs"===g.volumeType){if("true"===g.thin_provision){o.type="BLUN"}else{o.type="BLUN_THICK"}}else{if("ext4"===g.volumeType){if("true"===g.adv_legacy){o.type="ADV"}else{if("true"===g.thin_provision){o.type="THIN"}else{o.type="FILE"}}}}}var h=k.getField("adv_write_same").getValue(),n=k.getField("adv_caw").getValue(),m=k.getField("adv_xcopy").getValue(),e=k.getField("adv_unmap").getValue(),b=k.getField("adv_snapshot").getValue();o.dev_attribs=[{dev_attrib:"emulate_tpws",enable:(true===h)?1:0},{dev_attrib:"emulate_caw",enable:(true===n)?1:0},{dev_attrib:"emulate_3pc",enable:(true===m)?1:0},{dev_attrib:"emulate_tpu",enable:(true===e)?1:0},{dev_attrib:"can_snapshot",enable:(true===b)?1:0}];l.push({api:"SYNO.Core.ISCSI.LUN",method:"create",version:1,params:o});var p=this.getMappedType();j.target_ids=[];if("create"===p){var d=this.getTargetInfo();d.auth_type=("true"===d.chap)?1:0;if(("true"===d.chap)&&("true"===d.mutual_chap)){d.auth_type=2}f=true;l.push({api:"SYNO.Core.ISCSI.Target",method:"create",version:1,params:d})}else{if("exists"===p){j.target_ids.push(this.getStep("mapping_step").getTargetId())}}if("exists"===p||"create"===p){a.push({api:"SYNO.Core.ISCSI.LUN",method:"map_target",version:1,params:j})}if(null!==i){l=i}this.getButton("next").disable();this.setStatusBusy({text:_T("common","saving")});this.sendWebAPI({scope:this,timeout:600000,compound:{stopwhenerror:true,mode:"sequential",params:l},callback:function(x,s){var v=[];if(!x||s.has_fail){this.clearStatusBusy()}for(var t=0;t<s.result.length;t++){if(!s.result[t].success){var r;var w="",u="";l[t].params.is_soft_feas_ignored=true;for(var q=0;q<l.length;q++){if(!s.result[q].success){v.push(l[q])}}if(s.result[t].hasOwnProperty("error")&&s.result[t].error.hasOwnProperty("errors")){r=s.result[t].error.errors;if("SYNO.Core.ISCSI.Target"===l[t].api){u=l[t].params.name}else{if("SYNO.Core.ISCSI.LUN"===l[t].api){w=l[t].params.name}}if(r.hasOwnProperty("feasibility_hard")||r.hasOwnProperty("feasibility_soft")){SYNO.SDS.iSCSI.LUN.GeneralFeasChkFailCallback(r,v,w,u,this,this.getButton("next").getId());return}}SYNO.SDS.iSCSI.Utils.HARemoteCheckErrParsing(s.result[t].error);SYNO.SDS.iSCSI.Utils.ReportWebapiFailure(this,s.result[t].error);return}}if(c){if(s.result[0]&&s.result[0].success&&s.result[0].data){j.uuid=s.result[0].data.uuid}}if(f){if(s.result[1]&&s.result[1].success&&s.result[1].data){j.target_ids.push(s.result[1].data.target_id.toString())}}this.sendWebAPI({scope:this,compound:{stopwhenerror:true,mode:"sequential",params:a},callback:function(B,y,A,z){this.clearStatusBusy();this.getButton("next").enable();this.getButton("next").setText(_T("common","alt_finish"));if(y.str){this.getMsgBox().alert(this.title,y.str,this.close,this)}else{this.isDataChanged=true;this.close()}}})}})},contFromSoftFeasCheck:function(a){this.applySettings(a)}});Ext.define("SYNO.SDS.iSCSI.LUN.Delete",{extend:"SYNO.SDS.ModalWindow",isDataChanged:false,target:null,mapped_luns:null,task_luns:[],lunbkp_tasks:[],constructor:function(a){var c=this,b;c.ignoreSoftFeasibility=false;c.isDataChanged=false;c.task_luns="";c.lunbkp_tasks="";c.appWin=a.appWin;c.owner=a.owner;c.luns=a.luns;b={title:_T("iscsilun","iscsilun_remove_title"),width:640,height:350,resizable:false,layout:"fit",items:[{xtype:"syno_formpanel",itemId:"main",border:false,items:[{xtype:"syno_displayfield",htmlEncode:false,value:"",id:c.descID=Ext.id(),itemId:"desc"},c.grid=new SYNO.SDS.Wizard.SummaryStep({layout:"fit",height:200})]}],buttons:[{xtype:"syno_button",btnStyle:"red",disabled:_S("demo_mode"),tooltip:_S("demo_mode")?_JSLIBSTR("uicommon","error_demo"):"",text:_T("common","remove"),id:c.applyButtonID=Ext.id(),scope:c,handler:c.onDelete},{xtype:"syno_button",text:_T("common","alt_cancel"),scope:c,handler:c.onCancel}]};c.callParent([Ext.apply(b,a)])},onOpen:function(){this.callParent(arguments);this.loadData("")},loadData:function(d){var c=this,b=c.grid.getStore();var e={};var a=false;e.uuids=[];e.uuid="";e.uuids=this.luns.map(function(f){return f.get("uuid")});e.feasibility_precheck=true;Ext.each(this.luns,function(f){if(f.isAdvancedLun()){a=true;return false}});this.setStatusBusy({text:_T("common","saving")});this.sendWebAPI({api:"SYNO.Core.ISCSI.LUN",method:"delete",version:1,params:e,callback:function(h,g){this.clearStatusBusy();if(!h){if(g.hasOwnProperty("errors")){var f=g.errors;if(f.hasOwnProperty("feasibility_hard")||f.hasOwnProperty("feasibility_soft")){this.feasPreCheckCallback(f,e);this.ignoreSoftFeasibility=true;return}}SYNO.SDS.iSCSI.Utils.ReportWebapiFailure(this,g);return}b.append(_T("volume","volume_iscsitrg_lun"),c.genLunsStr(c.luns));if(a){Ext.getCmp(c.descID).setValue(_T("iscsimgr","lun_delete_adv_desc"))}else{Ext.getCmp(c.descID).setValue(_T("volume","volume_delete_summary_desc"))}},scope:this})},genLunsStr:function(a){return a.map(function(b){return b.get("name")}).join(", ")},onDelete:function(){var d=this;var b=_T("iscsilun","iscsilun_remove_cinder_lun_warning");var c={yes:{text:_T("common","remove"),btnStyle:"red"},no:{text:_T("common","cancel")}};var a=this.luns.some(function(e){return e.isLunOwnedByCinder()});if(a){this.getMsgBox().confirmDelete(this.title,b,function(e){if("yes"==e){SYNO.SDS.Utils.PasswordConfirmDialog.openDialog(d,d.onSave)}},this,c)}else{SYNO.SDS.Utils.PasswordConfirmDialog.openDialog(d,d.onSave)}},onSave:function(){var a={};a.uuids=[];a.uuid="";a.uuids=this.luns.map(function(b){return b.get("uuid")});this.apply(a)},onCancel:function(){this.close()},apply:function(a){a.is_soft_feas_ignored=this.ignoreSoftFeasibility;this.setStatusBusy({text:_T("common","saving")});this.sendWebAPI({api:"SYNO.Core.ISCSI.LUN",method:"delete",version:1,params:a,callback:function(c,b){this.clearStatusBusy();if(!c){SYNO.SDS.iSCSI.Utils.ReportWebapiFailure(this,b);return}this.isDataChanged=true;this.close()},scope:this})},contFromSoftFeasCheck:function(a){this.ignoreSoftFeasibility=true;this.apply(a)},feasPreCheckCallback:function(h,c){var d=false,i=false;var f=this;var e=f.grid.getStore();var b="";if(h.hasOwnProperty("feasibility_soft")){d=true;b="feasibility_soft"}else{if(h.hasOwnProperty("feasibility_hard")){i=true;b="feasibility_hard"}}var a=h;a.objType="lun";if(c.hasOwnProperty("name")){var g={};g.name=c.name;g.check_message=a[b];a[b]=[g]}SYNO.SDS.iSCSI.Utils.fillGridByFeasMsg(a,e);if(true===i){Ext.getCmp(f.applyButtonID).disable();Ext.getCmp(f.descID).setValue(_T("volume","del_hard_check_fail"))}else{if(true===d){Ext.getCmp(f.descID).setValue(_T("volume","del_soft_check_fail"))}else{f.clearStatusBusy();return}}}});Ext.define("SYNO.SDS.iSCSI.LUN.Mapping",{extend:"SYNO.ux.GridPanel",constructor:function(a){var c=this,d,b;c.appWin=a.appWin;d=new SYNO.ux.EnableColumn({dataIndex:"enabled",width:40,align:"center",bindRowClick:true});b={title:_T("iscsitrg","iscsitrg_mapping"),plugins:d,columns:[d,{id:"name",header:_T("common","name"),dataIndex:"name",align:"left",width:160,sortable:true,renderer:null},{id:"iqn",header:"IQN",dataIndex:"iqn",align:"left",width:340,sortable:true,renderer:SYNO.SDS.iSCSI.Utils.TipRenderer}],store:new Ext.data.JsonStore({autoDestroy:true,idProperty:"id",fields:["id","iqn","enabled",{name:"name",sortType:"asNaturalUCString"}],sortInfo:{field:"name",direction:"ASC"}}),enableHdMenu:false,autoExpandColumn:"name",listeners:{activate:function(){if(0===this.getStore().totalLength){this.mask(_T("iscsitrg","iscsitrg_no_iscsitrg"),"syno-ux-mask-info")}}}};c.callParent([Ext.apply(b,a)])}});Ext.define("SYNO.SDS.iSCSI.LUN.Edit",{extend:"SYNO.SDS.ModalWindow",isDataChanged:false,lun:null,targets:null,constructor:function(a){var d=this,b,c;d.appWin=a.appWin;d.owner=a.owner;d.lun=a.lun;d.lunType=d.lun.getLunType();d.prop=new SYNO.SDS.iSCSI.LUN.Property({appWin:d.appWin,owner:d,itemId:"prop",mode:"edit",lunType:d.lunType,vol_type_of_lun:d.lun.isBtrfsLun()?"btrfs":"all"});d.map=new SYNO.SDS.iSCSI.LUN.Mapping({itemId:"map",appWin:d.appWin,owner:d});c=[d.prop,d.map];b={title:_T("common","alt_edit"),width:d.appWin.supportVAAI?640:625,height:350,minWidth:625,minHeight:350,resizable:true,layout:"fit",border:false,items:[{itemId:"main",xtype:"syno_tabpanel",activeTab:0,plain:true,hideMode:"offsets",deferredRender:false,items:c}],buttons:[{xtype:"syno_button",btnStyle:"blue",disabled:_S("demo_mode"),tooltip:_S("demo_mode")?_JSLIBSTR("uicommon","error_demo"):"",text:_T("common","alt_apply"),id:d.applyButtonID=Ext.id(),scope:this,handler:this.onSave},{xtype:"syno_button",text:_T("common","alt_cancel"),scope:this,handler:this.onCancel}]};d.callParent([Ext.apply(b,a)])},onOpen:function(){var a=this;a.callParent(arguments);if(this.lun.isSinkLun()){this.map.disable()}else{a.loadtargets()}if(a.lunType==="block"){a.prop.loadPools()}else{a.prop.loadVolumes()}a.loadForm()},loadForm:function(){this.prop.loadLunData(this.lun)},loadtargets:function(){var e=this;var d=e.lun.get("uuid");var a=e.appWin.iscsiTargets.getAll();var c=e.appWin.iscsiLuns;var b=e.map.getStore();var f=[];var g=String.format(' - <span class="blue-status">{0}</span>',_T("iscsimgr","target_mapped"));b.removeAll();Ext.each(a,function(l){var k=l.get("mapped_luns");var m=false;var j=false;for(var h=0;h<k.length;h++){if(k[h].lun_uuid===d){m=true;break}else{if(c.getById(k[h].lun_uuid).isLunOwnedByCinder()){j=true;break}}}if(j){return true}f.push({id:l.get("target_id"),name:l.get("name")+((0===k.length)?"":g),iqn:l.get("iqn"),enabled:m})},e);b.loadData(f,false);b.commitChanges()},isDirty:function(){var b=this,a;a=b.map.getStore();if(b.prop.getForm().isDirty()){return true}if(a.getModifiedRecords().length){return true}return false},getPropPanel:function(){return this.prop},onSave:function(){var m=this;var n=[];var b={},k={};var g,h=m.map.getStore();var o,d;if(!m.getPropPanel().getForm().isValid()){m.getComponent("main").activate("prop");return}if(!m.isDirty()){m.close();return}Ext.apply(b,m.getPropPanel().getForm().getValues());d=b.size;o=parseInt(d,10)*SYNO.SDS.iSCSI.Utils.ISCSITRG_UNIT_GB;k.new_size=o;k.new_name=b.name;if(b.hasOwnProperty("location")){k.new_location=b.location}k.uuid=m.lun.get("uuid");k.is_soft_feas_ignored=this.ignoreSoftFeasibility;if(m.getPropPanel().getForm().isDirty()){n.push({api:"SYNO.Core.ISCSI.LUN",method:"set",version:1,params:k})}var c=h.getModifiedRecords();var j=[],e=[];var l={},f={};l.uuid=m.lun.get("uuid");f.uuid=m.lun.get("uuid");for(g=0;g<c.length;g++){var a=c[g].data;if(true===a.enabled){e.push(a.id)}else{j.push(a.id)}}l.target_ids=e;f.target_ids=j;if(e.length>0){n.push({api:"SYNO.Core.ISCSI.LUN",method:"map_target",version:1,params:l})}if(j.length>0){n.push({api:"SYNO.Core.ISCSI.LUN",method:"unmap_target",version:1,params:f})}m.applySettings(n)},applySettings:function(a){if(!this.lun.get("is_mapped")){this.doApply(a);return}this.getMsgBox().confirm(this.title,_T("iscsitrg","iscsitrg_disconnect_warning"),function(b){if("yes"===b){this.doApply(a)}},this)},doApply:function(a){var d=this;var c=false;d.setStatusBusy({text:_T("common","saving")});for(var b=0;b<a.length;b++){if(a[b].params.hasOwnProperty("is_soft_feas_ignored")){a[b].params.is_soft_feas_ignored=this.ignoreSoftFeasibility}if(a[b].method=="map_target"||a[b].method=="unmap_target"){c=true}}this.sendWebAPI({scope:this,compound:{stopwhenerror:true,mode:"sequential",params:a},callback:function(j,f){var h=d.lun.get("name");this.clearStatusBusy();for(var g=0;g<f.result.length;g++){if(!f.result[g].success){var e;if(f.result[g].hasOwnProperty("error")&&f.result[g].error.hasOwnProperty("errors")){e=f.result[g].error.errors;if(e.hasOwnProperty("feasibility_hard")||e.hasOwnProperty("feasibility_soft")){SYNO.SDS.iSCSI.LUN.GeneralFeasChkFailCallback(e,a,h,"",this,this.applyButtonID);return}}SYNO.SDS.iSCSI.Utils.HARemoteCheckErrParsing(f.result[g].error);SYNO.SDS.iSCSI.Utils.ReportWebapiFailure(this,f.result[g].error);return}}if("ture"===c){SYNO.SDS.StatusNotifier.setServiceDisabled("SYNO.SDS.StorageManager.ISCSI",false)}this.isDataChanged=true;this.close()}})},onCancel:function(){var a=this;if(a.isDirty()){a.getMsgBox().confirm(a.title,_T("common","confirm_lostchange"),function(b){if("yes"===b){a.close()}},a);return}a.close()},contFromSoftFeasCheck:function(a){this.ignoreSoftFeasibility=true;this.doApply(a)}});Ext.define("SYNO.SDS.iSCSI.LUN.Clone",{extend:"SYNO.SDS.ModalWindow",isDataChanged:false,lun:null,volumes:null,targets:null,pool:null,constructor:function(a){var c=this,b;c.owner=a.owner;c.appWin=a.appWin;c.lun=a.lun;c.ignoreSoftFeasibility=false;c.forceReload=false;c.lunType=c.lun.getLunType();c.needWarning=false;c.prop=new SYNO.SDS.iSCSI.LUN.Property({appWin:c.appWin,owner:c,itemId:"property",mode:"clone",vol_type_of_lun:("btrfs"===c.lunType&&c.lun.isThinProvisioningLun())?"btrfs":"all",lunType:c.lunType});b={title:_T("iscsilun","clone"),width:640,height:SYNO.SDS.iSCSI.Utils.IsAnyMappedTargetConnected(c.lun.get("uuid"),c.appWin.iscsiTargets.getAll())?420:320,resizable:false,layout:"fit",plain:true,border:false,items:[c.prop],buttons:[{xtype:"syno_button",btnStyle:"blue",disabled:_S("demo_mode"),tooltip:_S("demo_mode")?_JSLIBSTR("uicommon","error_demo"):"",text:_T("common","alt_apply"),id:c.applyButtonID=Ext.id(),scope:this,handler:this.onSave},{xtype:"syno_button",text:_T("common","alt_cancel"),scope:this,handler:this.onCancel}]};c.callParent([Ext.apply(b,a)])},onOpen:function(){this.callParent(arguments);this.prop.loadVolumes();this.prop.loadLunData(this.lun);this.prop.getForm().setValues({name:this.appWin.genNewLunName()})},getPropPanel:function(){return this.prop},isDirty:function(){if(this.getComponent("property").getForm().isDirty()){return true}return false},prepareCloneParams:function(){var c=this;var e=c.getPropPanel();var b=e.getForm().getValues();var a=[];var d={};d.is_soft_feas_ignored=this.ignoreSoftFeasibility;d.src_lun_uuid=c.lun.get("uuid");d.dst_lun_name=b.name;d.dst_location=b.location;if(!this.lun.canSnapshot()){c.needWarning=true}if(this.lun.isLunOnBtrfsVol(this.appWin.volumes)&&this.lun.isThinProvisioningLun()&&!this.lun.isAdvancedLun()){c.needWarning=false}if("btrfs"===e.lunType){if(e.getComponent("thin_provision").getValue()){d.clone_type="BLUN"}else{d.clone_type="BLUN_THICK"}}else{if(this.lun.isAdvancedLun()){d.clone_type="ADV"}else{if(this.lun.isThinProvisioningLun()){d.clone_type="THIN"}else{d.clone_type="FILE"}}}a.push({api:"SYNO.Core.ISCSI.LUN",method:"clone",version:1,params:d});return a},onSave:function(){var c=this;var b=this.getPropPanel().getForm();var a;if(!b.isValid()){return}a=c.prepareCloneParams();if(c.needWarning){this.getMsgBox().confirm(this.title,_T("iscsitrg","iscsitrg_disconnect_warning"),function(d){if("yes"===d){this.doApply(a)}},this)}else{this.doApply(a)}},doApply:function(a){var b=this;this.setStatusBusy({text:_T("common","saving")});this.sendWebAPI({scope:this,compound:{stopwhenerror:true,mode:"sequential",params:a},callback:function(g,d){var f=b.lun.get("name");this.clearStatusBusy();for(var e=0;e<d.result.length;e++){if(!d.result[e].success){var c;if(d.result[e].hasOwnProperty("error")&&d.result[e].error.hasOwnProperty("errors")){c=d.result[e].error.errors;if(c.hasOwnProperty("feasibility_hard")||c.hasOwnProperty("feasibility_soft")){SYNO.SDS.iSCSI.LUN.GeneralFeasChkFailCallback(c,a,f,"",this,this.applyButtonID);return}}SYNO.SDS.iSCSI.Utils.HARemoteCheckErrParsing(d.result[e].error);SYNO.SDS.iSCSI.Utils.ReportWebapiFailure(this,d.result[e].error);return}}b.isDataChanged=true;if(b.forceReload){b.appWin.pollTask.restart(true)}b.close()}})},onCancel:function(){this.close()},contFromSoftFeasCheck:function(){this.ignoreSoftFeasibility=true;this.onSave()}});Ext.define("SYNO.SDS.iSCSI.LUN.Wizard.ConvertReadmeStep",{extend:"SYNO.ux.FormPanel",constructor:function(a){this.appWin=a.appWin;this.owner=a.owner;this.lun=a.lun;this.cannotConvertReason=a.cannotConvertReason;var b={headline:_T("iscsimgr","iscsilun_convert_desc"),items:[{xtype:"syno_displayfield",htmlEncode:false,value:_T("iscsimgr","iscsilun_convert_desc_detail")},{xtype:"syno_displayfield",htmlEncode:false,value:String.format(_T("iscsimgr","iscsilun_convert_rqmt"),'<span style="font-weight: bold">',"</span>")},{xtype:"syno_displayfield",htmlEncode:false,value:'<span class="syno-ux-note">'+_T("common","note")+_T("common","colon")+" </span>"+_T("iscsimgr","iscsilun_convert_note")}]};this.callParent([Ext.apply(b,a)])},getNext:function(){if(this.cannotConvertReason&&this.cannotConvertReason!==""){this.owner.getMsgBox().alert("",this.cannotConvertReason);return false}return this.nextId}});Ext.define("SYNO.SDS.iSCSI.LUN.Wizard.ConvertSummaryStep",{extend:"SYNO.SDS.Wizard.SummaryStep",constructor:function(a){this.lun=a.lun;var b=Ext.apply({headline:_T("ezinternet","ezinternet_summary_title"),viewConfig:{forceFit:false},columns:[{width:150,header:_T("status","header_item"),dataIndex:"key",renderer:this.fieldRenderer},{id:"value",autoExpand:true,header:_T("status","header_value"),dataIndex:"value",renderer:this.descRenderer,scope:this}],enableHdMenu:false,enableColumnMove:false,autoExpandColumn:"value",store:new SYNO.SDS.Wizard.SummaryStore()},a);SYNO.SDS.Wizard.SummaryStep.superclass.constructor.call(this,b)},getNext:function(){var c=this;var a=c.checkConvertRule();if(a.has_any_mapped_target||a.has_any_snapshot){var b="";if(a.has_any_mapped_target){b+=_T("iscsimgr","iscsilun_convert_mapped_trg_warn");c.owner.needUnmap=true}if(a.has_any_snapshot){b+=_T("iscsimgr","iscsilun_convert_snap_warn")}b+=_T("common","ask_cont");c.owner.getMsgBox().confirm(c.owner.title,b,function(d){if("yes"===d){this.owner.applySettings(null)}},this,{yes:{text:Ext.MessageBox.buttonText.yes,btnStyle:"red"},no:{text:Ext.MessageBox.buttonText.no}})}else{this.owner.applySettings(null);return false}return false},checkConvertRule:function(){var b=this.lun.mappedTargets.length>0;var a=(this.lun.data.snapshots&&this.lun.data.snapshots.length)>0;return{has_any_mapped_target:b,has_any_snapshot:a}},descRenderer:function(e,b,a,g,d,c){var f=e.toString().replace(/<.*?>/g,"");b.attr='ext:qtip="'+f+'"';return e},checkState:function(){SYNO.SDS.Wizard.Step.prototype.checkState.apply(this,arguments);this.owner.getButton("next").setText(_T("iscsimgr","iscsilun_convert"))}});Ext.define("SYNO.SDS.iSCSI.LUN.WizardConvert",{extend:"SYNO.SDS.Wizard.ModalWindow",isDataChanged:false,constructor:function(a){var c=this,b;c.appWin=a.appWin;c.owner=a.owner;c.lun=a.lun;c.cannotConvertReason="";c.availDstLocations=c.getCanConvertVols();c.needUnmap=false;c.readmeStep=new SYNO.SDS.iSCSI.LUN.Wizard.ConvertReadmeStep({appWin:c.appWin,lun:c.lun,owner:c.owner,cannotConvertReason:c.cannotConvertReason,itemId:"convert_readme_step",nextId:"convert_prop_step"});c.propStep=new SYNO.SDS.iSCSI.LUN.Wizard.PropertyStep({appWin:c.appWin,mode:"convert",itemId:"convert_prop_step",vol_type_of_lun:"btrfs",lun:c.lun,avail_dst_locations:c.availDstLocations,nextId:"convert_summary"});c.summaryStep=new SYNO.SDS.iSCSI.LUN.Wizard.ConvertSummaryStep({appWin:c.appWin,itemId:"convert_summary",lun:c.lun,nextId:null});b={title:_T("iscsimgr","iscsilun_convert_title"),cls:"syno-app-iscsi",width:640,height:580,resizable:false,border:false,steps:[c.readmeStep,c.propStep,c.summaryStep]};c.callParent([Ext.apply(b,a)])},getPropPanel:function(){return this.propStep},getCanConvertVols:function(){var b=this;var a=[];b.cannotConvertReason="";a=b.appWin.volumes.filter(function(c){return c.fs_type==="btrfs"});if(a.length===0){b.cannotConvertReason=_T("iscsimgr","convert_no_btrfs_volume");return b.canConvertVols}a=a.filter(function(c){return b.lun.get("allocated_size")<=parseInt(c.size_free_byte,10)});if(a.length===0){b.cannotConvertReason=_T("iscsimgr","convert_btrfs_no_available_capacity")}return a},prepareConvertParams:function(){var c=this;var e=c.getPropPanel();var b=e.getForm().getValues();var d={};d.src_lun_uuid=c.lun.get("uuid");d.dst_lun_name=b.name;d.dst_location=b.location;d.clone_type="BLUN";if("true"===b.delete_orig_lun_after_convert){d.is_delete_parent_lun=true;d.map_new_lun_to_target_ids=c.lun.mappedTargets}var a={api:"SYNO.Core.ISCSI.LUN",method:"clone",version:1,params:d};return a},applySettings:function(b){var c=this;var a=[];if(!c.getPropPanel().getForm().isValid()){return}if(c.needUnmap){a.push({api:"SYNO.Core.ISCSI.LUN",method:"unmap_target",version:1,params:{uuid:c.lun.get("uuid"),target_ids:c.lun.mappedTargets}})}a.push(c.prepareConvertParams());if(null!==b){a=b}c.getButton("next").disable();c.setStatusBusy({text:_T("common","saving")});c.sendWebAPI({compound:{stopwhenerror:true,mode:"sequential",params:a},callback:function(l,f,j){var h=[];c.clearStatusBusy();c.getButton("next").enable();c.getButton("next").setText(_T("common","alt_finish"));for(var g=0;g<f.result.length;g++){if(!f.result[g].success){var e;a[g].params.is_soft_feas_ignored=true;for(var d=0;d<a.length;d++){if(!f.result[d].success){h.push(a[d])}}if(f.result[g].hasOwnProperty("error")&&f.result[g].error.hasOwnProperty("errors")){e=f.result[g].error.errors;if(e.hasOwnProperty("feasibility_hard")||e.hasOwnProperty("feasibility_soft")){SYNO.SDS.iSCSI.LUN.GeneralFeasChkFailCallback(e,h,c.lun.get("name"),"",c,c.getButton("next").getId());return}}SYNO.SDS.iSCSI.Utils.HARemoteCheckErrParsing(f.result[g].error);SYNO.SDS.iSCSI.Utils.ReportWebapiFailure(c,f.result[g].error);return}}c.isDataChanged=true;c.close()}})},contFromSoftFeasCheck:function(a){this.applySettings(a)}});Ext.define("SYNO.SDS.iSCSI.LUN.iSCSILUN",{check:SYNO.SDS.iSCSI.Utils.check,utils:SYNO.SDS.iSCSI.Utils,prepareDevAttribsJson:function(){var b={};var a=this.get("dev_attribs");if(a){a.forEach(function(c){b[c.dev_attrib]=c.enable})}this.data.dev_attribs_json=b},get:function(a){if(this.data){return this.data[a]}return undefined},getLunType:function(){if(this.isBtrfsLun()){return"btrfs"}else{if(this.isFileLun()){return"file"}else{return"block"}}},getSpace:function(c,b){if(this.space){return this.space}if(this.isBlockLun()){this.space=this.utils.getLUNPoolInfo(b,this.get("location"))}else{for(var a=0;a<c.length;a++){if(c[a].volume_path===this.get("location")){this.space=c[a]}}}if(!this.space){return{size_free_byte:0,status:"unknown"}}return this.space},getSpaceStatus:function(b,a){return this.getSpace(b,a).status},getSpaceFreeSize:function(c,a){var b=this.getSpace(c,a);return parseInt(b.size_free_byte,10)},getSummaryStatus:function(e,b,a){var d=this.getSpace(e,b);var c=d.status;var f=parseInt(d.size_free_byte,10);if(this.cacheMissing()){return this.utils.StatusNameRender("cache_missing")}else{if(this.cacheCrashed()&&!this.isDeleting()){return this.utils.StatusNameRender("crashed")}else{if((this.isNormal()||this.isFinished())&&("degrade"===c||"crashed"===c)){return this.utils.StatusNameRender(c)}else{if(this.isHardLimit()){return String.format('<span class="{0}">{1}</span>',"red-status",_T("iscsimgr","hard_limit_reach"))}else{if(this.isThinProvisioningLun()&&f<SYNO.SDS.iSCSI.TP_HARD_THRESHOLD_DEFAULT_SIZE&&a){return String.format('<span class="{0}">{1}</span>',"red-status",_T("iscsimgr","lun_low_capacity"))}else{if(this.isSoftLimit()){return String.format('<span class="{0}">{1}</span>',"orange-status",_T("iscsimgr","soft_limit_reach"))}else{return this.utils.StatusNameRender(this.get("status"))}}}}}}},getProgress:function(){var b=this.get("status"),a,c;if(b==="defragging"){a=this.get("sync_done");c=this.get("sync_total")}return(c&&a!==undefined)?String.format('<span class="blue-status">({0}%)</span>',Math.floor(a*100/c)):""},getAdvFeatureDesc:function(){if(this.isAdvancedLun()){return _T("iscsimgr","lun_adv_feature_legacy")+" "+(this.isEnableUnmap()?_T("iscsimgr","unmap_yes_desc"):_T("iscsimgr","unmap_no_desc"))}var a=[];if(this.isEnableTPWriteSame()){a.push(_T("iscsimgr","lun_adv_feature_write_same"))}if(this.isEnableCompareAndWrite()){a.push(_T("iscsimgr","lun_adv_feature_acw"))}if(this.isEnableXcopy()){a.push(_T("iscsimgr","lun_adv_feature_xcopy"))}if(this.isEnableUnmap()){a.push(_T("iscsimgr","unmap_command"))}if(this.isEnableSnapshot()){a.push(_T("iscsilun","snapshot"))}return 0===a.length?_T("common","no"):a.join(", ")},getDefaultAdvFeatureDesc:function(){var a=[_T("iscsimgr","lun_adv_feature_write_same"),_T("iscsimgr","lun_adv_feature_acw"),_T("iscsimgr","lun_adv_feature_xcopy"),_T("iscsilun","snapshot")];return a.join(", ")},isSummaryWarning:function(b,a){return this.isSoftLimit()||this.isUnhealthy()||(this.getCrashType(b,a)==="volume_degrade")},isSummaryCrashed:function(d,c,a){var b=this.getCrashType(d,c,a);return(b!=="normal"&&b!=="soft_limit_reach")},getCrashType:function(e,b,a){var d=this.getSpace(e,b);var c=d.status;var f=parseInt(d.size_free_byte,10);if(this.cacheCrashed()){return"cache_crashed"}if(this.isHardLimit()){return a?"hard_limit_reach":"hard_limit_reach_without_low_capacity_write"}if(this.isThinProvisioningLun()&&f<SYNO.SDS.iSCSI.TP_HARD_THRESHOLD_DEFAULT_SIZE&&a){return"low_capacity_write_on"}if(this.isSoftLimit()){return"soft_limit_reach"}if("unavailabling"===this.get("status")){return"unavailabling"}if(this.isUnhealthy()){return"Unhealthy"}if("crashed"===c){return"volume_crashed"}if("degrade"===c){return"volume_degrade"}return"normal"},isActioning:function(){return this.get("is_action_locked")},isDeleting:function(){return("deleting"===this.get("status"))},isFinished:function(){return("finished"===this.get("status"))},isUnhealthy:function(){return("Unhealthy"===this.get("status"))},isNormal:function(){return("normal"===this.get("status"))},isSoftLimit:function(){return("soft_limit_reach"===this.get("status"))},isHardLimit:function(){return("hard_limit_reach"===this.get("status"))},isCrashed:function(){return(("unavailabling"===this.get("status"))||this.isUnhealthy())},cacheMissing:function(){return("cache_missing"===this.get("flashcache_status"))},cacheCrashed:function(){return("cache_crashed"===this.get("flashcache_status"))},isFileLun:function(){return(0!==(this.get("type")&2))},isThinProvisioningLun:function(){return(0!==(this.get("type")&4))},isAdvancedLun:function(){return(0!==(this.get("type")&8))},isSinkLun:function(){return(0!==(this.get("type")&16))},isVdiskLun:function(){return(0!==(this.get("type")&32))},isBtrfsLun:function(){return(0!==(this.get("type")&256))},isLunOwnedByCinder:function(){return(0!==(this.get("type")&128))},isBlockLun:function(){return !this.isFileLun()},isEnableAnyAdvancedFeature:function(){return this.isEnableTPWriteSame()||this.isEnableCompareAndWrite()||this.isEnableXcopy()||this.isEnableUnmap()||this.isEnableSnapshot()},isEnableTPWriteSame:function(){return this.get("dev_attribs_json").emulate_tpws===1},isEnableCompareAndWrite:function(){return this.get("dev_attribs_json").emulate_caw===1},isEnableXcopy:function(){return this.get("dev_attribs_json").emulate_3pc===1},isEnableUnmap:function(){return(this.get("dev_attribs_json").emulate_tpu===1)},isEnableSnapshot:function(){return(this.get("dev_attribs_json").can_snapshot===1)},isLunOnBtrfsVol:function(c){var a=this.get("location");var b=c.filter(function(d){return d.volume_path==a});return("btrfs"==b[0].fs_type)},canSnapshot:function(){return this.isEnableSnapshot()},canBeMapped:function(b,a){switch(this.get("status")){case"unavailabling":case"Unhealthy":case"deleting":case"creating":return false}if(this.isActioning()||this.isSinkLun()||this.isLunOwnedByCinder()||this.cacheCrashed()||"crashed"===this.getSpaceStatus(b,a)){return false}return true}});Ext.define("SYNO.SDS.iSCSI.LUN.Main",{extend:"SYNO.ux.FormPanel",constructor:function(a){var b=this;b.appWin=a.appWin;b.owner=a.appWin;b.loaded=false;b.view=b.createView();this.callParent([this.fillConfig(a)])},fillConfig:function(a){var c=this;var b={border:false,layout:"fit",itemId:"iscsi_lun",cls:"syno-app-iscsi",tbar:this.toolbar=new Ext.Toolbar({defaultType:"syno_button",items:[{itemId:"create",text:_T("common","create"),handler:c.onCreate,scope:c},{itemId:"remove",text:_T("common","remove"),handler:c.onDelete,scope:c}]}),items:c.view,listeners:{activate:c.onActivate,data_ready:c.onDataReady,scope:c}};c.actionMenu=new SYNO.SDS.iSCSI.Comp.TooltipMenu({itemId:"action_menu",items:[{itemId:"edit",text:_T("common","alt_edit"),handler:c.onEdit,scope:c},{itemId:"clone",text:_T("iscsilun","clone"),handler:c.onClone,scope:c,hidden:!(c.appWin.supportVAAI&&c.appWin.isLio4x)},{itemId:"convert",text:_T("iscsimgr","iscsilun_convert"),hidden:true,handler:c.onConvert,scope:c}]});c.defragMenu=new SYNO.ux.Menu({itemId:"defrag_menu",items:[{itemId:"start",text:_T("common","start"),handler:c.onDefrag,disabled:false,scope:c},{itemId:"stop",text:_T("common","stop"),handler:c.onStopDefrag,disabled:false,scope:c}]});this.toolbar.add({itemId:"action_btn",text:_T("common","action"),menu:c.actionMenu});this.toolbar.add({itemId:"defrag_btn",hidden:true,text:_T("iscsilun","defrag"),menu:c.defragMenu});Ext.apply(b,a);return b},createView:function(){var e=this,c=SYNO.SDS.iSCSI.UsageTpl(),d=SYNO.SDS.iSCSI.PropertyTpl(),f=SYNO.SDS.iSCSI.TargetTpl({scope:"targets",title:_T("iscsitrg","iscsitrg_mapped_target"),emptyText:_T("iscsitrg","iscsitrg_mapped_no_targets")}),b=new Ext.XTemplate('<div class="item-detail-inner">',d.html,f.html,"</div>"),a={appWin:e.appWin,owner:e,dataType:"iscsiLuns",itemId:"lunView",multiSelect:true,usageTpl:c,detailTpl:b,store:e.createLunStore(),listeners:{selectionchange:e.onSelectChange,scope:e}};return new SYNO.SDS.iSCSI.DataView(a)},createLunStore:function(){var a=["numId","id","iconPic","iconCls","statusIconCls",{name:"displayName",sortType:"asNaturalUCString"},"property","targets","desc","usage","barWidth","summaryStatus","progressStatus","status","totalSize","location"];return new Ext.data.JsonStore({autoDestroy:true,idProperty:"id",fields:a,sortInfo:{field:"displayName",direction:"ASC"}})},prepareSummary:function(g,f){var d=SYNO.SDS.iSCSI.Utils;var c=parseInt(g.get("size"),10);var b=parseInt(g.get("allocated_size"),10);b=b>c?c:b;f.iconPic="iscsi-lun-icon";f.numId=g.get("lun_id");f.status=g.get("status");f.totalSize=c;f.usedSize=b;f.location=g.get("location");f.id=g.get("uuid");f.displayName=g.get("name");f.usage=String.format('<span style="color:#0086E5">{0}</span>&nbsp;/&nbsp;{1}',d.SizeRender(b),d.SizeRender(c));f.barWidth=(0===c)?0:Math.floor(b*100/c);f.summaryStatus=String.format("&nbsp;-&nbsp;{0}&nbsp;",g.getSummaryStatus(this.appWin.volumes,this.appWin.pools,this.appWin.isLowCapacityWriteEnable()));f.progressStatus=g.getProgress();f.desc="";if(""===f.location){}else{if(g.isBlockLun()){var a=g.get("location"),e=d.getLUNPoolInfo(this.appWin.pools,a).pool_id;f.desc=String.format(_T("volume","volume_default_desc"),d.SpaceIDParser(e).str)}else{f.desc=String.format(_T("volume","volume_default_desc"),d.RootPathParser(f.location).str);f.desc+=", "+d.volumeFsTypeRender(this.mappedVolume[f.location].fs_type)}}if(g.isSinkLun()){f.iconCls="iscsi-lun-icon-sink";f.desc+=", "+_T("iscsimgr","sink_lun")}else{if(g.isBtrfsLun()&&g.isThinProvisioningLun()){f.iconCls="iscsi-lun-icon-btrfs"}else{if(g.isAdvancedLun()){f.iconCls="iscsi-lun-icon-file"}else{if(g.isThinProvisioningLun()){f.iconCls="iscsi-lun-icon-file"}else{f.iconCls="iscsi-lun-icon-block";if("no_cache"!==g.get("flashcache_status")){f.desc+=", "+_T("volume","ssd_cache")}}}}}if(g.isEnableAnyAdvancedFeature()){f.desc+=", "+_T("iscsitrg","iscsitrg_vaai")}if(g.isActioning()){f.statusIconCls="iscsi-list-status-icon-acting"}else{if(g.isSummaryWarning(this.appWin.volumes,this.appWin.pools)){f.statusIconCls="iscsi-list-status-icon-crashed"}else{if(g.isSummaryCrashed(this.appWin.volumes,this.appWin.pools,this.appWin.isLowCapacityWriteEnable())){f.statusIconCls="iscsi-list-status-icon-crashed"}}}},prepareUiData:function(){var b=this,a=b.appWin.iscsiLuns.getAll(),c;delete b.uiData;b.uiData=[];Ext.each(a,function(d){c={};b.prepareSummary(d,c);b.prepareFileLunProperty(d,c);b.prepareMap(d,c);b.uiData.push(c)},b)},prepareFileLunProperty:function(o,g){var m=SYNO.SDS.iSCSI.Utils,b,c;var h=o.getSpaceStatus(this.appWin.volumes,this.appWin.pools);var l=o.getSpaceFreeSize(this.appWin.volumes,this.appWin.pools);var k="";b=o.getSummaryStatus(this.appWin.volumes,this.appWin.pools,this.appWin.isLowCapacityWriteEnable());c="";g.property=[];if(o.isLunOwnedByCinder()){g.property.push({name:_T("iscsilun","user"),value:"Openstack Cinder"})}if(o.isHardLimit()||(o.isThinProvisioningLun()&&l<SYNO.SDS.iSCSI.TP_HARD_THRESHOLD_DEFAULT_SIZE&&this.appWin.isLowCapacityWriteEnable())){if(!o.isHardLimit()){k=_T("iscsimgr","lun_status_low_capacity_write_on_tip")}else{if(l>SYNO.SDS.iSCSI.TP_HARD_THRESHOLD_MIN_SIZE&&!this.appWin.isLowCapacityWriteEnable()){k=_T("iscsimgr","lun_status_hard_limit_without_low_capacity_tip")}else{k=_T("iscsimgr","lun_status_hard_limit_tip")}}}else{if(o.isSoftLimit()){k=_T("iscsimgr","lun_status_soft_limit_tip")}}g.property.push({name:_T("volume","volume_volumestatus"),value:b+c,iconTip:k},{name:_T("volume","volume_totalsize"),value:m.SizeRender(o.get("size"))},{name:_T("volume","volume_used"),value:m.SizeRender(o.get("allocated_size"))});if(o.isFileLun()){g.property.push({name:_T("iscsimgr","space_allocation_type"),value:o.isThinProvisioningLun()?_T("iscsitrg","iscsitrg_thin_provisioning"):_T("iscsimgr","iscsitrg_thick_provisioning")});if(this.appWin.supportVAAI){g.property.push({name:_T("iscsitrg","iscsitrg_vaai"),value:o.getAdvFeatureDesc()})}}else{if("no_cache"!==o.get("flashcache_status")){g.property.push({name:_T("volume","ssd_cache"),value:o.cacheCrashed()?_T("volume","volume_status_crashed"):_T("common","yes")})}}var f="";if(o.isBlockLun()){var i=m.getLUNPoolInfo(this.appWin.pools,o.get("location")).pool_id;f=m.SpaceIDParser(i).str}else{f=m.RootPathParser(o.get("location")).str}g.property.push({name:_T("volume","volume_raid_location"),value:f});if(o.isThinProvisioningLun()){var n=m.StatusNameRender(h);if(l<SYNO.SDS.iSCSI.TP_HARD_THRESHOLD_MIN_SIZE){n+=" ("+_T("iscsimgr","lun_volume_status_hard_limit")+")"}else{if(l<SYNO.SDS.iSCSI.TP_HARD_THRESHOLD_DEFAULT_SIZE){n+=" ("+_T("iscsimgr","lun_volume_status_freesize_less_than_default_size")+")"}else{if(o.isSoftLimit()){n+=" ("+_T("iscsimgr","lun_volume_status_soft_limit")+")"}}}g.property.push({name:_T("volume","volume_status"),value:n})}var j=o.get("family_config");var e=j.parent_lun_name;var a=j.parent_snapshot_time;if(""!==e){if(0!==a){var d=new Date(a*1000);e+=" ( "+SYNO.SDS.DateTimeFormatter(d,{type:"datetimesec"})+" )"}g.property.push({name:_T("iscsilun","source"),value:e})}},prepareMap:function(b,a){a.targets=this.appWin.getMappedTrgs(b.get("uuid"),true)},onActivate:function(){var a=this;if(!a.loaded){a.appWin.setStatusBusy(null,null,50)}a.appWin.fireEvent("poll_activate")},resetBtnStatus:function(){var a=this;a.enableButton(a.getButton("create"),a.canCreate())},prepareVolumeMapping:function(){var a=this,b=a.appWin.volumes;a.mappedVolume={};Ext.each(b,function(c){a.mappedVolume[c.volume_path]=c})},onDataReady:function(){var b=this,a=b.view.store;if(!b.loaded){b.appWin.clearStatusBusy();b.loaded=true}b.prepareVolumeMapping();b.prepareUiData();a.suspendEvents(true);a.loadData(b.uiData,false);a.resumeEvents();b.canCreateLunTypes=b.appWin.getCanCreateLunTypes();b.resetBtnStatus();if(0<b.view.store.getCount()&&0===b.view.getSelectedItemIds().length){b.view.select(0,true,true)}b.onSelectChange();b.setMask();b.appWin.fireEvent("afterlaunchlunpage");b.layoutDrawn=true},enableButton:function(b,a){if(!b){throw Error("could not get button")}return a?b.enable():b.disable()},getButton:function(a){return this.getTopToolbar().getComponent(a)},onSelectChange:function(){var d=this;var c=d.view.getSelectedItems();var a=d.toolbar.getComponent("defrag_btn");var e=d.actionMenu.getComponent("edit");var h=d.actionMenu.getComponent("clone");var b=d.actionMenu.getComponent("convert");e.disable();h.disable();b.disable();d.enableButton(d.getButton("remove"),d.canDelete(c));if(1===c.length){var g=c[0];var f=(g.get("status")==="defragging");if(!g.isLunOwnedByCinder()){d.enableButton(e,d.canEdit(g))}if(g.isFileLun()&&d.appWin.supportVAAI&&d.appWin.isLio4x){d.enableButton(h,d.canClone(g))}b.setVisible(g.isAdvancedLun()&&d.appWin.supportBtrfsLun);d.enableButton(b,d.canConvert(g));a.setVisible(g.isBtrfsLun()&&g.isThinProvisioningLun()&&!g.isSinkLun());d.enableButton(a,f||d.canDefrag(g));a.menu.getComponent("start").setDisabled(f);a.menu.getComponent("stop").setDisabled(!f)}else{a.setVisible(false)}},setMask:function(){if(this.isVisible()&&0===this.view.store.getCount()){this.body.mask(_T("iscsilun","iscsilun_no_luns"),"syno-ux-mask-info")}if(0<this.view.store.getCount()){this.body.unmask()}},setFocus:function(b){this.view.focusNode(b);this.view.select(b,false,false);var a=Ext.get(b);if(a&&a.getAttribute("aria-expanded")!="true"){this.view.toggleDetail(a,true)}return true},canCreate:function(){var a=this.getButton("create");if(this.appWin.isUpToLunMaxCount()){a.setTooltip(_T("iscsimgr","lun_up_to_max"));return false}if(0===Object.keys(this.canCreateLunTypes).length||(-1===Object.values(this.canCreateLunTypes).indexOf(true))){a.setTooltip(_T("iscsimgr","lun_no_volume"));return false}a.setTooltip();return true},canDelete:function(a){if(0===a.length){return false}return !a.some(function(b){return b.isDeleting()})},canEdit:function(a){return(a&&!a.isActioning()&&!a.cacheMissing()&&!a.cacheCrashed()&&"crashed"!==a.getSpaceStatus(this.appWin.volumes,this.appWin.pools))},canClone:function(a){this.actionMenu.resetTooltip("clone");if(this.appWin.isUpToLunMaxCount()){this.actionMenu.setTooltip("clone",_T("iscsimgr","lun_up_to_max"));return false}if(a&&!a.isSinkLun()&&!a.isActioning()&&!a.isCrashed()&&"crashed"!==a.getSpaceStatus(this.appWin.volumes,this.appWin.pools)){return true}return false},canConvert:function(a){this.actionMenu.resetTooltip("convert");if(this.appWin.isUpToLunMaxCount()){this.actionMenu.setTooltip("convert",_T("iscsimgr","lun_up_to_max"));return false}if(a&&!a.isActioning()&&!a.isCrashed()&&"crashed"!==a.getSpaceStatus(this.appWin.volumes,this.appWin.pools)){return true}return false},canDefrag:function(a){return(a&&!a.isActioning()&&!a.isCrashed()&&"crashed"!==a.getSpaceStatus(this.appWin.volumes,this.appWin.pools))},onCreate:function(){this.openWindow("WizardCreate",{canCreate:this.canCreateLunTypes})},onEdit:function(){var a=this,b=a.view.getSelectedItem();if(!b){return}a.openWindow("Edit",{lun:b})},onDelete:function(){var b=this,a=b.view.getSelectedItems();if(0===a.length){return}b.openWindow("Delete",{luns:a})},onClone:function(){var a=this,b=a.view.getSelectedItem();if(!b){return}a.openWindow("Clone",{lun:b})},onConvert:function(){var a=this,b=a.view.getSelectedItem();if(!b){return}a.openWindow("WizardConvert",{lun:b})},doDefrag:function(c,a){var b=this;b.sendWebAPI({api:"SYNO.Core.ISCSI.LUN",version:1,method:a?"defrag":"stop_defrag",params:{uuid:c.get("uuid")},scope:b,callback:function(d,e){if(!d){SYNO.SDS.iSCSI.Utils.ReportWebapiFailure(this,e)}b.owner.setStatusBusy();b.loaded=false;b.appWin.fireEvent("poll_activate")}})},onDefrag:function(h){var d=this,g=d.view.getSelectedItem(),b=SYNO.SDS.iSCSI.Utils,e,c,f,a;if(!g){return}e=g.getSpace(this.appWin.volumes,this.appWin.pools);f=parseInt(e.size_free_byte,10);c=parseInt(g.get("allocated_size"),10);a='<span class="blue-status" style="font-weight:bold;">'+b.SizeRender(c)+"</span>";d.sendWebAPI({api:"SYNO.Core.ISCSI.LUN",version:1,method:"list_snapshot",params:{src_lun_uuid:g.get("uuid"),is_count_only:true},scope:d,callback:function(i,k){var j;if(i&&k.count>0){if(c>f){d.appWin.getMsgBox().alert(_T("iscsilun","defrag"),String.format(_T("iscsilun","defrag_alert_insufficient_space"),a));return}j=String.format(_T("iscsilun","defrag_confirm_with_snap"),a)}else{j=_T("iscsilun","defrag_confirm_without_snap")}d.appWin.getMsgBox().confirm(_T("iscsilun","defrag"),j,function(l){if("yes"===l){d.doDefrag(g,true)}},this,{yes:{text:_T("common","continue")},no:{text:_T("common","cancel")}})}})},onStopDefrag:function(c){var a=this,b=a.view.getSelectedItem();if(!b){return}a.appWin.getMsgBox().confirm(_T("iscsilun","defrag"),_T("common","task_cancel_confirm"),function(d){if("yes"===d){a.doDefrag(b,false)}})},openWindow:function(b,a){var c=this;var d=new SYNO.SDS.iSCSI.LUN[b](Ext.apply({appWin:c.appWin,owner:c.owner,mainPage:c},a));c.mon(d,"close",function(){if(Ext.isFunction(d.hideFromOwner)){d.hideFromOwner()}if(d.isDataChanged){c.owner.setStatusBusy();c.loaded=false;c.appWin.fireEvent("poll_activate")}},c,{single:true});d.open()}});Ext.define("SYNO.SDS.iSCSI.Snapshot.TakeSnapshot",{extend:"SYNO.SDS.iSCSI.ModalWindow",constructor:function(a){var d=this,b,c=false;d.appWin=a.appWin;d.owner=a.owner;d.luns=a.luns;d.snapshot=a.snapshot;d.connectedLuns=d.getMappedConnectedLuns(d.luns,d.appWin.iscsiTargets.getAll());c=(d.connectedLuns.length>0);b={title:a.title,width:572,height:c?436:250,resizable:false,buttons:[{xtype:"syno_button",btnStyle:"blue",disabled:_S("demo_mode"),tooltip:_S("demo_mode")?_JSLIBSTR("uicommon","error_demo"):"",text:_T("common","alt_apply"),scope:d,handler:d.onSave},{xtype:"syno_button",text:_T("common","alt_cancel"),scope:d,handler:d.onCancel}],items:[d.createForm(c)]};Ext.QuickTips.init();d.callParent([Ext.apply(b,a)])},getMappedConnectedLuns:function(c,a){if(undefined===c||undefined===a){return[]}var b=[];Ext.each(a,function(f){if("connected"!==f.get("status")){return true}for(var d=0;d<f.get("mapped_luns").length;++d){for(var e=0;e<c.length;++e){if(c[e].get("uuid")===f.get("mapped_luns")[d].lun_uuid){if(!(c[e] in b)){b.push(c[e])}}}}});return b},formatLunArray:function(b){if(undefined===b){return""}var c=b.map(function(d){return d.get("name")});var a=(0<c.length)?c.join(", "):"";return a},getForm:function(){return this.getComponent("lunSnapshot").getForm()},onOpen:function(){var a=this;a.callParent(arguments);a.initValues();a.addTip()},addTip:function(){var a=this;SYNO.SDS.Utils.AddTip(a.getForm().findField("lock").getEl(),Ext.util.Format.htmlEncode(_T("iscsilun","snapshot_lock_notify")))},initValues:function(){var a=this;a.getForm().setValues({type:"app"})},onCancel:function(){if(this.getForm().isDirty()){this.getMsgBox().confirm(_T("iscsimgr","app_title"),_T("common","confirm_lostchange"),function(a){if("yes"===a){this.close()}},this);return}this.close()},createForm:function(a){var c=this;var b={xtype:"form",itemId:"lunSnapshot",border:false,trackResetOnLoad:true,defaults:{width:260,labelWidth:200},items:[{xtype:"syno_displayfield",htmlEncode:false,height:8},{xtype:"syno_textfield",name:"desc",itemId:"desc",maxlength:255,fieldLabel:_T("share","share_comment")},{xtype:"syno_combobox",name:"type",hiddenName:"type",itemId:"type",hidden:!a?true:false,fieldLabel:_T("iscsilun","snapshot_method"),store:[["app",_T("iscsilun","snapshot_application_consistent")],["crash",_T("iscsilun","snapshot_crash_consistent")]]},{xtype:"syno_checkbox",name:"lock",itemId:"lock",boxLabel:_T("iscsilun","snapshot_lock"),checked:true},{xtype:"syno_displayfield",htmlEncode:false,width:528,hidden:a?false:true,value:String.format('<span class="red-status"><b>{0}</b>: </span>{1}',_T("widget","attention_status"),String.format(_T("iscsimgr","clone_snapshot_inconsistent_warning_multiple"),'<a id="'+(c.helpLinkId=Ext.id())+'"class="link-font" href="">',"</a>")),listeners:{afterrender:function(d){c.mon(Ext.get(c.helpLinkId),"click",function(e){e.preventDefault();SYNO.SDS.AppLaunch("SYNO.SDS.HelpBrowser.Application",{topic:"SYNO.SDS.iSCSI.Application:iSCSIManager/snapshot.html"},false)},c)}}},{xtype:"syno_displayfield",htmlEncode:false,name:"connected_luns",itemId:"connected_luns",width:410,autoHeight:true,hidden:a?false:true,value:a?String.format('<div ext:qtip="{0}">{1}</div>',c.formatLunArray(c.connectedLuns),c.formatLunArray(c.connectedLuns)):""}]};return b},genParams:function(c,b,a){return{desc:c,type:b,lock:a}},prepareCreateParams:function(b,a,f,c,d){var e;e={api:"SYNO.Core.ISCSI.LUN",method:"take_snapshot",version:1,src_lun_uuid:b,description:f,is_locked:a};if(undefined!==c){Ext.apply(e,{is_app_consistent:c})}if(undefined!==d){Ext.apply(e,{taken_by:d})}return e},onSave:function(){var f=this,e=f.getForm();if(!e.isValid()){return}f.setStatusBusy({text:_T("common","saving")});var h=e.findField("desc").getValue();var c=e.findField("type").getValue();var d=("app"===c);var b=e.findField("lock").getValue();var g="user";var a=[];Ext.each(f.luns,function(k){var j=k.get("uuid");var i=f.prepareCreateParams(j,b,h,d,g);a.push(i)},f);f.sendWebAPI({api:"SYNO.Entry.Request",version:2,method:"request",params:{mode:"parallel",compound:a},scope:f,callback:function(l,j,i){if(!l||j.has_fail){var k=SYNO.SDS.iSCSI.Utils.checkLUNSnapCompoundError.call(f,l,j,i);f.owner.getMsgBox().alert(undefined,k)}f.clearStatusBusy();f.fireEvent("smart_close");f.close()}})}});Ext.define("SYNO.SDS.iSCSI.Snapshot.CloneSnapshot",{extend:"SYNO.SDS.iSCSI.ModalWindow",utils:SYNO.SDS.iSCSI.Utils,constructor:function(a){var c=this,b;c.appWin=a.appWin;c.owner=a.owner;c.lun=a.lun;c.snapshot=a.snapshot;b={title:a.title,width:625,height:500,resizable:false,buttons:[{xtype:"syno_button",btnStyle:"blue",disabled:_S("demo_mode"),tooltip:_S("demo_mode")?_JSLIBSTR("uicommon","error_demo"):"",text:_T("common","alt_apply"),scope:c,handler:c.onSave},{xtype:"syno_button",text:_T("common","alt_cancel"),scope:c,handler:c.onCancel}],items:[c.createForm()]};c.callParent([Ext.apply(b,a)])},getForm:function(){return this.getComponent("snapshotClone").getForm()},onCancel:function(){if(this.getForm().isDirty()){this.getMsgBox().confirm(_T("iscsimgr","app_title"),_T("common","confirm_lostchange"),function(a){if("yes"===a){this.close()}},this);return}this.close()},createForm:function(){var d=this;var a=[[false,_T("common","no")],[true,_T("common","yes")]];var c=d.appWin.supportVAAI;d.cloneInfo=d.prepareCloneInfo();var b={xtype:"form",itemId:"snapshotClone",border:false,trackResetOnLoad:true,fieldWidth:280,labelWidth:280,items:[{xtype:"syno_textfield",name:"name",vtype:"iscsilunname",itemId:"name",maxlength:128,allowBlank:false,fieldLabel:_T("common","name"),value:d.appWin.genNewLunName(),validator:function(e){if(d.appWin.isUniqueLunName(e)){return true}else{return _T("iscsitrg","iscsitrg_lun_name_exists")}}},{xtype:"syno_displayfield",name:"location",itemId:"location",fieldLabel:_T("volume","volume_raid_location"),value:d.cloneInfo.location},{xtype:"syno_displayfield",name:"thin_provision",itemId:"thin_provision",fieldLabel:_T("iscsimgr","space_allocation_type"),value:d.cloneInfo.thin_provision,hidden:!c,store:a},{xtype:"syno_displayfield",name:"extent_based",itemId:"extent_based",fieldLabel:_T("iscsitrg","iscsitrg_vaai"),value:d.cloneInfo.extent_based,hidden:!c},{xtype:"syno_displayfield",name:"size",itemId:"size",fieldLabel:String.format("{0} ({1})",_T("volume","volume_totalsize"),_T("common","size_gb")),value:d.cloneInfo.size}]};return b},prepareCloneInfo:function(){var e=this;var h=e.lun,f=e.appWin.volumes,d=e.appWin.supportVAAI;var c={};var a=e.appWin.iscsiLuns.getById(h.get("uuid"));c.size=e.utils.GetSizeGB(h.get("size"),0);var g,b;Ext.each(f,function(i){if(h.get("vol_path")===i.volume_path){g=parseInt(i.size_free_byte,10);b=i.fs_type;c.location=String.format("{0} ({1}: {2} {3}) - {4}",i.display_name,_T("volume","volume_freesize"),e.utils.GetSizeGB(g,0),_T("common","size_gb"),b);return true}});if(d){c.thin_provision=h.get("thin_provision")?_T("iscsitrg","iscsitrg_thin_provisioning"):_T("iscsimgr","iscsitrg_thick_provisioning");c.extent_based=a.getAdvFeatureDesc()}return c},onSave:function(){var b=this,a=b.getForm();if(!a.isValid()){return}b.setStatusBusy({text:_T("common","saving")});var c={src_lun_uuid:b.lun.get("uuid"),snapshot_uuid:b.snapshot.uuid,cloned_lun_name:a.findField("name").getValue()};b.sendWebAPI({api:"SYNO.Core.ISCSI.LUN",version:1,method:"clone_snapshot",params:c,scope:b,callback:function(e,d){b.clearStatusBusy();if(!e){SYNO.SDS.iSCSI.Utils.ReportWebapiFailure(this,d)}else{b.close()}}})}});Ext.define("SYNO.SDS.iSCSI.Snapshot.Edit",{extend:"SYNO.SDS.iSCSI.ModalWindow",constructor:function(a){var c=this,b;c.appWin=a.appWin;c.owner=a.owner;c.luns=a.luns;c.snapshot=a.snapshot;b={title:a.title,width:450,height:250,resizable:false,buttons:[{xtype:"syno_button",btnStyle:"blue",disabled:_S("demo_mode"),tooltip:_S("demo_mode")?_JSLIBSTR("uicommon","error_demo"):"",text:_T("common","alt_apply"),scope:c,handler:c.onSave},{xtype:"syno_button",text:_T("common","alt_cancel"),scope:c,handler:c.onCancel}],items:[c.createForm()]};Ext.QuickTips.init();c.callParent([Ext.apply(b,a)])},formatLunArray:function(b){if(undefined===b){return""}var c=b.map(function(d){return d.get("name")});var a=(0<c.length)?c.join(", "):"";return a},getForm:function(){return this.getComponent("lunSnapshot").getForm()},onOpen:function(){var a=this;a.callParent(arguments);a.initValues();a.addTip()},addTip:function(){var a=this;SYNO.SDS.Utils.AddTip(a.getForm().findField("lock").getEl(),Ext.util.Format.htmlEncode(_T("iscsilun","snapshot_lock_notify")))},initValues:function(){var b=this,a;a=new Date(b.snapshot.time*1000);b.getForm().setValues(b.snapshot);b.getForm().setValues({time:SYNO.SDS.DateTimeFormatter(a,{type:"datetimesec"})})},genNewSnapShotName:function(c){var b="SnapShot-",a=b.length,d=0;Ext.each(c,function(e){var f=parseInt(e.name.slice(a),10);if(d<f){d=f}});d=d+1;return b+d},onCancel:function(){if(this.getForm().isDirty()){this.getMsgBox().confirm(_T("iscsimgr","app_title"),_T("common","confirm_lostchange"),function(a){if("yes"===a){this.close()}},this);return}this.close()},createForm:function(){var a={xtype:"form",itemId:"lunSnapshot",border:false,trackResetOnLoad:true,defaults:{width:250,labelWidth:150},items:[{xtype:"syno_textfield",name:"desc",itemId:"desc",maxlength:255,fieldLabel:_T("share","share_comment")},{xtype:"syno_combobox",name:"type",hiddenName:"type",itemId:"type",hidden:true,fieldLabel:_T("iscsilun","snapshot_method"),store:[["app",_T("iscsilun","snapshot_application_consistent")],["crash",_T("iscsilun","snapshot_crash_consistent")]]},{xtype:"syno_checkbox",name:"lock",itemId:"lock",boxLabel:_T("iscsilun","snapshot_lock"),checked:true}]};return a},genParams:function(c,b,a){return{desc:c,type:b,lock:a}},prepareEditParams:function(d,a,b,f,c){var e={api:"SYNO.Core.Storage.iSCSILUN",method:"snapshot",version:1,mode:"edit",lid:d,sid:a,desc:f,type:c,lock:b};return e},onSave:function(){var h=this,c=h.getForm();if(!c.isDirty()){h.close();return}if(!c.isValid()){return}h.setStatusBusy({text:_T("common","saving")});var e=c.findField("desc").getValue();var i=c.findField("type").getValue();var j=c.findField("lock").getValue();var d=[];var a=h.luns[0];var f=a.data.lid;var b=h.snapshot.sid;var g=h.prepareEditParams(f,b,j,e,i);d.push(g);h.sendWebAPI({api:"SYNO.Entry.Request",version:2,method:"request",params:{mode:"parallel",compound:d},scope:h,callback:function(n,l,k){if(!n||l.has_fail){var m=SYNO.SDS.iSCSI.Utils.checkLUNSnapCompoundError.call(h,n,l,k);h.owner.getMsgBox().alert(undefined,m)}h.clearStatusBusy();h.close()}})}});Ext.define("SYNO.SDS.iSCSI.Snapshot.LUNSnapList",{extend:"SYNO.SDS.iSCSI.ModalWindow",constructor:function(a){var c=this,b;c.appWin=a.appWin;c.owner=a.owner;c.lun=a.lun;c.canManage=SYNO.SDS.iSCSI.Utils.LunCanManage(c.lun);c.launchfrom3rd=a.launchfrom3rd||false;c.snapshotuuidfrom3rd=a.snapshotuuidfrom3rd;c.isOwnedByCinder=c.isLunOwnedByCinder();c.launched3rd=false;b={title:a.title,layout:"fit",items:[],minWidth:760,minHeight:450,width:760,height:450,useStatusBar:false,closable:true};c.callParent([Ext.apply(b,a)])},initComponent:function(){this.items.push(this.createPanel());this.callParent(arguments)},getGrid:function(){return this.get("lunSnapshots")},getSelections:function(){return this.getGrid().getSelectionModel().getSelections()},getSelected:function(){return this.getGrid().getSelectionModel().getSelected()},getButton:function(a){return this.getGrid().getTopToolbar().get(a)},initEvents:function(){this.callParent(arguments)},onSelectionChange:function(f){var c=this,b=f.getCount(),d=false;var a=c.lun.get("volume_crashed");var e=SYNO.SDS.iSCSI.Utils.LunCanManage(c.lun);f.selections.items.each(function(g){if("Healthy"!==g.data.status.type&&"Unhealthy"!==g.data.status.type){d=true;return false}});c.getButton("btDelete").disable();c.getButton("btEdit").disable();c.getButton("btRestore").disable();c.getButton("btClone").disable();c.getButton("btClone").setTooltip();if(0!==b&&false===d&&!a&&e){c.getButton("btDelete").enable()}if(1===b&&false===d&&!a&&e){c.getButton("btEdit").enable()}if(1===b&&!c.isLunActioning()&&!c.isSinkLun()){c.getButton("btRestore").enable()}if(1===b){if(c.appWin.isUpToLunMaxCount()){c.getButton("btClone").setTooltip(_T("iscsimgr","lun_up_to_max"))}else{c.getButton("btClone").enable()}}return},onOpen:function(){var a=this;a.callParent(arguments);a.startPollingTask()},onCancel:function(){this.close()},startPollingTask:function(){var a=this;if(!Ext.isDefined(a.storePollingTask)){a.storePollingTask=a.addWebAPITask({api:"SYNO.Core.Storage.iSCSILUN",method:"load_snapshot",version:1,params:{lid:a.lun.get("lid")},interval:5000,callback:function(c,b){if(!c){SYNO.SDS.iSCSI.Utils.ReportWebapiFailure(a,b);return}a.loadGrid({data:b});if(a.launchfrom3rd&&!a.launched3rd){a.snapshotCheckingAndCloneFrom3rdApp(b)}}})}if(true!==a.storePollingTask.running){a.setLoadingMask();a.storePollingTask.start()}},stopPollingTask:function(){var a=this.storePollingTask;if(Ext.isDefined(a)&&true===a.running){a.stop()}},setLoadingMask:function(){this.setStatusBusy({text:_T("common","loading")});this.loadingMask=true},clearLoadingMask:function(){var a=this;if(true===a.loadingMask){a.clearStatusBusy();a.loadingMask=false}},loadGrid:function(d){var c=this,a,b;if(undefined===c.getGrid()){return}a=c.getGrid().getStore();a.loadData(d);b=c.getGrid().getTopToolbar().get("search").getValue();if(""!==b){a.filter("desc",b,true)}c.clearLoadingMask()},createPanel:function(){var e=this;var a=new Ext.data.JsonStore({autoDestroy:true,pruneModifiedRecords:true,sortInfo:{field:"snapshot_time",direction:"DESC"},idProperty:"sid",root:"data",fields:["sid","uuid","desc","snapshot_time","status","canClone","type","lock","is_locked_by_app","total_size"]});e.store=a;var d=[{id:"snapshot_time",header:_T("time","time_time"),dataIndex:"snapshot_time",width:170,renderer:function(i){var h=new Date(i*1000);return SYNO.SDS.DateTimeFormatter(h,{type:"datetimesec"})}},{id:"snapshot_method",header:_T("iscsilun","snapshot_method"),dataIndex:"type",width:160,renderer:function(h){return("app"===h?_T("iscsilun","snapshot_application_consistent"):_T("iscsilun","snapshot_crash_consistent"))}},{id:"desc",header:_T("share","share_comment"),dataIndex:"desc",width:190,renderer:SYNO.SDS.iSCSI.Utils.TipRender},{id:"status",header:_T("iscsitrg","iscsitrg_status"),dataIndex:"status",width:70,renderer:SYNO.SDS.Utils.StorageUtils.UiRenderHelper.SnapShotStatusRender},{id:"lock",header:_T("iscsilun","snapshot_lock"),dataIndex:"lock",width:45,renderer:SYNO.SDS.iSCSI.Utils.UIRender.lockIconRenderer}];var g={defaultType:"syno_button",items:[{text:_T("iscsilun","clone"),itemId:"btClone",handler:this.snapshotClone,disabled:true,scope:this},{text:_T("common","remove"),itemId:"btDelete",handler:this.snapshotDelete,hidden:this.isOwnedByCinder,disabled:true,scope:this},{text:_T("iscsilun","restore"),itemId:"btRestore",handler:this.snapshotRestore,hidden:this.isOwnedByCinder,disabled:true,scope:this},{text:_T("common","alt_edit"),itemId:"btEdit",handler:this.snapshotEdit,hidden:this.isOwnedByCinder,disabled:true,scope:this},"->",new SYNO.SDS.iSCSI.Lun.TextFilter({iconStyle:"filter",itemId:"search",store:a,localFilter:true,localFilterField:"desc"})]};var f=new SYNO.ux.PageLessToolbar({store:e.store,displayInfo:true,showRefreshBtn:false});var c={forceFit:true,onLoad:Ext.emptyFn,listeners:{beforerefresh:function(h){h.scrollTop=h.scroller.dom.scrollTop},refresh:function(h){h.scroller.dom.scrollTop=h.scrollTop}}};var b={layout:"fit",xtype:"syno_gridpanel",itemId:"lunSnapshots",style:{padding:"0px 12px 0px 16px"},tbar:g,bbar:f,store:a,columns:d,selModel:new Ext.grid.RowSelectionModel({singleSelect:false,listeners:{selectionchange:e.onSelectionChange,scope:e}}),listeners:{scope:e,activate:e.onActivate,rowdblclick:{scope:e,fn:function(i,k,j){var h=e.store.getAt(k);if(h&&e.canManage){e.snapshotEdit()}}}},enableHdMenu:false,autoExpandColumn:"desc",viewConfig:c,enableColumnMove:false,cls:"without-dirty-red-grid"};return b},isLunActioning:function(){return this.lun.get("is_actioning")},isSinkLun:function(){return("sink"===this.lun.get("device_type"))},isLunOwnedByCinder:function(){return("cinder"===this.lun.get("used_by"))},snapshotClone:function(){var a=this.getSelected().data;this.doSnapshotClone(a)},snapshotDelete:function(){var a=this;a.getMsgBox().confirmDelete(a.title,String.format("{0}<br>{1}",_T("common","remove_cfrmrmv"),_T("iscsilun","space_reclamation_warning")),function(b){if("yes"===b){a.doSnapshotDelete()}},a)},snapshotRestore:function(){var c=this,e=c.getSelected(),a=SYNO.SDS.DateTimeFormatter(new Date(e.get("snapshot_time")*1000),{type:"datetimesec"}),d='<span class="red-status">'+String.format(_T("iscsilun","restore_data_lost_warning"),a)+"</span><br/>"+String.format(_T("iscsilun","snapshot_restore_confirm"),a);if(SYNO.SDS.iSCSI.Utils.IsAnyMappedTargetConnected(c.lun.get("uuid"),c.appWin.iscsiTargets.getAll())){var b=String.format('<span class="red-status"> {0} </span><br/><br/>',String.format(_T("iscsilun","online_restore_warning"),c.lun.get("name")));d=b+d}if(!e.get("canClone")){c.getMsgBox().alert(c.title,_T("iscsitrg","iscsitrg_set_failed_space_not_enough"));return}if("sink"===c.lun.get("device_type")){c.getMsgBox().alert(c.title,_T("iscsilun","dr_readonly_register_message"));return}c.getMsgBox().confirm(c.title,d,function(f){if("yes"===f){c.snapshotCheckingAndRestore()}})},snapshotEdit:function(){var c=this,a=c.getSelected().data;var b=new SYNO.SDS.iSCSI.Snapshot.Edit({owner:c,appWin:c.appWin,title:_T("common","alt_edit")+" - "+c.lun.get("name"),luns:[c.lun],snapshot:a});c.mon(b,"destroy",function(){c.startPollingTask()},c,{single:true});c.stopPollingTask();b.open()},snapshotCheckingAndCloneFrom3rdApp:function(c){var b=this,a;Ext.each(c,function(d){if(d.uuid===b.snapshotuuidfrom3rd){a=d;return false}});if(undefined!==a){b.launched3rd=true;b.doSnapshotClone(a)}},snapshotCheckingAndRestore:function(){var a=this,b=a.getSelected();if(b.get("total_size")>=parseInt(a.lun.get("size"),10)){a.doSnapshotRestore()}else{this.sendWebAPI({api:"SYNO.Core.ISCSI.Replication",version:1,method:"list",params:{lun_uuid:a.lun.get("uuid")},scope:this,callback:function(e,d){if(e){if(d.tasks.length>0){var c=_T("iscsitrg","iscsitrg_restore_to_smaller_size_with_replication");this.getMsgBox().confirm(this.title,c,function(f){if("yes"===f){a.doSnapshotRestore()}})}else{a.doSnapshotRestore()}}}})}},doSnapshotRestore:function(){var a=this,b=a.getSelected();a.setStatusBusy({text:_T("common","msg_waiting")});a.sendWebAPI({api:"SYNO.Core.Storage.iSCSILUN",version:1,method:"snapshot",params:{mode:"restore",lid:a.lun.get("lid"),sid:b.get("sid")},callback:function(d,c){a.clearStatusBusy();if(!d){SYNO.SDS.iSCSI.Utils.ReportWebapiFailure(a,c);return}a.isDataChanged=true;a.fireEvent("smart_close");a.close()}})},doSnapshotDelete:function(){var b=this,c=b.getSelections(),a=[];b.setStatusBusy({text:_T("common","saving")});c.each(function(d){a.push(d.get("sid"))});b.stopPollingTask();this.sendWebAPI({api:"SYNO.Core.Storage.iSCSILUN",version:1,method:"snapshot",params:{mode:"delete",lid:b.lun.get("lid"),sids:a},callback:function(h,e){var d=[];var f=0;var g;b.clearStatusBusy();if(!h){b.startPollingTask();SYNO.SDS.iSCSI.Utils.ReportWebapiFailure(this,e);return}b.isDataChanged=true;c.each(function(i){if(i.get("is_locked_by_app")){d[f]=[];d[f][i.get("snapshot_time")]=3337;f++}});if(d.length){g=new SYNO.SDS.iSCSI.Snapshot.MultiDeleteError({appWin:b.appWin,owner:b,title:_T("share","share_snapshot_delete_failed"),errorData:d,listeners:{close:function(){b.startPollingTask()}}});g.open()}else{b.startPollingTask()}},scope:b})},doSnapshotClone:function(a){var b=this;if(!a.canClone){b.getMsgBox().alert(b.title,_T("iscsitrg","iscsitrg_set_failed_space_not_enough"));return}var c=new SYNO.SDS.iSCSI.Snapshot.CloneSnapshot({appWin:b.appWin,owner:b,lun:b.lun,snapshot:a,title:_T("iscsilun","clone")});b.mon(c,"close",function(){b.appWin.setStatusBusy();b.sendWebAPI({api:"SYNO.Core.Storage.iSCSILUN",method:"list",version:1,params:{blSink:true,offset:0,limit:-1},scope:b,callback:function(f,e,d){if(f){b.appWin.processLunData(e.luns)}b.appWin.clearStatusBusy()}})},b,{single:true});c.open()},reportFailure:function(a){this.getMsgBox().alert(this.title,a.text)}});Ext.define("SYNO.SDS.iSCSI.Snapshot.Configure.Main",{extend:"SYNO.SDS.iSCSI.ModalWindow",constructor:function(a){var d=this,b=[];var e=false;d.owner=a.owner;d.appWin=a.appWin;d.luns=a.luns;d.multiple=(1<d.luns.length);d.maxSnapshot=d.appWin.maxSnapshotPerLun;b.push(new SYNO.SDS.iSCSI.Snapshot.Configure.Schedule({appWin:d.appWin,owner:d}));b.push(new SYNO.SDS.iSCSI.Snapshot.Configure.Retention({appWin:d.appWin,owner:d,type:"Lun",showKeepAll:d.multiple,isCreate:false}));b.push(new SYNO.SDS.iSCSI.Snapshot.Configure.LunApplication({appWin:d.appWin,owner:d,multiple:d.multiple}));Ext.each(d.luns,function(f){if("sink"===f.get("device_type")){e=true;return false}},d);d.tabPanel=new SYNO.SDS.Utils.TabPanel({appWin:d.appWin,owner:d.owner,activeTab:0,items:b});var c={items:[d.tabPanel],width:690,height:460,minWidth:690,minHeight:460,resizable:false,buttons:[{xtype:"syno_button",btnStyle:"blue",text:_T("common","alt_apply"),scope:d,handler:d.onSave},{xtype:"syno_button",text:_T("common","alt_cancel"),scope:d,handler:d.onCancel}]};d.callParent([Ext.apply(c,a)]);d.getiSCSILunScheData();if(e){d.tabPanel.get("scheduleSnapshot").setDisabled(true);d.tabPanel.get("lunApplication").setDisabled(true);d.tabPanel.setActiveTab("retentionSnapshot")}},getForm:function(a){return this.tabPanel.getItem(a).getForm()},setTargetConf:function(){var a=this;a.setStatusBusy({text:_T("common","saving")});a.setiSCSILunConf()},onSave:function(){var c=this,e=c.tabPanel.get("retentionSnapshot");if(!e.isValid()){c.tabPanel.setActiveTab("retentionSnapshot");return}var a=e.getRetention().policyType;var d=c.getForm("scheduleSnapshot").findField("enable_schedule").getValue();var b=(SYNO.SDS.iSCSI.RTT_KEEP_ALL!==a)&&(SYNO.SDS.iSCSI.RTT_ALL!==a);if(e.isDirty()){c.getMsgBox().confirm(undefined,_T("snapmgr","run_retention_immed"),function(f){if("ok"===f){c.setTargetConf()}},c,Ext.MessageBox.OKCANCEL)}else{if(d&&!b){c.getMsgBox().confirm(undefined,_T("snapmgr","ret_setting_remind"),function(f){if("ok"===f){c.tabPanel.setActiveTab("retentionSnapshot")}else{c.setTargetConf()}},c,{ok:{text:Ext.MessageBox.buttonText.ok},cancel:{text:_T("common","skip")}})}else{c.setTargetConf()}}},geniSCSILunConfWebapi:function(f,e,c,a){var d=this;var g=(c)?d.taskMap[f].schedule:e;var b={api:"SYNO.Core.Storage.iSCSILUN",method:"set_sched_snapshot",version:1,lid:f,general:d.getGeneralData(f,a),schedule:g};return b},setiSCSILunConf:function(){var d=this,e=d.getScheData();var b=d.getForm("scheduleSnapshot").findField("schedule_keep_all").getValue();var a=d.getForm("lunApplication").findField("application_keep_all").getValue();if(b&&a){d.setRetention();return}var c=[];Ext.each(d.luns,function(f){c.push(d.geniSCSILunConfWebapi(f.get("lid"),e,b,a))},d);d.sendWebAPI({api:"SYNO.Entry.Request",method:"request",version:2,params:{mode:"parallel",compound:c},scope:d,callback:function(i,g,f){if(!i||g.has_fail){var h=_T("iscsimgr","err_set_sche");d.clearStatusBusy();d.getMsgBox().alert(_T("common","common_settings"),h,function(){d.close()},d);return false}else{d.setRetention()}}})},onCancel:function(){this.close()},genRetentionTaskMap:function(d,c){var b=this;b.rttTaskMap={};if(d.result.length!==c.compound.length){return false}for(var a=0;a<d.result.length;a++){b.rttTaskMap[c.compound[a].name]=d.result[a].data.tid}return true},genShareTaskMap:function(d,c){var b=this;b.taskMap={};if(d.result.length!==c.compound.length){return false}for(var a=0;a<d.result.length;a++){b.taskMap[c.compound[a].name]=d.result[a].data.task_id}return true},genLunTaskMap:function(a){var d=this;d.taskMap={};for(var c=0;c<a.length;c++){var b=a[c].data[0].general;d.taskMap[b.lid]={};d.taskMap[b.lid].tid=b.tid;d.taskMap[b.lid].task_name=b.task_name;d.taskMap[b.lid].snap_type=b.snap_type;d.taskMap[b.lid].schedule=a[c].data[0].schedule}},genLoadSchedSnapshotWebapi:function(a){return{api:"SYNO.Core.Storage.iSCSILUN",version:1,method:"load_sched_snapshot",lid:a}},genLoadPluginWebapi:function(){return{api:"SYNO.Core.ISCSI.Node",version:1,method:"get",additional:["plugin_info"]}},getiSCSILunScheData:function(){var b=this;var a=[];Ext.each(b.luns,function(c){a.push(b.genLoadSchedSnapshotWebapi(c.get("lid")))},b);a.push(b.genLoadPluginWebapi());b.setStatusBusy({text:_T("common","msg_waiting")});b.sendWebAPI({api:"SYNO.Entry.Request",method:"request",version:2,params:{mode:"parallel",compound:a},scope:b,callback:function(h,e,d){var g={};if(!h||e.has_fail){var f=_T("iscsimgr","err_get_sche");b.clearStatusBusy();b.getMsgBox().alert(_T("common","common_settings"),f,function(){b.close()},b);return}else{var c=[];e.result.each(function(i){if(true===SYNO.ux.Utils.checkApiConsistency(b.genLoadPluginWebapi(),i)){b.tabPanel.getItem("lunApplication").updateNASTpl(i)}else{if(true===SYNO.ux.Utils.checkApiConsistency(b.genLoadSchedSnapshotWebapi(),i)){c.push(i)}}});b.tabPanel.items.each(function(i){if(!b.multiple){b.processLunResp(c[0].data[0],g);if(Ext.isFunction(i.updateScheData)){i.updateScheData(g)}}else{if(Ext.isFunction(i.loadDefaultData)){i.loadDefaultData()}}},b);b.genLunTaskMap(c);b.getRetention()}}})},processLunResp:function(b,a){a.enable_snapshot_schedule=b.general.task_enabled;a.enable_app_consist=("crash"===b.general.snap_type)?false:true;a.schedule=b.schedule},updateLunListPanel:function(){var a=this;a.sendWebAPI({api:"SYNO.Core.Storage.iSCSILUN",method:"list",version:1,params:{blSink:true,offset:0,limit:-1},scope:a,callback:function(d,c,b){if(d){a.appWin.processLunData(c.luns)}a.clearStatusBusy();a.close()}})},genSetRetentionWebapi:function(b,c){var a={api:"SYNO.DisasterRecovery.Retention",method:"set",version:1,type:"Lun",name:b};Ext.apply(a,c);Ext.apply(a,{tid:this.rttTaskMap[b]});return a},setRetention:function(){var b=this,d=b.tabPanel.get("retentionSnapshot");if(!d.isDirty()){b.updateLunListPanel();return}var c=Ext.apply({type:"Lun"},d.getRetention());var a=b.luns.map(function(e){return b.genSetRetentionWebapi(e.get("lid").toString(),c)});b.sendWebAPI({api:"SYNO.Entry.Request",method:"request",version:2,params:{mode:"sequential",compound:a},scope:b,callback:function(g,f,e){if(!g||f.has_fail){b.clearStatusBusy();b.getMsgBox().alert(undefined,_T("snapmgr","err_set_ret_policy"));return}else{b.updateLunListPanel()}}})},getRetention:function(){var a=this;a.sendWebAPI({compound:{stopwhenerror:true,mode:"parallel",params:a.luns.map(function(b){return{api:"SYNO.DisasterRecovery.Retention",method:"get",version:1,params:{type:"Lun",name:b.get("lid").toString()}}})},scope:a,callback:function(d,c,b){a.clearStatusBusy();if(!d||c.has_fail){a.getMsgBox().alert(undefined,_T("snapmgr","err_get_ret_policy"),function(){a.close()},a);return}else{a.tabPanel.items.each(function(e){if(Ext.isFunction(e.updateRetData)){if(1===b.compound.length){e.updateRetData(c.result[0].data)}else{e.loadDefaultData()}}},a);a.genRetentionTaskMap(c,b)}}})},getGeneralData:function(d,a){var c=this,b={};var f=c.tabPanel.getItem("scheduleSnapshot").getForm(),e=c.tabPanel.getItem("lunApplication").getForm();b.task_enabled=f.findField("enable_schedule").getValue();if(a){b.snap_type=c.taskMap[d].snap_type}else{b.snap_type=e.findField("enable_app_consist").getValue()?"app":"crash"}b.task_name=c.taskMap[d].task_name;b.tid=c.taskMap[d].tid;return b},getScheData:function(){var c=this,b=c.tabPanel.getItem("scheduleSnapshot"),a={};a.date_type=0;a.week_name=Ext.getCmp(b.week_name_id).getValue();a.hour=Ext.getCmp(b.hour_id).getValue();a.min=Ext.getCmp(b.min_id).getValue();a.repeat_hour=Ext.getCmp(b.repeat_hour_id).getValue()%100;a.repeat_min=parseInt(Ext.getCmp(b.repeat_hour_id).getValue()/100,10);a.last_work_hour=Ext.getCmp(b.last_work_hour_id).getValue();return a}});Ext.define("SYNO.SDS.iSCSI.Snapshot.Configure.Schedule",{extend:"SYNO.SDS.TaskScheduler2.EditSchedulePanel",constructor:function(a){var b=this;b.callParent(arguments);b.mon(b,"afterlayout",b.setEnableCheckGroup,b,{single:true})},fillConfig:function(d){var e=this;var g=[],c=[],b=0;for(b=0;b<24;++b){g.push([String.leftPad(String(b),2,"0"),b])}for(b=0;b<60;++b){c.push([String.leftPad(String(b),2,"0"),b])}var h=new Ext.data.ArrayStore({fields:["display","value"],data:g});var f=new Ext.data.ArrayStore({fields:["display","value"],data:c});e.addManagedComponent(h);e.addManagedComponent(f);e.repeat_hour_store=new Ext.data.ArrayStore({fields:["display","value"]});e.addManagedComponent(e.repeat_hour_store);e.last_work_hour_store=new Ext.data.ArrayStore({fields:["display","value"]});e.addManagedComponent(e.last_work_hour_store);var a={title:_T("common","schedule"),itemId:"scheduleSnapshot",border:false,height:480,MinInterval:[5,15,30],HourInterval:[1,2,3,4,6,8,12],items:[{xtype:"syno_checkbox",name:"schedule_keep_all",id:e.schedule_keep_all_id=Ext.id(),boxLabel:_T("iscsimgr","sche_keep_all"),checked:false,hidden:true},{xtype:"syno_checkbox",name:"enable_schedule",id:e.enable_schedule_id=Ext.id(),boxLabel:_T("iscsilun","snapshot_schedule_enable")},{xtype:"syno_compositefield",fieldLabel:_T("iscsimgr","sche_exec_day"),labelWidth:180,width:200,indent:1,items:[{xtype:"syno_schedulefield",id:e.week_name_id=Ext.id(),hideLabel:true,allowBlank:false,editable:false,width:200}]},{xtype:"syno_combobox",store:e.repeat_hour_store,value:0,fieldLabel:_T("iscsimgr","sche_repeat_every"),labelWidth:180,displayField:"display",valueField:"value",id:e.repeat_hour_id=Ext.id(),triggerAction:"all",width:200,mode:"local",editable:false,indent:1,listeners:{select:{fn:function(){e.updateMinComboBox();e.updateLastWorkTimeStore()},scope:e},enable:{fn:function(){e.updateMinComboBox();e.updateLastWorkHourComboBox()},scope:e,delay:5}}},{xtype:"syno_compositefield",fieldLabel:_T("iscsimgr","sche_start_at"),labelWidth:180,width:200,indent:1,items:[{xtype:"syno_combobox",store:h,displayField:"display",id:e.hour_id=Ext.id(),valueField:"value",triggerAction:"all",mode:"local",width:90,editable:false,listeners:{select:{fn:function(){e.updateRepeatHourStore();e.updateMinComboBox();e.updateLastWorkTimeStore()},scope:e}}},{xtype:"syno_displayfield",value:":",width:10,style:{"text-align":"center"}},{xtype:"syno_combobox",store:f,displayField:"display",id:e.min_id=Ext.id(),valueField:"value",triggerAction:"all",mode:"local",width:90,editable:false,listeners:{select:{fn:function(){e.updateRepeatHourStore();e.updateLastWorkTimeStore()},scope:e}}}]},{xtype:"syno_combobox",store:e.last_work_hour_store,value:0,labelWidth:180,fieldLabel:_T("iscsimgr","sche_repeat_until"),displayField:"display",valueField:"value",id:e.last_work_hour_id=Ext.id(),triggerAction:"all",width:200,mode:"local",editable:false,indent:1}]};Ext.apply(a,d);return a},updateMinComboBox:function(){var b=this;var a=Math.floor(Ext.getCmp(b.repeat_hour_id).getValue()/100);if(a>0){Ext.getCmp(b.min_id).setValue(0);Ext.getCmp(b.min_id).setDisabled(true)}else{Ext.getCmp(b.min_id).setDisabled(false)}},updateLastWorkHourComboBox:function(){var d=this,b=Math.floor(Ext.getCmp(d.repeat_hour_id).getValue()/100),a=Ext.getCmp(d.repeat_hour_id).getValue()%100;var e=(b===0&&a===0);var c=Ext.getCmp(d.repeat_hour_id).disabled;Ext.getCmp(d.last_work_hour_id).setDisabled(e||c)},updateLastWorkTimeStore:function(){var h=this,a=-1,f=[],k=Ext.getCmp(h.hour_id).getValue(),j=Ext.getCmp(h.min_id).getValue(),d=Math.floor(Ext.getCmp(h.repeat_hour_id).getValue()/100),b=Ext.getCmp(h.repeat_hour_id).getValue()%100,e=Ext.getCmp(h.last_work_hour_id).getValue();if(d>0){b=1}h.updateLastWorkHourComboBox();for(var c=k;c<24;c+=b){var g=String.leftPad(String(c),2,"0")+":";if(0<d){g+=String.leftPad(String(60-d),2,"0")}else{g+=String.leftPad(String(j),2,"0")}f.push([g,c]);if(c===e){a=c}if(0===b){break}}h.last_work_hour_store.loadData(f);if(-1===a){Ext.getCmp(h.last_work_hour_id).setValue(f[f.length-1][1])}else{Ext.getCmp(h.last_work_hour_id).setValue(a)}if(0<d){Ext.getCmp(h.last_work_hour_id).setValue(f[f.length-1][1])}if(h.last_work_hour_store.totalLength>0){Ext.getCmp(h.last_work_hour_id).setValue(h.last_work_hour_store.getAt(h.last_work_hour_store.totalLength-1).data.value)}},loadDefaultData:function(){var a=this;Ext.getCmp(a.schedule_keep_all_id).show();Ext.getCmp(a.schedule_keep_all_id).setValue(true);a.updateScheData({schedule:SYNO.SDS.iSCSI.Utils.GetDailySchedule(0)})},updateScheData:function(b){var a=this,c=b.schedule;Ext.getCmp(a.week_name_id).setValue(c.week_name);a.form.findField("enable_schedule").setValue(b.enable_snapshot_schedule);Ext.getCmp(a.hour_id).setValue(c.hour);Ext.getCmp(a.min_id).setValue(c.min);a.updateRepeatHourStore();Ext.getCmp(a.repeat_hour_id).setValue(c.repeat_hour+c.repeat_min*100);a.updateLastWorkTimeStore();Ext.getCmp(a.last_work_hour_id).setValue(c.last_work_hour)},setEnableCheckGroup:function(){var a=this;a.dummy1=new SYNO.ux.Utils.EnableCheckGroup(a.form,"enable_schedule",[a.week_name_id,a.hour_id,a.min_id,a.repeat_hour_id,a.last_work_hour_id]);a.dummy2=new SYNO.ux.Utils.EnableCheckGroup(a.form,"schedule_keep_all",[],[a.enable_schedule_id])},onDestroy:function(){Ext.destroy(this.dummy1);Ext.destroy(this.dummy2);this.callParent()}});Ext.define("SYNO.SDS.iSCSI.Snapshot.Configure.Retention",{extend:"SYNO.ux.FormPanel",constructor:function(b){var e=this;e.appWin=b.appWin;e.maxSnapshot=e.appWin.maxSnapshotPerLun;e.supportTimeTrigger=b.appWin.supportTimeTrigger;e.isAdvDirty=false;Ext.apply(e,{MAX_RET_RECENTLY:e.maxSnapshot,MIN_RET_RECENTLY:1});e.ret_trigger_time_store=new Ext.data.ArrayStore({fields:["display","value"]});var a=[],d;for(d=0;d<24;d++){var f=String.format(d<10?"0{0}:00":"{0}:00",d);a.push([f,d])}a.push([_T("snapmgr","ret_trigger_after_snap"),-1]);e.ret_trigger_time_store.loadData(a);var c={title:_T("snapmgr","ret_title"),itemId:"retentionSnapshot",trackResetOnLoad:true,items:[{xtype:"syno_displayfield",value:_T("snapmgr","ret_desp")},{xtype:"syno_radio",name:"policyType",id:e.ret_keep_all=Ext.id(),boxLabel:_T("snapmgr","ret_keep_all"),inputValue:SYNO.SDS.iSCSI.RTT_KEEP_ALL,listeners:{check:function(h,g){if(g){e.adjustUIComps(SYNO.SDS.iSCSI.RTT_KEEP_ALL)}},scope:e},hidden:!b.showKeepAll},{xtype:"syno_radio",name:"policyType",id:e.ret_all=Ext.id(),boxLabel:_T("snapmgr","ret_all_desc"),inputValue:SYNO.SDS.iSCSI.RTT_ALL,listeners:{check:function(h,g){if(g){e.adjustUIComps(SYNO.SDS.iSCSI.RTT_ALL)}},scope:e}},{xtype:"syno_radio",name:"policyType",id:e.ret_del_old_deprecated=Ext.id(),boxLabel:String.format(_T("snapmgr","ret_del_old_summary"),e.maxSnapshot),inputValue:SYNO.SDS.iSCSI.RTT_DEL_OLD_DEPRECATED,listeners:{check:function(h,g){if(g){e.adjustUIComps(SYNO.SDS.iSCSI.RTT_DEL_OLD_DEPRECATED)}},scope:e},hidden:true},{xtype:"syno_compositefield",hideLabel:true,height:28,id:e.ret_del_old_comp=Ext.id(),items:[{xtype:"syno_radio",name:"policyType",id:e.ret_del_old=Ext.id(),boxLabel:_T("snapmgr","ret_del_old"),inputValue:SYNO.SDS.iSCSI.RTT_DEL_OLD,listeners:{check:function(h,g){if(g){e.adjustUIComps(SYNO.SDS.iSCSI.RTT_DEL_OLD)}},scope:e}},{xtype:"syno_displayfield",width:2,value:""},{xtype:"syno_numberfield",name:"recently",id:e.ret_recently_id=Ext.id(),value:e.maxSnapshot,width:51,minValue:e.MIN_RET_RECENTLY,maxValue:e.MAX_RET_RECENTLY,maxLength:e.countDigitLength(e.MAX_RET_RECENTLY),enableKeyEvents:true,listeners:{keypress:function(h,g){if(!this.isValid()&&this.el.dom.selectionStart===this.el.dom.selectionEnd&&this.getRawValue()!==""){g.stopEvent()}},disable:function(){this.reset()}}}]},{xtype:"syno_compositefield",hideLabel:true,height:28,id:e.ret_adv_field=Ext.id(),items:[{xtype:"syno_radio",name:"policyType",id:e.ret_adv=Ext.id(),boxLabel:_T("snapmgr","ret_adv"),inputValue:SYNO.SDS.iSCSI.RTT_POL_TIME,listeners:{check:function(h,g){if(g){e.adjustUIComps(SYNO.SDS.iSCSI.RTT_POL_TIME)}},scope:e}},{xtype:"syno_button",id:e.ret_adv_btn=Ext.id(),text:_T("snapmgr","setting"),listeners:{disable:function(){e.isAdvDirty=false}},scope:e,handler:e.onAdvance}]},{xtype:"syno_displayfield",id:e.ret_trigger_time_title=Ext.id(),value:_T("snapmgr","snap_ret_trigger_time")},{xtype:"syno_combobox",store:e.ret_trigger_time_store,id:e.ret_trigger_time=Ext.id(),width:160,hideLabel:true,editable:false,displayField:"display",valueField:"value",value:e.supportTimeTrigger?2:-1,disabled:!e.supportTimeTrigger,mode:"local",triggerAction:"all",listeners:{disable:function(){this.reset()},afterrender:function(h){var g=new Ext.util.TextMetrics.createInstance(h.getEl());h.setWidth(39+g.getWidth(_T("snapmgr","ret_trigger_after_snap")))}},scope:e},{id:e.ret_note=Ext.id(),xtype:"syno_displayfield",htmlEncode:false,value:SYNO.SDS.iSCSI.Utils.NoteRenderer(_T("iscsilun","space_reclamation_warning"))}],bbar:{xtype:"syno_panel",padding:"0px 10px 14px 0px",items:[{cls:"iscsi-retention-descpanel",xtype:"syno_displayfield",value:String.format(_T("snapmgr","ret_desc_lun"),e.maxSnapshot)}]}};e.callParent([Ext.apply(c,b)]);e.mon(e,"activate",e.adjustPanelSize,e);e.mon(e,"afterlayout",function(){var g={};g[SYNO.SDS.iSCSI.RTT_KEEP_ALL]=[];g[SYNO.SDS.iSCSI.RTT_ALL]=[];g[SYNO.SDS.iSCSI.RTT_DEL_OLD]=[e.ret_recently_id];g[SYNO.SDS.iSCSI.RTT_DEL_OLD_DEPRECATED]=[];g[SYNO.SDS.iSCSI.RTT_POL_TIME]=[e.ret_adv_btn];e.dummy=new SYNO.ux.Utils.EnableRadioGroup(e.form,"policyType",g);SYNO.SDS.Utils.AddTip(Ext.getCmp(e.ret_all).getEl(),Ext.util.Format.htmlEncode(_T("snapmgr","ret_all_tip")));e.ret_trigger_time_tip=SYNO.SDS.Utils.AddTip(Ext.getCmp(e.ret_trigger_time).getEl(),Ext.util.Format.htmlEncode(_T("snapmgr","snap_ret_trigger_time_desc")))},e,{single:true})},adjustPanelSize:function(){this.setHeight(this.owner.getInnerHeight()-34)},showTimeTrigger:function(){var a=this;Ext.getCmp(a.ret_trigger_time_title).show();Ext.getCmp(a.ret_trigger_time).show();Ext.getCmp(a.ret_note).show();a.ret_trigger_time_tip.show()},hideTimeTrigger:function(){var a=this;Ext.getCmp(a.ret_trigger_time_title).hide();Ext.getCmp(a.ret_trigger_time).hide();Ext.getCmp(a.ret_note).hide();a.ret_trigger_time_tip.hide()},adjustUIComps:function(a){var b=this;if(!b.supportTimeTrigger||SYNO.SDS.iSCSI.RTT_ALL===a){Ext.getCmp(b.ret_trigger_time).setDisabled(true);b.hideTimeTrigger()}else{b.showTimeTrigger();Ext.getCmp(b.ret_trigger_time).setDisabled(SYNO.SDS.iSCSI.RTT_KEEP_ALL===a)}},isValid:function(){var b=this,a=b.getRetention(),c=true;if(SYNO.SDS.iSCSI.RTT_POL_TIME&a.policyType){c=(b.maxSnapshot>=a.hourly+a.daily+a.weekly+a.monthly+a.yearly)}return b.form.isValid()&&c},isDirty:function(){var a=this;return !Ext.getCmp(a.ret_keep_all).getValue()&&(a.form.isDirty()||a.isAdvDirty)},countDigitLength:function(a){if(undefined===a||isNaN(a)){return -1}return a.toString().length},updateRetData:function(b){var a=this;a.loadData(b)},getRetention:function(){var d=this,c={isEnabled:true,policyType:parseInt(d.form.getValues().policyType,10)};Ext.apply(c,d.getAdvData());if(false===Ext.getCmp(d.ret_del_old_comp).isVisible()){if(SYNO.SDS.iSCSI.RTT_DEL_OLD===c.policyType){c.policyType=SYNO.SDS.iSCSI.RTT_DEL_OLD_DEPRECATED}}else{c.recently=Ext.getCmp(d.ret_recently_id).getValue()}var a=Ext.getCmp(d.ret_trigger_time);var b=a.getValue();if(-1!==b){if(!a.disabled){c.policyType|=SYNO.SDS.iSCSI.RTT_TRRIGER_BY_TIME}c.tid=-1;c.schedule=SYNO.SDS.iSCSI.Utils.GetDailySchedule(b)}return c},setInitialValue:function(b,a){Ext.getCmp(b).setValue(a);Ext.getCmp(b).originalValue=a},loadData:function(c){var b=this,a;if(SYNO.SDS.iSCSI.RTT_KEEP_ALL===c.policyType){b.setInitialValue(b.ret_trigger_time,b.supportTimeTrigger?2:-1)}else{if(SYNO.SDS.iSCSI.RTT_ALL===c.policyType){if(c.schedule&&(undefined!==c.schedule.hour)){b.setInitialValue(b.ret_trigger_time,c.schedule.hour)}else{b.setInitialValue(b.ret_trigger_time,b.supportTimeTrigger?2:-1)}}else{if(SYNO.SDS.iSCSI.RTT_TRRIGER_BY_TIME&c.policyType){b.setInitialValue(b.ret_trigger_time,c.schedule.hour)}else{b.setInitialValue(b.ret_trigger_time,-1)}}}a=c.policyType&(~SYNO.SDS.iSCSI.RTT_TRRIGER_BY_TIME);switch(a){case SYNO.SDS.iSCSI.RTT_ALL:b.setInitialValue(b.ret_all,true);break;case SYNO.SDS.iSCSI.RTT_POL_TIME:b.setInitialValue(b.ret_adv,true);break;case SYNO.SDS.iSCSI.RTT_DEL_OLD:b.setInitialValue(b.ret_del_old,true);break;case SYNO.SDS.iSCSI.RTT_DEL_OLD_DEPRECATED:b.setInitialValue(b.ret_del_old_deprecated,true);c.policyType=SYNO.SDS.iSCSI.RTT_DEL_OLD;c.recently=b.maxSnapshot;break;case SYNO.SDS.iSCSI.RTT_KEEP_ALL:b.setInitialValue(b.ret_keep_all,true);break}b.ret_hourly=c.hourly;b.ret_daily=c.daily;b.ret_weekly=c.weekly;b.ret_monthly=c.monthly;b.ret_yearly=c.yearly;b.init_hourly=c.hourly;b.init_daily=c.daily;b.init_weekly=c.weekly;b.init_monthly=c.monthly;b.init_yearly=c.yearly;b.setInitialValue(b.ret_recently_id,c.recently)},loadDefaultAdvData:function(){var a=this;if(undefined===a.init_hourly||undefined===a.init_daily||undefined===a.init_weekly||undefined===a.init_monthly||undefined===a.init_yearly){a.ret_hourly=a.isHourlyFieldDisabled?0:24;a.ret_daily=7;a.ret_weekly=2;a.ret_monthly=1;a.ret_yearly=1}else{a.ret_hourly=a.init_hourly;a.ret_daily=a.init_daily;a.ret_weekly=a.init_weekly;a.ret_monthly=a.init_monthly;a.ret_yearly=a.init_yearly}},getAdvData:function(){var a=this;if(!a.isAdvDirty){a.loadDefaultAdvData()}return{hourly:a.ret_hourly,daily:a.ret_daily,weekly:a.ret_weekly,monthly:a.ret_monthly,yearly:a.ret_yearly}},loadDefaultData:function(){var a=this;Ext.getCmp(a.ret_keep_all).show();a.loadData({hourly:24,daily:7,weekly:2,monthly:1,policyType:SYNO.SDS.iSCSI.RTT_KEEP_ALL,yearly:1,recently:a.maxSnapshot,tid:-1,schedule:SYNO.SDS.iSCSI.Utils.GetDailySchedule(2)})},onAdvance:function(){var b=this;var a={appWin:b.appWin,owner:b.owner,isCreate:b.isCreate,maxSnapshot:b.maxSnapshot,isHourlyFieldDisabled:b.isHourlyFieldDisabled};Ext.apply(a,b.getAdvData());var c=new SYNO.SDS.iSCSI.SmartRetention(a);b.mon(c,"ret_adv_edited",b.onAdvanceEdited,b,{single:true});c.open()},onAdvanceEdited:function(a){var b=this;b.isAdvDirty=true;b=Ext.apply(b,a)},onDestroy:function(){Ext.destroy(this.dummy);this.callParent()}});Ext.define("SYNO.SDS.iSCSI.Snapshot.Configure.LunApplication",{extend:"SYNO.ux.Panel",constructor:function(a){var d=this;d.multiple=a.multiple;var c="https://www.synology.com/en-global/support/download/"+_D("upnpmodelname","");var e=String.format(_T("iscsimgr","appaware_link"),'<a href="'+c+'" target="_blank">',"</a>");d.nasTpl=d.createNASTpl();var b={title:_T("backup","application"),itemId:"lunApplication",items:[{xtype:"syno_formpanel",height:100,itemId:d.form_id=Ext.id(),items:[{xtype:"syno_checkbox",name:"application_keep_all",id:d.application_keep_all_id=Ext.id(),boxLabel:_T("iscsimgr","application_keep_all"),checked:d.multiple,hidden:!d.multiple},{xtype:"syno_checkbox",name:"enable_app_consist",id:d.enable_app_consist_id=Ext.id(),boxLabel:_T("iscsimgr","appaware_desc")},{xtype:"syno_displayfield",htmlEncode:false,value:e}]},{xtype:"syno_displayfield",itemId:"nasPanel",height:200,autoScroll:true,value:d.nasTpl.html}]};this.callParent([Ext.apply(b,a)]);d.mon(d,"afterlayout",d.setEnableCheckGroup,d,{single:true})},createNASTpl:function(){var b,a;b=new Ext.XTemplate('<tpl if="this.hasValues(values) === false">',String.format('<div style="padding-left:10px;height:28px;line-height:28px">{0}</div>',_T("iscsimgr","no_snapshot_manager")),"</tpl>",'<tpl for=".">','<dl class="iscsi-grid-list-row">','<dt class="iscsi-grid-list-column" style="width:50%">{ip}</dt>','<dt class="iscsi-grid-list-column" style="width:50%">{type}</dt>','<div class="x-clear"></div>',"</dl>","</tpl>");a=new Ext.XTemplate(String.format('<div class="iscsi-grid-section-header">{0}</div>',_T("iscsilun","snapshot_manager_list")),'<div class="iscsi-grid-list">','<div class="iscsi-grid-list-header">','<dl style="padding-left:10px;">',String.format('<dt class="iscsi-grid-list-column" style="width:50%">{0}</dt>',_T("common","ip_addr")),String.format('<dt class="iscsi-grid-list-column" style="width:50%">{0}</dt>',_T("network","interface_type")),'<div class="x-clear"></div>',"</dl>","</div>",'<div class="iscsi-grid-list-body">',b.html,"</div>","</div>",'<div class="x-clear"></div>',{compiled:true,hasValues:function(c){if(!c){return false}return 0<c.length}});Ext.destroy(b);return a},updateNASTpl:function(a){this.nasTpl.overwrite(this.getComponent("nasPanel").getEl(),a.data.plugin_info||"")},getForm:function(){return this.getComponent(this.form_id).getForm()},updateScheData:function(a){Ext.getCmp(this.getForm().findField("enable_app_consist").setValue(a.enable_app_consist))},isAppConsist:function(){var a=this;return a.getForm().findField("enable_app_consist").getValue()},setEnableCheckGroup:function(){var a=this;a.dummy1=new SYNO.ux.Utils.EnableCheckGroup(a.getForm(),"application_keep_all",[],[a.enable_app_consist_id])}});Ext.namespace("SYNO.SDS.iSCSI.Snapshot");Ext.define("SYNO.SDS.iSCSI.Snapshot.Main",{extend:"SYNO.ux.Panel",constructor:function(a){var c=this,b,e=[];c.appWin=a.appWin;c.owner=a.owner;c.loaded=false;c.list=new SYNO.SDS.iSCSI.ListDataView({appWin:c.appWin,owner:c,multiSelect:true,singleSelect:false,store:new SYNO.SDS.iSCSI.LunList.Store(),progressTpl:SYNO.SDS.iSCSI.ProgressTpl(),innerTpl:SYNO.SDS.iSCSI.SnapshotTpl(),listeners:{selectionchange:c.onSelectionChange,scope:c}});e.push({itemId:"snapshot_menu",text:_T("iscsilun","snapshot"),disabled:true,menu:{items:[{itemId:"take_snapshot",text:_T("iscsilun","take_snapshot"),handler:c.onTakeSnapshot,disabled:true,scope:c},{itemId:"manage",text:_T("iscsimgr","snap_list"),handler:c.onManage,disabled:true,scope:c}]}},{itemId:"configure",text:_T("common","common_settings"),handler:c.onConfigure,disabled:true,scope:c},{itemId:"replication",text:_T("iscsimgr","replication"),handler:c.onReplication,disabled:("no"===_D("support_dr_snap","no")),scope:c});var d=new SYNO.SDS.iSCSI.Snapshot.SearchField({appWin:c.appWin,owner:c,allDisaplayText:_T("iscsimgr","snap_lun_all")});b={title:_T("tree","leaf_iscsilun"),border:false,layout:"fit",tbar:{defaultType:"syno_button",items:[e,"->",d]},items:[c.list],listeners:{activate:c.onActivate,data_ready:c.onDataReady,scope:c}};c.callParent([Ext.apply(b,a)])},onActivate:function(){var a=this;if(!a.loaded){a.appWin.setStatusBusy(null,null,50)}a.appWin.fireEvent("poll_activate")},onDataReady:function(){this.loadData(this.appWin.iSCSILuns)},loadData:function(d){var e=this;var a=e.list.store;var f=[],b="",c="protected";if(!e.loaded){e.appWin.clearStatusBusy();e.loaded=true}a.suspendEvents(true);a.loadData(d);c=e.getTopToolbar().get("searchShareName").getSearchFilter();b=e.getTopToolbar().get("searchShareName").getSearchText();if("protected"===c){f.push({property:"isProtected",value:true,anyMatch:true})}else{if(c!==null&&c!==SYNO.SDS.iSCSI.STATUS_ALL){f.push({property:"statusCategory",value:c,anyMatch:true})}}if(""!==b){f.push({property:"name",value:b,anyMatch:true})}if(f.length>0){a.filter(f)}a.resumeEvents();if(0<a.getCount()&&0===e.list.getSelectedItemIds().length){e.list.select(0,true,true)}e.setMask();e.onSelectionChange();e.appWin.fireEvent("afterlaunchpage")},onSelectionChange:function(){var d=this,b=d.list.getSelectedRecords();d.getButton("snapshot_menu").setDisabled(false);d.getButton("snapshot_menu").menu.get("take_snapshot").setDisabled(false);d.getButton("snapshot_menu").menu.get("manage").setDisabled(false);d.getButton("replication").setDisabled(false);d.getButton("configure").setDisabled(false);var a=true,g=true,f=false,c=true,e=false;Ext.each(b,function(h){a=a&&h.get("volume_crashed");g=g&&h.get("support_snapshot");f=f||SYNO.SDS.iSCSI.Utils.lunCanSnapshot(h);c=c&&("sink"===h.get("device_type"));e=e||SYNO.SDS.iSCSI.Utils.LunCanManage(h)});if(!f||a){d.getButton("snapshot_menu").menu.get("take_snapshot").setDisabled(true)}if((0!==b.length)&&c){d.getButton("snapshot_menu").menu.get("take_snapshot").setDisabled(true)}if(!g||0===b.length){d.getButton("snapshot_menu").setDisabled(true);d.getButton("configure").setDisabled(true);d.getButton("replication").setDisabled(true)}if(!e){d.getButton("snapshot_menu").menu.get("take_snapshot").setDisabled(true);d.getButton("configure").setDisabled(true)}if(0===b.length){d.getButton("snapshot_menu").setDisabled(true)}if(1<b.length){d.getButton("snapshot_menu").menu.get("manage").setDisabled(true)}},setMask:function(){if(this.isVisible()&&0===this.list.store.getCount()){this.body.mask(_T("iscsilun","iscsilun_no_luns"),"syno-ux-mask-info")}if(0<this.list.store.getCount()){this.body.unmask()}},getButton:function(a){return this.getTopToolbar().get(a)},checkSelected:function(a,c){var d=this;var b=c.call(d,a);if(0<b.length){var h=_T("iscsimgr","selected_targets_operation_deny");var f=b.map(function(i){return i.get("name")},d);var g=f.filter(function(k,i,j){return j.indexOf(k)===i},d);var e=(0<g.length)?g.join(", "):"";d.owner.getMsgBox().alert("Operations not allowed",h+"<br><br>"+e,function(){d.deselectRecords(b)},d);return false}return true},deselectRecords:function(a){var c=this,b=c.list.getSelectedRecords();Ext.each(b,function(e){var d=a.find(function(f){return e.id===f.id});if(d){c.list.deselect(e)}});c.doLayout()},checkTakeSnapshot:function(a){var c=this,b=[];Ext.each(a,function(e){var d=e.get("volume_crashed");var h=e.get("support_snapshot");var f=("sink"===e.get("device_type"));var g=SYNO.SDS.iSCSI.Utils.lunCanSnapshot(e);var i=SYNO.SDS.iSCSI.Utils.LunCanManage(e);if(d||!h||f||!g||!i){b.push(e)}},c);return b},onTakeSnapshot:function(){var a=this;a.records=a.list.getSelectedRecords();if(!a.checkSelected(a.records,a.checkTakeSnapshot)){return}var b=new SYNO.SDS.iSCSI.Snapshot.TakeSnapshot({appWin:a.appWin,owner:a.appWin,luns:a.records,title:_T("iscsilun","take_snapshot")});a.mon(b,"smart_close",function(e){var d=a.appWin.iSCSILuns;Ext.each(a.records,function(f){Ext.each(d,function(g){if(f.data.id==g.id){g.displayProg="show";g.snapStatus=String.format("&nbsp;-&nbsp;{0}",'<font class="blue-status">'+_T("iscsimgr","status_processing")+"</font>")}})});a.loadData(d);var c=function(){a.sendWebAPI({api:"SYNO.Core.Storage.iSCSILUN",method:"list",version:1,params:{blSink:true,is_include_blun:true,offset:0,limit:-1},scope:a,callback:function(h,g,f){if(h){a.appWin.processLunData(g.luns);if(0<=a.appWin.iSCSILuns.length){a.onDataReady()}}a.appWin.clearStatusBusy()}})};a.appWin.setStatusBusy();setTimeout(c,500)},a,{single:true});b.open()},onManage:function(){var a=this;a.record=a.list.getSelectedRecords();var b=new SYNO.SDS.iSCSI.Snapshot.LUNSnapList({appWin:a.appWin,owner:a.appWin,title:_T("iscsimgr","snap_list")+" - "+a.record[0].get("name"),lun:a.record[0]});a.mon(b,"smart_close",function(e){var d=a.appWin.iSCSILuns;Ext.each(d,function(f){if(a.record[0].data.id==f.id){f.displayProg="show";f.snapStatus=String.format("&nbsp;-&nbsp;{0}",'<font class="blue-status">'+_T("iscsimgr","status_processing")+"</font>")}});a.loadData(d);var c=function(){a.sendWebAPI({api:"SYNO.Core.Storage.iSCSILUN",method:"list",version:1,params:{blSink:true,is_include_blun:true,offset:0,limit:-1},scope:a,callback:function(h,g,f){if(h){a.appWin.processLunData(g.luns);if(0<=a.appWin.iSCSILuns.length){a.onDataReady()}}a.appWin.clearStatusBusy()}})};a.appWin.setStatusBusy();setTimeout(c,500)},a,{single:true});b.open()},checkConfigure:function(a){var c=this,b=[];Ext.each(a,function(e){var d=e.get("volume_crashed");var g=e.get("support_snapshot");var f=SYNO.SDS.iSCSI.Utils.lunCanSnapshot(e);var h=SYNO.SDS.iSCSI.Utils.LunCanManage(e);if(d||!g||!f||!h){b.push(e)}},c);return b},onConfigure:function(){var b=this;var a=b.list.getSelectedRecords();if(!b.checkSelected(a,b.checkConfigure)){return}var c=new SYNO.SDS.iSCSI.Snapshot.Configure.Main({appWin:b.appWin,owner:b.appWin,luns:a,title:_T("common","common_settings")});c.open()},onReplication:function(){var b=this,a;b.owner.setStatusBusy();b.sendWebAPI({api:"SYNO.Core.Package",method:"get",version:1,params:{additional:["status"],id:"SnapshotReplication"},callback:function(d,c){if(d){a=("running"===c.additional.status)}else{a=false}b.owner.clearStatusBusy();b.launchApp(a)}})},launchApp:function(a){if(a){SYNO.SDS.AppLaunch("SYNO.SDS.DisasterRecovery.Application",{fn:"SYNO.SDS.DisasterRecovery.Replication.Main",dlg:"CreateReplicationTaskMain",params:{targetType:1}})}else{SYNO.SDS.AppLaunch("SYNO.SDS.PkgManApp.Instance",{action:"open",packages:["SnapshotReplication"]})}}});Ext.define("SYNO.SDS.iSCSI.Setting.Main",{extend:"SYNO.SDS.Utils.FormPanel",API:SYNO.SDS.iSCSI.Utils.API,constructor:function(a){this.appWin=a.appWin;this.owner=a.owner;this.callParent([this.fillConfig(a)]);this.suspendLcwPrompt=true},fillConfig:function(a){var d=this;var e=false;Ext.each(d.appWin.iscsiLuns.getAll(),function(f){if(f.isAdvancedLun()){e=true;return false}},d);var c=[{xtype:"syno_fieldset",title:"iSNS (Internet Storage Name Service)",itemId:"isns_fieldset",name:"isns_fieldset",id:"isns_fieldset",items:[{xtype:"syno_checkbox",boxLabel:_T("iscsitrg","iscsitrg_isns_enable"),name:"isns_enabled",id:d.isns_enabled=Ext.id(),listeners:{check:function(h,g){var f=Ext.getCmp(d.isns_address);if(!g){f.reset()}f.setDisabled(!g)}}},{xtype:"syno_textfield",name:"isns_address",fieldLabel:_T("router_networktools","server"),emptyText:String.format("{0}, {1}",_T("common","ip_addr"),_T("mailstation","mailstation_fqdn")),indent:1,disabled:true,allowBlank:true,id:d.isns_address=Ext.id(),validator:function(f){return d.isAddrValid(f)}}]},{xtype:"syno_fieldset",title:_T("iscsimgr","io_queue_length"),itemId:"ioqueue_fieldset",name:"ioqueue_fieldset",id:"ioqueue_fieldset",hidden:!d.appWin.isLio4x,items:[{xtype:"syno_displayfield",value:_T("iscsimgr","io_queue_length_desc")},{xtype:"syno_combobox",name:"io_queue_length",fieldLabel:"I/O",hiddenName:"io_queue_length",itemId:"io_queue_length",store:[[1,1],[16,String.format("{0} ({1})",16,_T("common","default"))],[64,64],[128,128]]}]},{xtype:"syno_fieldset",title:_T("iscsimgr","lun_low_capacity_write_header"),itemId:"lcw",name:"lcw",id:"lcw",hidden:!d.appWin.isLio4x,items:[{xtype:"syno_checkbox",boxLabel:_T("iscsimgr","lun_low_capacity_write_enable"),name:"lcw_enabled",id:d.lcw_enabled=Ext.id(),listeners:{check:d.promptLcwDialog,scope:d}},{xtype:"syno_displayfield",indent:1,value:String.format(_T("iscsimgr","lun_low_capacity_write_desc"),String.format('<a target="_blank" rel="noopener noreferrer" href="{0}">',SYNO.SDS.iSCSI.READONLY_HELP_WEB_LINK),"</a>",'<span class="red-status">',"</span>"),htmlEncode:false}]}];c.push({xtype:"syno_fieldset",title:_T("rsrcmonitor","performance_event"),itemId:"perf_fieldset",name:"perf_fieldset",id:"perf_fieldset",hidden:!d.owner.supportPerfEvent,items:[{xtype:"syno_displayfield",htmlEncode:false,value:String.format(_T("iscsimgr","call_resource_monitor_desc"),'<a class="link-font" style="cursor:pointer">',"</a>"),listeners:{afterrender:d.addLink},isDirty:function(){return false}}]});c.push({xtype:"syno_fieldset",title:_T("iscsimgr","ep_buf_unmap_mode_title"),itemId:"unmap_mode_fieldset",name:"unmap_mode_fieldset",id:"unmap_mode_fieldset",hidden:!e,items:[{xtype:"syno_displayfield",value:_T("iscsimgr","ep_buf_unmap_mode_desc")},{xtype:"syno_combobox",name:"ep_unmap_buf_mode",fieldLabel:_T("iscsimgr","ep_buf_unmap_mode_field_label"),hiddenName:"ep_unmap_buf_mode",itemId:"ep_unmap_buf_mode",store:[[1,_T("iscsimgr","ep_buf_unmap_mode_io")],[2,String.format("{0} ({1})",_T("iscsimgr","ep_buf_unmap_mode_reclaim_balanced"),_T("common","default"))],[3,_T("iscsimgr","ep_buf_unmap_mode_space_reclaim")]]}]});var b={title:_T("common","common_settings"),autoScroll:true,useDefaultBtn:true,labelWidth:200,fieldWidth:240,webapi:{api:"SYNO.Core.ISCSI.Node",methods:{get:"get",set:"set"},version:1,params:{get:{additional:["no_rod_key","isns_info","io_queue_length","ep_unmap_buf_mode","tp_hard_threshold_bytes"]}}},items:c,listeners:{activate:function(){this.suspendLcwPrompt=true;d.loadForm()},deactivate:function(){return !d.isFormDirty()}},processReturnData:function(k,j,h){for(var f=0;f<j.result.length;f++){var g=j.result[f];if("set"===g.method&&!g.success){this.appWin.getMsgBox().alert(this.title,this.API.getErrorString(g.error))}else{if("get"===g.method&&g.success){this.appWin.setTpHardThreshold(g.data.tp_hard_threshold_bytes);g.data.lcw_enabled=SYNO.SDS.iSCSI.TP_HARD_THRESHOLD_MAX_SIZE>g.data.tp_hard_threshold_bytes?true:false;delete g.data.tp_hard_threshold_bytes}}}SYNO.SDS.iSCSI.Setting.Main.superclass.processReturnData.call(d,k,j,h);d.suspendLcwPrompt=false;d.doLayout()},processParams:function(j,h){if("set"===j&&h[0].params){var g=h[0].params.lcw_enabled;var f=h[0].params.isns_enabled;var i=Ext.getCmp(d.isns_address).getValue();if(!f){h[0].params.isns_address=i?i:""}h[0].params.tp_hard_threshold_bytes=g?SYNO.SDS.iSCSI.TP_HARD_THRESHOLD_MIN_SIZE:SYNO.SDS.iSCSI.TP_HARD_THRESHOLD_MAX_SIZE;delete h[0].params.lcw_enabled}return SYNO.SDS.iSCSI.Setting.Main.superclass.processParams.call(d,j,h)}};Ext.apply(b,a);return b},isFQDN:function(b){var a=/(?=^.{1,254}$)(^(?:(?!\d+\.|-)[a-zA-Z0-9_\-]{1,63}\.)*(?:[a-zA-Z]{2,})$)/;return a.test(b)},isAddrValid:function(a){return Ext.form.VTypes.looseip(a)||this.isFQDN(a)},addLink:function(e){var c=this;var a=e.el.query("a")[0];var b=Ext.get(a);var d=function(){SYNO.SDS.AppLaunch("SYNO.SDS.ResourceMonitor.Instance",{fn:"SYNO.SDS.ResourceMonitor.Setting.Tab"})};c.mon(b,"click",d,c)},promptLcwDialog:function(c,b){var a=this;if(!b||a.suspendLcwPrompt){return}SYNO.SDS.Desktop.getMsgBox().show({title:a.title,msg:_T("iscsimgr","lun_low_capacity_write_dialog"),buttons:{yes:{text:Ext.MessageBox.buttonText.yes,btnStyle:"red"},no:{text:Ext.MessageBox.buttonText.no}},fn:function(d){if("yes"!==d){this.form.findField("lcw_enabled").reset()}},scope:a,icon:Ext.MessageBox.ERRORRED,minWidth:Ext.MessageBox.minWidth})}});Ext.define("SYNO.SDS.iSCSI.Log.Main",{extend:"SYNO.ux.GridPanel",itemsPerPage:1000,constructor:function(a){var c=this,b;Ext.apply(c,a);b=c.fillConfig(a);c.itemsPerPage=c.appWin.appInstance.getUserSettings(c.itemId+"-dsPageLimit")||c.itemsPerPage;c.callParent([b]);c.mon(c,"resize",function(d,f,e){c.updateFbarItems(f)},c)},getPageRecordStore:function(){var a=new Ext.data.SimpleStore({fields:["value","display"],data:[[100,100],[500,500],[1000,1000],[3000,3000]]});return a},onChangeDisplayRecord:function(d,e,b){var c=this,a=c.logStore;if(c.itemsPerPage!==d.getValue()){c.itemsPerPage=d.getValue();c.paging.pageSize=c.itemsPerPage;a.load({params:{offset:0,limit:c.itemsPerPage}});c.appWin.appInstance.setUserSettings(c.itemId+"-dsPageLimit",c.itemsPerPage)}},initPageComboBox:function(a){var b=new SYNO.ux.ComboBox({name:"page_rec",hiddenName:"page_rec",hiddenId:Ext.id(),store:a,displayField:"display",valueField:"value",triggerAction:"all",value:this.itemsPerPage,editable:false,width:72,mode:"local",listeners:{select:{fn:this.onChangeDisplayRecord,scope:this}}});return b},initPagingToolbar:function(){var a=new SYNO.ux.PagingToolbar({store:this.logStore,displayInfo:true,pageSize:this.itemsPerPage,showRefreshBtn:true,items:["-",_T("common","items_perpage"),this.initPageComboBox(this.getPageRecordStore()),"-",{xtype:"tbtext",text:"",itemId:"infoLevel"},"-",{xtype:"tbtext",text:"",itemId:"warnLevel"},"-",{xtype:"tbtext",text:"",itemId:"errorLevel"},"-"]});return a},initSearchForm:function(){var a=new SYNO.SDS.iSCSI.SearchFormPanel({cls:"syno-sds-fs-search-panel",renderTo:Ext.getBody(),shadow:false,hidden:true,owner:this});return a},initToolbar:function(){var b=this,a=new SYNO.ux.Toolbar();b.clearButton=new SYNO.ux.Button({xtype:"syno_button",text:_TT("SYNO.SDS.LogCenter.Instance","logview","btn_clear"),handler:b.onLogClear,scope:b});b.exportButton=new SYNO.ux.SplitButton({xtype:"syno_splitbutton",text:_TT("SYNO.SDS.LogCenter.Instance","logview","btn_export"),handler:b.onExportHtml,scope:b,menu:{items:[{text:_T("log","html_type"),handler:b.onExportHtml,scope:b},{text:_T("log","csv_type"),handler:b.onExportCSV,scope:b}]}});b.searchField=new SYNO.SDS.iSCSI.AdvancedSearchField({iconStyle:"filter",owner:b});b.searchField.searchPanel=b.searchPanel;a.add(b.clearButton);a.add(b.exportButton);a.add("->");a.add(b.searchField);return a},initEvents:function(){this.mon(this.searchPanel,"search",this.onSearch,this);this.mon(this,"activate",this.onActive,this)},loadException:function(){this.appWin.clearStatusBusy();this.body.mask(_T("log","no_log_available"),"iscsi-no-hover")},onBeforeStoreLoad:function(a,b){this.body.unmask();this.appWin.setStatusBusy()},onAfterStoreLoad:function(a,f,c){var e=this,d,b='<div class="{0}" style="width:40px;" ext:qtip="{1}">{2}</div>';e.appWin.clearStatusBusy();if(f.length<1){e.body.mask(_T("log","no_log_available"),"iscsi-no-hover")}else{e.body.unmask()}d=a.reader.jsonData;e.setLogLevelText(e.getInfoCompoent(),b,"syno-log-info",_T("log","info_level"),d.summary.info_count);e.setLogLevelText(e.getWarnCompoent(),b,"syno-log-warn",_T("log","warn_level"),d.summary.warn_count);e.setLogLevelText(e.getErrorCompoent(),b,"syno-log-err",_T("log","error_level"),d.summary.error_count);e.setPagingToolbar(a,e.paging);this.enableButtonCheck()},getStore:function(){var a=new SYNO.API.Store({api:"SYNO.Core.ISCSI.Node",version:1,method:"log_list",baseParams:{keyword:""},appWindow:this.appWin,sortInfo:{field:"time",direction:"DESC"},remoteSort:false,reader:new Ext.data.JsonReader({idProperty:"id",root:"logs",totalProperty:"summary.total",fields:[{name:"log_level",mapping:"log_level"},{name:"time",mapping:"time"},{name:"user",mapping:"user"},{name:"event",mapping:"event"}]}),listeners:{exception:this.loadException,beforeload:this.onBeforeStoreLoad,load:this.onAfterStoreLoad,scope:this}});return a},logLevelRenderer:function(a){switch(a){case"err":return"<span class='red-status'>Error</span>";case"warning":return"<span class='orange-status'>Warning</span>";case"info":return"<span class='green-status'>Information</span>";default:return"Undefined"}},htmlTimeRender:function(b){var a=new Date(b*1000);return SYNO.SDS.DateTimeFormatter(a,{type:"datetimesec"})},getColumnModel:function(){var a=new Ext.grid.ColumnModel({columns:[{header:_TT("SYNO.SDS.LogCenter.Instance","logattr","attr_priority"),dataIndex:"log_level",width:100,align:"center",sortable:true,renderer:this.logLevelRenderer},{header:_T("log","log_time"),dataIndex:"time",width:150,align:"center",sortable:true,renderer:this.htmlTimeRender},{header:_T("log","log_account"),dataIndex:"user",width:100,align:"center",sortable:true,renderer:SYNO.SDS.iSCSI.Utils.htmlEncodeRender},{id:"descr",header:_T("log","log_action"),dataIndex:"event",css:"white-space:normal;",width:300,renderer:SYNO.SDS.iSCSI.Utils.htmlEventEncodeRender}],defaults:{sortable:false,menuDisabled:false}});return a},fillConfig:function(a){var c=this;c.searchPanel=c.initSearchForm();c.logStore=c.getStore();c.paging=c.initPagingToolbar();var b={border:false,trackResetOnLoad:true,layout:"fit",itemId:"iscsi_log",tbar:c.initToolbar(),enableColumnMove:false,enableHdMenu:false,bbar:c.paging,store:c.logStore,colModel:c.getColumnModel(),view:new SYNO.ux.FleXcroll.grid.BufferView({rowHeight:27,scrollDelay:30,borderHeight:1,templates:{cell:new Ext.XTemplate('<td class="x-grid3-col x-grid3-cell x-grid3-td-{id} x-selectable {css}" style="{style}" tabIndex="-1" {cellAttr}>','<div class="{this.selectableCls} x-grid3-cell-inner x-grid3-col-{id}" {attr}>{value}</div>',"</td>",{selectableCls:SYNO.SDS.Utils.SelectableCLS})}}),loadMask:true,stripeRows:true};Ext.apply(b,a);return b},isBelong:function(b,a){var c;for(c in a){if(a[c]!==b[c]){return false}}return true},isTheSame:function(b,a){return this.isBelong(b,a)&&this.isBelong(a,b)},onSearch:function(d,e){var c=this,b=c.logStore;if(!c.isTheSame(b.baseParams,e)){if(e.date_from){e.date_from=Date.parseDate(e.date_from,SYNO.SDS.DateTimeUtils.GetDateFormat())/1000}if(e.date_to){var a=Date.parseDate(e.date_to,SYNO.SDS.DateTimeUtils.GetDateFormat());a.setDate(a.getDate()+1);e.date_to=(a/1000)-1}b.baseParams=e;c.loadData()}},setUnread:function(){var a=this;a.sendWebAPI({api:"SYNO.Core.ISCSI.Node",version:1,method:"log_list",params:{additional:["update_unread"]},scope:a})},onActive:function(){this.loadData();this.setUnread()},enableButtonCheck:function(){var a=this.logStore;if(!a.getTotalCount()){this.exportButton.disable();this.clearButton.disable()}else{this.exportButton.enable();this.clearButton.enable()}},loadData:function(){var a=this.logStore,b={offset:0,limit:this.itemsPerPage};a.load({params:b});this.enableButtonCheck()},setLogLevelText:function(b,a,c,e,d){if(b){d=d||"0";b.setText(String.format(a,c,e,d))}},getInfoCompoent:function(){return this.paging.getComponent("infoLevel")},getWarnCompoent:function(){return this.paging.getComponent("warnLevel")},getErrorCompoent:function(){return this.paging.getComponent("errorLevel")},setPagingToolbar:function(a,b){this.setPagingToolbarVisible(b,a.getTotalCount()>this.itemsPerPage)},setPagingToolbarVisible:function(a,b){a.setButtonsVisible(true)},updateFbarItems:function(b){var a=0;if(!this.isVisible()){return}if(b<880){for(a=16;a<23;a++){this.paging.items.get(a).hide()}}else{for(a=16;a<23;a++){this.paging.items.get(a).show()}}},onClearLogDone:function(d,b,c,a){if(d){this.loadData()}else{this.appWin.getMsgBox().alert(this.appWin.title,_T("common","error_system"))}this.appWin.clearStatusBusy()},onLogClear:function(){var a=this;a.appWin.getMsgBox().confirmDelete(a.appWin.title,_T("log","log_cfrm_clear"),function(b){if("yes"===b){a.appWin.setStatusBusy();a.appWin.sendWebAPI({api:"SYNO.Core.ISCSI.Node",version:1,method:"log_clear",callback:a.onClearLogDone,scope:a})}},a)},onExportCSV:function(){this.onLogSave("csv")},onExportHtml:function(){this.onLogSave("html")},onLogSave:function(a){if(_S("demo_mode")){this.appWin.getMsgBox().alert(this.appWin.title,_JSLIBSTR("uicommon","error_demo"));return}this.saveLog(a)},saveLog:function(b){var c=this;var a=c.logStore;c.downloadWebAPI({webapi:{version:1,api:"SYNO.Core.ISCSI.Node",method:"log_export",params:{export_format:b,log_level:a.baseParams.log_level,date_to:a.baseParams.date_to,date_from:a.baseParams.date_from,keyword:a.baseParams.keyword}},scope:c})},destroy:function(){if(this.rowNav){Ext.destroy(this.rowNav);this.rowNav=null}if(this.searchField){this.searchField.fireEvent("destroy")}this.callParent([this])}});Ext.define("SYNO.SDS.iSCSI.Application",{extend:"SYNO.SDS.AppInstance",appWindowName:"SYNO.SDS.iSCSI.MainWindow"});Ext.define("SYNO.SDS.iSCSI.Store",{constructor:function(a){var b=this;b.count=0;b.data={};b.env={};b.dataArray=[];b.callParent([a])},getAll:function(){return this.dataArray},getMatched:function(){var c=this,b,e,a=arguments,d=[];for(b in c.data){if(c.data.hasOwnProperty(b)){e=c.data[b];if(e.check.apply(e,a)){d.push(e)}}}d.sort(function(g,f){g=g.get("id");f=f.get("id");return(g>f)?1:((g<f)?-1:0)});return d},isAnyMatched:function(){var a=arguments;return(undefined!==this.findBy(function(b){return b.check.apply(b,a)}))},findBy:function(a){var c=this,b,d;for(b in c.data){if(c.data.hasOwnProperty(b)){d=c.data[b];if(a(d)){return d}}}return undefined},getById:function(a){return this.data[a]},prepareArray:function(){var b=this,a;for(a in b.data){if(b.data.hasOwnProperty(a)){b.dataArray.push(b.data[a])}}b.dataArray.sort(function(d,c){return(d.get("num_id")>c.get("num_id"))?1:((d.get("num_id")===c.get("num_id"))?0:-1)})}});Ext.define("SYNO.SDS.iSCSI.MainWindow",{extend:"SYNO.SDS.PageListAppWindow",activePage:"SYNO.SDS.iSCSI.Overview.Main",defaultWinSize:{width:1042,height:580},SizeRender:SYNO.SDS.Utils.StorageUtils.UiRenderHelper.SizeRender,pollingInterval:5,webapiTimeGet:{api:"SYNO.Core.Region.NTP",version:1,method:"get"},webapiTrgList:{api:"SYNO.Core.ISCSI.Target",version:1,method:"list",additional:["mapped_lun","acls","connected_sessions","status"]},webapiLunList:{api:"SYNO.Core.Storage.iSCSILUN",version:1,method:"list",blSink:true,is_include_blun:true,offset:0,limit:-1},webapiVolumeList:{api:"SYNO.Core.Storage.Volume",version:1,method:"list",limit:-1,offset:0,location:"all"},webapiPoolList:{api:"SYNO.Core.Storage.Pool",version:1,method:"list",limit:-1,offset:0},webapiiSCSILunList:{api:"SYNO.Core.ISCSI.LUN",version:1,method:"list",types:["BLOCK","FILE","THIN","ADV","SINK","CINDER","CINDER_BLUN","CINDER_BLUN_THICK","BLUN","BLUN_THICK","BLUN_SINK","BLUN_THICK_SINK"],additional:["is_action_locked","is_mapped","allocated_size","status","allow_bkpobj","flashcache_status","family_config","sync_progress","snapshot_info"]},webapiUnreadEventList:{api:"SYNO.Core.ISCSI.Node",version:1,method:"log_list",limit:0,additional:["unread"]},webapiNetInterfaceList:{api:"SYNO.Core.Network.Interface",version:1,method:"list"},webapiRetentionInfo:{api:"SYNO.DisasterRecovery.Retention",method:"info",version:1},constructor:function(a){var b=this;b.isVDSM=("kvmx64"===_D("synobios")||"nextkvmx64"===_D("synobios"));b.isSDRRunning=_S("systemdr_running");b.supportVAAI=("yes"===_D("support_vaai","no"));b.isLio4x=("lio4x"===_D("iscsi_target_type"));b.supportPerfEvent=("yes"===_D("support_performance_event"));b.supportBtrfsLun=("yes"===_D("support_iscsi_btrfs_lun","no"));b.maxSnapshotPerLun=_D("max_snapshot_per_lun","256");b.timestampNow=0;b.dsZoneOffset=0;b.targetStatusMapping={crashed:{priority:5,type:"crashed",desc:"********",color:"red-status"},unavailable:{priority:4,type:"unavailable",desc:"********",color:"red-status"},processing:{priority:3,type:"processing",desc:"********",color:"blue-status"},error:{priority:2,type:"error",desc:"********",color:"red-status"},warning:{priority:1,type:"warning",desc:"********",color:"orange-status"},normal:{priority:0,type:"normal",desc:"********",color:"green-status"}};b.webapis={"SYNO.SDS.iSCSI.Target.Main":[b.webapiVolumeList,b.webapiPoolList,b.webapiTrgList,b.webapiiSCSILunList,b.webapiNetInterfaceList],"SYNO.SDS.iSCSI.LUN.Main":[b.webapiVolumeList,b.webapiPoolList,b.webapiTrgList,b.webapiiSCSILunList],"SYNO.SDS.iSCSI.Snapshot.Main":[b.webapiTimeGet,b.webapiVolumeList,b.webapiPoolList,b.webapiTrgList,b.webapiiSCSILunList,b.webapiLunList,b.webapiRetentionInfo],"SYNO.SDS.iSCSI.Overview.Main":[b.webapiVolumeList,b.webapiPoolList,b.webapiTrgList,b.webapiiSCSILunList,b.webapiUnreadEventList],"SYNO.SDS.iSCSI.Setting.Main":[b.webapiiSCSILunList]};b.callParent([b.fillConfig(a)]);b.mon(b,"data_ready",function(){b.getActivePage().fireEvent("data_ready")},b);b.mon(b,"poll_activate",function(){b.stopPollTask();b.createPollTask();b.startPollTask()},b)},fillConfig:function(a){var c;c=this.getListItems();var b={cls:"syno-app-iscsi",width:this.defaultWinSize.width,height:this.defaultWinSize.height,minWidth:this.defaultWinSize.width,minHeight:this.defaultWinSize.height,activePage:"SYNO.SDS.iSCSI.Overview.Main",listItems:c};Ext.apply(b,a);return b},getListItems:function(){return[{text:_T("tree","leaf_overview"),iconCls:"icon-overview",fn:"SYNO.SDS.iSCSI.Overview.Main",help:"iSCSIManager/overview.html"},{text:"Target",iconCls:"icon-iscsi-target",fn:"SYNO.SDS.iSCSI.Target.Main",help:"iSCSIManager/target.html"},{text:"LUN",iconCls:"icon-iscsi-lun",fn:"SYNO.SDS.iSCSI.LUN.Main",help:"iSCSIManager/lun.html"},{text:_T("iscsilun","snapshot"),iconCls:"icon-snapshot",fn:"SYNO.SDS.iSCSI.Snapshot.Main",help:"iSCSIManager/snapshot.html",hidden:!this.supportVAAI},{text:_T("common","common_settings"),iconCls:"icon-settings",fn:"SYNO.SDS.iSCSI.Setting.Main",help:"iSCSIManager/setting.html"},{text:_T("tree","leaf_log"),iconCls:"icon-log",fn:"SYNO.SDS.iSCSI.Log.Main",help:"iSCSIManager/overview.html"}]},launchPageOnOpen:function(d){var b=this;if(this.checkModalOrMask()){return}this.openParams=d;if("CloneSnapshot"===d.dlg){this.selectPage("SYNO.SDS.iSCSI.Snapshot.Main");this.on("afterlaunchpage",function(){var h=this.openParams.params;var f=new SYNO.SDS.iSCSI.LUN.iSCSILUN();Ext.each(this.iSCSILuns,function(i){if(i.uuid===h.lun_uuid){f.data=i;return false}});if(f.data===undefined){return}var g=new SYNO.SDS.iSCSI.Snapshot.LUNSnapList({appWin:this,owner:this,launchfrom3rd:true,snapshotuuidfrom3rd:h.snapshot_uuid,title:_T("iscsimgr","snap_list")+" - "+f.get("name"),lun:f});g.open()},this,{single:true})}else{if("FocusLun"===d.dlg){if(!this.openParams||!this.openParams.params||!this.openParams.params.lun_uuid){return}var e=this.openParams.params.lun_uuid;this.selectPage("SYNO.SDS.iSCSI.LUN.Main");var a=function(){var f=b.getActivePage();if(f&&Ext.isFunction(f.setFocus)){f.setFocus(e)}};var c=this.getActivePage();if(c&&c.layoutDrawn){a()}else{this.on("afterlaunchlunpage",function(){a()},this,{single:true})}}}},onOpen:function(a){var b=this;b.initEnv();b.callParent(arguments);b.mon(SYNO.SDS.StatusNotifier,"redirect",b.stopPollTask,b);b.mon(SYNO.SDS.StatusNotifier,"logout",b.stopPollTask,b);b.mon(SYNO.SDS.StatusNotifier,"halt",b.stopPollTask,b)},onClose:function(){this.stopPollTask()},initEnv:function(){this.sendWebAPI({api:"SYNO.Core.ISCSI.Node",version:1,method:"get",params:{additional:["no_rod_key","iqn_hash_key","tp_hard_threshold_bytes","promote_storage_console"]},scope:this,callback:function(c,b,a){if(c){this.env={iqn_hash_key:b.iqn_hash_key,tp_hard_threshold_bytes:b.tp_hard_threshold_bytes,promote_storage_console:b.promote_storage_console}}this.selectPage(this.activePage)}})},processTargets:function(a){var c=this,b,d,e,g;var f=new SYNO.SDS.iSCSI.Store();for(b=0;b<a.length;++b){d=a[b];e=new SYNO.SDS.iSCSI.Target.iSCSITarget();e.data=d;g=d.target_id;e.id=d.target_id;f.data[g]=e}f.prepareArray();f.count=a.length;c.iscsiTargets=f},processLUNs:function(a){var c=this,b,d,e,g;var f=new SYNO.SDS.iSCSI.Store();for(b=0;b<a.length;++b){d=a[b];e=new SYNO.SDS.iSCSI.LUN.iSCSILUN();e.data=d;g=d.uuid;e.id=d.lun_id;e.prepareDevAttribsJson();f.data[g]=e}f.prepareArray();f.count=a.length;c.iscsiLuns=f},getCanCreateLunTypes:function(){var b={};var a=this.supportBtrfsLun?"btrfs_lun":"file_lun";Ext.each(this.volumes,function(c){if(c.size_free_byte<SYNO.SDS.iSCSI.Utils.ISCSITRG_UNIT_GB){return true}if("crashed"===c.status){return true}if(c.fs_type==="btrfs"){b[a]=true}else{if(c.fs_type==="ext4"){b.file_lun=true}}});return b},isUpToLunMaxCount:function(){var a=parseInt(_D("max_iscsiluns",10),10);if(!this.iscsiLuns){return false}return(this.iscsiLuns.count>=a)},isUpToTargetMaxCount:function(){var a=parseInt(_D("max_iscsitrgs",10),10);if(!this.iscsiTargets){return false}return(this.iscsiTargets.count>=a)},createPollTask:function(c){var a=this,b=a.getActivePage().getItemId();a.pollTaskConf={interval:a.pollingInterval,immediate:true,appWindow:a,webapi:{api:"SYNO.Entry.Request",version:2,method:"request",params:{mode:"parallel",compound:a.webapis[b]}},scope:a,status_callback:function(f,e,d){if(!f){a.clearStatusBusy();a.getMsgBox().alert(_T("iscsimgr","app_title"),_T("common","error_system"));a.stopPollTask();return}a.processData(e);a.fireEvent("data_ready")}}},stopPollTask:function(){var a=this;if(a.pollTaskID!==undefined){a.pollUnreg(a.pollTaskID);delete a.pollTaskID}},startPollTask:function(){var a=this;if(undefined===a.pollTaskID){a.pollTaskID=a.pollReg(a.pollTaskConf)}},restartPollTask:function(){this.stopPollTask();this.startPollTask()},processData:function(b){var a=this;if(a.volumes){delete a.volumes}a.volumes=[];b.result.each(function(c){if(true===SYNO.ux.Utils.checkApiConsistency(a.webapiTimeGet,c)){a.processNtpData(c.success?c.data:null)}else{if(true===SYNO.ux.Utils.checkApiConsistency(a.webapiRetentionInfo,c)){if(c&&c.data){a.advRetentionFeatures=c.data.adv_features}a.supportTimeTrigger=(-1!==a.advRetentionFeatures.indexOf(SYNO.SDS.iSCSI.RET_TRIGGER_BY_TIME))}else{if(true===SYNO.ux.Utils.checkApiConsistency(a.webapiVolumeList,c)){if(c.success){a.volumes=c.data.volumes.filter(function(d){return d.location!="usb"})}else{a.volumes=[]}}else{if(true===SYNO.ux.Utils.checkApiConsistency(a.webapiPoolList,c)){a.pools=c.success?c.data.pools:[]}else{if(true===SYNO.ux.Utils.checkApiConsistency(a.webapiiSCSILunList,c)){a.processLUNs(c.success?c.data.luns:[])}else{if(true===SYNO.ux.Utils.checkApiConsistency(a.webapiLunList,c)){a.processLunData(c.success?c.data.luns:[])}else{if(true===SYNO.ux.Utils.checkApiConsistency(a.webapiTrgList,c)){a.processTargets(c.success?c.data.targets:[])}else{if(true===SYNO.ux.Utils.checkApiConsistency(a.webapiUnreadEventList,c)){a.summary=c.success?c.data.summary:{}}else{if(true===SYNO.ux.Utils.checkApiConsistency(a.webapiNetInterfaceList,c)){a.netInterfaces=c.success?c.data:[]}}}}}}}}}},a)},processNtpData:function(d){if(!d){return}var c=this,a=SYNO.SDS.Utils.getTimeZoneData(),b;if(undefined!==a){Ext.each(a,function(e){if(d.timezone===e.value){c.dsZoneOffset=e.offset;return false}})}b=d.date.split("/").map(function(e){return parseInt(e,10)});c.dsNowSec=Date.UTC(b[0],b[1]-1,b[2],d.hour,d.minute,d.second)/1000-c.dsZoneOffset*60;c.timestampNow=Math.round(new Date().getTime()/1000)},processScheduledRender:function(c){var a;var b;a=new SYNO.ux.ScheduleField();a.setValue(c);b=a.rawValue;Ext.destroy(a);return b},isVolumeCrashed:function(d){var b=this,a="",c;if(d.type==="lun"){a=d.rootpath}c=b.volumes.find(function(f,e,g){if(f.volume_path===a){return true}return false});if(undefined===c){return false}return(true===c.readonly||true===c.crashed)},getVolumeFsType:function(d){var b=this,a=d.rootpath,c;c=b.volumes.find(function(f,e,g){if(f.volume_path===a){return true}return false});if(undefined===c){return""}return c.fs_type},isLunActing:function(b){var a=["processing","moving","creating","expanding","snapshot_deleting","deleting","cloning","be_cloning","restoring","snapshotting"];return(-1!==a.indexOf(b.status))},getLunActionProgress:function(c){var b;if("-1"!==c.progress.percent&&-1!==c.progress.percent){b=parseInt(c.progress.percent,10)}else{var a=(c.snapshots)?c.snapshots[c.snapshots.length-1]:null;b=(a)?parseInt(a.status.progress.percent,10):-1}return(0>b)?0:b},processLunData:function(c){var d=this,a=SYNO.SDS.iSCSI.Utils,b=a.UIRender;c.each(function(i){var f;Ext.apply(i,i.iscsi_lun);delete i.iscsi_lun;if(i.device_type&&"sink"===i.device_type){i.iconCls="iscsi-lun-icon iscsi-lun-icon-sink"}else{if(!i.thin_provision){i.iconCls="iscsi-lun-icon iscsi-lun-icon-block"}else{i.iconCls=String.format("iscsi-lun-icon iscsi-lun-icon-{0}",i.is_blun?"btrfs":"file")}}i.is_actioning=d.isLunActing(i);f=(i.is_actioning)?d.getLunActionProgress(i):0;i.type="lun";i.volume_crashed=d.isVolumeCrashed(i);i.vol_path=i.rootpath;i.vol_fs_type=d.getVolumeFsType(i);i.vol_info=a.lunVolumeInfoRenderer(i);i.isProtected=(i.snapshots&&(0<i.snapshots.length))?true:false;i.isSnapScheduled=(i.scheduled_task&&i.scheduled_task[0].general.task_enabled)?true:false;i.is_actioning=i.is_actioning;i.used_by=i.hasOwnProperty("used_by")?i.used_by:"dsm";i.canManage=("cinder"!==i.used_by);var h="unavailabling"===i.status?false:i.is_actioning;i.displayProg=h?"show":"hide";i.progress=f.toString()+" %";i.barWidth=200*f/100;i.lastSnapshot=(!i.isProtected)?SYNO.SDS.iSCSI.invalid:d.timeRender(Math.round(d.timestampNow-(d.getSnapTime(i.snapshots[i.snapshots.length-1])/1000)));if(i.isSnapScheduled){var e=i.scheduled_task[0].schedule.next_trigger_time.split(/[: -]+/).map(function(j){return parseInt(j,10)});i.next_run_time=Date.UTC(e[0],e[1]-1,e[2],e[3],e[4],0)/1000-d.dsZoneOffset*60}else{i.next_run_time=SYNO.SDS.iSCSI.invalid}if(true===i.extent_based){i.lun_type=SYNO.SDS.iSCSI.LUN_TYPE_ADV}else{if(true===i.is_blun){i.lun_type=SYNO.SDS.iSCSI.LUN_TYPE_BTRFS}else{i.lun_type=SYNO.SDS.iSCSI.LUN_TYPE_NOT_SUPPORT}}i.lun_snap_type_desc=SYNO.SDS.iSCSI.Utils.LunSnapTypeRenderer(i.lun_type);i.support_snapshot=d.iscsiLuns.getById(i.uuid).isEnableSnapshot();if(a.IsALUN(i.lun_type)||a.IsBLUN(i.lun_type)){i.snapshotProp=[{name:_T("schedule","next_trigger_time"),value:(i.isSnapScheduled)?b.planNextTimeRender(i.next_run_time,d.dsNowSec):SYNO.SDS.iSCSI.invalid},{name:_T("iscsimgr","snap_last_time"),value:i.lastSnapshot},{name:_T("iscsimgr","snap_can_restore"),value:i.isProtected?i.snapshots.length:SYNO.SDS.iSCSI.invalid},{name:_T("iscsimgr","snap_ret_time"),value:d.retentionRender(d.iscsiLuns.data[i.uuid]?d.iscsiLuns.data[i.uuid].get("retention"):{},"Lun")}];var g=d.retentionTriggerRender(d.iscsiLuns.data[i.uuid]?d.iscsiLuns.data[i.uuid].get("retention"):{},"Lun");if(g){i.snapshotProp.push({name:_T("snapmgr","snap_ret_trigger_time"),value:g})}}i.capacity=i.support_snapshot?d.SizeRender(i.size):SYNO.SDS.iSCSI.invalid;i.scheduleTask=[];if(i.isSnapScheduled){i.scheduleTask.push({date:d.processScheduledRender(i.scheduled_task[0].schedule.week_name),freq:d.freqRender(i.scheduled_task[0].schedule),type:_T("iscsimgr","snap_local_snapshot")})}i.restorePageLastSnapshot=_T("iscsimgr","snap_last_time")+" - "+i.lastSnapshot;if(i.volume_crashed){i.recoveryStatus="crashed"}else{i.recoveryStatus=i.is_actioning?"processing":(i.isProtected?"normal":"warning")}i.recoveryDesc=d.recoveryDescRender(i.isSnapScheduled?_T("iscsimgr","type_scheduled_snapshot"):_T("iscsimgr","type_manual_snapshot"),i.recoveryStatus);i.restoreProp=[{name:_T("iscsimgr","snap_can_restore"),value:i.isProtected?i.snapshots.length:SYNO.SDS.iSCSI.invalid}];i.replicationTest=[];i.isTestingReplica=false;i.replicatedSites=0;if(i.isProtected){i.snapshots.each(function(j){j.epoch_msec=d.getSnapTime(j);j.ownername=i.name},d)}i.retention_info={type:"Lun",name:i.lid.toString()};d.statusRender(i,i.is_actioning,null,i.isSnapScheduled)},d);d.iSCSILuns=c},createPage:function(b){var c=Ext.getClassByName(b);var a=new c({appWin:this,owner:this});a.itemId=b;return a},genNewTargetName:function(){var b="Target-";var a,c=0;while(!this.isUniqueTargetName(a=b+(++c))){}return a},genNewIQN:function(e){var a=_S("hostname");a=a.replace(/_/g,"-");a=a.replace(/\+/g,"p");var d="iqn.2000-01.com.synology:"+a+"."+e;var f="."+this.getUniqueKey();var b=d;var c=1;while(!this.isUniqueIQN(b+f)){b=d+(c++)}return b+f},genNewLunName:function(){var b="LUN-";var a,c=0;while(!this.isUniqueLunName(a=b+(++c))){}return a},getUniqueKey:function(){return this.env?(Ext.isString(this.env.iqn_hash_key)?this.env.iqn_hash_key:""):""},setTpHardThreshold:function(a){if(this.env){this.env.tp_hard_threshold_bytes=a}},getTpHardThreshold:function(){return(this.env&&this.env.tp_hard_threshold_bytes)?this.env.tp_hard_threshold_bytes:SYNO.SDS.iSCSI.TP_HARD_THRESHOLD_DEFAULT_SIZE},isLowCapacityWriteEnable:function(){return this.getTpHardThreshold()<SYNO.SDS.iSCSI.TP_HARD_THRESHOLD_DEFAULT_SIZE},isUniqueIQN:function(a){return !this.iscsiTargets.isAnyMatched(function(){return(this.get("iqn").toUpperCase()===a.toUpperCase())})},isUniqueTargetName:function(a){return !this.iscsiTargets.isAnyMatched(function(){return(this.get("name")===a)})},isUniqueLunName:function(a){return !this.iscsiLuns.isAnyMatched(function(){return(this.get("name")===a)})},genTargetLUNMapping:function(){var a=this.iscsiTargets.getAll();var b=this.iscsiLuns;var c=b.getAll();Ext.each(c,function(d){d.mappedTargets=[]});Ext.each(a,function(d){Ext.each(d.get("mapped_luns"),function(e){b.getById(e.lun_uuid).mappedTargets.push(d.id)})})},getMappedTrgs:function(c,d){if(undefined===this.iscsiLuns.getById(c).mappedTargets){this.genTargetLUNMapping()}var b=this.iscsiTargets;var a=[];Ext.each(this.iscsiLuns.getById(c).mappedTargets,function(e){var f=b.getById(e);a.push({name:f.get("name"),status:d?SYNO.SDS.iSCSI.Utils.TargetStatusRender(f.get("status")):f.get("status")})});return a},retentionStringConbine:function(a,c,b){if(""===a){return c+" "+b}else{return c+" "+b+", "+a}},statusRender:function(d,c,a,b){var e;if(d.volume_crashed){d.snapStatus=String.format("&nbsp;-&nbsp;{0}",'<font class="red-status">'+_T("iscsimgr","status_volume_crash_title")+"</font>");d.statusCategory=SYNO.SDS.iSCSI.STATUS_VOLUME_CRASHED}else{if(!d.canManage){e=String.format(_T("iscsimgr","target_managed_by"),SYNO.SDS.iSCSI.Utils.UIRender.getManagedByRender(d.used_by));d.snapStatus=String.format("&nbsp;-&nbsp;{0}",'<font class="orange-status">'+e+"</font>");d.statusCategory=SYNO.SDS.iSCSI.STATUS_NOT_MANAGEABLE}else{if(!a&&!b){if(!d.support_snapshot){d.snapStatus=(d.thin_provision?String.format("&nbsp;-&nbsp;{0}",'<font class="gray-status">'+_T("snapmgr","snap_lun_snapshot_disable")+"</font>"):String.format("&nbsp;-&nbsp;{0}",'<font class="gray-status">'+_T("snapmgr","snap_lun_not_support")+"</font>"))}else{d.snapStatus=String.format("&nbsp;-&nbsp;{0}",'<font class="orange-status">'+_T("iscsimgr","status_no_protection")+"</font>");d.statusCategory=SYNO.SDS.iSCSI.STATUS_NO_PROTECTED}}else{if(a){d.snapStatus=String.format("&nbsp;-&nbsp;{0}",'<font class="green-status">'+_T("iscsimgr","status_replica")+"</font>");d.statusCategory=SYNO.SDS.iSCSI.STATUS_REPLICA}else{d.snapStatus=String.format("&nbsp;-&nbsp;{0}",'<font class="blue-status">'+_T("iscsimgr","status_schedule")+"</font>");d.statusCategory=SYNO.SDS.iSCSI.STATUS_SCHEDULE}}}}if(c){d.snapStatus=String.format("&nbsp;-&nbsp;{0}",'<font class="blue-status">'+_T("iscsimgr","status_processing")+"</font>")}},retentionRender:function(c){if(!c||!c.policyType){return _T("iscsimgr","ret_all_snap")}var d="";var b=~SYNO.SDS.iSCSI.RTT_TRRIGER_BY_TIME&c.policyType;if(SYNO.SDS.iSCSI.RTT_ALL===b){d=_T("iscsimgr","ret_all_snap")}else{if(SYNO.SDS.iSCSI.RTT_DEL_OLD===b){d=String.format(_T("iscsimgr","ret_recent_num"),c.recently)}else{var a="";if(0!==c.yearly){a=this.retentionStringConbine(a,c.yearly,_T("iscsimgr","ret_yearly_short"))}if(0!==c.monthly){a=this.retentionStringConbine(a,c.monthly,_T("iscsimgr","ret_monthly_short"))}if(0!==c.weekly){a=this.retentionStringConbine(a,c.weekly,_T("iscsimgr","ret_weekly_short"))}if(0!==c.daily){a=this.retentionStringConbine(a,c.daily,_T("iscsimgr","ret_daily_short"))}if(0!==c.hourly){a=this.retentionStringConbine(a,c.hourly,_T("iscsimgr","ret_hourly_short"))}if(""!==a){d=a}else{d=_T("iscsimgr","ret_late_snap")}}}return d},retentionTriggerRender:function(b){if(!b||!b.policyType){return null}var a=~SYNO.SDS.iSCSI.RTT_TRRIGER_BY_TIME&b.policyType;if(SYNO.SDS.iSCSI.RTT_ALL===a){return null}var c=SYNO.SDS.iSCSI.RTT_TRRIGER_BY_TIME&b.policyType;if(c&&b.schedule){return String.format(_T("iscsimgr","ret_trigger_at"),b.schedule.hour+":00")}else{return _T("snapmgr","ret_trigger_after_snap")}},recoveryDescRender:function(c,a){var d=this,b=d.targetStatusMapping[a];if(b&&b.color&&b.desc){return String.format(' - {0}, <font class ="{1}">{2}</font>',c,b.color,b.desc)}return""},freqRender:function(a){if(0!==a.repeat_hour){return String.format(_T("schedule","every_x_hours"),a.repeat_hour.toString())}else{if(0!==a.repeat_min){return String.format(_T("schedule","every_x_minutes"),a.repeat_min.toString())}else{return _T("schedule","schedule_every_once")}}},timeRender:function(d,a){var c,b;if(0>d){d=0}if(2>d){c=d;b=_T("common","time_second")}else{if(60>d){c=d;b=_T("common","time_seconds")}else{if(2*60>d){c=Math.floor(d/60);b=_T("common","time_minute")}else{if(60*60>d){c=Math.floor(d/60);b=_T("common","time_minutes")}else{if(2*60*60>d){c=Math.floor(d/(60*60));b=_T("common","time_hour")}else{if(24*60*60>d){c=Math.floor(d/(60*60));b=_T("common","time_hours")}else{if(2*24*60*60>d){c=Math.floor(d/(24*60*60));b=_T("common","time_day")}else{c=Math.floor(d/(24*60*60));b=_T("common","time_days")}}}}}}}return String.format(a?a:_T("iscsimgr","snap_last_time_msg"),c,b)},getSnapTime:function(a){if(!a){return}return a.time*1000}});